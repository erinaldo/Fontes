#INCLUDE "PROTHEUS.CH" 
#INCLUDE "COMXFUN.CH"
#DEFINE CAB_ARQTMP  01
#DEFINE CAB_POSATU  02
#DEFINE CAB_SAYGET  03
#DEFINE CAB_HFLD1   04
#DEFINE CAB_HFLD2   05
#DEFINE CAB_HFLD3   06
#DEFINE CAB_MARK	 07
#DEFINE CAB_GETDAD  08
#DEFINE CAB_COTACAO 09
#DEFINE CAB_MSMGET  10
#DEFINE CAB_ULTFORN 11
#DEFINE CAB_HISTORI 12

Static lRestComp
/*/
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³COMXFUN   ?Autor ?Eduardo Riera         ?Data ?08.12.97  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Biblioteca de funcoes das rotinas de compras.                ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³Materiais                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Descri‡…o ?PLANO DE MELHORIA CONTINUA        ³Programa     COMXFUN.PRX³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³ITEM PMC  ?Responsavel              ?Data                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?     01  ?Marcos V. Ferreira       ?23/12/2005                      ³±?
±±?     02  ?Nereu Humberto Junior    ?05/12/2005                      ³±?
±±?     03  ?Marcos V. Ferreira       ?05/04/2006 - Bops: 00000094869  ³±?
±±?     04  ?Ricardo Berti            ?20/02/2006 - Bops: 00000089826  ³±?
±±?     05  ?Erike Yuri da Silva      ?26/01/2006 - Bops: 00000090885  ³±?
±±?     06  ?Marcos V. Ferreira       ?14/03/2006 - Bops: 00000093752  ³±?
±±?     07  ?Marcos V. Ferreira       ?23/12/2005                      ³±?
±±?     08  ?Erike Yuri da Silva      ?26/01/2006 - Bops: 00000090885  ³±?
±±?     09  ?Nereu Humberto Junior    ?05/12/2005                      ³±?
±±?     10  ?Ricardo Berti            ?20/02/2006 - Bops: 00000089826  ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaAvalSC  ?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Rotina de avaliacao dos eventos de uma solicitacao de compra ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaAvalSC(ExpC1,ExpN1,ExpC2,ExpC3,ExpL1,ExpL2,ExpL3)		   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela de solicitacao de compra              ³±?
±±?         ³ExpN1: Codigo do Evento                                      ³±?
±±?         ?      [1] Implantacao de uma solicitacao de compra          ³±?
±±?         ?      [2] Estorno de uma solicitacao de compra              ³±?
±±?         ?      [3] Exclusao de uma solicitacao de compra             ³±?
±±?         ?      [4] Implantacao de uma cotacao para a SC              ³±?
±±?         ?      [5] Cancelamento de uma cotacao para a SC             ³±?
±±?         ?      [6] Implantacao de um pedido de compra para a SC      ³±?
±±?         ?      [7] Cancelamento de um pedido de compra da SC         ³±?
±±?         ?      [8] Aprovacao/rejeicao de solicitacao de compra       ³±?
±±?         ?      [9] Cancelamento da solicitacao de compra             ³±?
±±?         ³ExpC2: Alias da tabela de cotacao de compra                  ³±?
±±?         ³ExpC3: Alias da tabela de pedido de compra                   ³±?
±±?         ³ExpL1: Indica se o SC1 deve ser atualizado                   ³±?
±±?         ³ExpL2: Indica se o SB2 deve ser atualizado.                  ³±?
±±?         ?              ( DEFAULT .T. )                          (OPC)³±?
±±?         ³ExpL3: Indica se o Parametro MV_PCEXCOT esta ativo para      ³±?
±±?         ?      restaurar a cotacao na exclusao PC ( DEFAULT .F.)(OPC)³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ?T. 		                                                   ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar os eventos vinculados³±?
±±?         ³a uma solicitacao de compra:                                 ³±?
±±?         ³A) Atualizacao das tabelas complementares.                   ³±?
±±?         ³B) Atualizacao das informacoes complementares a SC           ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaAvalSC(cAliasSC1,nEvento,cAliasSC8,cAliasSC7,lAcumulados,lAtuSB2,lRestCot,cAprovBkp)

Local aArea 	:= GetArea()
Local aAreaSC8  := SC8->(GetArea())
Local aAreaSC1	:= SC1->(GetArea())
Local aAreaSM0  := SM0->(GetArea())
Local cAlias    := ""
Local cUser 	:= ""
Local cFilBkp   := cFilAnt
Local lQuery    := .F.
Local nQtdEmSC  := 0
Local nQtdEmSC2 := 0
Local lSb1TES  := SuperGetMv("MV_SB1TES",.F.,.F.)
Local lSCSldBl	:= SuperGetMv("MV_SCSLDBL",.F.,.F.)
//-- Variavel usada para verificar se o disparo da funcao IntegDef() pode ser feita manualmente
Local lIntegDef  	:=  FindFunction("GETROTINTEG") .And. FindFunction("FWHASEAI") .And. FWHasEAI("MATA110",.T.,,.T.)
Local lMkPlace	:= .F.
Local cEntrega  := If(SuperGetMv("MV_PCFILEN"),If(Empty((cAliasSC1)->C1_FILENT),xFilial("SB2"),SB2->(xFilEnt((cAliasSC1)->C1_FILENT))),xFilial("SB2"))
#IFDEF TOP
	Local cQuery	:= ""
#ENDIF
Local lPrjCni := FindFunction("ValidaCNI") .And. ValidaCNI()
DEFAULT cAliasSC1   := "SC1"
DEFAULT cAliasSC8   := "SC8"
DEFAULT cAliasSC7   := "SC7"
DEFAULT lAcumulados := .F.
DEFAULT lAtuSB2     := .T.
DEFAULT lRestCot    := .F.
DEFAULT cAprovBkp	:= ""

Do Case
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de uma solicitacao de compra                                ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 1
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza dados complementares da solicitacao de compra                  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ( !lAcumulados )
		
		If Empty((cAliasSC1)->C1_USER)
			cUser := RetCodUsr()
			RecLock(cAliasSC1)
			(cAliasSC1)->C1_USER    := cUser
			(cAliasSC1)->C1_GRUPCOM := MaRetComSC((cAliasSC1)->C1_PRODUTO,UsrRetGrp(),cUser)
		Endif
		
		If (cAliasSC1)->C1_IMPORT == "S"
			If (cAliasSC1)->C1_COTACAO<>"IMPORX"
				(cAliasSC1)->C1_COTACAO := "IMPORT"
			EndIf
			(cAliasSC1)->C1_CLASS   :=  IIf(Empty((cAliasSC1)->C1_CLASS),"1",(cAliasSC1)->C1_CLASS)
		ElseIf (cAliasSC1)->C1_IMPORT == "N" .And. (cAliasSC1)->C1_COTACAO == "IMPORT"
			(cAliasSC1)->C1_COTACAO := ""
		Else
			(cAliasSC1)->C1_COTACAO := If((cAliasSC1)->C1_QUJE==0.And.(cAliasSC1)->C1_COTACAO=="XXXXXX","",(cAliasSC1)->C1_COTACAO)	
		EndIf
		If !lPrjCni .And. (SC1->(FieldPos("C1_SCORI")) == 0 .Or. Empty((cAliasSC1)->C1_SCORI))
	   		If SuperGetMv("MV_APROVSC") .AND. !( SuperGetMv("MV_APRSCEC",.F.,.F.) ) .And. !(cAliasSC1)->C1_QUJE > 0 // Verifica se a SC foi atendida total ou parcialmente
		  		(cAliasSC1)->C1_APROV := IIf(MaVldSolic((cAliasSC1)->C1_PRODUTO,/*aGrupo*/,/*cUser*/,.F.),"L","B")
			ElseIf SuperGetMv("MV_APROVSC") .AND. SuperGetMv("MV_APRSCEC",.F.,.F.)
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				//³Bloqueia item por entidade ctb. e valor?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		  		(cAliasSC1)->C1_APROV := "B"
   			ElseIF (cAliasSC1)->(FieldPos("C1_COMPRAC")) > 0	//-- Se compra centralizada, apenas atualiza flag da descentralização 
	  			(cAliasSC1)->C1_COMPRAC := '2'
	  		EndIf
			
			SB5->(DbSetOrder(1))
			If SB5->(DbSeek( xFilial("SB5") + SC1->C1_PRODUTO ) )
				If SB5->(FieldPos("B5_ENVMKT")) > 0
					If SB5->B5_ENVMKT == "1"
						lMkPlace := .T.				
					EndIf
				EndIf
			EndIf
		
			If lIntegDef .And. (cAliasSC1)->C1_APROV $ " ,L" .And. SuperGetMV("MV_MKPLACE",.F.,.F.) .And. lMkPlace 
				Inclui:=.T.             
				SetRotInteg('MATA110' )
				FwIntegDef( 'MATA110' )				
			EndIf
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza as tabelas auxiliares                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SB2")
	dbSetOrder(1)
	If ( !MsSeek(cEntrega+(cAliasSC1)->C1_PRODUTO+(cAliasSC1)->C1_LOCAL) )
		CriaSB2((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_LOCAL,cEntrega)
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica se deve atualizar o Campo B2_SALPEDI            ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !lSCSldBl .Or. (lSCSldBl .And. (cAliasSC1)->C1_APROV <> 'B')
		If (cAliasSC1)->(FieldPos("C1_ESTOQUE")) > 0 .And. lSb1TES
		   	If (cAliasSC1)->C1_ESTOQUE=="S" .Or.  Empty((cAliasSC1)->C1_ESTOQUE)
				GravaB2Pre("+",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
			EndIf
		Else 
			GravaB2Pre("+",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
		EndIf
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza os arquivos do SIGAPMS                                         ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If GetMV("MV_INTPMS",,"N") == "S"
		PMSWriteSC(1,cAliasSC1)
	EndIf
	If ! lAcumulados
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		LancaPCO("SC1","000051","01","MATA110")
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Cancelamento de uma solicitacao de compra                               ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 2
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza as tabelas auxiliares                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ		
	dbSelectArea("SB2")
	dbSetOrder(1)
	If ( !MsSeek(cEntrega+(cAliasSC1)->C1_PRODUTO+(cAliasSC1)->C1_LOCAL) )
		CriaSB2((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_LOCAL,cEntrega)
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica se deve atualizar o Campo B2_SALPEDI            ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ 
	If !lSCSldBl .Or. (lSCSldBl .And. (cAliasSC1)->C1_APROV <> 'B')
		If (cAliasSC1)->(FieldPos("C1_ESTOQUE")) > 0 .And. lSb1TES
		   	If (cAliasSC1)->C1_ESTOQUE=="S" .Or.  Empty((cAliasSC1)->C1_ESTOQUE)  
				GravaB2Pre("-",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
			EndIF
		Else 
			GravaB2Pre("-",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
		EndIf
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza os arquivos do SIGAPMS - Estorno da SC                         ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If GetMV("MV_INTPMS",,"N") == "S"
		PMSWriteSC(2,cAliasSC1)
	EndIf
	
	//-- Se gerada por compra centralizada, libera SC origem
	If SC1->(FieldPos("C1_SCORI")) > 0 .And. !Empty((cAliasSC1)->C1_SCORI)
		SC1->(dbSetOrder(2))
		If SC1->(dbSeek((cAliasSC1)->(C1_FISCORI+C1_PRODUTO+C1_SCORI+C1_ITSCORI))) .And. RecLock("SC1",.F.)
			SC1->C1_COMPRAC := "2"
		EndIf
		SC1->(RestArea(aAreaSC1))
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Exclusao de uma solicitacao de compra                                   ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 3
	If !lAcumulados
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If Alltrim((cAliasSC1)->C1_APROV) == "L"
			LancaPCO("SC1","000051","02","MATA110",.T.)		
		Endif     
		
		LancaPCO("SC1","000051","01","MATA110",.T.)

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Atualiza os arquivos do SIGAPMS                                         ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If GetMV("MV_INTPMS",,"N") == "S"
			PMSWriteSC(3,cAliasSC1)
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Retira a amarracao da SC com o Pedido de Compra.                ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		#IFDEF TOP
			If ( TcSrvType()<>"AS/400")
				lQuery := .T.
				cAlias := "MAAVALSC"
				cQuery := "SELECT SC7.*,R_E_C_N_O_ SC7RECNO "
				cQuery += "FROM "+RetSqlName("SC7")+" SC7 "
				cQuery += "WHERE SC7.C7_FILIAL='"+xFilial("SC7")+"' AND "
				cQuery += "SC7.C7_PRODUTO='"+(cAliasSC1)->C1_PRODUTO+"' AND "
				cQuery += "SC7.C7_NUMSC='"+(cAliasSC1)->C1_NUM+"' AND "
				cQuery += "SC7.C7_ITEMSC='"+(cAliasSC1)->C1_ITEM+"' AND "
				cQuery += "SC7.D_E_L_E_T_<>'*'"
				cQuery := ChangeQuery(cQuery)
				SC7->(dbCommit())
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAlias,.T.,.T.)
				
			Else			
		#ENDIF
			cAlias := "SC7"
			dbSelectArea("SC7")
			dbSetOrder(2)
			MsSeek(xFilial("SC7")+(cAliasSC1)->C1_PRODUTO)
			#IFDEF TOP
			EndIf		
			#ENDIF
		While ( !Eof() .And. xFilial("SC7") == (cAliasSC7)->C7_FILIAL .And.;
				(cAliasSC1)->C1_PRODUTO == (cAlias)->C7_PRODUTO )
			If ( (cAliasSC1)->C1_NUM == (cAliasSC7)->C7_NUMSC .And.;
					(cAliasSC1)->C1_ITEM == (cAliasSC7)->C7_ITEMSC )
				If ( lQuery )
					SC7->(MsGoto((cAlias)->SC7RECNO))
				EndIf
				RecLock("SC7",.F.)
				SC7->C7_NUMSC  := ""
				SC7->C7_ITEMSC := ""
			EndIf
			dbSelectArea(cAlias)
			dbSkip()
		EndDo
		If ( lQuery )
			dbSelectArea(cAlias)
			dbCloseArea()
			dbSelectArea(cAliasSC1)
		EndIf
		
		If SC1->(FieldPos("C1_SCORI")) > 0
			//-- Se gerada por compra centralizada, volta SC origem
			If !Empty((cAliasSC1)->C1_SCORI)
				SC1->(dbSetOrder(2))
				If SC1->(dbSeek((cAliasSC1)->(C1_FISCORI+C1_PRODUTO+C1_SCORI+C1_ITSCORI))) .And. RecLock("SC1",.F.)
					SC1->C1_QUANT   := SC1->C1_QTDORIG
					SC1->C1_RESIDUO := ""
					SC1->C1_COMPRAC := "2"
					SC1->(MsUnLock())
					
					//-- Troca filial para processar acumulados
					SM0->(dbSetOrder(1))
					SM0->(dbSeek(cEmpAnt+AllTrim(SC1->C1_FILENT)))
					cFilAnt := FWCodFil()
					MaAvalSC("SC1",1,.F.)				
					If lPrjCni
						//Rodrigo Guerato - FSW - Estorno do Logs na Filial de Origem
						COMA080(SC1->C1_NUM,SC1->C1_ITEM,"COI",{},"COI_DTHTRA","COI_UTRA",.T.,/*cUser*/,"COI_DOCTRA")
					EndIf					
					SM0->(RestArea(aAreaSM0))
					cFilAnt := cFilBkp
				EndIf
				SC1->(RestArea(aAreaSC1))
			Else
				SC1->(dbSetOrder(11))
				//-- Se centralizou, exclui a SC centralizada
				If SC1->(dbSeek((cAliasSC1)->(C1_FILIAL+C1_NUM+C1_ITEM+C1_PRODUTO)))
					If MACanDelSC("SC1",1,.F.) //-- Se puder deletar, deleta
						//-- Troca filial para processar acumulados
						SM0->(dbSetOrder(1))
						SM0->(dbSeek(cEmpAnt+AllTrim(SC1->C1_FILENT)))
						cFilAnt := FWCodFil()
						MaAvalSC("SC1",2)
						SM0->(RestArea(aAreaSM0))
						cFilAnt := cFilBkp
						
						//-- Deleta
						RecLock("SC1",.F.)
						SC1->(dbDelete())
						SC1->(MsUnLock())
					Else						//-- Se nao puder deletar, remove vinculo
						RecLock("SC1",.F.)
						SC1->C1_FISCORI	:= ""
						SC1->C1_SCORI 	:= ""
						SC1->C1_ITSCORI	:= ""
						SC1->(MsUnLock())
					EndIf
				EndIf
				SC1->(RestArea(aAreaSC1))
			EndIf
		EndIf		
				
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Exclui o documento se gerado na CPM                      ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
		If AliasInDic("CPM")
			A181EXCCPM('1',SC1->C1_NUM)
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de uma cotacao para a solicitacao de compra                 ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 4
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Cancelamento de uma cotacao para a solicitacao de compra                ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 5
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de um pedido de compra para a solicitacao de compra         ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 6
	If !lAcumulados
		RecLock("SC1",.F.)
		(cAliasSC1)->C1_PEDIDO  := 	(cAliasSC7)->C7_NUM
		(cAliasSC1)->C1_ITEMPED := (cAliasSC7)->C7_ITEM
		//Atualização da legenda da solicitacao
		If SuperGetMV("MV_MKPLACE",.F.,.F.) .And. (cAliasSC1)->(FieldPos("C1_ACCPROC")) > 0
			(cAliasSC1)->C1_ACCPROC := ""
		Endif		
		//Se o fornecedor estiver vazio, grava o fornecedor do pedido, caso contrário, preserva o da solicitacao
		If Empty((cAliasSC1)->C1_FORNECE)
			(cAliasSC1)->C1_FORNECE := (cAliasSC7)->C7_FORNECE
			(cAliasSC1)->C1_LOJA    := (cAliasSC7)->C7_LOJA
		EndIf
		(cAliasSC1)->C1_COTACAO := If(Empty((cAliasSC1)->C1_COTACAO),Repl("X",Len((cAliasSC1)->C1_COTACAO)),(cAliasSC1)->C1_COTACAO)
		If ( Empty((cAliasSC7)->C7_NUMCOT) .Or. (cAliasSC7)->C7_QTDSOL<>0 )
			nQtdEmSc := (cAliasSC7)->C7_QTDSOL
			nQtdEmSc2:= (cAliasSC1)->C1_QTSEGUM*(cAliasSC7)->C7_QTDSOL/(cAliasSC1)->C1_QUANT
		Else
			nQtdEmSc := (cAliasSC1)->C1_QUANT
			nQtdEmSc2:= (cAliasSC1)->C1_QTSEGUM
		EndIf
		
		If (cAliasSC1)->C1_QUJE+nQtdEmSc > (cAliasSC1)->C1_QUANT
			nQtdEmSc  := (cAliasSC1)->C1_QUANT - (cAliasSC1)->C1_QUJE
			nQtdEmSc2 := (cAliasSC1)->C1_QTSEGUM*(((cAliasSC1)->C1_QUANT - (cAliasSC1)->C1_QUJE)/(cAliasSC1)->C1_QUANT)
			
			RecLock("SC7",.F.)
				SC7->C7_QTDSOL := nQtdEmSc
			Msunlock()
		Endif
		
		(cAliasSC1)->C1_QUJE    += nQtdEmSC
		(cAliasSC1)->C1_QUJE2   += nQtdEmSC2
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Atualiza as tabelas auxiliares                                          ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lAtuSB2
			dbSelectArea("SB2")
			dbSetOrder(1)
			If ( !MsSeek(cEntrega+(cAliasSC1)->C1_PRODUTO+(cAliasSC1)->C1_LOCAL) )
				CriaSB2((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_LOCAL,cEntrega)
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Verifica se deve atualizar o Campo B2_SALPEDI            ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ 
			If (cAliasSC7)->(FieldPos("C7_ESTOQUE"))> 0  .And. lSb1TES
				If (cAliasSC7)->C7_ESTOQUE=="S" .Or. Empty((cAliasSC7)->C7_ESTOQUE)
					GravaB2Pre("-",nQtdEmSC,(cAliasSC1)->C1_TPOP,nQtdEmSC2)
				EndIf	
			Else 
				GravaB2Pre("-",nQtdEmSC,(cAliasSC1)->C1_TPOP,nQtdEmSC2)
			EndIf
		EndIf
		
		//-- Se encerrou SC e for compra centralizada, atualiza status da SC origem
		If SC1->(FieldPos("C1_SCORI")) > 0 .And. (cAliasSC1)->(C1_QUANT - C1_QUJE) <= 0 .And. !Empty((cAliasSC1)->C1_SCORI)
			SC1->(dbSetOrder(2))
			If SC1->(dbSeek((cAliasSC1)->(C1_FISCORI+C1_PRODUTO+C1_SCORI+C1_ITSCORI)))
				RecLock("SC1",.F.)
				SC1->C1_RESIDUO := ""
				SC1->(MsUnLock())
			EndIf
			SC1->(RestArea(aAreaSC1))
		EndIf
	EndIf

	If ( !lAcumulados )
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		LancaPCO("SC1","000052","05","MATA121")
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Cancelamento de um pedido de compra para a solicitacao de compra        ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 7
	If !lAcumulados
		RecLock("SC1",.F.)
		If ( Empty((cAliasSC7)->C7_NUMCOT) )
			nQtdEmSc := (cAliasSC7)->C7_QTDSOL
			nQtdEmSC2:= (cAliasSC1)->C1_QTSEGUM*(cAliasSC7)->C7_QTDSOL/(cAliasSC1)->C1_QUANT
		Else
			nQtdEmSc := Min((cAliasSC1)->C1_QUJE,(cAliasSC7)->C7_QTDSOL)
			nQtdEmSC2:= Min((cAliasSC1)->C1_QUJE2,(cAliasSC1)->C1_QTSEGUM*(cAliasSC7)->C7_QTDSOL/(cAliasSC1)->C1_QUANT)
		EndIf
		(cAliasSC1)->C1_QUJE    -= nQtdEmSc
		(cAliasSC1)->C1_QUJE2   -= nQtdEmSc2
		If (cAliasSC1)->C1_QUJE == 0
			If !lRestCot
				(cAliasSC1)->C1_COTACAO :=	If( (cAliasSC7)->C7_TIPO == 3 , "IMPORT" ,"" )
			EndIf
		Endif
		(cAliasSC1)->C1_PEDIDO  := ""
		(cAliasSC1)->C1_ITEMPED := ""
		(cAliasSC1)->C1_FORNECE := ""
		(cAliasSC1)->C1_LOJA    := "" 	

		//Caio.Santos - 11/01/13 - Req.72
		If lPrjCni
			If !Empty((cAliasSC7)->C7_NUMCOT) //Proveniente de cotação
				RSTSCLOG("PED",4,/*cUser*/,(cAliasSC7)->(C7_NUM+C7_ITEM))
			EndIf
		EndIf
		
		If ( !Empty((cAliasSC7)->C7_NUMCOT) )
			RecLock("SC7",.F.)
			(cAliasSC7)->C7_QTDSOL -= nQtdEmSC
		EndIf	
		
		//-- Se reabriu SC e for compra centralizada, atualiza status da SC origem
		If SC1->(FieldPos("C1_SCORI")) > 0 .And. (cAliasSC1)->(C1_QUANT - C1_QUJE) > 0 .And. !Empty((cAliasSC1)->C1_SCORI)
			SC1->(dbSetOrder(2))
			If SC1->(dbSeek((cAliasSC1)->(C1_FISCORI+C1_PRODUTO+C1_SCORI+C1_ITSCORI)))
				RecLock("SC1",.F.)
				SC1->C1_RESIDUO := "S"
				SC1->(MsUnLock())
			EndIf
			SC1->(RestArea(aAreaSC1))
		EndIf
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza as tabelas auxiliares                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SB2")
	dbSetOrder(1)
	If ( !MsSeek(cEntrega+(cAliasSC1)->C1_PRODUTO+(cAliasSC1)->C1_LOCAL) )
		CriaSB2((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_LOCAL,cEntrega)
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica se deve atualizar o Campo B2_SALPEDI            ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ 
	If (cAliasSC7)->(FieldPos("C7_ESTOQUE")) > 0  .And. lSb1TES
		If (cAliasSC7)->C7_ESTOQUE=="S" .Or. Empty((cAliasSC7)->C7_ESTOQUE)     
			GravaB2Pre("+",nQtdEmSc,(cAliasSC1)->C1_TPOP,nQtdEmSc2)
		EndIf
	Else
		GravaB2Pre("+",nQtdEmSc,(cAliasSC1)->C1_TPOP,nQtdEmSc2)
	EndIf						
	
	If ( !lAcumulados )
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		LancaPCO("SC1","000052","06","MATA121")
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Aprovaçao/Rejeicao de uma solicitacao de compra                         ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 8
	If ( !lAcumulados ) .And. Alltrim(SC1->C1_APROV) == "L"
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		LancaPCO("SC1","000051","02","MATA110")
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Envia a Solicitacao de Compra para o PORTAL    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lIntegDef .And. SuperGetMV("MV_MKPLACE",.F.,.F.)
			SB5->(DbSetOrder(1))
			If SB5->(DbSeek( xFilial("SB5") + (cAliasSC1)->C1_PRODUTO ) )
				If SB5->(FieldPos("B5_ENVMKT")) > 0
					If SB5->B5_ENVMKT == "1"
						Inclui:=.T.             
						SetRotInteg('MATA110' )
						FwIntegDef( 'MATA110' )
					EndIf
				EndIf
			EndIf
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Verifica se deve atualizar o Campo B2_SALPEDI            ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lSCSldBl .And. cAprovBkp $ "B*R"
			dbSelectArea("SB2")
			dbSetOrder(1)
			If !msSeek(cEntrega+(cAliasSC1)->C1_PRODUTO+(cAliasSC1)->C1_LOCAL) 
				CriaSB2((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_LOCAL,cEntrega)
			EndIf
			If (cAliasSC1)->(FieldPos("C1_ESTOQUE")) > 0 .And. lSb1TES
				If (cAliasSC1)->C1_ESTOQUE=="S" .Or.  Empty((cAliasSC1)->C1_ESTOQUE)
					GravaB2Pre("+",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
				EndIf
			Else 
				GravaB2Pre("+",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
			EndIf
		EndIf

	Elseif ( !lAcumulados ) .and. Alltrim(SC1->C1_APROV) == "R"
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		LancaPCO("SC1","000051","02","MATA110",.T.)
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Atualiza as tabelas auxiliares                                          ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ		
		dbSelectArea("SB2")
		dbSetOrder(1)
		If ( !MsSeek(cEntrega+(cAliasSC1)->C1_PRODUTO+(cAliasSC1)->C1_LOCAL) )
			CriaSB2((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_LOCAL,cEntrega)
		EndIf
	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Verifica se deve atualizar o Campo B2_SALPEDI            ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ 
		If lSCSldBl .And. cAprovBkp $ "L* "
			If (cAliasSC1)->(FieldPos("C1_ESTOQUE")) > 0 .And. lSb1TES
			   	If (cAliasSC1)->C1_ESTOQUE=="S" .Or.  Empty((cAliasSC1)->C1_ESTOQUE)  
					GravaB2Pre("-",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
				EndIF
			Else 
				GravaB2Pre("-",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
			EndIf
		EndIf
	EndIf	
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Cancelamento de uma solicitacao de compra                               ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 9

	If ! lAcumulados
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		LancaPCO("SC1","000051","02","MATA110",.T.)
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza as tabelas auxiliares                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ		
	dbSelectArea("SB2")
	dbSetOrder(1)
	If ( !MsSeek(cEntrega+(cAliasSC1)->C1_PRODUTO+(cAliasSC1)->C1_LOCAL) )
		CriaSB2((cAliasSC1)->C1_PRODUTO,(cAliasSC1)->C1_LOCAL,cEntrega)
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica se deve atualizar o Campo B2_SALPEDI            ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ 
	If lSCSldBl .And. cAprovBkp $ "L* "
		If (cAliasSC1)->(FieldPos("C1_ESTOQUE")) > 0 .And. lSb1TES
		   	If (cAliasSC1)->C1_ESTOQUE=="S" .Or.  Empty((cAliasSC1)->C1_ESTOQUE)  
				GravaB2Pre("-",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
			EndIF
		Else 
			GravaB2Pre("-",(cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE,(cAliasSC1)->C1_TPOP,(cAliasSC1)->C1_QTSEGUM-(cAliasSC1)->C1_QUJE2)
		EndIf
	EndIf

EndCase
RestArea(aAreaSC8)
RestArea(aArea)
Return(.T.)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaCanDelSC?Autor ?Eduardo Riera         ?Data ?8.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Verifica se um item da solicitacao de compra pode ser exclui-³±?
±±?         ³do                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := MaCanDelSC(ExpC1,ExpN1,ExpL2,ExpC2)				   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela da solicitacao de compra              ³±?
±±?         ³ExpN1: Codigo do evento                                      ³±?
±±?         ?      [1] Exclusao manual de solicitacao de compra          ³±?
±±?         ?      [2] Exclusao de solicitacao de compra prevista        ³±?
±±?         ³ExpL2: Indica se o help deve ser disparado                   ³±?
±±?         ³ExpC2: Codigo do help que foi gerado se o mesmo nao foi dispa³±?
±±?         ?      rado                                                  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: .T. - Se a solicitacao pode ser excluida              ³±?
±±?         ?      .F. - Se a solicitacao NAO pode ser excluida          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar se a solicitacao de  ³±?
±±?         ³compra pode ser excluida sem maiores problemas para a integri³±?
±±?         ³dade do sistema                                              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaCanDelSC(cAliasSC1,nEvento,lHelp,cHelp)
Local aAreaSC1 := SC1->(GetArea())
Local lRetorno := .T.
Local lR5      := Val(GetVersao(.F.)) == 11 .And. GetRpoRelease() >= "R5" .Or. Val(GetVersao(.F.))  > 11
Local lVldLoja := AllTrim(Str(SuperGetMv("MV_LJGERSC",,1))) $ "2|3"
Local cCodUser := RetCodUsr()

DEFAULT lHelp  := .T.
DEFAULT cHelp  := ""
DEFAULT nEvento:= 1

Do Case
Case SubStr((cAliasSC1)->C1_TX,1,1)=="R" .And. SubStr((cAliasSC1)->C1_TX,2,1)<>" "
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"PORTRANS")
	Else
		cHelp := "PORTRANS"
	EndIf
Case (SC1->(FieldPos("C1_COMPRAC")) == 0 .Or. (cAliasSC1)->C1_COMPRAC # '1') .And. ((cAliasSC1)->C1_QUJE >= (cAliasSC1)->C1_QUANT .Or. (cAliasSC1)->C1_QUJE > 0)
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A110ALT")
	Else
		cHelp := "A110ALT"
	EndIf
Case (!Empty((cAliasSC1)->C1_COTACAO) .And. !SubStr((cAliasSC1)->C1_COTACAO,1,6)$"IMPORT#XXXXXX") .And. !IsInCallStack("EICSI400") //LGS-25/09/2015
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A11006")
	Else
		cHelp := "A11006"
	EndIf
Case nEvento <> 2 .And. ((cAliasSC1)->C1_TPOP == "P" .And. !Empty((cAliasSC1)->C1_OP))
	lRetorno :=.F.
	If ( lHelp )
		Help("  ",1,"NOPPREVIST")
	Else
		cHelp := "NOPPREVIST"
	EndIf
Case (cAliasSC1)->C1_FLAGGCT == "1"
	lRetorno := .F.
	If ( lHelp )
		Aviso("SIGAGCT",STR0105,{"Ok"}) //-- Esta solicitação est?sendo atendida por contrato e não poder?ser excluída.
	Else
		cHelp := "SIGAGCT"
	EndIf
Case SC1->(FieldPos("C1_TIPO")) > 0 .And. (cAliasSC1)->C1_TIPO == 2 .And. !IsInCallStack("MATA113")
	lRetorno := .F.
	If ( lHelp )
		Help(" ",1,"A113TIPO")
	Else
		cHelp := "A113TIPO"
	EndIf
Case lR5 .And. lVldLoja .And. SC1->(FieldPos("C1_ORCAM")) > 0 .And. !Empty((cAliasSC1)->C1_ORCAM)
	lRetorno := .F.
	If ( lHelp )
		Aviso("SIGALOJA",STR0106,{"Ok"}) //-- Solicitação de compra gerada pelo módulo SIGALOJA não pode ser alterada, excluida ou cancelada por esta rotina.
	Else
		cHelp := "SIGALOJA"
	EndIf
Case !Empty((cAliasSC1)->C1_NUM_SI) .And. !IsInCallStack("EICSI400") //LGS-25/09/2015
	If ( lHelp )	
		Help(" ",1,"ITEMIMPORT")
	Else
		cHelp := "ITEMIMPORT"
	EndIf
EndCase

If lRetorno .And. SuperGetMv("MV_RESTSOL")=="S"
	SB1->(dbSetOrder(1))
	If SB1->(MsSeek(xFilial("SB1")+(cAliasSC1)->C1_PRODUTO)) .And. SB1->B1_SOLICIT == "S".And.;
			!A110Restr((cAliasSC1)->C1_PRODUTO,UsrRetGrp(,cCodUser),RetCodUsr(),lHelp)
		lRetorno := .F.
	EndIf
EndIf

If lRetorno .And. (cAliasSC1)->(FieldPos("C1_COMPRAC")) > 0 .And. (cAliasSC1)->C1_COMPRAC == '1'
	SC1->(dbSetOrder(11))
	If SC1->(dbSeek((cAliasSC1)->(C1_FILIAL+C1_NUM+C1_ITEM+C1_PRODUTO)))
		lRetorno := MACanDelSC("SC1",nEvento,lHelp,@cHelp)
	EndIf
EndIf

SC1->(RestArea(aAreaSC1))
Return(lRetorno)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaCanAltSC?Autor ?Eduardo Riera         ?Data ?8.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Verifica se um item da solicitacao de compra pode ser altera-³±?
±±?         ³do                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := MaCanAltSC(ExpC1,ExpN1,ExpL2,ExpC2)				   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela da solicitacao de compra              ³±?
±±?         ³ExpN1: Codigo do evento                                      ³±?
±±?         ?      [1] Alteracao manual de solicitacao de compra         ³±?
±±?         ?      [2] Alteracao de solicitacao de compra prevista       ³±?
±±?         ³ExpL2: Indica se o help deve ser disparado                   ³±?
±±?         ³ExpC2: Codigo do help que foi gerado se o mesmo nao foi dispa³±?
±±?         ?      rado                                                  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: .T. - Se a solicitacao pode ser alterada              ³±?
±±?         ?      .F. - Se a solicitacao NAO pode ser alterada          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar se a solicitacao de  ³±?
±±?         ³compra pode ser alterada sem maiores problemas para a integri³±?
±±?         ³dade do sistema                                              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaCanAltSC(cAliasSC1,nEvento,lHelp,cHelp)
Local lR5       := Val(GetVersao(.F.)) == 11 .And. GetRpoRelease() >= "R5" .Or. Val(GetVersao(.F.))  > 11
Local lVldLoja  := AllTrim(Str(SuperGetMv("MV_LJGERSC",,1))) $ "2|3"
Local lAltSolic := IIF(GetNewPar("MV_ALTSOLI","S")=="S",.T.,.F.)
Local cCodUser := RetCodUsr()
Local lRetorno := .T.
DEFAULT lHelp  := .T.
DEFAULT cHelp  := ""
DEFAULT nEvento:= 1

Do Case
Case SubStr((cAliasSC1)->C1_TX,1,1)=="R" .And. SubStr((cAliasSC1)->C1_TX,2,1)<>" "
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"PORTRANS")
	Else
		cHelp := "PORTRANS"
	EndIf
Case (cAliasSC1)->C1_QUJE >= (cAliasSC1)->C1_QUANT
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A110ALT")
	Else
		cHelp := "A110ALT"
	EndIf
Case (cAliasSC1)->C1_QUJE > 0 .And. !lAltSolic // Se .F. nao permite que as SC parcialmente entregue sejam alteradas MV_ALTSOLI = N   
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A110ALT")
	Else
		cHelp := "A110ALT"             
	EndIf
Case (!Empty((cAliasSC1)->C1_COTACAO) .And. !SubStr((cAliasSC1)->C1_COTACAO,1,6)$"IMPORT#XXXXXX") .And. !IsInCallStack("EICSI400") //LGS-25/09/2015
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A11006")
	Else
		cHelp := "A11006"
	EndIf
Case nEvento <> 2 .And. ((cAliasSC1)->C1_TPOP == "P" .And. !Empty((cAliasSC1)->C1_OP))
	lRetorno :=.F.
	If ( lHelp )
		Help("  ",1,"NOPPREVIST")
	Else
		cHelp := "NOPPREVIST"
	EndIf
Case (cAliasSC1)->C1_FLAGGCT == "1"
	lRetorno := .F.
	If ( lHelp )
		Aviso("SIGAGCT",STR0105,{"Ok"}) //-- Esta solicitação est?sendo atendida por contrato e não poder?ser excluída.
	Else
		cHelp := "SIGAGCT"
	EndIf
Case SC1->(FieldPos("C1_TIPO")) > 0 .And. (cAliasSC1)->C1_TIPO == 2 .And. !IsInCallStack("MATA113") 
	lRetorno := .F.
	If ( lHelp )
		Help(" ",1,"A113TIPO")
	Else
		cHelp := "A113TIPO"
	EndIf
Case lR5 .And. lVldLoja .And. SC1->(FieldPos("C1_ORCAM")) > 0 .And. !Empty((cAliasSC1)->C1_ORCAM)
	lRetorno := .F.
	If ( lHelp )
		Aviso("SIGALOJA",STR0106,{"Ok"}) //-- Solicitação de compra gerada pelo módulo SIGALOJA não pode ser alterada, excluida ou cancelada por esta rotina.
	Else
		cHelp := "SIGALOJA"
	EndIf
Case SC1->(FieldPos("C1_SCORI")) > 0 .And. !Empty((cAliasSC1)->C1_SCORI)
	lRetorno := .F.
	If ( lHelp )
		Aviso("SIGACOM",STR0115,{"OK"}) //-- Esta solicitação não poder?ser alterada pois atende a uma solicitação de outra filial.
	Else
		cHelp := "COMCEN"
	EndIf
Case !Empty((cAliasSC1)->C1_NUM_SI) .And. !IsInCallStack("EICSI400") //LGS-25/09/2015
	If ( lHelp )	
		Help(" ",1,"ITEMIMPORT") 
	Else
		cHelp := "ITEMIMPORT"
	EndIf
EndCase

If lRetorno .And. SuperGetMv("MV_RESTSOL")=="S"
	dbSelectArea("SB1")
	dbSetOrder(1)
	If ( MsSeek(xFilial("SB1")+SC1->C1_PRODUTO).And.SB1->B1_SOLICIT =="S".And.;
			!A110Restr(SC1->C1_PRODUTO,UsrRetGrp(,cCodUser),RetCodUsr(),lHelp))
		lRetorno := .F.
		cHelp := "A110RESTR"
	EndIf
EndIf

If lRetorno .And. Existblock("MT110ALT")
	lRetorno := ExecBlock("MT110ALT",.F.,.F.,{cAliasSC1,nEvento})
	If ValType(lRetorno) <> "L"
		lRetorno := .T.
	Endif	
    If lRetorno == .F.
    	cHelp := "A110RESTR "             
    EndIf    
EndIf

Return(lRetorno)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaAvalCOT ?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Rotina de avaliacao dos eventos do processo de cotacao       ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaAvalCOT(ExpC1,ExpN1,ExpA1,ExpA2,ExpA3,ExpL1,ExpL2,ExpB1)   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1:*Alias da tabela de cotacao                            ³±?
±±?         ³ExpN1:*Codigo do Evento                                      ³±?
±±?         ?      [01] Geracao de uma cotacao                           ³±?
±±?         ?      [02] Atualizacao dos precos de uma cotacao            ³±?
±±?         ?      [03] Cancelamento de uma cotacao                      ³±?
±±?         ?      [04] Analise de uma cotacao                           ³±?
±±?         ³ExpA1: Array com as cotacoes(SC8)                            ³±?
±±?         ?      [x] Array com os produtos/identificadores da cotacao  ³±?
±±?         ?   [x][y] Array com os dados de uma cotacao                 ³±?
±±?         ?[x][y][1] Nome do campo                                     ³±?
±±?         ?      [2] Conteudo do campotaacao                           ³±?
±±?         ³ExpA2: Array no formato aHeader das cotacoes vencedoras      ³±?
±±?         ³ExpA3: Array com os produtos/identificadores das cotacoes    ³±?
±±?         ?      vencedoras(SCE)                                       ³±?
±±?         ?      [x] Array no formato acols das cotacoes vencedoras    ³±?
±±?         ³ExpL1: .T. - Mantem a data da necessidade da cotacao(D)      ³±?
±±?         ?      .F. - Ajusta a data da necessidade para a Entrega     ³±?
±±?         ³ExpL2: .T. - Indica que eh o ultimo item da cotacao a ser Av.³±?
±±?         ³ExpB1: Codeblock de contabilizacao  On-Line.                 ³±?
±±?         ³ExpC2: Codigo do comprador responsavel vindo do ACC		   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ?T. 	                                                       ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar os eventos vinculados³±?
±±?         ³a uma cotacao, como:                                         ³±?
±±?         ³A) Atualizacao das tabelas complementares.                   ³±?
±±?         ³B) Atualizacao das informacoes complementares a cotacao      ³±?
±±?         ³C) Executar o B2B                                            ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaAvalCOT(cAliasSC8,nEvento,aSC8,aHeadSCE,aCOLSSCE,lNecessid,lLast,bCtbOnLine,cCompACC)

Local aArea 	:= GetArea()
Local aAreaSC8  := SC8->(GetArea())
Local aRegSC1   := {}
Local aVencedor := {}
Local aPaginas  := {}
Local aRefImp   := {}
Local aSCMail	:= {}
Local aNroItGrd := {}
Local aPedidos	:= {}
Local aCTBEnt	:= If(FindFunction("CTBEntArr"),CTBEntArr(),{})
Local cNumCot   := ""
Local cProduto  := ""
Local cIdent    := ""
Local cQuery    := ""
Local cCursor   := ""
Local cNumPed   := ""
Local cItemPC   := ""
Local cUsers 	:= ""
Local cCndCot	:= ""
Local cNumContr := ""
Local cItemContr:= ""
Local cFLuxo    := Criavar("C7_FLUXO")
Local lQuery    := .F.
Local lCotSC  	:= SuperGetMV("MV_COTSC")=="S"
Local lTrava	:= .T.
Local nA		:= 0
Local nB		:= 0
Local nX        := 0
Local nY        := 0
Local nZ		:= 0
Local nP        := 0
Local nPQtdSCE  := 0
Local nPMotSCE  := 0
Local nPRegSC8  := 0
Local nPForSC8  := 0
Local nPLojSC8  := 0
Local nPCndSC8  := 0
Local nPPrdSC8  := 0
Local nPFilSC8  := 0
Local nScan     := 0
Local nSaveSX8  := GetSX8Len()
Local nSaveSX82 := 0
Local cGrupo	:= SuperGetMv("MV_PCAPROV")
Local lLiberou	:= .F.
Local lPEGerPC  := ExistBlock("MT160GRPC")
Local aRatFin	:= {}
Local lPrjCni   := FindFunction("ValidaCNI") .And. ValidaCNI()
Local cGrComPad := Space(Len(SC7->C7_GRUPCOM))
Local cCotFiAP  := "C"
Local aBkpFilAdm:= Array(5)
Local aRetPE		:= {}
Local lCotSI	:= ExistBlock("MT130SI")
Local aRetPO	:=	{}

DEFAULT aSC8      := {}
DEFAULT aHeadSCE  := {}
DEFAULT aCOLSSCE  := {}
DEFAULT lNecessid := .T.
DEFAULT lLast     := .F.
DEFAULT bCtbOnLine:= {|| .T.}
DEFAULT cCompACC  := ""

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Verifica o grupo de aprovacao do Comprador.                  ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SY1")
dbSetOrder(3)
If dbSeek(xFilial("SY1")+If(Empty(cCompACC),RetCodUsr(),cCompACC))
	cGrupo	:= If(!Empty(Y1_GRAPROV),SY1->Y1_GRAPROV,cGrupo)
EndIf
If dbSeek(xFilial("SY1")+RetCodUsr())
	cGrComPad	:= If(!Empty(Y1_GRUPCOM),SY1->Y1_GRUPCOM,Space(Len(SC7->C7_GRUPCOM)))
EndIf

Do Case
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de uma cotacao                                              ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 1
	cNumCot   := (cAliasSC8)->C8_NUM
	cProduto  := (cAliasSC8)->C8_PRODUTO
	cIdent    := (cAliasSC8)->C8_IDENT
	If ( lLast )
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³M-Message - Verifica o Evento 003 - Solicitacao com cotacao pendente.   ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If MExistMail("003")
			#IFDEF TOP
				If ( TcSrvType()<>"AS/400" )
					cCursor := "MAAVALCOT"
					cQuery := "SELECT C1_NUM,C1_ITEM,C1_DESCRI,C1_USER,C1_SOLICIT,C1_OP "
					cQuery += "FROM "+RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_COTACAO='"+cNumCot+"' AND "
					cQuery += "SC1.C1_PRODUTO='"+cProduto+"' AND "
					cQuery += "SC1.C1_IDENT='"+cIdent+"' AND "
					cQuery += "SC1.D_E_L_E_T_<>'*'"
					cQuery := ChangeQuery(cQuery)
					SC1->(dbCommit())					
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cCursor,.T.,.T.)
					While ( !Eof() )
						aadd(aSCMail,C1_NUM+"/"+C1_ITEM+" "+C1_SOLICIT+" "+C1_DESCRI)
						cUsers += C1_USER+"#"							
						dbSelectArea(cCursor)
						dbSkip()					
					EndDo
					dbSelectArea(cCurSor)
					dbCloseArea()
					dbSelectArea("SC1")					
				Else
			#ENDIF
				dbSelectArea("SC1")
				dbSetOrder(5)
				MsSeek(xFilial("SC1")+cNumCot+cProduto+cIdent)
				While ( !Eof() .And. xFilial("SC1")	== SC1->C1_FILIAL .And.;
						cNumCot		== SC1->C1_COTACAO.And.;
						cProduto == SC1->C1_PRODUTO.And.;
						cIdent == SC1->C1_IDENT )
					aadd(aSCMail,C1_NUM+"/"+C1_ITEM+" "+C1_SOLICIT+" "+C1_DESCRI)
					cUsers += C1_USER+"#"
					dbSelectArea("SC1")
					dbSkip()
				EndDo
				#IFDEF TOP
				EndIf			
				#ENDIF
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Envia e-mail do Evento 003                                              ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			MEnviaMail("003",{cNumCot,"","","L",cUsers})
		EndIf
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Neogrid - Verifica a existencia da Administracao colaborativa de Pedidos?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ( NeoEnable("001") )
			NeoEnvCot(cNumCot)
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualizacao dos precos de uma cotacao                                   ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 2
	cNumCot   := (cAliasSC8)->C8_NUM
	cCndCot   := (cAliasSC8)->C8_COND
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifica a existencia do Evento 004 - Cotacao com analise pendente.     ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lLast .And. !Empty(cCndCot)
		MEnviaMail("004",{cNumCot})
	EndIf		
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Cancelamento da cotacao                                                 ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 3
	cNumCot   := (cAliasSC8)->C8_NUM
	cProduto  := (cAliasSC8)->C8_PRODUTO
	cIdent    := (cAliasSC8)->C8_IDENT
	
	If lPrjCni
		RSTSCLOG("ATL",2,/*cUser*/) //Se ainda pertence a cotação, apenas exclui log da atualização do fornecedor excluído
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Somente estornar a solicitacao de compra quando esta nao possuir cotacao?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea(cAliasSC8)
	dbSetOrder(4)		
	If ( !MsSeek(xFilial("SC8")+cNumCot+cIdent+cProduto) )
		#IFDEF TOP
			If ( TcSrvType()<>"AS/400" )
				cCursor := "MAAVALCOT"
				cQuery := "SELECT R_E_C_N_O_ SC1RECNO "
				cQuery += "FROM "+RetSqlName("SC1")+" SC1 "
				cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
				cQuery += "SC1.C1_COTACAO='"+cNumCot+"' AND "
				cQuery += "SC1.C1_PRODUTO='"+cProduto+"' AND "
				cQuery += "SC1.C1_IDENT='"+cIdent+"' AND "
				cQuery += "SC1.D_E_L_E_T_<>'*'"
				cQuery := ChangeQuery(cQuery)
				SC1->(dbCommit())					
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cCursor,.T.,.T.)
				While ( !Eof() )
					aadd(aRegSC1,SC1RECNO)
					dbSelectArea(cCursor)
					dbSkip()					
				EndDo
				dbSelectArea(cCurSor)
				dbCloseArea()
				dbSelectArea("SC1")					
			Else
		#ENDIF
			dbSelectArea("SC1")
			dbSetOrder(5)
			MsSeek(xFilial("SC1")+cNumCot+cProduto+cIdent)
			While ( !Eof() .And. xFilial("SC1")	== SC1->C1_FILIAL .And.;
					cNumCot		== SC1->C1_COTACAO.And.;
					cProduto == SC1->C1_PRODUTO.And.;
					cIdent == SC1->C1_IDENT )
				aadd(aRegSC1,RecNo())
				dbSelectArea("SC1")
				dbSkip()
			EndDo
			#IFDEF TOP
			EndIf			
			#ENDIF			
		For nX := 1 To Len(aRegSC1)
			dbSelectArea("SC1")
			MsGoto(aRegSC1[nX])
			RecLock("SC1",.F.)
			If ( lCotSC .And. SC1->C1_QUJE < SC1->C1_QUANT )
				SC1->C1_COTACAO := ""
			Else
				SC1->C1_COTACAO := Repl("X",Len(SC1->C1_COTACAO))
			EndIf
			
			//Caio.Santos - 11/01/13 - Req.72
			If lPrjCni
				RSTSCLOG("COT",2,/*cUser*/)
			EndIf
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Ponto de Entrada para tratamento dos registros da solicitacao compras.  ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ExistBlock("MT150EXC")
				ExecBlock("MT150EXC",.f.,.f.)
			Endif
		Next nX
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Analise da cotacao                                                      ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 4
	nPQtdSCE  := aScan(aHeadSCE,{|x| Trim(x[2])=="CE_QUANT"})
	nPMotSCE  := aScan(aHeadSCE,{|x| Trim(x[2])=="CE_MOTIVO"})
	nPEntSCE  := aScan(aHeadSCE,{|x| Trim(x[2])=="CE_ENTREGA"})
	nPRegSC8  := aScan(aSC8[1][1],{|x| Trim(x[1])=="SC8RECNO"})
	nPForSC8  := aScan(aSC8[1][1],{|x| Trim(x[1])=="C8_FORNECE"})
	nPLojSC8  := aScan(aSC8[1][1],{|x| Trim(x[1])=="C8_LOJA"})
	nPCndSC8  := aScan(aSC8[1][1],{|x| Trim(x[1])=="C8_COND"})
	nPPrdSC8  := aScan(aSC8[1][1],{|x| Trim(x[1])=="C8_PRODUTO"})
	nPFilSC8  := aScan(aSC8[1][1],{|x| Trim(x[1])=="C8_FILENT"})

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifico quais fornecedores possuem cotacoes vencedoras                 ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	For nX := 1 To Len(aColsSCE)
		For nY := 1 To Len(aColsSCE[nX])
			dbSelectArea("SC8")
			MsGoto(aSC8[nX][nY][nPRegSC8][2])
			If ( aColsSCE[nX][nY][nPQtdSCE] > 0 )
				If ( RecLock("SC8") )
					nZ := aScan(aVencedor,{|x| x[1]==aSC8[nX][nY][nPForSC8][2].And.;
						x[2]==aSC8[nX][nY][nPLojSC8][2].And.;
						x[3]==aSC8[nX][nY][nPCndSC8][2].And.;
						x[4]==aSC8[nX][nY][nPFilSC8][2]})
					If ( nZ == 0 )
						aadd(aVencedor,{aSC8[nX][nY][nPForSC8][2],;
							aSC8[nX][nY][nPLojSC8][2],;
							aSC8[nX][nY][nPCndSC8][2],;
							aSC8[nX][nY][nPFilSC8][2]})
					EndIf
				EndIf
			EndIf
		Next nY
	Next nX
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Verifica a quais impostos devem ser gravados.                           ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aRefImp := MaFisRelImp('MT100',{"SC7"})
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Efetua a gravacao dos pedidos para cada Vencedor                        ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	For nZ := 1 To Len(aVencedor)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Travo todos os registros antes de iniciar a gravacao                    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		lTrava := .T.
		For nX := 1 To Len(aColsSCE)
			For nY := 1 To Len(aColsSCE[nX])
				If ( aVencedor[nZ][1]==aSC8[nX][nY][nPForSC8][2].And.;
						aVencedor[nZ][2]==aSC8[nX][nY][nPLojSC8][2].And.;
						aVencedor[nZ][3]==aSC8[nX][nY][nPCndSC8][2].And.;
						aVencedor[nZ][4]==aSC8[nX][nY][nPFilSC8][2] )
					
					dbSelectArea("SC8")
					MsGoto(aSC8[nX][nY][nPRegSC8][2])
					
					if lPrjCNI
						if SC8->(!Eof())
							if (!Empty(SC8->C8_XGCT))                                         
								lTrava := .F.
								Exit
							EndIf
						EndIf
					EndIf
					
					If (!RecLock("SC8") )
						lTrava := .F.
						Exit
					EndIf
				EndIf
			Next nY
		Next nX
		
		aBkpFilAdm[1] := cFilAnt
				
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Inicio o processo de gravacao do Pedido de Compra                       ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ( lTrava )
			cCotFiAP  := "C"
			cNumPed   := CriaVar("C7_NUM",.T.)
			While ( GetSX8Len() > nSaveSX8 )
				ConfirmSx8()
			EndDo
			cItemPC   := StrZero(1,Len(SC7->C7_ITEM))
			If ( Empty(cNumPed) )
				cNumPed := GetNumSC7(.F.)
			EndIf
			
			aBkpFilAdm[2] := cNumPed
			aBkpFilAdm[4] := cGrupo
			aBkpFilAdm[5] := cGrComPad
			
			If lPrjCni
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Esvazia vetor rateio financeiro                                         ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				aRatFin := {}
			EndIf

			For nX := 1 To Len(aColsSCE)
				For nY := 1 To Len(aColsSCE[nX])
					If ( aVencedor[nZ][1]==aSC8[nX][nY][nPForSC8][2].And.;
							aVencedor[nZ][2]==aSC8[nX][nY][nPLojSC8][2].And.;
							aVencedor[nZ][3]==aSC8[nX][nY][nPCndSC8][2].And.;
							aVencedor[nZ][4]==aSC8[nX][nY][nPFilSC8][2].And.;
							aColsSCE[nX][nY][nPQtdSCE]<>0)
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Guarda as paginas que houveram vencedores                               ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If ( aScan(aPaginas,nX)==0 )
							aadd(aPaginas,nX)
						EndIf
						dbSelectArea("SB1")
						dbSetOrder(1)
						MsSeek(xFilial("SB1")+aSC8[nX][nY][nPPrdSC8][2])
						dbSelectArea("SC8")
						MsGoto(aSC8[nX][nY][nPRegSC8][2])
						dbSelectArea("SC1")
						dbSetOrder(5)
						MsSeek(xFilial("SC1",aBkpFilAdm[1])+SC8->C8_NUM+SC8->C8_PRODUTO+SC8->C8_IDENT)
						dbSelectArea("SA2")
						dbSetOrder(1)
						MsSeek(xFilial("SA2")+aVencedor[nZ][1]+aVencedor[nZ][2])
						
						If lPrjCni
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³Controle do Rateio Financeiro                                           ?
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If SC8->C8_RATFIN == "1"
								cChaveRat := "SC8"+SC8->C8_FILIAL+SC8->C8_NUM
								F641TrfRat(cChaveRat,@aRatFin,NoRound(aColsSCE[nX][nY][nPQtdSCE]*SC8->C8_PRECO))
							EndIf							
						EndIf     
						
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Incluo o item do Pedido de Compra                                       ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						RecLock("SC7",.T.)
						dbSelectArea("SC7")
						For nA := 1 to SC7->(FCount())
							If SC7->(FieldName(nA)) <> "C7_NUM"
								nB := SC8->(FieldPos("C8"+SubStr(SC7->(FieldName(nA)),3)))
								If ( nB <> 0 )
									FieldPut(nA,SC8->(FieldGet(nB)))
								EndIf
							EndIf
						Next nA

						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Controla a numeracao do Item no PC quando for Item de Grade vindo do SC8?
						//³Observar que o Numero do Item no PC C7_ITEM sera trocado toda vez que na?
						//³mesma grade o C8_PRECO for diferente, ou seja, somente sera aglutinado  ?
						//³na mesma grade (mesmo C7_ITEM) os itens do Grid que possuirem o mesmo   ?
						//³preco para preservar os valores,calculos de impostos e afins.           ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If SC8->C8_GRADE == "S"

							cProdRef := SC8->C8_PRODUTO
							lReferencia := MatGrdPrrf(@cProdRef, .T.)
							
							If (nScan := aScan(aNroItGrd, {|x| x[1] + x[2] + x[3] + x[4] + x[5] + x[6] + x[7] + x[8] == ;
								SC8->C8_ITEM + cProdRef + SC8->C8_NUMPRO + SC8->C8_FORNECE + SC8->C8_LOJA + SC8->C8_NUMSC + SC8->C8_ITEMSC + TransForm(SC8->C8_PRECO,PesqPict("SC8","C8_PRECO")) })) == 0

								Aadd(aNroItGrd, { SC8->C8_ITEM , cProdRef , SC8->C8_NUMPRO , SC8->C8_FORNECE , SC8->C8_LOJA ,SC8->C8_NUMSC ,SC8->C8_ITEMSC ,TransForm(SC8->C8_PRECO,PesqPict("SC8","C8_PRECO")) , cItemPc } )
								nScan := Len(aNroItGrd)
								cItemPc	:= Soma1(cItemPc)

							Endif
						Else
							nScan := Nil
						EndIf
						
						//-- Verifica filial que ira administrar o pedido de compra
						If (cCotFiAP := SuperGetMV("MV_COTFIAP",.F.,"C")) == "E"
							//-- Valida se o produto existe na filial de entrega
							SB1->(dbSetOrder(1))
							cCotFiAP := If(cCotFiAP == "E" .And. SB1->(dbSeek(xFilial("SB1",SC8->C8_FILENT)+SC8->C8_PRODUTO)),"E","C")
							
							//-- Valida se o fornecedor existe na filial de entrega
							SA2->(dbSetOrder(1))
							cCotFiAP := If(cCotFiAP == "E" .And. SA2->(dbSeek(xFilial("SA2",SC8->C8_FILENT)+aVencedor[nZ,1]+aVencedor[nZ,2])),"E","C")
							
							//-- Valida se a condicao de pagamento existe na filial de entrega
							SE4->(dbSetOrder(1))
							cCotFiAP := If(cCotFiAP == "E" .And. SE4->(dbSeek(xFilial("SE4",SC8->C8_FILENT)+aVencedor[nZ,3])),"E","C")
						EndIf
							
						//-- Se administradora do PC for a filial de entrega
						If cCotFiAP == "E" .And. PadR(cFilAnt,Len(AllTrim(SC8->C8_FILENT))) # AllTrim(SC8->C8_FILENT)
							aBkpFilAdm[3] := cItemPC
						
							//-- Troca filial
							SM0->(dbSetOrder(1))
							SM0->(dbSeek(cEmpAnt+AllTrim(SC8->C8_FILENT)))
							cFilAnt := FWCodFil()
							
							//-- Troca numero do pedido
							nSaveSX82 := GetSX8Len()
							cNumPed := CriaVar("C7_NUM",.T.)
							While (GetSX8Len() > nSaveSX82)
								ConfirmSx8()
							End
							cItemPC := StrZero(1,Len(SC7->C7_ITEM))
							If (Empty(cNumPed))
								cNumPed := GetNumSC7(.F.)
							EndIf
							
							//-- Troca grupo de compra e aprovacao
							SY1->(dbSetOrder(3))
							If SY1->(dbSeek(xFilial("SY1")+If(Empty(cCompACC),RetCodUsr(),cCompACC)))
								cGrupo := If(!Empty(SY1->Y1_GRAPROV),SY1->Y1_GRAPROV,SuperGetMv("MV_PCAPROV",.F.,""))
								cGrComPad := If(!Empty(SY1->Y1_GRUPCOM),SY1->Y1_GRUPCOM,CriaVar("C7_GRUPCOM",.F.))
							EndIf
						EndIf

						SC7->C7_FILIAL := xFilial("SC7")
						SC7->C7_TIPO   := 1
						SC7->C7_NUM    := cNumPed
						SC7->C7_ITEM   := If(nScan == Nil, cItemPc , aNroItGrd[nScan, 9 ])
						SC7->C7_GRADE  := IIF(Empty(SC8->C8_GRADE),"N",SC8->C8_GRADE)
						SC7->C7_ITEMGRD:= SC8->C8_ITEMGRD
						SC7->C7_FORNECE:= aVencedor[nZ][1]
						SC7->C7_LOJA   := aVencedor[nZ][2]
						SC7->C7_COND   := aVencedor[nZ][3]
						SC7->C7_OP     := SC1->C1_OP
						SC7->C7_LOCAL  := SC1->C1_LOCAL
						SC7->C7_DESCRI := SC1->C1_DESCRI
						SC7->C7_UM     := SC1->C1_UM
						SC7->C7_SEGUM  := SC1->C1_SEGUM
						SC7->C7_QUANT  := aColsSCE[nX][nY][nPQtdSCE]
						SC7->C7_QTDSOL := 0
						SC7->C7_QTSEGUM := IIf(SB1->B1_CONV==0,SC1->C1_QTSEGUM,ConvUm(aSC8[nX][nY][nPPrdSC8][2],aColsSCE[nX][nY][nPQtdSCE],0,2))
						SC7->C7_PRECO   := SC8->C8_PRECO
						SC7->C7_TOTAL   := SC7->C7_QUANT*SC7->C7_PRECO
						SC7->C7_CONTATO := SC8->C8_CONTATO
						SC7->C7_OBS     := SC8->C8_OBS
						SC7->C7_EMISSAO := dDataBase
						SC7->C7_DATPRF  := IIf(lNecessid,aColsSCE[nX][nY][nPentSCE],dDataBase+SC8->C8_PRAZO)
						SC7->C7_CC      := SC1->C1_CC
						SC7->C7_CLVL    := SC1->C1_CLVL
						SC7->C7_CONTA   := SC1->C1_CONTA
						SC7->C7_ITEMCTA := SC1->C1_ITEMCTA
						SC7->C7_ORIGEM  := SC1->C1_ORIGEM
						SC7->C7_DESC1   := SC8->C8_DESC1
						SC7->C7_DESC2   := SC8->C8_DESC2
						SC7->C7_DESC3   := SC8->C8_DESC3
						SC7->C7_REAJUST := SC8->C8_REAJUST
						SC7->C7_IPI     := SC8->C8_ALIIPI    
						If SC7->(FieldPos("C7_FISCORI")) > 0
							SC7->C7_FISCORI := SC8->C8_FILIAL
						EndIf
						SC7->C7_NUMSC   := SC8->C8_NUMSC
						SC7->C7_ITEMSC  := SC8->C8_ITEMSC
						SC7->C7_NUMCOT  := SC8->C8_NUM
						SC7->C7_FILENT  := SC8->C8_FILENT
						SC7->C7_TPFRETE := SC8->C8_TPFRETE
						SC7->C7_VLDESC  := ((SC7->C7_TOTAL*SC8->C8_VLDESC)/SC8->C8_TOTAL)
						SC7->C7_IPIBRUT := "B"
						SC7->C7_VALEMB  := SC8->C8_VALEMB
						SC7->C7_FRETE   := SC8->C8_TOTFRE
						SC7->C7_FLUXO   := cFluxo
						SC7->C7_GRUPCOM := If(Empty(C7_GRUPCOM),cGrComPad,C7_GRUPCOM)
						If cPaisLoc == "BRA"
							SC7->C7_ICMSRET := SC8->C8_VALSOL
						EndIf	
						
						If lCotSI
							aRetPO := ExecBlock("MT130SI",.F.,.F.,{2})//parametro 2 indica que o PE esta sendo executado para gerar uma P.O
							If ValType(aRetPO) <> "A"
								lCotSI := .F.
							EndIf
						EndIf
						// Criado ponto de entrada para cotação de produto importado
						// As alterações a baixo vão fazer com que o PC vire uma P.O
						If lCotSI 
							SC7->C7_TIPO   	:= 3
							SC7->C7_FREPPCC := aRetPO[1] // default = CC
							SC7->C7_DT_IMP	:= aRetPO[2] // Data de importação
							SC7->C7_AGENTE	:= aRetPO[3] //Ag embarcador
							SC7->C7_TIPO_EM	:= aRetPO[4] //via de transporte
							SC7->C7_ORIGIMP	:= aRetPO[5] //Origem
							SC7->C7_DEST	:= aRetPO[6] //Destino
							SC7->C7_COMPRA	:= aRetPO[7] //Comprador
							SC7->C7_INCOTER	:= aRetPO[8] //Incorterm
							SC7->C7_IMPORT	:= aRetPO[9] //Importador
							SC7->C7_CONF_PE	:= aRetPO[10]// Data da confirmação do Pedido //default = data base
							SC7->C7_CONTAIN	:= aRetPO[11] // Desova de Container //default = 1
						EndIf
						
						For nA := 1 To Len(aCTBEnt)
							If SC7->(FieldPos("C7_EC"+aCTBEnt[nA]+"CR")) > 0 .And. SC1->(FieldPos("C1_EC"+aCTBEnt[nA]+"CR")) > 0
								SC7->&("C7_EC"+aCTBEnt[nA]+"CR") := SC1->&("C1_EC"+aCTBEnt[nA]+"CR")
								SC7->&("C7_EC"+aCTBEnt[nA]+"DB") := SC1->&("C1_EC"+aCTBEnt[nA]+"DB")
							EndIf							
						Next nA
						
						If SC7->(FieldPos("C7_RATEIO")) > 0
							SC7->C7_RATEIO  := CriaVar('C7_RATEIO',.T.)			
						EndIf
						
						If SC7->(FieldPos("C7_ACCNUM")) > 0 .And. (SuperGetMv("MV_MKPLACE",.F.,.F.)) .And. !Empty( SC8->C8_ACCNUM )
							SC7->C7_ACCNUM  := aColsSCE[nX][nY][Len(aColsSCE[nX][nY])-1]
							SC7->C7_ACCITEM := aColsSCE[nX][nY][Len(aColsSCE[nX][nY])] 
							SC7->C7_USER    := cCompACC
						EndIf

						If lPrjCni					
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³Controle do Rateio Financeiro                                           ?
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If Len(aRatFin) > 0
								SC7->C7_RATFIN := "1"  // 1 = Sim; 2 = Nao
							EndIf
						EndIf
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³PE para atualizacao de campos especificos do SC7      ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ						
						If lPEGerPC
							ExecBlock("MT160GRPC",.F.,.F.,{aVencedor,aSC8})
						EndIf
						
						MaFisIni(aVencedor[nZ][1],aVencedor[nZ][2],"F","N","R",aRefImp)						
						
						If cItemPC == StrZero(1,Len(SC7->C7_ITEM)) .And. ExistBlock("MT120APV")
							cGrupo := ExecBlock("MT120APV",.F.,.F.,{aVencedor,aSC8})
						EndIf
						SC7->C7_APROV   := cGrupo
						MaFisIniLoad(1)
						For nA := 1 To Len(aRefImp)
							MaFisLoad(aRefImp[nA][3],FieldGet(FieldPos(aRefImp[nA][2])),1)
						Next nA
						MaFisRecal("",1)
						MaFisEndLoad(1)
						MaFisAlt("IT_ALIQIPI",SC7->C7_IPI,1)
						MaFisAlt("IT_ALIQICM",SC7->C7_PICM,1)
						If cPaisLoc == "BRA"
							MaFisAlt("IT_VALSOL", SC7->C7_ICMSRET,1)
						EndIf	
						MaFisWrite(1,"SC7",1)
						MaFisWrite(2,"SC7",1,.F.)  
						
						// alimenta o vl do IPI quando informado apenas o valor
                		If SC8->C8_ALIIPI == 0 .And. SC8->C8_VALIPI <> 0    
							SC7->C7_VALIPI  := SC8->C8_VALIPI  
						EndIf						
						//-- Adiciona pedido gerado no array de controle para chamada
						//-- de funções de atualização
						nP := aScan(aPedidos,{|x| xFilial("SC7",x[1])+x[2] == SC7->(C7_FILIAL+C7_NUM)})
						If  nP == 0
							aAdd(aPedidos,{cFilAnt,SC7->C7_NUM,aRatFin,MaFisRet(1,"IT_TOTAL")})
						Else
							aPedidos[nP,4] += MaFisRet(1,"IT_TOTAL")
						EndIf
						
						MaFisEnd()
						
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Encerro a cotacao vencedora                                             ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						dbSelectArea("SC8")
						MsGoto(aSC8[nX][nY][nPRegSC8][2])
						SC8->C8_NUMPED := cNumPed
						SC8->C8_ITEMPED:= If(nScan == Nil, cItemPc , aNroItGrd[nScan, 9 ])
						SC8->C8_MOTIVO := aColsSCE[nX][nY][nPMotSCE]
						SC8->C8_DATPRF := IIf(lNecessid,aColsSCE[nX][nY][nPentSCE],dDataBase+SC8->C8_PRAZO)
						SC8->C8_PRAZO  := SC8->C8_DATPRF - dDataBase
						
						//Caio.Santos - 11/01/13 - Req.72
						If lPrjCni
							RSTSCLOG("PED",3,/*cUser*/,SC7->(C7_NUM+C7_ITEM))
						EndIf						
						
						RecLock("SCE",.T.)
						SCE->CE_FILIAL := xFilial("SCE",SC8->C8_FILIAL)
						SCE->CE_NUMCOT := SC8->C8_NUM
						SCE->CE_ITEMCOT:= SC8->C8_ITEM
						SCE->CE_NUMPRO := SC8->C8_NUMPRO
						SCE->CE_PRODUTO:= SC8->C8_PRODUTO
						SCE->CE_FORNECE:= SC8->C8_FORNECE
						SCE->CE_LOJA   := SC8->C8_LOJA
						SCE->CE_ITEMGRD:= SC8->C8_ITEMGRD
						For nA := 1 To Len(aHeadSCE)
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//?Nao grava campos virutais e de controle (walkthru)   ?
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If !(IsHeadRec(Trim(aHeadSCE[nA][2])) .OR. IsHeadAlias(Trim(aHeader[nA][2])) .OR. aHeader[nA][10] == "V")
								FieldPut(FieldPos(aHeadSCE[nA][2]),aCOLSSCE[nX][nY][nA])
							EndIf
						Next nA
						SCE->CE_MOTIVO := aColsSCE[nX][nY][nPMotSCE]
						SCE->CE_ENTREGA:= IIf(lNecessid,aColsSCE[nX][nY][nPentSCE],dDataBase+SC8->C8_PRAZO)							
						If SC8->C8_QTDCTR > 0
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//?Gravacao do Contrato de Parceria                     ?
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If Empty(cNumContr)
								cNumContr := CriaVar("C3_NUM",.T.)
								cItemContr:= Strzero(1,Len(SC3->C3_ITEM))
								While ( GetSX8Len() > nSaveSX8 )
									ConfirmSx8()
								EndDo				
							EndIf
							RecLock("SC3",.T.)
							dbSelectArea("SC3")
							SC3->C3_FILIAL  := xFilial("SC3")
							SC3->C3_NUM     := cNumContr
							SC3->C3_FORNECE := aVencedor[nZ][1]
							SC3->C3_LOJA    := aVencedor[nZ][2]
							SC3->C3_GRADE   := SC8->C8_GRADE
							SC3->C3_ITEMGRD := SC8->C8_ITEMGRD
							SC3->C3_ITEM    := cItemContr
							SC3->C3_PRODUTO := SC8->C8_PRODUTO
							SC3->C3_QUANT   := SC8->C8_QTDCTR
							SC3->C3_PRECO   := SC8->C8_PRECO
							SC3->C3_TOTAL   := SC3->C3_PRECO*SC3->C3_QUANT
							SC3->C3_DATPRI  := dDataBase
							SC3->C3_DATPRF  := IIf(lNecessid,aColsSCE[nX][nY][nPentSCE],dDataBase+SC8->C8_PRAZO)
							SC3->C3_LOCAL   := SC1->C1_LOCAL
							SC3->C3_COND    := aVencedor[nZ][3]
							SC3->C3_CONTATO := SC8->C8_CONTATO
							SC3->C3_FILENT  := SC8->C8_FILENT
							SC3->C3_EMISSAO := dDatabase
							SC3->C3_REAJUST := SC8->C8_REAJUST
							SC3->C3_TPFRETE := SC8->C8_TPFRETE
							SC3->C3_FRETE   := SC8->C8_TOTFRE
							SC3->C3_OBS     := SC8->C8_OBS
							If SC3->(FieldPos("C3_AVISTA"))<>0
								SC3->C3_AVISTA := SC8->C8_AVISTA
							EndIf
							If SC3->(FieldPos("C3_TAXAFOR"))<>0
								SC3->C3_TAXAFOR := SC8->C8_TAXAFOR
							EndIf
							MsUnLock()
							SB1->(DBSetOrder(1))
							If SB1->(MsSeek(xFilial("SB1")+SC8->C8_PRODUTO))
								RecLock("SB1",.F.)
								Replace SB1->B1_CONTRAT With "S"
								Replace SB1->B1_PROC    With aVencedor[nZ][1]
								Replace SB1->B1_LOJPROC With aVencedor[nZ][2]
								MsUnLock()
							EndIf
							cItemContr  :=  Soma1(cItemContr,Len(SC3->C3_ITEM))
						EndIf
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//?Atualizo os acumulados do Pedido de Compra           ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ							
						MaAvalPC("SC7",1,nZ==Len(aVencedor),Nil,Nil,Nil,bCtbOnLine,.F.)
						
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
						//³Grava o rateio do centro de custo da solicitacao no pedido de compra ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
						CotGeraSCH(aBkpFilAdm[1])
												
						If nScan == Nil 
  							cItemPc	:= Soma1(cItemPc)
         				EndIf

						If (Existblock("AVALCOT"))
							ExecBlock("AVALCOT",.F.,.F.,{nEvento})
						EndIf
					EndIf
				Next nY
			Next nX
		EndIf
	
		//-- Retorna filial
		If cFilAnt # aBkpFilAdm[1]
			SM0->(dbSetOrder(1))
			SM0->(dbSeek(cEmpAnt+aBkpFilAdm[1]))
			cFilAnt := FWCodFil()
			
			//-- Volta backup de variaveis
			cNumPed   := aBkpFilAdm[2]
			cItemPC   := aBkpFilAdm[3]
			cGrupo    := aBkpFilAdm[4]
			cGrComPad := aBkpFilAdm[5]
		EndIf
	Next nZ

	For nZ := 1 To Len(aPedidos)
		SM0->(dbSetOrder(1))
		SM0->(dbSeek(cEmpAnt+aPedidos[nZ,1]))
		cFilAnt := aPedidos[nZ,1]
		
		SC7->(dbSetOrder(1))
		SC7->(dbSeek(xFilial("SC7")+aPedidos[nZ,2]))
		cNumPed := SC7->C7_NUM		

		//-- Grava rateio financeiro
		If lPrjCni .And. Len(aPedidos[nZ,3]) > 0
			cChaveRat := "SC7"+SC7->C7_FILIAL+SC7->C7_NUM
			F641GrvRat(cChaveRat,aPedidos[nZ,3])
		EndIf
		
		lLiberou := MaAlcDoc({SC7->C7_NUM,"PC",aPedidos[nZ,4],,,SC7->C7_APROV,,SC7->C7_MOEDA,SC7->C7_TXMOEDA,SC7->C7_EMISSAO},dDataBase,1)
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		//?Integracao ACC envia aprovacao do pedido            ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?		
		If lLiberou .And. If(FindFunction("WebbConfig"),WebbConfig(.F.),.F.) .And. !Empty(SC7->C7_ACCNUM)
			If IsBlind()
				Webb533(SC7->C7_NUM)
			Else
				MsgRun(STR0101,STR0102,{|| Webb533(SC7->C7_NUM)}) //Aguarde, comunicando aprovação ao portal ## Portal ACC
			EndIf
		EndIf
		
		#IFDEF TOP
		If TcSrvType()<>"AS/400"
			SC7->(dbCommit())
			cQuery := "UPDATE "
			cQuery += RetSqlName("SC7")+" "	
			cQuery += "SET C7_CONAPRO = '"+ IIf( !lLiberou .Or. GetNewPar("MV_SIGAGSP","0") == "1" , "B" , "L" ) + "' "
			cQuery += "WHERE C7_FILIAL='"+xFilial("SC7")+"' AND "
			cQuery += "C7_NUM='"+SC7->C7_NUM+"' AND "
			cQuery += "D_E_L_E_T_=' ' "					
			TcSqlExec(cQuery)
			SC7->(msGoto(RecNo()))
		Else
		#ENDIF
			dbSelectArea("SC7")
			dbSetOrder(1)
			dbSeek(xFilial("SC7")+cNumPed)
			While !Eof() .And. C7_FILIAL+C7_NUM == xFilial("SC7")+cNumPed
				RecLock("SC7",.F.)
				If !lLiberou .Or. GetNewPar("MV_SIGAGSP","0") == "1" //Consiste parametro de integracao do SIGAGSP.
					SC7->C7_CONAPRO := "B"
				Else
					SC7->C7_CONAPRO := "L"
				EndIf
				MsUnlock()
				dbSkip()
			EndDo
		#IFDEF TOP
		EndIf
		#ENDIF
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Envia e-mail na inclusao do Pedido de Compras.                   ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		SC7->(MsSeek(xFilial("SC7")+cNumPed))
		MEnviaMail("037",{SC7->C7_NUM,SC7->C7_NUMCOT,SC7->C7_APROV,SC7->C7_CONAPRO,Subs(cUsuario,7,15)})

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?PE para manipular cada PC gravado pela analise da cotacao.       ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (Existblock("AVALCOPC")) .And. ValType(aRetPE := ExecBlock("AVALCOPC",.F.,.F.,aPedidos)) == "A" 
			aPedidos := aClone(aRetPE)
		EndIf

	Next nZ
	
		//-- Retorna filial
	If ValType(aBkpFilAdm[1]) # "U" .And. cFilAnt # aBkpFilAdm[1]
		SM0->(dbSetOrder(1))
		SM0->(dbSeek(cEmpAnt+aBkpFilAdm[1]))
		cFilAnt := FWCodFil()		
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Tratamento das cotacoes perdedoras que foram analisadas                 ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	For nZ := 1 To Len(aPaginas)
		nX := aPaginas[nZ]
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Inicio o processo de gravacao do Pedido de Compra                       ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		For nY := 1 To Len(aColsSCE[nX])
			dbSelectArea("SC8")
			MsGoto(aSC8[nX][nY][nPRegSC8][2])
			If ( Empty(SC8->C8_NUMPED) )
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Encerro as cotacoes perdedoras                                          ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				RecLock("SC8")
				SC8->C8_NUMPED := Repl("X",Len(SC8->C8_NUMPED))
				SC8->C8_ITEMPED:= Repl("X",Len(SC8->C8_ITEMPED))
				SC8->C8_MOTIVO := aColsSCE[nX][nY][nPMotSCE]
			EndIf
		Next nY
	Next nZ
EndCase

RestArea(aAreaSC8)
RestArea(aArea)
Return(.T.)
    

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaCanDelCo?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Verifica se um item da cotacao pode ser excluido.            ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := MaCanDelCot(ExpC1,ExpL2,ExpC2,ExpC3)				   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela de cotacao                            ³±?
±±?         ³ExpL2: Indica se o help deve ser disparado                   ³±?
±±?         ³ExpC2: msg de aviso (nao utilizada)                          ³±?
±±?         ³ExpC3: Codigo do help que foi gerado se o mesmo nao foi dispa³±?
±±?         ?      rado                                                  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: .T. - Se a cotacao pode ser excluida                  ³±?
±±?         ?      .F. - Se a cotacao nao pode ser excluida              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar se a cotacao pode ser³±?
±±?         ³excluida sem maiores problemas para a integridade do sistema ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaCanDelCot(cAliasSC8,lHelp,cAviso,cHelp)

Local aArea 		:= GetArea()
Local lRetorno  	:= .T.
DEFAULT lRestComp	:= SuperGetMv("MV_RESTCOM")=="S"
DEFAULT lHelp       := .T.
DEFAULT cHelp       := ""
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Valida o comprador.                                          ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do Case
Case ( lRestComp .And. !VldGrComp(RetCodUsr(),(cAliasSC8)->C8_GRUPCOM) )
	If ( lHelp )
		Aviso(STR0069,STR0070+(cAliasSC8)->C8_GRUPCOM+ STR0071,{STR0016},2) //"Acesso Restrito"###"O  acesso  e  a utilizacao desta rotina e destinada apenas aos usuarios pertencentes ao grupo de compras : "###". Usuario sem permissao para utilizar esta rotina.  "###"Voltar"
	Else
		cAviso := STR0070+(cAliasSC8)->C8_GRUPCOM+ STR0071 //"O  acesso  e  a utilizacao desta rotina e destinada apenas aos usuarios pertencentes ao grupo de compras : "###". Usuario sem permissao para utilizar esta rotina.  "
	EndIf
	lRetorno := .F.
Case ( !Empty((cAliasSC8)->C8_NUMPED) )
	If ( lHelp )
		Help(" ",1,"A150PED")
	Else
		cHelp := "A150PED"
	EndIf
	lRetorno := .F.
EndCase

If lRetorno
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Ponto de entrada para validar a exclusao                     ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ExistBlock( "MCANDCOT" )
		lRetorno := ExecBlock( "MCANDCOT", .F., .F., { ( cAliasSC8 )->C8_NUM,;
			( cAliasSC8 )->C8_FORNECE,( cAliasSC8 )->C8_LOJA,( cAliasSC8 )->C8_ITEM,;
			( cAliasSC8 )->C8_NUMPRO } )
	EndIf 	
EndIf

RestArea(aArea)
Return(lRetorno)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaCanAltCo?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Verifica se um item da cotacao pode ser alterado.            ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := MaCanAltCot(ExpC1,ExpL2,ExpC2,ExpN1)				   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela de cotacao                            ³±?
±±?         ³ExpL2: .T. - Exibe o help,  .F. - nao exibe			       ³±?
±±?         ³ExpC2: msg de aviso (nao utilizada)                          ³±?
±±?         ³ExpN1: numero da opcao  			                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: .T. - Se a cotacao pode ser alterada                  ³±?
±±?         ?      .F. - Se a cotacao nao pode ser alterada              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar se a cotacao pode ser³±?
±±?         ³alterada sem maiores problemas para a integridade do sistema ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaCanAltCot(cAliasSC8,lHelp,cAviso,nOpc)

Local aArea 		:= GetArea()
Local lRetorno  	:= .T.
Local aRet          := {}
Local lPortFor	:= IsInCallStack("PUTQUOTE") //Proposta veio do portal do fornecedor
DEFAULT lRestComp	:= SuperGetMv("MV_RESTCOM")=="S" .And. If(Type("lIsACC")#"L",.T.,!lIsACC)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Valida o comprador.                                          ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do Case
Case ( lRestComp .And. !VldGrComp(RetCodUsr(),(cAliasSC8)->C8_GRUPCOM) .And. !lPortFor)
	If lHelp
		Aviso(STR0069,STR0070+(cAliasSC8)->C8_GRUPCOM+ STR0071,{STR0016},2) //"Acesso Restrito"###"O  acesso  e  a utilizacao desta rotina e destinada apenas aos usuarios pertencentes ao grupo de compras : "###". Usuario sem permissao para utilizar esta rotina.  "###"Voltar"
	Else
		cAviso := STR0070+(cAliasSC8)->C8_GRUPCOM+ STR0071 //"O  acesso  e  a utilizacao desta rotina e destinada apenas aos usuarios pertencentes ao grupo de compras : "###". Usuario sem permissao para utilizar esta rotina.  "
	EndIf
	lRetorno := .F.
Case ( !Empty((cAliasSC8)->C8_NUMPED) )
	If lHelp
		Help(" ",1,"A150PED")
	Else
		cHelp := "A150PED"
	EndIf
	lRetorno := .F.
EndCase

If lRetorno .And. Existblock("MTALTCOT")
	aRet := ExecBlock("MTALTCOT",.F.,.F.,{cAliasSC8,nOpc})
	If ValType(aRet) == "A"
		lRetorno := IIF(Valtype(aRet[1]) == "L",aRet[1],.T.)
		cAviso   := IIF(Valtype(aRet[2]) == "C" .And. !lRetorno,aRet[2],"")
	Endif	
EndIf

RestArea(aArea)
Return(lRetorno)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³MaMontaCot?Autor ?Eduardo Riera          ?Data ?0.08.2000³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Rotina de montagem dos dados para analise da cotacao         ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := MaMontaCot(ExpA1,ExpA2,ExpA3,ExpA4,ExpA5,ExpA6,     ³±?
±±?         ?     			  ExpL2,ExpL3) 							   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpA1: Array com os dados do cabecalho da analise de cotacao ³±?
±±?         ?      [1] Nome do arquivo temporario                        ³±?
±±?         ?      [2] Numero da pagina selecionada                      ³±?
±±?         ?      [3] Array com os objetos do cabecalho da cotacao      ³±?
±±?         ?      [4] Header da Planilha de Cotacao (MarkBrowse)        ³±?
±±?         ?      [5] Header da Planilha de auditoria (GetDados)        ³±?
±±?         ?      [6] Header do Listbox da cotacao                      ³±?
±±?         ?      [7] Objeto da markbrowse                              ³±?
±±?         ?      [8] Objeto da GetDados                                ³±?
±±?         ?      [9] Objeto do ListBox da Cotacao                      ³±?
±±?         ?      [A] Objeto da MSMGET                                  ³±?
±±?         ?      [B] Objeto do ListBox dos ultimos fornecimentos       ³±?
±±?         ³ExpA2:*Array com os os dados da Planilha de Analise          ³±?
±±?         ?      [x] Array com a pagina atual a ser demonstrada        ³±?
±±?         ?      [x,y] Array com o conteudo dos campos a serem exibidos³±?
±±?         ³ExpA3:*Array com os os dados da Planilha de Auditoria        ³±?
±±?         ?      [x] Array com a pagina atual a ser demonstrada        ³±?
±±?         ?      [x,y] Array com o conteudo do acols da getdados       ³±?
±±?         ³ExpA4:*Array com os os dados dos registros da cotacao        ³±?
±±?         ?      [x] Array com a pagina atual a ser demonstrada        ³±?
±±?         ?      [x,1] Nome do campo                                   ³±?
±±?         ?      [x,2] Conteudo do campo                               ³±?
±±?         ³ExpA5:*Array com os os dados da Planilha de Fornecimento     ³±?
±±?         ?                                                            ³±?
±±?         ³ExpA6:*Impostos tratados pela rotina                         ³±?
±±?         ?      [x,1] Codigo de referencia do imposto                 ³±?
±±?         ?      [x,2] Nome do campo                                   ³±?
±±?         ³ExpL2: Inicializa com TES Padrao                             ³±?
±±?         ³ExpL3: Indica se eh uma visualizacao                         ³±?
±±?         ³ExpL4: Indica se a analise sera por cotacao ou por produto   ³±?
±±?         ³ExpC1: Codigo do produto se a analise for por produto        ³±?
±±?         ³ExpC2: C8_IDENT do produto se a analise for por produto      ³±?
±±?         ³ExpL5: Indica se eh e a primeira chamada da analise por prod.³±?
±±?         ³ExpA7:*Array com os dados do SC8 para restauracao da Grade.  ³±?
±±?         ?      [x] Array com a pagina atual a ser demonstrada        ³±?
±±?         ?      [x,1] Nome do campo                                   ³±?
±±?         ?      [x,2] Conteudo do campo                               ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: .T. se Len(aPlanilha)>0                               ³±?
±±?         ?	 .F. se vazia                                          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina efetua a montagem dos dados para a analise de uma³±?
±±?         ³cotacao. Apesar de possuir uma estrutura vinculada a interfa-³±?
±±?         ³ce da analise da cotacao, ela pode ser utilizada genericamen-³±?
±±?         ³te para customizacoes da analise da cotacao (Ex. Listening ) ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaMontaCot(aCabec,aPlanilha,aAuditoria,aCotacao,aListBox,aRefImpos,lTes,lVisual,lProceCot,cProdCot,cItemCotID,lFirsT,aSC8,aCpoSC8, aHeadSC8, aColsSC8)

Local aArea 	  := GetArea()
Local aAreaSX3    := SX3->(GetArea())
Local aStruQry	  := SC8->(dbStruct())
Local aStruTmp    := {}
Local aCampoSC8   := {}
Local aRetM160PL  := {}
Local aRetStru    := {}
Local aScanGrd    := {}

Local cNumSC8     := SC8->C8_NUM
Local cAliasSC8   := "SC8"
Local cQuery	  := ""
Local cIdentSC8   := ""
Local cGrupCom    := ""
Local cProdRef    := ""
Local cFiltro     := ".T."

Local lVerifica   := GetMV("MV_QBLQFOR",,"N") == "S"
Local lSigaGSP    := GetNewPar("MV_SIGAGSP","0")=="0"
Local lMtxFisCo   := GetNewPar('MV_PERFORM',.T.) //Indica se ira utilizar as funcoes fiscais para calcular o valor presente
Local lSolic      := SuperGetMv("MV_RESTCOM")=="S"
Local lQuery	  := .F.
Local lGrupCom    := .T.
Local lPedido     := .T.
Local lRetorno    := .F.
Local lReferencia := .F. 
Local lGrade      := MaGrade()

Local nP		  := 0
Local nX		  := 0
Local nY		  := 0
Local nZ		  := 0
Local nPosRef1    := 0
Local nPosRef2    := 0
Local nCusto      := 0
Local nUsadoSC8   := 0
Local nUsadoSCE   := 0
Local nScan       := 0
Local nSC8Fornec  := 0
Local nSC8Loja    := 0
Local nSC8NumPro  := 0
Local nSC8Item    := 0
Local nSC8Quant   := 0
Local nSC8Preco   := 0
Local nSC8Total   := 0
Local nSC8Scan    := 0
Local nPlanScan   := 0
Local nPlanFornec := 0
Local nPlanLoja   := 0
Local nPlanNumPro := 0
Local nPlanItem   := 0
Local nPlanPreco  := 0
Local nPlanTotal  := 0

DEFAULT aPlanilha  := {}
DEFAULT aAuditoria := {}
DEFAULT aCotacao   := {}
DEFAULT aListBox   := {}
DEFAULT aSC8       := {}
DEFAULT aCabec     := Array(12)
DEFAULT aCabec[CAB_HFLD1] := {}
DEFAULT aCabec[CAB_HFLD2] := {}
DEFAULT aCabec[CAB_HFLD3] := {}
DEFAULT aRefImpos  := {}
DEFAULT lTES	   := .F.
DEFAULT lVisual	   := .F.
DEFAULT lProceCot  := .T. 
DEFAULT lFirsT     := .T.
DEFAULT cProdCot   := " "
DEFAULT cItemCotID := " "
DEFAULT aCpoSC8    := {}
DEFAULT aHeadSC8	:= {}
DEFAULT aColsSC8	:= {}

If Type("lCotacao") == "U"
   lCotacao := .F.
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Funcao utilizada para verificar a ultima versao dos fontes      ?
//?SIGACUS.PRW, SIGACUSA.PRX e SIGACUSB.PRX, aplicados no rpo do   |
//| cliente, assim verificando a necessidade de uma atualizacao     |
//| nestes fontes. NAO REMOVER !!!							        ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
IF !(FindFunction("SIGACUS_V") .and. SIGACUS_V() >= 20050512)
    Final(STR0093) //"Atualizar SIGACUS.PRW !!!"
Endif
IF !(FindFunction("SIGACUSA_V") .and. SIGACUSA_V() >= 20050512)
    Final(STR0094) //"Atualizar SIGACUSA.PRX !!!"
Endif
IF !(FindFunction("SIGACUSB_V") .and. SIGACUSB_V() >= 20050512)
    Final(STR0095)  //"Atualizar SIGACUSB.PRX !!!"
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Funcao utilizada para verificar a ultima versao do ATUALIZADOR  ?
//?do dicionario do modulo de Compras necessario para o uso do     |
//| recurso de grade produtos no MP10 Relese I dever?ser retirado  |
//| no proximo Release da Versao quando o dicionario for Atualizado |
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
If !(FindFunction("UPDCOM01_V") .And. UPDCOM01_V() >= 20070615)
	Final(STR0099) // "Atualizar UPDCOM01_V.PRW ou checar o processamento deste UPDATE !!!"
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Efetua a montagem da planilha de fornecimento                          ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SX3")
dbSetOrder(1)
MsSeek("SC8")
While ( !Eof() .And. SX3->X3_ARQUIVO == "SC8" )
	If ( X3Uso(SX3->X3_USADO) .And. cNivel >= SX3->X3_NIVEL .And.;
			SX3->X3_CONTEXT<>"V" .And. !Trim(SX3->X3_CAMPO)$"C8_ITEM" )
		If lMtxFisCo
			nUsadoSC8++
			If lFirsT
				AADD(aCabec[CAB_HFLD3],TRIM(X3Titulo()))
				AADD(aHeadSC8,{ TRIM(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,;
							SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_F3,SX3->X3_CONTEXT })
			Endif	
			AADD(aCampoSC8,{SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TIPO})
		Else
			If Trim(SX3->X3_CAMPO)$ "C8_NUMPRO#C8_NUMSC#C8_ITEMSC#C8_PRODUTO#C8_PRECO#C8_QUANT#C8_TOTAL#C8_AVISTA"
				nUsadoSC8++
				If lFirsT
					AADD(aCabec[CAB_HFLD3],TRIM(X3Titulo()))
					AADD(aHeadSC8,{ TRIM(X3Titulo()),SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TAMANHO,SX3->X3_DECIMAL,;
							SX3->X3_VALID,SX3->X3_USADO,SX3->X3_TIPO,SX3->X3_F3,SX3->X3_CONTEXT })
				Endif	
				AADD(aCampoSC8,{SX3->X3_CAMPO,SX3->X3_PICTURE,SX3->X3_TIPO})
			Endif	
		Endif	
	EndIf
	If lFirsT
		nPosRef1	:= At("MAFISREF(",Upper(SX3->X3_VALID))
		If ( nPosRef1 > 0 )
			nPosRef1    += 10
			nPosRef2    := At(",",SubStr(SX3->X3_VALID,nPosRef1))-2
			aadd(aRefImpos,{"SC8",SX3->X3_CAMPO,SubStr(SX3->X3_VALID,nPosRef1,nPosRef2)})
		EndIf
	Endif	
	dbSelectArea("SX3")
	dbSkip()
EndDo
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Efetua a montagem da planilha de auditoria                             ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SX3")
dbSetOrder(1)
MsSeek("SCE")
While ( !Eof() .And. SX3->X3_ARQUIVO == "SCE" )
	If ( X3Uso(SX3->X3_USADO) .And. cNivel >= SX3->X3_NIVEL ) .Or. AllTrim(SX3->X3_CAMPO) == "CE_NUMPRO"
		If ! AllTrim(SX3->X3_CAMPO) $ "CE_NUMCOT; CE_ITEMCOT"
			nUsadoSCE++
			If lFirsT
				AADD(aCabec[CAB_HFLD2],{ TRIM(X3Titulo()),;
					Trim(SX3->X3_CAMPO),;
					SX3->X3_PICTURE,;
					SX3->X3_TAMANHO,;
					SX3->X3_DECIMAL,;
					SX3->X3_VALID,;
					SX3->X3_USADO,;
					SX3->X3_TIPO,;
					SX3->X3_ARQUIVO,;
					SX3->X3_CONTEXT } )
			Endif	
		Endif
	EndIf
	dbSelectArea("SX3")
	dbSkip()
EndDo

If aScan(aCabec[CAB_HFLD2], {|z| AllTrim(z[2]) == "CE_ITEMCOT"}) == 0
	dbSetOrder(2)
	dbSeek(Pad("CE_ITEMCOT", 10))
	nUsadoSCE++
	AADD(aCabec[CAB_HFLD2],{ TRIM(X3Titulo()),;
		Trim(SX3->X3_CAMPO),;
		SX3->X3_PICTURE,;
		SX3->X3_TAMANHO,;
		SX3->X3_DECIMAL,;
		SX3->X3_VALID,;
		SX3->X3_USADO,;
		SX3->X3_TIPO,;
		SX3->X3_ARQUIVO,;
		SX3->X3_CONTEXT } )
	dbSetOrder(1)
Endif

If aScan(aCabec[CAB_HFLD2], {|z| AllTrim(z[2]) == "CE_NUMCOT"}) == 0
	dbSetOrder(2)
	dbSeek(Pad("CE_NUMCOT", 10))
	nUsadoSCE++
	AADD(aCabec[CAB_HFLD2],{ TRIM(X3Titulo()),;
		Trim(SX3->X3_CAMPO),;
		SX3->X3_PICTURE,;
		SX3->X3_TAMANHO,;
		SX3->X3_DECIMAL,;
		SX3->X3_VALID,;
		SX3->X3_USADO,;
		SX3->X3_TIPO,;
		SX3->X3_ARQUIVO,;
		SX3->X3_CONTEXT } )
	dbSetOrder(1)
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Walk Thru                   ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
ADHeadRec("SCE",aCabec[CAB_HFLD2])

If lFirsT
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Efetua a preparacao dos dados que serao mostrados na planilha          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aadd(aCabec[CAB_HFLD1],{"PLN_OK"     ,"","",""})
	aadd(aCabec[CAB_HFLD1],{"PLN_FORNECE","",RetTitle("C8_FORNECE"),PesqPict("SC8","C8_FORNECE")})
	aadd(aCabec[CAB_HFLD1],{"PLN_LOJA"   ,"",RetTitle("C8_LOJA"),PesqPict("SC8","C8_LOJA")})
	aadd(aCabec[CAB_HFLD1],{"PLN_NREDUZ" ,"",RetTitle("A2_NREDUZ"),PesqPict("SA2","A2_NREDUZ")})
	aadd(aCabec[CAB_HFLD1],{"PLN_NUMPRO" ,"",RetTitle("C8_NUMPRO"),PesqPict("SC8","C8_NUMPRO")})
	aadd(aCabec[CAB_HFLD1],{"PLN_TOTAL"  ,"",RetTitle("C8_TOTAL"),PesqPict("SC8","C8_TOTAL")})
	aadd(aCabec[CAB_HFLD1],{"PLN_DATPRF" ,"",RetTitle("C8_DATPRF"),PesqPict("SC8","C8_DATPRF")})
	aadd(aCabec[CAB_HFLD1],{"PLN_DATPRZ" ,"",RetTitle("C8_PRAZO"),PesqPict("SC8","C8_DATPRF")})
	aadd(aCabec[CAB_HFLD1],{"PLN_DESVIO" ,"",RetTitle("A2_DESVIO"),PesqPict("SA2","A2_DESVIO")})
	aadd(aCabec[CAB_HFLD1],{"PLN_NOTA"   ,"",RetTitle("A5_NOTA"),PesqPict("SA5","A5_NOTA")})
	aadd(aCabec[CAB_HFLD1],{"PLN_OBS"    ,"",RetTitle("C8_OBS"),PesqPict("SC8","C8_OBS")})  
	aadd(aCabec[CAB_HFLD1],{"PLN_FLAG"   ,"","",""})
	aadd(aCabec[CAB_HFLD1],{"PLN_ITEM"   ,"",RetTitle("C8_ITEM"),PesqPict("SC8","C8_ITEM")})
	aadd(aCabec[CAB_HFLD1],{"PLN_PRECO"  ,"",RetTitle("C8_PRECO"),PesqPict("SC8","C8_PRECO")})
	aadd(aCabec[CAB_HFLD1],{"PLN_COND"   ,"",RetTitle("C8_COND"),PesqPict("SC8","C8_COND")})
	aadd(aCabec[CAB_HFLD1],{"PLN_DESCRI" ,"",RetTitle("E4_DESCRI"),PesqPict("SE4","E4_DESCRI")})
	aadd(aCabec[CAB_HFLD1],{"PLN_PRAZO"  ,"",RetTitle("C8_PRAZO"),PesqPict("SC8","C8_PRAZO")})
	aadd(aCabec[CAB_HFLD1],{"PLN_VISTO"  ,"","",""})
	aadd(aCabec[CAB_HFLD1],{"PLN_ITEMGRD","",RetTitle("C8_ITEMGRD"),PesqPict("SC8","C8_ITEMGRD")})

	dbSelectArea("SX3")
	dbSetOrder(2)
	MsSeek("C8_FORNECE")
	aadd(aStruTmp,{"PLN_OK","C",2,0})
	aadd(aStruTmp,{"PLN_FORNEC",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("C8_LOJA")
	aadd(aStruTmp,{"PLN_LOJA",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("A2_NREDUZ")
	aadd(aStruQry,{"A2_NREDUZ",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	aadd(aStruTmp,{"PLN_NREDUZ",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("C8_NUMPRO")
	aadd(aStruTmp,{"PLN_NUMPRO",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("C8_TOTAL")
	aadd(aStruTmp,{"PLN_TOTAL",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("C8_DATPRF")
	aadd(aStruTmp,{"PLN_DATPRF",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	aadd(aStruTmp,{"PLN_DATPRZ",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("A2_DESVIO")
	aadd(aStruQry,{"A2_DESVIO",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	aadd(aStruTmp,{"PLN_DESVIO",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("A5_NOTA")
	aadd(aStruTmp,{"PLN_NOTA",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("C8_OBS")
	aadd(aStruTmp,{"PLN_OBS",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	aadd(aStruTmp,{"PLN_FLAG","N",1,0})
	MsSeek("C8_ITEM")
	aadd(aStruTmp,{"PLN_ITEM",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("C8_PRECO")
	aadd(aStruTmp,{"PLN_PRECO",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("C8_COND")
	aadd(aStruTmp,{"PLN_COND",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("E4_DESCRI")
	aadd(aStruTmp,{"PLN_DESCRI",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("C8_PRAZO")
	aadd(aStruTmp,{"PLN_PRAZO",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	aadd(aStruTmp,{"PLN_VISTO","C",1,0})
	MsSeek("C8_ITEMGRD")
	aadd(aStruTmp,{"PLN_ITEMGR",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Preenche array aCpoSC8 com os campos do cabecalho para permitir alterar?
	//?a ordem dos campos                                                     ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
	aEval( aCabec[CAB_HFLD1] , { |x| aAdd( aCpoSC8 , x[1] ) } )

	If ExistBlock("M160STRU") 
		aRetStru := ExecBlock("M160STRU",.F.,.F.,{aStruTmp,aCabec[CAB_HFLD1],aCpoSC8})
	    If ValType(aRetStru[1]) == "A" .And. Len(aRetStru[1]) > 0
		    aStruTmp := aRetStru[1]
	    Endif
	    If ValType(aRetStru[2]) == "A" .And. Len(aRetStru[2]) > 0
		    aCabec[CAB_HFLD1] := aRetStru[2]
	    Endif	    
	    If ValType(aRetStru[3]) == "A" .And. Len(aRetStru[3]) > 0
		    aCpoSC8 := aRetStru[3]
	    Endif	    
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Cria o arquivo temporario                                              ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aCabec[CAB_ARQTMP] := CriaTrab(aStruTmp,.T.)
	dbUseArea(.T.,__LocalDrive,aCabec[CAB_ARQTMP],aCabec[CAB_ARQTMP],.F.,.F.)
Else
	dbSelectArea("SX3")
	dbSetOrder(2)
	MsSeek("A2_NREDUZ")
	aadd(aStruQry,{"A2_NREDUZ",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})

	MsSeek("A2_DESVIO")
	aadd(aStruQry,{"A2_DESVIO",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
Endif	

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Efetua a montagem das paginas de cotacao                               ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SC8")
dbSetOrder(4)
MsSeek(xFilial("SC8")+cNumSC8)

#IFDEF TOP
	cAliasSC8:= "MAMONTACOT"
	lQuery := .T.
	cQuery := ""
	For nX := 1 To Len(aStruQry)
		cQuery += ","+aStruQry[nX][1]
	Next nX
	cQuery := "SELECT SB1.B1_TE,"+SubStr(cQuery,2)+",SC8.R_E_C_N_O_ SC8RECNO "
	cQuery += "FROM "+RetSqlName("SC8")+" SC8,"
	cQuery += RetSqlName("SA2")+" SA2,"
	cQuery += RetSqlName("SB1")+" SB1 "
	cQuery += "WHERE SC8.C8_FILIAL='"+xFilial("SC8")+"' AND "
	cQuery += "SC8.C8_NUM='"+cNumSC8+"' AND "
   
   IF lCotacao 
	   cQuery += "SC8.C8_NUMPED='' AND "
	EndIf

	If !lProceCot .And. !Empty(cProdCot) .And. !Empty(cItemCotID)
		cQuery += "SC8.C8_PRODUTO = '"+cProdCot+"' AND "
		cQuery += "SC8.C8_IDENT   = '"+cItemCotID+"' AND "
	Endif
	cQuery += "SC8.D_E_L_E_T_=' ' AND "
	cQuery += "SA2.A2_FILIAL='"+xFilial("SA2")+"' AND "
	cQuery += "SA2.A2_COD=SC8.C8_FORNECE AND "
	cQuery += "SA2.A2_LOJA=SC8.C8_LOJA AND "
	cQuery += "SA2.D_E_L_E_T_=' ' AND "
	cQuery += "SB1.B1_FILIAL='"+xFilial("SB1")+"' AND "
	cQuery += "SB1.B1_COD=SC8.C8_PRODUTO AND "
	cQuery += "SB1.D_E_L_E_T_=' ' "
	cQuery += "ORDER BY "+SqlOrder(SC8->(IndexKey()))
	cQuery := ChangeQuery(cQuery)
	dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSC8,.T.,.T.)
	For nX := 1 To Len(aStruQry)
		If ( aStruQry[nX][2] <> "C" )
			TcSetField(cAliasSC8,aStruQry[nX][1],aStruQry[nX][2],aStruQry[nX][3],aStruQry[nX][4])
		EndIf
	Next nX	
#ENDIF

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Verifica ponto de entrada de filtragem                                 ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If (Type('lIsACC')#'L' .Or. !lIsACC) .And. ExistBlock("MT160FIL")
	cFiltro := ExecBlock("MT160FIL",.F.,.F.,{cAliasSC8})
EndIf

dbSelectArea(cAliasSC8)
While ( !Eof() .And. (cAliasSC8)->C8_FILIAL == xFilial("SC8") .And. (cAliasSC8)->C8_NUM == cNumSC8 )
	
	If lCotacao
	   If ! IsEmpty((cAliasSC8)->C8_NUMPED) 
			(cAliasSC8)->(dbSkip())
			Loop
	   EndIf
	EndIf
	If ( !lQuery )
		If !lProceCot .And. !Empty(cProdCot) .And. !Empty(cItemCotID)
			If RetCodProdFam((cAliasSC8)->C8_PRODUTO) <> RetCodProdFam(cProdCot) .And. (cAliasSC8)->C8_IDENT <> cItemCotID
				dbSelectArea(cAliasSC8)
				dbSkip()
				Loop
			Endif
		Endif
	Endif
    
    //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica se o filtro utilizado e valido senao substitui por ".T."      ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
    If Valtype(cFiltro) == "C" .And. Empty(cFiltro)
    	cFiltro:= ".T."
    ElseIf Valtype(cFiltro) != "C"
    	cFiltro:= ".T."
    EndIf
    
	If &(cFiltro)  .And. If( lSigaGSP,.t.,GSPF190() )
		
		If !lVisual .And. lSolic .And. !VldAnCot(RetCodUsr(),(cAliasSC8)->C8_GRUPCOM)
			cGrupCom  := (cAliasSC8)->C8_GRUPCOM
		Else

			lGrupCom  := .F.

			If lVisual .Or. Empty((cAliasSC8)->C8_NUMPED)

				lPedido   := .F.
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Verifica se o Produto x Fornecedor esta definido para Inspecao no QIE, ?
				//?se o mesmo possui a Situacao; "Nao-Habilitado, neste caso o mesmo nao  ?
				//?sera selecionado para analise nas cotacoes. 						   ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If !lVisual .And. lVerifica
					If !QieSitFornec((cAliasSC8)->C8_FORNECE,(cAliasSC8)->C8_LOJA,(cAliasSC8)->C8_PRODUTO,.F.)
					    Aviso((STR0127),OemToAnsi(STR0123)+Alltrim((cAliasSC8)->C8_PRODUTO)+OemToAnsi(STR0124)+Alltrim((cAliasSC8)->C8_FORNECE)+OemToAnsi(STR0125)+Alltrim((cAliasSC8)->C8_LOJA)+(STR0126),{"Ok"}) // O produto XXX foi bloqueado pela Qualidade para esse Fornecedor  Loja, O mesmo nao participara do processo realizado. "                                                                           
						dbSelectArea(cAliasSC8)
						dbSkip()
						Loop
					EndIf
				EndIf
						
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Calculo do custo da Cotacao                                            ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If lMtxFisCo
					nMoedaAval := Max((cAliasSC8)->C8_MOEDA,1)
					MaFisIni((cAliasSC8)->C8_FORNECE,(cAliasSC8)->C8_LOJA,"F","N","R")
					MaFisIniLoad(1)
					For nY := 1 To Len(aRefImpos)
						MaFisLoad(aRefImpos[nY][3],(cAliasSC8)->(FieldGet(FieldPos(aRefImpos[nY][2]))),1)
					Next nY
					If ( lTes .And. Empty((cAliasSC8)->C8_TES) )
						If ( !lQuery )
							dbSelectArea("SB1")
							dbSetOrder(1)
							MsSeek(xFilial("SB1")+(cAliasSC8)->C8_PRODUTO)
							MaFisAlt("IT_TES",RetFldProd(SB1->B1_COD,"B1_TE"),1)
						Else
							MaFisAlt("IT_TES",RetFldProd((cAliasSC8)->C8_PRODUTO,"B1_TE"),1)
						EndIf
					EndIf
					MaFisEndLoad(1)
					nCusto := Ma160Custo(cAliasSC8,1)
					MaFisEnd()
				Else
					nCusto := Ma160Custo(cAliasSC8,1)
				Endif
                
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Quando o C8_IDENT for diferente sera construida uma nova dimensao em   ?
				//?todo conjunto de Arrays da Analise para paginar um novo produto, isso  ?
				//?so nao ocorrera se o Produto for um produto com item de Grade, neste   ?
				//?caso o C8_IDENT e o mesmo para todos os itens com Grade e os arrays    ?
				//?aPlanilha,aCotacao e aAuditoria sao construido de forma Sintetica.     ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If cIdentSC8 <> (cAliasSC8)->C8_IDENT 
					cIdentSC8:= (cAliasSC8)->C8_IDENT
					aadd(aPlanilha,{})
					aadd(aCotacao,{})
					aadd(aAuditoria,{})
					aadd(aListBox,{})
					aadd(aColsSC8,{})
					nX 		 := Len(aPlanilha)
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//?Array usado para Gravacao do PC pela Analise da Cotacao na MaAvalCot   ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aadd(aSC8,{})
					nP 		:= Len(aSC8)
				Endif

				aadd(aSC8[nP],{})
				nY := Len(aSC8[nP])
				dbSelectArea(cAliasSC8)
				For nZ := 1 To FCount()
					If FieldName(nZ) $ "C8_NUMPRO#C8_FORNECE#C8_LOJA#C8_COND#C8_PRODUTO#C8_ITEM#C8_NUM#C8_ITEMGRD#SC8RECNO#C8_FILENT"
						aadd(aSC8[nP][nY],{FieldName(nZ),FieldGet(nZ)})
					Endif
				Next nZ
				If !lQuery 
					aadd(aSC8[nP][nY],{"SC8RECNO",(cAliasSC8)->(RecNo())})
				EndIf
			
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Planilha de cotacao                                                    ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ				
				If !lGrade .Or. Empty((cAliasSC8)->C8_ITEMGRD) .Or. aScan(aScanGrd, {|z| z[1] + z[2] + z[3] + z[4] == (cAliasSC8)->(C8_FORNECE+C8_LOJA+C8_NUMPRO+C8_ITEM)}) == 0

					Aadd(aScanGrd, {(cAliasSC8)->C8_FORNECE, (cAliasSC8)->C8_LOJA, (cAliasSC8)->C8_NUMPRO, (cAliasSC8)->C8_ITEM, (cAliasSC8)->(Recno())})

					cProdRef   := (cAliasSC8)->C8_PRODUTO
					lReferencia:= MatGrdPrrf(@cProdRef,.T.)
					dbSelectArea("SA5")
					dbSetOrder(1)
					If ! MsSeek(xFilial("SA5")+(cAliasSC8)->C8_FORNECE+(cAliasSC8)->C8_LOJA+(cAliasSC8)->C8_PRODUTO).And.lReferencia
						dbSelectArea("SA5")
						dbSetOrder(9)
						MsSeek(xFilial("SA5")+(cAliasSC8)->C8_FORNECE+(cAliasSC8)->C8_LOJA+cProdRef )
					Endif

					SE4->(dbSetOrder(1))
					SE4->(MsSeek(xFilial("SE4")+(cAliasSC8)->C8_COND))
										
					If !( lQuery )
						dbSelectArea("SA2")
						dbSetOrder(1)
						MsSeek(xFilial("SA2")+(cAliasSC8)->C8_FORNECE+(cAliasSC8)->C8_LOJA)
					EndIf
					
					aAdd(aPlanilha[nx],Array(len(aCpoSC8)))
					
					For ny:=1 to len(aCpoSC8)
						Do Case
							Case aCpoSC8[ny] == "PLN_DESCRI"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := SE4->E4_DESCRI
							Case aCpoSC8[ny] == "PLN_NOTA"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := SA5->A5_NOTA
							Case aCpoSC8[ny] == "PLN_DESVIO"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := If(lQuery,(cAliasSC8)->A2_DESVIO,SA2->A2_DESVIO)
							Case aCpoSC8[ny] == "PLN_NREDUZ"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := If(lQuery,(cAliasSC8)->A2_NREDUZ,SA2->A2_NREDUZ)
							Case aCpoSC8[ny] == "PLN_OK"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := Space(2)
							Case aCpoSC8[ny] == "PLN_TOTAL"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := nCusto
							Case aCpoSC8[ny] == "PLN_DATPRZ"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := dDataBase+(cAliasSC8)->C8_PRAZO
							Case aCpoSC8[ny] == "PLN_PRECO"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := xMoeda((cAliasSC8)->C8_PRECO,(cAliasSC8)->C8_MOEDA,1,(cAliasSC8)->C8_EMISSAO,tamsx3("C8_PRECO")[2],If((cAliasSC8)->(FIELDPOS("C8_TXMOEDA")) > 0,(cAliasSC8)->C8_TXMOEDA,''))
							Case aCpoSC8[ny] == "PLN_FLAG"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := 0
							Case aCpoSC8[ny] == "PLN_VISTO"
								aPlanilha[nx,len(aPlanilha[nx]),ny] := " "
							Case aCpoSC8[ny] == "PLN_OBS"
								//Posiciona a SC8 na linha, referenciando pelo RECNO (Topconn não l?campo Memo)
								If !lQuery
									SC8->(MsGoTo((cAliasSC8)->(RecNo()))) 
								Else
									SC8->(MsGoTo((cAliasSC8)->SC8RECNO))	
								EndIf
								aPlanilha[nx,len(aPlanilha[nx]),ny] := SC8->C8_OBS
							OtherWise
								aPlanilha[nx,len(aPlanilha[nx]),ny] := (cAliasSC8)->&("C8_"+substr(aCpoSC8[ny],at("_",aCpoSC8[ny])+1))
						EndCase
					Next

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//?Armazenna posicao dos campos da planilha                               ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					nPlanFornec := aScan(aCpoSC8,"PLN_FORNEC")
					nPlanLoja   := aScan(aCpoSC8,"PLN_LOJA")
					nPlanNumPro := aScan(aCpoSC8,"PLN_NUMPRO")
					nPlanItem   := aScan(aCpoSC8,"PLN_ITEM")
					nPlanPreco  := aScan(aCpoSC8,"PLN_PRECO")
					nPlanTotal  := aScan(aCpoSC8,"PLN_TOTAL")

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//?Dados da cotacao                                                       ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aadd(aCotacao[nX],{})
					nY := Len(aCotacao[nX])
					dbSelectArea(cAliasSC8)
					For nZ := 1 To FCount()
						If lMtxFisCo
							aadd(aCotacao[nX][nY],{FieldName(nZ),FieldGet(nZ)})
						Else
							If FieldName(nZ) $ "C8_NUM#C8_ITEM#C8_NUMPRO#C8_FORNECE#C8_LOJA#C8_PRODUTO#C8_QUANT#C8_NUMSC#C8_ITEMSC#C8_TAXAFIN#C8_COND#SC8RECNO#C8_QTDAUDI#C8_ITEMGRD"
								aadd(aCotacao[nX][nY],{FieldName(nZ),FieldGet(nZ)})
							Endif
						Endif
					Next nZ
					If ( !lQuery )
						aadd(aCotacao[nX][nY],{"SC8RECNO",(cAliasSC8)->(RecNo())})
					EndIf
					
					nSC8Fornec  := aScan(aCotacao[nX, nY], {|z| AllTrim(z[1]) == "C8_FORNECE"})
					nSC8Loja    := aScan(aCotacao[nX, nY], {|z| AllTrim(z[1]) == "C8_LOJA"   })
					nSC8NumPro  := aScan(aCotacao[nX, nY], {|z| AllTrim(z[1]) == "C8_NUMPRO" })
					nSC8Item    := aScan(aCotacao[nX, nY], {|z| AllTrim(z[1]) == "C8_ITEM"   })
					nSC8Quant   := aScan(aCotacao[nX, nY], {|z| AllTrim(z[1]) == "C8_QUANT"  })
					nSC8Preco   := aScan(aCotacao[nX, nY], {|z| AllTrim(z[1]) == "C8_PRECO"  })
					nSC8Total   := aScan(aCotacao[nX, nY], {|z| AllTrim(z[1]) == "C8_TOTAL"  })

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//?Planilha de Auditoria                                                  ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					aadd(aAuditoria[nX],Array(Len(aCabec[CAB_HFLD2])+1))
					For nY := 1 To Len(aCabec[CAB_HFLD2])
						Do Case
							Case IsHeadRec(aCabec[CAB_HFLD2][nY][2])
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := IIf(lQuery , (cAliasSC8)->SC8RECNO , (cAliasSC8)->(Recno()) )
							Case IsHeadAlias(aCabec[CAB_HFLD2][nY][2])
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := "SC8"
							Case aCabec[CAB_HFLD2][nY][2]=="CE_NUMPRO"
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := (cAliasSC8)->C8_NUMPRO
							Case aCabec[CAB_HFLD2][nY][2]=="CE_FORNECE"
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := (cAliasSC8)->C8_FORNECE
							Case aCabec[CAB_HFLD2][nY][2]=="CE_LOJA"
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := (cAliasSC8)->C8_LOJA
							Case  aCabec[CAB_HFLD2][nY][2]=="CE_ENTREGA"
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := (cAliasSC8)->C8_DATPRF
							Case  aCabec[CAB_HFLD2][nY][2]=="CE_ITEMCOT"
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := (cAliasSC8)->C8_ITEM
							Case  aCabec[CAB_HFLD2][nY][2]=="CE_NUMCOT"
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := (cAliasSC8)->C8_NUM
							Case  aCabec[CAB_HFLD2][nY][2]=="CE_ITEMGRD"
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := (cAliasSC8)->C8_ITEMGRD
							Case  aCabec[CAB_HFLD2][nY][2]=="CE_QUANT"
								dbSelectArea("SCE")
								dbSetOrder(1)
								If MsSeek(xFilial("SCE")+(cAliasSC8)->C8_NUM+(cAliasSC8)->C8_ITEM+(cAliasSC8)->C8_PRODUTO+;
									(cAliasSC8)->C8_FORNECE+(cAliasSC8)->C8_LOJA)
									While SCE->(!Eof()) .And. SCE->CE_FILIAL+SCE->CE_NUMCOT+SCE->CE_ITEMCOT+SCE->CE_PRODUTO+SCE->CE_FORNECE+SCE->CE_LOJA ==;
									    xFilial("SCE")+(cAliasSC8)->C8_NUM+(cAliasSC8)->C8_ITEM+(cAliasSC8)->C8_PRODUTO+(cAliasSC8)->C8_FORNECE+(cAliasSC8)->C8_LOJA
									    If SCE->CE_NUMPRO == (cAliasSC8)->C8_NUMPRO
											aAuditoria[nX][Len(aAuditoria[nX])][nY] := SCE->CE_QUANT
											aPlanilha[nX][Len(aPlanilha[nX])][1]    := "XX"//Marca fornecedor ganhador
											Exit
										Else
											aAuditoria[nX][Len(aAuditoria[nX])][nY] := IIF(SC8->(FieldPos("C8_QTDAUDI")) > 0 ,(cAliasSC8)->C8_QTDAUDI , 0 )
										Endif
									    SCE->(dbSkip())
									EndDo
								Else
									aAuditoria[nX][Len(aAuditoria[nX])][nY] := IIF(SC8->(FieldPos("C8_QTDAUDI")) > 0 ,(cAliasSC8)->C8_QTDAUDI , 0 )
								EndIf
							Case  aCabec[CAB_HFLD2][nY][2]=="CE_MOTIVO"
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := (cAliasSC8)->C8_MOTIVO
							OtherWise
								aAuditoria[nX][Len(aAuditoria[nX])][nY] := CriaVar(aCabec[CAB_HFLD2][nY][2],.T.)

								//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
								//?Verifica se o campo pertence a tabela SCE  ?
								//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
								If !Empty(SCE->(FieldPos(aCabec[CAB_HFLD2][nY][2])))
									dbSelectArea("SCE")
									dbSetOrder(1)
									//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
									//?Verifica se o fornecedor foi o vencedor    ?
									//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
									If MsSeek(xFilial("SCE")+(cAliasSC8)->C8_NUM+(cAliasSC8)->C8_ITEM+(cAliasSC8)->C8_PRODUTO+;
										(cAliasSC8)->C8_FORNECE+(cAliasSC8)->C8_LOJA)

										//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
										//?Verifica a proposta correta    ?
										//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
										While SCE->(!Eof()) .And. SCE->CE_FILIAL+SCE->CE_NUMCOT+SCE->CE_ITEMCOT+SCE->CE_PRODUTO+SCE->CE_FORNECE+SCE->CE_LOJA ==;
										    xFilial("SCE")+(cAliasSC8)->C8_NUM+(cAliasSC8)->C8_ITEM+(cAliasSC8)->C8_PRODUTO+(cAliasSC8)->C8_FORNECE+(cAliasSC8)->C8_LOJA
										    If SCE->CE_NUMPRO == (cAliasSC8)->C8_NUMPRO
												//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
												//?Preenche o campo da auditoria  ?
												//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
												aAuditoria[nX][Len(aAuditoria[nX])][nY] := SCE->&(aCabec[CAB_HFLD2][nY][2])
												Exit
											Endif
										    SCE->(dbSkip())
										EndDo
									EndIf							
								EndIf
						EndCase
					Next nY
					aAuditoria[nX][Len(aAuditoria[nX])][ Len(aCabec[CAB_HFLD2])+1] := .F.

					aadd(aListBox[nX],{})
					aadd(aColsSC8[nX],{})
					nPlanScan := Len(aListBox[nX])
				Else
					If (nPlanFornec > 0 .And. nPlanLoja > 0 .And. nPlanNumPro > 0 .And. nPlanItem > 0)
						If (nPlanScan := aScan(aPlanilha[nX], {|z|	z[nPlanFornec] == (cAliasSC8)->C8_FORNECE .And. ;
							z[nPlanLoja] == (cAliasSC8)->C8_LOJA    .And. ;
							z[nPlanNumPro] == (cAliasSC8)->C8_NUMPRO  .And. ;
							z[nPlanItem] == (cAliasSC8)->C8_ITEM   })) > 0
							If nPlanTotal > 0
								aPlanilha[nX, nPlanScan, nPlanTotal] += nCusto
							EndIf
						Endif
					EndIf

					If (nSC8Scan := aScan(aCotacao[nX], {|z|	z[nSC8Fornec, 2] == (cAliasSC8)->C8_FORNECE .And. ;
						z[nSC8Loja  , 2] == (cAliasSC8)->C8_LOJA    .And. ;
						z[nSC8NumPro, 2] == (cAliasSC8)->C8_NUMPRO  .And. ;
						z[nSC8Item  , 2] == (cAliasSC8)->C8_ITEM   })) > 0
						
						aCotacao[nX, nSC8Scan, nSC8Quant, 2] += (cAliasSC8)->C8_QUANT
						aCotacao[nX, nSC8Scan, nSC8Total, 2] += (cAliasSC8)->C8_TOTAL
						aCotacao[nX, nSC8Scan, nSC8Preco, 2] := aCotacao[nX, nSC8Scan, nSC8Total, 2] / aCotacao[nX, nSC8Scan, nSC8Quant, 2]
						
						If nPlanPreco > 0
							aPlanilha[nX, nPlanScan,nPlanPreco] := aCotacao[nX, nSC8Scan, nSC8Preco, 2]						
						EndIf
					Endif

				Endif
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Planilha de Fornecimento                                               ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				aadd(aListBox[nX][nPlanScan],Array(nUsadoSC8)) 
				aadd(aColsSC8[nX][nPlanScan],Array(nUsadoSC8))
				dbSelectArea(cAliasSC8)
				For nY := 1 To Len(aCabec[CAB_HFLD3])
					If aCampoSC8[nY][3] <> "M"
						aColsSC8[nX][nPlanScan][Len(aListBox[nX][nPlanScan])][nY] := FieldGet(FieldPos(aCampoSC8[nY][1]))
						aListBox[nX][nPlanScan][Len(aListBox[nX][nPlanScan])][nY] := TransForm(aColsSC8[nX][nPlanScan][Len(aListBox[nX][nPlanScan])][nY],aCampoSC8[nY][2])
					Else
						SC8->(msGoto( IIf(lQuery , (cAliasSC8)->SC8RECNO , (cAliasSC8)->(Recno())) ))
						aColsSC8[nX][nPlanScan][Len(aListBox[nX][nPlanScan])][nY] := &("SC8->"+aCampoSC8[nY][1])
						aListBox[nX][nPlanScan][Len(aListBox[nX][nPlanScan])][nY] := aColsSC8[nX][nPlanScan][Len(aListBox[nX][nPlanScan])][nY]
					EndIf
				Next nY
				aAdd(aColsSC8[nX][nPlanScan][Len(aListBox[nX][nPlanScan])], .F.)
				
				SCE->(dbSeek(xFilial("SCE") + (cAliasSC8)->(C8_NUM+C8_ITEM+C8_PRODUTO+C8_FORNECE+C8_LOJA)))

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Definicao da Estrutura do array aCotaGrade ?
				//ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
				//?1 - C8_FORNECE                             ?
				//?2 - C8_LOJA                                ?
				//?3 - C8_NUMPRO                              ?
				//?4 - C8_ITEM                                ?
				//?5 - C8_PRODUTO (Familia)                   ?
				//?6 - Alimentado quando for produto de Grade ?
				//?6.1 - C8_PRODUTO                           ?
				//?6.2 - CE_QUANT                             ?
				//?6.3 - C8_DATPRF                            ?
				//?6.4 - C8_ITEMGRD                           ?
				//?6.5 - Recno SC8                            ?
				//?6.6 - C8_QUANT (Quantidade Original)       ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If (nScan := aScan(aCotaGrade, {|z| z[1] + z[2] + z[3] + z[4] == ;
					(cAliasSC8)->C8_FORNECE + (cAliasSC8)->C8_LOJA + (cAliasSC8)->C8_NUMPRO + (cAliasSC8)->C8_ITEM})) == 0
					Aadd(aCotaGrade, {(cAliasSC8)->C8_FORNECE, (cAliasSC8)->C8_LOJA, (cAliasSC8)->C8_NUMPRO, (cAliasSC8)->C8_ITEM, RetCodProdFam((cAliasSC8)->C8_PRODUTO,!Empty((cAliasSC8)->C8_ITEMGRD)), {} })
					nScan := Len(aCotaGrade)
				Endif
				
				If (! Empty((cAliasSC8)->C8_ITEMGRD )) .And. nScan > 0
					Aadd(aCotaGrade[nScan, 6], {(cAliasSC8)->C8_PRODUTO,SCE->CE_QUANT, (cAliasSC8)->C8_DATPRF, (cAliasSC8)->C8_ITEMGRD, If(lQuery, (cAliasSC8)->SC8RECNO, (cAliasSC8)->(Recno())), (cAliasSC8)->C8_QUANT })
				Endif
												
				If ExistBlock("M160PLAN")
					aRetM160PL := ExecBlock("M160PLAN",.F.,.F.,{(cAliasSC8),aPlanilha[Len(aPlanilha)],aCpoSC8})
					If ValType(aRetM160PL) == "A" .And. Len(aRetM160PL) > 0
						aPlanilha[Len(aPlanilha)] := aRetM160PL
					Endif
				EndIf

			EndIf
		EndIf
	EndIf

	dbSelectArea(cAliasSC8)
	dbSkip()

EndDo

If !lVisual 
	If lGrupCom 
		Aviso(STR0069,STR0070+cGrupCom+ STR0072,{STR0016},2) //"Acesso Restrito"###"O  acesso  e  a utilizacao desta rotina e destinada apenas aos usuarios pertencentes ao grupo de compras : "###". com direito de analise de cotacao. Usuario sem permissao para utilizar esta rotina.  "###"Voltar"
	ElseIf lPedido 
		Help(" ",1,	"A160ENCER")
	EndIf
EndIf

lRetorno := Len(aPlanilha) > 0

If lRetorno .And. Existblock("MTVLDCOT")
	lRetorno := ExecBlock("MTVLDCOT",.F.,.F.,{cNumSC8})
	lRetorno := IIF(ValType(lRetorno)=="L",lRetorno,.T.)
EndIf

If lQuery
	dbSelectArea(cAliasSC8)
	dbCloseArea()
	dbSelectArea("SC8")
EndIf

RestArea(aAreaSX3)
RestArea(aArea)

Return(lRetorno)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaCanAltPC?Autor ?Eduardo Riera         ?Data ?1.08.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Verifica se um item de pedido de compra pode ser alterado    ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := MaCanAltPC(ExpC1,ExpL1,ExpC2)					   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela de pedido compra                      ³±?
±±?         ³ExpL1: Indica se o help deve ser disparado                   ³±?
±±?         ³ExpC2: Codigo do help que foi gerado se o mesmo nao foi dispa³±?
±±?         ?      rado                                                  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: .T. - Se o pedido de compra pode ser alterado         ³±?
±±?         ?      .F. - Se o pedido de compra nao pode ser alterado     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar se o pedido de compra³±?
±±?         ³pode ser excluida sem maiores problemas para a integridade do³±?
±±?         ³sistema                                                      ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaCanAltPC(cAliasPC,lHelp,cHelp)

Local lRetorno := .T.
DEFAULT lHelp  := .T.
DEFAULT cHelp  := ""
Do Case
Case (cAliasSC7)->C7_QUJE > 0
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A120ALTPC")
	Else
		cHelp := "A120ALTPC"
	EndIf
Case (cAliasSC7)->C7_RESIDUO > "S"
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A120ALTPC")
	Else
		cHelp := "A120ALTPC"
	EndIf
Case (cAliasSC7)->C7_QTDACLA > 0
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A120ALTPC")
	Else
		cHelp := "A120ALTPC"
	EndIf		
EndCase
Return(lRetorno)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaCanDelPC?Autor ?Eduardo Riera         ?Data ?1.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Verifica se um item da pedido de compra pode ser excluido    ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := MaCanDelPC(ExpC1,ExpL1,ExpC2)					   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela de pedido de compra                   ³±?
±±?         ³ExpL2: Indica se o help deve ser disparado                   ³±?
±±?         ³ExpC2: Codigo do help que foi gerado se o mesmo nao foi dispa³±?
±±?         ?      rado                                                  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: .T. - Se o pedido de compra pode ser excluido         ³±?
±±?         ?      .F. - Se a pedido de compra nao pode ser excluido     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar se o pedido de compra³±?
±±?         ³pode ser excluida sem maiores problemas para a integridade   ³±?
±±?         ³do sistema                                                   ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaCanDelPC(cAliasSC7,lHelp,cHelp)

Local lRetorno := .T.
DEFAULT lHelp  := .T.
DEFAULT cHelp  := ""
Do Case
Case (cAliasSC7)->C7_QUJE > 0
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A120NDEL")
	Else
		cHelp := "A120NDEL"
	EndIf
Case (cAliasSC7)->C7_RESIDUO > "S"
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A120NDEL")
	Else
		cHelp := "A120NDEL"
	EndIf
Case (cAliasSC7)->C7_QTDACLA > 0
	lRetorno :=.F.
	If ( lHelp )
		Help(" ",1,"A120NDEL")
	Else
		cHelp := "A120NDEL"
	EndIf		
EndCase
Return(lRetorno)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaAvalPC  ?Autor ?Eduardo Riera         ?Data ?2.08.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Rotina de avaliacao dos eventos de um pedido de compra       ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaAvalPC(ExpC1,ExpN1,ExpL1,ExpL2,ExpC2,ExpL3,ExpB1,ExpL4)	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1:*Alias da tabela de pedido de compra                   ³±?
±±?         ³ExpN1:*Codigo do Evento                                      ³±?
±±?         ?      [1] Implantacao de uma Pedido de compra               ³±?
±±?         ?      [2] Estorno de um pedido de compra                    ³±?
±±?         ?      [3] Exclusao de um pedido de compra                   ³±?
±±?         ?      [4] Liberacao de um pedido de compra                  ³±?
±±?         ?      [5] Estorno da liberacao do pedido de compra          ³±?
±±?         ?      [6] Implantacao de um pre-documento de entrada        ³±?
±±?         ?      [7] Estorno de um pre-documento de entrada            ³±?
±±?         ?      [8] Implantacao de um documento de entrada            ³±?
±±?         ?      [9] Estorno de um documento de entrada                ³±?
±±?         ?      [10]Implantacao de um documento de entrada - Average  ³±?
±±?         ?      [11]Estorno de um documento de entrada     - Average  ³±?
±±?         ³ExpL1: Indica se este eh o ultimo registro a ser processado  ³±?
±±?         ?                                                       (OPC)³±?
±±?         ³ExpL2: Indica se somente os acumalados devem ser atualizados ³±?
±±?         ?                                                       (OPC)³±?
±±?         ³ExpC2: Alias da item do documento de entrada            (OPC)³±?
±±?         ³ExpL3: Indica se a amarracao fornecedor/produto deve ser atu-³±?
±±?         ?      alizada ( DEFAULT .F. )                          (OPC)³±?
±±?         ³ExpB1: CodeBlock de contabilizacao                      (OPC)³±?
±±?         ?      E passado para o codebock o codigo do evento          ³±?
±±?         ³ExpL4: Indica se o SB2 deve ser atualizado                   ³±?
±±?         ?              ( DEFAULT .T. )                          (OPC)³±?
±±?         ³ExpL9: Indica se o SA5 dever?ser atualizado pelo codigo do  |±±
±±?         ?      produto ou pela referência de grade                   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ?T.	                                                       ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar os eventos vinculados³±?
±±?         ³a um pedido de compra:                                       ³±?
±±?         ³A) Atualizacao das tabelas complementares.                   ³±?
±±?         ³B) Atualizacao das informacoes complementares ao PC          ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaAvalPC(cAliasSC7,nEvento,lLast,lAcumulados,cAliasSD1,lIncSA5,bCtbOnLine,lAtuSB2,lIncRef)

Local aArea 	:= GetArea()
Local aAreaSCR 	:= SCR->(GetArea())
Local aAreaSF4  := SF4->(GetArea())
Local aLibera   := {}
Local aEstSC1   := {}
Local aRecnoSC8 := {}
Local nX        := 0
Local nQtdSol   := 0
Local nQtdaEst  := 0
Local nQtdaEst2 := 0
Local nQtdSC    := 0
Local nQtdSC2   := 0
Local nRegSC1   := 0
Local nQtdALib  := 0
Local nQtdLib   := 0
Local nQuantRes := 0
Local lContinua := .T.
Local lQuery    := .F.                      
Local cQuery    := ""
Local cTipo     := ""
Local cFilSC1	:= ""
Local cFilSC7 := xFilial("SC7")
Local cAliasSCQ := "SCQ"
Local cAliasSC8 := "SC8"
Local cSC8Ident := ""
Local cFilialEnt:= SB2->(SC7->(xFilEnt((cAliasSC7)->C7_FILENT)))
Local cEntrega  := If(SuperGetMv("MV_PCFILEN"),IIF(!Empty(cFilialEnt),cFilialEnt,xFilial("SB2")),xFilial("SB2"))
Local lFISCORI	:= SC7->(FieldPos("C7_FISCORI")) > 0
Local lRestCot  := If(SuperGetMV("MV_PCEXCOT")=="1",.T.,.F.)
Local lPCExCot	:= lRestCot
Local lSb1TES   := SuperGetMv("MV_SB1TES",.F.,.F.)
Local lEncSC3   := .T.
Local cProdRef      := " "
Local lReferencia   := .F. 
Local nTamPed       := TamSX3("C7_NUM")[1] 
Local aArea2 := {}		
Local aAreaSC1 := {}
Local aAreaSC6 := {}		
Local aAreaSC7 := {}	
Local lCniEstMed   := FindFunction("ValidaCNI") .And. ValidaCNI() .And. IsInCallStack('CN120ESTOR') //Estorno de Medição CNI
Local cItemSC8 := ""	
DEFAULT cAliasSC7   := "SC7"
DEFAULT cAliasSD1   := "SD1"
DEFAULT lLast       := .F.
DEFAULT lAcumulados := .F.
DEFAULT lIncSA5     := .F.
DEFAULT lATUSB2     := .T.
DEFAULT bCtbOnLine  := {|| .T.}
DEFAULT lIncRef     := .F.
Do Case
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de um Pedido de Compra                                      ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 1
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza dados complementares do Pedido de Compra                       ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !lAcumulados
		If ( cAliasSC7 == "SC7" )
			RecLock(cAliasSC7)
			If !IsInCallStack("MATA160") .Or. ( IsInCallStack("MATA160") .And. Empty(SC8->C8_ACCNUM) )// Grava o campo usuário apenas se não possuir integração com o Market Place
				(cAliasSC7)->C7_USER := SA2->(RetCodUsr())
			EndIf
			If Empty((cAliasSC7)->C7_ENCER)
				(cAliasSC7)->C7_ENCER := If((cAliasSC7)->C7_QUANT - (cAliasSC7)->C7_QUJE > 0," ","E")
			EndIf
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza as tabelas auxiliares                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lAtuSB2 .And. (cAliasSC7)->C7_RESIDUO <> "S"
		
		dbSelectArea("SF4")
		dbSetOrder(1)
		MsSeek(xFilial("SF4",(cAliasSC7)->C7_FILIAL)+(cAliasSC7)->C7_TES)
		If SF4->F4_ESTOQUE == "S" .Or. Empty((cAliasSC7)->C7_TES)
			dbSelectArea("SB2")
			dbSetOrder(1)
			If ( !MsSeek(cEntrega+(cAliasSC7)->C7_PRODUTO+(cAliasSC7)->C7_LOCAL) )
				CriaSB2((cAliasSC7)->C7_PRODUTO,(cAliasSC7)->C7_LOCAL,cEntrega)
			EndIf
			If (cAliasSC7)->(FieldPos("C7_ESTOQUE")) > 0  .And. lSb1TES
				If (cAliasSC7)->C7_ESTOQUE == "S" .Or. Empty((cAliasSC7)->C7_ESTOQUE)
					GravaB2Pre("+",(cAliasSC7)->C7_QUANT-(cAliasSC7)->C7_QUJE,(cAliasSC7)->C7_TPOP,((cAliasSC7)->C7_QUANT-(cAliasSC7)->C7_QUJE)*(cAliasSC7)->C7_QTSEGUM/(cAliasSC7)->C7_QUANT)
				EndIf
			Else
				GravaB2Pre("+",(cAliasSC7)->C7_QUANT-(cAliasSC7)->C7_QUJE,(cAliasSC7)->C7_TPOP,((cAliasSC7)->C7_QUANT-(cAliasSC7)->C7_QUJE)*(cAliasSC7)->C7_QTSEGUM/(cAliasSC7)->C7_QUANT)
			EndIf
		EndIf
	EndIf
			
	If !lAcumulados
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Baixo as solicitacoes de compra vinculadas                              ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ( !Empty((cAliasSC7)->C7_NUMSC) )
			If ( (cAliasSC7)->C7_TIPO == 1 .Or. (cAliasSC7)->C7_TIPO == 3 )
				If ( !Empty((cAliasSC7)->C7_NUMCOT) ) //-- Pedido de compra originado por cotacao
					If !(xFilial("SC8",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL)) == SC8->C8_FILIAL .And.;
						(cAliasSC7)->C7_NUMCOT == SC8->C8_NUM .And.;
						(cAliasSC7)->C7_PRODUTO == SC8->C8_PRODUTO .And.;
						(cAliasSC7)->C7_FORNECE == SC8->C8_FORNECE .And.;
						(cAliasSC7)->C7_LOJA == SC8->C8_LOJA .And.;
						(cAliasSC7)->C7_ITEM == SC8->C8_ITEMPED .And.;
						(cAliasSC7)->C7_NUM == SC8->C8_NUMPED )
						dbSelectArea("SC8")
						dbSetOrder(3)
						MsSeek(xFilial("SC8",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL))+(cAliasSC7)->C7_NUMCOT+(cAliasSC7)->C7_PRODUTO+(cAliasSC7)->C7_FORNECE+(cAliasSC7)->C7_LOJA+(cAliasSC7)->C7_NUM+(cAliasSC7)->C7_ITEM)
					EndIf
					If !(xFilial("SCE",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL)) == SCE->CE_FILIAL .And.;
						SC8->C8_NUM == SCE->CE_NUMCOT .And.;
						SC8->C8_PRODUTO == SCE->CE_PRODUTO .And.;
						SC8->C8_FORNECE == SCE->CE_FORNECE .And.;
						SC8->C8_LOJA == SCE->CE_LOJA .And.;
						SC8->C8_ITEM == SCE->CE_ITEMCOT )
						dbSelectArea("SCE")
						dbSetOrder(1)
						MsSeek(xFilial("SCE",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL))+SC8->C8_NUM+SC8->C8_ITEM+SC8->C8_PRODUTO+SC8->C8_FORNECE+SC8->C8_LOJA)
					EndIf
					If !( xFilial("SC1",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL)) == SC1->C1_FILIAL .And.;
						SC8->C8_NUM == SC1->C1_COTACAO .And.;
						SC8->C8_PRODUTO == SC1->C1_PRODUTO .And.;
						SC8->C8_IDENT == SC1->C1_IDENT )
						dbSelectArea("SC1")
						dbSetOrder(5)
						MsSeek(xFilial("SC1",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL))+SC8->C8_NUM+SC8->C8_PRODUTO+SC8->C8_IDENT)
					EndIf
					nQtdAEst := SCE->CE_QUANT-(cAliasSC7)->C7_QUANT
					If nQtdAEst < 0
						nQtdaEst  := SC8->C8_QUANT-(cAliasSC7)->C7_QUANT
					EndIf
					nQtdAEst := Max(0,nQtdAEst)
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Quando a quantidade do Pedido de Compra for alterada para um valor menor do ?
					//³que a soma das SC´s vinculadas a cotação, deve-se diminuir o Qtd da Cotacao ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If ( nQtdAEst > 0 )
						RecLock("SC8")
						SC8->C8_QUANT -= nQtdAEst
						RecLock("SCE")
						SCE->CE_QUANT := Max(SCE->CE_QUANT - nQtdAEst,0)
					EndIf
					While ( !Eof() .And. xFilial("SC1",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL)) == SC1->C1_FILIAL .And.;
						SC8->C8_NUM     == SC1->C1_COTACAO .And.;
						SC8->C8_PRODUTO == SC1->C1_PRODUTO .And.;
						SC8->C8_IDENT   == SC1->C1_IDENT )
						nRegSC1   := 0
						If ( nQtdAEst > 0 )
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³Quando a quantidade do Pedido de Compra for alterada para um valor menor do ?
							//³que a soma das SC´s vinculadas a cotação, deve-se diminuir a Qtd da SC.     ?
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							RecLock("SC7")
							nQtdSol := SC7->C7_QTDSOL
							SC7->C7_QTDSOL := Min(SC1->C1_QUJE,nQtdAEst)
							
							SC1->(dbSkip())
							nRegSC1 := SC1->(RecNo())
							SC1->(dbSkip(-1))
							
							If SC7->C7_QTDSOL<>0
								nQtdAEst -= SC7->C7_QTDSOL
								RecLock("SC1")
								MaAvalSC("SC1",7,"SC8","SC7",Nil,lAtuSB2)
							EndIf
							SC7->C7_QTDSOL := nQtdSol
							If nQtdAEst == 0
								Exit
							EndIf
						Else
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³Implantacao de um pedido de compra atraves de cotacao                       ?
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							nQtdSol := SC7->C7_QTDSOL
							RecLock("SC1",.F.)
							SC7->C7_QTDSOL := Min(SC7->C7_QUANT-nQtdSol,SC1->C1_QUANT-SC1->C1_QUJE)
							If SC7->C7_QTDSOL > 0
								MaAvalSC("SC1",6,"SC8","SC7",Nil,lAtuSB2)
								SC7->C7_QTDSOL += nQtdSol
							Else
								SC7->C7_QTDSOL := nQtdSol
							EndIf
							If SC7->C7_QTDSOL>=SC7->C7_QUANT
								Exit
							EndIf
						EndIf
						dbSelectArea("SC1")
						If ( nRegSC1 <> 0 )
							MsGoto(nRegSC1)
						Else
							dbSkip()
						EndIf
					EndDo
				ElseIf !Empty( (cAliasSC7)->C7_NUMSC ) //-- Pedido de compra com SC vinculada
					dbSelectArea("SC1")
					dbSetOrder(2)
					cFilSC1 := xFilial("SC1",If(SC7->(FieldPos("C7_FISCORI")) == 0,NIL,(cAliasSC7)->C7_FISCORI))
				  	If ( MsSeek(cFilSC1+(cAliasSC7)->C7_PRODUTO+(cAliasSC7)->C7_NUMSC+(cAliasSC7)->C7_ITEMSC) )
						MaAvalSC("SC1",6,,"SC7")
						RecLock("SC7")
					EndIf
				ElseIf SC7->(FieldPos("C7_CODED")) > 0 .And. !Empty((cAliasSC7)->C7_CODED) //-- Pedido de edital
					SC1->(dbOrderNickName("GCP01"))
					cFilSC1 := xFilial("SC1",If(SC7->(FieldPos("C7_FISCORI")) == 0,NIL,(cAliasSC7)->C7_FISCORI))
				  	SC1->(dbSeek(cFilSC1+(cAliasSC7)->(C7_CODED+C7_NUMPR+C7_PRODUTO)))
				  	While !SC1->(EOF()) .And. SC1->(C1_FILIAL+C1_CODED+C1_NUMPR+C1_PRODUTO) == xFilial("SC1")+(cAliasSC7)->(C7_CODED+C7_NUMPR+C7_PRODUTO)
				  		//-- Atualiza acumulado das SCs atendidas pelo pedido do edital
						MaAvalSC("SC1",6,,"SC7")
											
						SC1->(dbSkip())
					End
				EndIf
			Else
				dbSelectArea("SC3")
				dbSetOrder(3)          
				If ( MsSeek(xFilial("SC3")+(cAliasSC7)->C7_PRODUTO+(cAliasSC7)->C7_NUMSC+(cAliasSC7)->C7_ITEMSC,.F.) )
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//?Ponto de entrada para impedir o encerramento do Contrato de Parceria ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If ExistBlock("MT125ENC")
						lEncSC3 := ExecBlock("MT125ENC",.F.,.F.,{nEvento,cAliasSC7})
					EndIf
					If lEncSC3
						RecLock("SC3",.F.)
						SC3->C3_QUJE  += (cAliasSC7)->C7_QTDSOL
						SC3->C3_ENCER := IIf(SC3->C3_QUANT - SC3->C3_QUJE > 0," ","E")
					EndIf
				EndIf
			EndIf
		EndIf
		If ( lLast .And. (cAliasSC7)->C7_RESIDUO <> "S")
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Neogrid - Verifica a existencia da Administracao colaborativa de Pedidos?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ( NeoEnable("001") )
				NeoEnvPC((cAliasSC7)->C7_NUM)
			EndIf
		EndIf
	EndIf
	If (cAliasSC7)->C7_RESIDUO <> "S"
		If lIncSA5
			dbSelectArea("SB1")
			dbSetOrder(1)
			MsSeek(xFilial("SB1")+(cAliasSC7)->C7_PRODUTO)
			
			AtuSA5((cAliasSC7)->C7_FORNECE,(cAliasSC7)->C7_LOJA,(cAliasSC7)->C7_PRODUTO,lIncRef)
			If !Empty(SB1->B1_GRUPO)
				dbSelectArea("SBM")
 				dbSetOrder( 1 )
				If dbSeek(xFilial("SBM")+SB1->B1_GRUPO)
					dbSelectArea("SAD")
					dbSetOrder(1)
					If !MsSeek(xFilial()+(cAliasSC7)->C7_FORNECE+(cAliasSC7)->C7_LOJA+SB1->B1_GRUPO,.F.)
						RecLock("SAD",.T.)
						SAD->AD_FILIAL	:= xFilial("SAD")
						SAD->AD_FORNECE := (cAliasSC7)->C7_FORNECE
						SAD->AD_LOJA    := (cAliasSC7)->C7_LOJA
						SAD->AD_NOMEFOR := SA2->A2_NOME
						SAD->AD_GRUPO   := SB1->B1_GRUPO
						SAD->AD_NOMGRUP := SBM->BM_DESC
						MsUnlock()
					EndIf
				EndIf
			EndIf
		EndIf
		
		If !Empty((cAliasSC7)->C7_SEQMRP) .And. !lAcumulados .And. Type("aPeriodos") == "A"
			If IsInCallStack("MATA710")
				A711CriSH5(SC7->C7_DATPRF,SC7->C7_PRODUTO,CriaVar("C2_OPC",.F.),Space(Len(SB1->B1_REVATU)),"SC7",SC7->(Recno()),SC7->C7_NUM,SC7->C7_ITEM,SC7->C7_OP,Max(0,SC7->C7_QUANT-SC7->C7_QUJE),"2",.T.,nil,nil,.T.)
			ElseIf IsInCallStack("MATA712")
				A712CriCZI(SC7->C7_DATPRF,SC7->C7_PRODUTO,CriaVar("C2_OPC",.F.),Space(Len(SB1->B1_REVATU)),"SC7",SC7->(Recno()),SC7->C7_NUM,SC7->C7_ITEM,SC7->C7_OP,Max(0,SC7->C7_QUANT-SC7->C7_QUJE),"2",.T.,/*13*/,/*14*/,.F.,/*16*/,/*17*/,/*18*/,/*19*/,/*20*/,/*21*/,/*22*/,/*23*/,/*24*/,/*25*/,/*26*/)
			EndIf
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Atualiza os arquivos do SIGAPMS                                         ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If GetMV("MV_INTPMS",,"N") == "S"
			PMSWritePC(1,cAliasSC7)
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If AllTrim( Upper( ProcName(1) ) ) # "MA215PROC"
			If (cAliasSC7)->C7_TIPO != 2
				If Empty((cAliasSC7)->C7_NUMCOT)
					If IsInCallStack("GCPA011") .and. Type('aRatCTBPC') == 'A'
						If Len(aRatCTBPC) == 0			//So efetua lancamento se nao houver rateio 
			   		   		LancaPCO("SC7","000052","07","MATA121")
			  	   		EndIf
					Else
						LancaPCO("SC7","000052","01","MATA121")
					EndIf
				   
					If lLast
						LancaPCO("SC7","000052","03","MATA121")
					EndIf
				Else
					LancaPCO("SC7","000052","02","MATA121")
				Endif
			Else
				If Empty((cAliasSC7)->C7_NUMCOT)
					LancaPCO("SC7","000053","01","MATA122")
					If lLast
						LancaPCO("SC7","000053","03","MATA122")
					EndIf
				Else                
					LancaPCO("SC7","000053","02","MATA122")
				Endif
			EndIf
		EndIf
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Estorno de um pedido de Compra                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 2
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza as tabelas auxiliares                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

	dbSelectArea("SF4")
	dbSetOrder(1)
	MsSeek(xFilial("SF4",(cAliasSC7)->C7_FILIAL)+(cAliasSC7)->C7_TES)
	If SF4->F4_ESTOQUE == "S" .Or. Empty((cAliasSC7)->C7_TES)
		
		dbSelectArea("SB2")
		dbSetOrder(1)
		If ( !MsSeek(cEntrega+(cAliasSC7)->C7_PRODUTO+(cAliasSC7)->C7_LOCAL) )
			CriaSB2((cAliasSC7)->C7_PRODUTO,(cAliasSC7)->C7_LOCAL,cEntrega)
		EndIf
		If (cAliasSC7)->C7_RESIDUO <> "S"
			If (cAliasSC7)->(FieldPos("C7_ESTOQUE")) > 0  .And. lSb1TES
				If (cAliasSC7)->C7_ESTOQUE == "S" .Or. Empty((cAliasSC7)->C7_ESTOQUE)
					GravaB2Pre("-",(cAliasSC7)->C7_QUANT-(cAliasSC7)->C7_QUJE,(cAliasSC7)->C7_TPOP,((cAliasSC7)->C7_QUANT-(cAliasSC7)->C7_QUJE)*(cAliasSC7)->C7_QTSEGUM/(cAliasSC7)->C7_QUANT)
				EndIf
			Else
				GravaB2Pre("-",(cAliasSC7)->C7_QUANT-(cAliasSC7)->C7_QUJE,(cAliasSC7)->C7_TPOP,((cAliasSC7)->C7_QUANT-(cAliasSC7)->C7_QUJE)*(cAliasSC7)->C7_QTSEGUM/(cAliasSC7)->C7_QUANT)
			Endif
		Endif
	EndIf
	
	If !lAcumulados
		If ( !Empty((cAliasSC7)->C7_NUMSC) ) //-- Pedido com SC vinculada
			If ( (cAliasSC7)->C7_TIPO == 1 .Or. (cAliasSC7)->C7_TIPO == 3 )
				If ( Empty((cAliasSC7)->C7_NUMCOT) )
					dbSelectArea("SC1")
					dbSetOrder(2)
					cFilSC1 := If(SC7->(FieldPos("C7_FISCORI")) == 0,xFilial("SC1"),IIF((cAliasSC7)->C7_FISCORI<>' ',(cAliasSC7)->C7_FISCORI,xFilial("SC1")))
					cFilSC1 := xFilial("SC1",cFilSC1)
					MsSeek(cFilSC1+(cAliasSC7)->C7_PRODUTO+(cAliasSC7)->C7_NUMSC+(cAliasSC7)->C7_ITEMSC)
					MaAvalSC("SC1",7,,cAliasSC7,,,lCniEstMed)
				EndIf
			Else
				dbSelectArea("SC3")
				dbSetOrder(3)
				If ( MsSeek(xFilial("SC3")+(cAliasSC7)->C7_PRODUTO+(cAliasSC7)->C7_NUMSC+(cAliasSC7)->C7_ITEMSC,.F.) )
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//?Ponto de entrada para impedir o encerramento do Contrato de Parceria ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If ExistBlock("MT125ENC")
						lEncSC3 := ExecBlock("MT125ENC",.F.,.F.,{nEvento,cAliasSC7})
					EndIf
					If lEncSC3
						RecLock("SC3",.F.)
						SC3->C3_QUJE  := IIf((cAliasSC7)->C7_QTDSOL > SC3->C3_QUJE,0,SC3->C3_QUJE - (cAliasSC7)->C7_QTDSOL)
						SC3->C3_ENCER := IIf(SC3->C3_QUANT - SC3->C3_QUJE > 0," ","E")
					EndIf
				EndIf
			EndIf
		ElseIf SC7->(FieldPos("C7_CODED")) > 0 .And. !Empty((cAliasSC7)->C7_CODED) //-- Pedido gerado por edital, volta SCs
			SC1->(dbOrderNickName("GCP01"))
			cFilSC1 := xFilial("SC1",If(SC7->(FieldPos("C7_FISCORI")) == 0,NIL,(cAliasSC7)->C7_FISCORI))
			SC1->(dbSeek(cFilSC1+(cAliasSC7)->(C7_CODED+C7_NUMPR+C7_PRODUTO)))
			While !SC1->(EOF()) .And. SC1->(C1_FILIAL+C1_CODED+C1_NUMPR+C1_PRODUTO) == xFilial("SC1")+(cAliasSC7)->(C7_CODED+C7_NUMPR+C7_PRODUTO)
				MaAvalSC("SC1",7,,cAliasSC7)
				SC1->(dbSkip())
			End
		EndIf
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza os arquivos do SIGAPMS                                         ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If GetMV("MV_INTPMS",,"N") == "S"
		PMSWritePC(2,cAliasSC7)
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Exclusao de um Pedido de Compra                                         ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 3
	If SC7->(FieldPos("C7_ACCNUM"))>0 .And. !Empty((cAliasSC7)->C7_ACCNUM)
		lRestCot := .T.
	EndIf

	If ( !Empty((cAliasSC7)->C7_NUMSC) ) .And. lContinua //-- Pedido com SC vinculada
		If ( (cAliasSC7)->C7_TIPO == 1 .Or. (cAliasSC7)->C7_TIPO == 3 )
			If !( Empty((cAliasSC7)->C7_NUMCOT) ) //-- Pedido gerado por cotacao
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Atualiza as tabelas auxiliares                                          ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If !lAcumulados
					
					If lRestCot
						dbSelectArea("SC8")
						dbSetOrder(1)
						
						aRecnoSC8 := {}
						
						#IFDEF TOP
							
							SC8->( dbCommit() )
							
							cAliasSC8 := GetNextAlias()
							
							cQuery := "SELECT C8_FILIAL,C8_NUM,C8_NUMPED,C8_PRODUTO,C8_ITEM,C8_IDENT,SC8.R_E_C_N_O_ SC8RECNO "
							cQuery += "FROM "+RetSqlName("SC8")+" SC8 "
							cQuery += "WHERE "
							cQuery += "C8_FILIAL ='" + xFilial( "SC8", If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL) )   + "' AND "
							cQuery += "C8_NUM ='" + ( cAliasSC7 )->C7_NUMCOT   + "' AND "
							cQuery += "(C8_NUMPED IN('XXXXXX','"+( cAliasSC7 )->C7_NUM+"') ) AND "
							cQuery += "C8_PRODUTO ='" + ( cAliasSC7 )->C7_PRODUTO    + "' AND "
							cQuery += "C8_FILENT  = '" +(cAliasSC7)->C7_FILENT +"' AND "
							cQuery += "D_E_L_E_T_=' '"
							
							cQuery := ChangeQuery( cQuery )
							
							dbUseArea( .T., "TOPCONN", TcGenQry( ,, cQuery ), cAliasSC8, .F.,.T. )

							//obtem o numero do item da cotação
							While !( cAliasSC8 )->( Eof() )
								If (cAliasSC8)->C8_NUMPED == (cAliasSC7)->C7_NUM
									cItemSC8 := (cAliasSC8)->C8_IDENT 
									Exit
								EndIf                                
								(cAliasSC8)->( dbSkip() )
							EndDo
														
							(cAliasSC8)->( dbEval( ;
								{|| AAdd( aRecnoSC8, ( cAliasSC8 )->SC8RECNO ) } ,; //ação
								{|| (cAliasSC8)->C8_IDENT == cItemSC8}) )//condição
														
							( cAliasSC8 )->( dbCloseArea() )
							
							dbSelectArea("SC8")
							
						#ELSE	
							
							MsSeek(xFilial("SC8",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL))+(cAliasSC7)->C7_NUMCOT)
							While !Eof() .And. xFilial("SC8",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL)) == SC8->C8_FILIAL .And. SC8->C8_NUM == SC7->C7_NUMCOT
								If SC8->C8_NUMPED != "XXXXXX" .And. !Empty(SC8->C8_NUMPED) .And. SC8->C8_NUMPED != (cAliasSC7)->C7_NUM
									aAreaSC7 := SC7->(GetArea())
									If SC7->(msSeek(cFilSC7+SC8->C8_NUMPED))
										lRestCot := .F.
										RestArea(aAreaSC7)
										Exit
									EndIf
									RestArea(aAreaSC7)
								EndIf

								If SC8->C8_PRODUTO == (cAliasSC7)->C7_PRODUTO
									AAdd( aRecnoSC8, SC8->( Recno() ) )
									cItemSC8 := (cAliasSC8)->C8_ITEM 
                                EndIf

								dbSelectArea("SC8")
								dbSkip()
							EndDo
							
						#ENDIF
						
						dbSelectArea("SC8")
						dbSetOrder(8)
						MsSeek(xFilial("SC8",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL))+(cAliasSC7)->C7_NUMCOT+(cAliasSC7)->C7_FORNECE+(cAliasSC7)->C7_LOJA+(cAliasSC7)->C7_PRODUTO+cItemSC8)

						cSC8Ident := SC8->C8_IDENT                     

						dbSelectArea("SCE")
						dbSetOrder(1)
						If MsSeek(xFilial("SCE",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL))+SC8->C8_NUM+SC8->C8_ITEM+SC8->C8_PRODUTO+SC8->C8_FORNECE+SC8->C8_LOJA)
							RecLock("SCE",.F.,.T.)
							dbDelete()
							MsUnlock()
						EndIf
					Else
						dbSelectArea("SC8")
						dbSetOrder(3)
						If MsSeek(xFilial("SC8",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL))+(cAliasSC7)->C7_NUMCOT+(cAliasSC7)->C7_PRODUTO+(cAliasSC7)->C7_FORNECE+(cAliasSC7)->C7_LOJA+(cAliasSC7)->C7_NUM+(cAliasSC7)->C7_ITEM)
							RecLock("SC8",.F.,.T.)
							SC8->C8_OBS := STR0003 //"P.C. Cancel., S.C. Estornada"
							MsUnlock()
						Endif
					EndIf
					
					dbSelectArea("SC1")
					dbSetOrder(5)
					MsSeek(xFilial("SC1",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL))+SC8->C8_NUM+SC8->C8_PRODUTO+SC8->C8_IDENT)
					While ( !Eof() .And. xFilial("SC1",If(lFISCORI,(cAliasSC7)->C7_FISCORI,NIL)) == SC1->C1_FILIAL .And.;
							SC8->C8_NUM     == SC1->C1_COTACAO .And.;
							SC8->C8_PRODUTO == SC1->C1_PRODUTO .And.;
							SC8->C8_IDENT   == SC1->C1_IDENT )
						aadd(aEstSC1,RecNo())
						dbSelectArea("SC1")
						dbSkip()
					EndDo
					
					For nX := 1 To Len(aEstSC1)
						SC1->(MsGoto(aEstSC1[nX]))
						RecLock("SC1",.F.)
						MaAvalSC("SC1",7,"SC8",cAliasSC7,,,lPCExCot)
						If SC7->C7_QTDSOL == 0
							Exit
						EndIf
					Next nX
					
                	If lRestCot
						For nX := 1 to Len( aRecnoSC8 )
							SC8->( msGoto( aRecnoSC8[ nX ] ) )
		 					If cSC8Ident == SC8->C8_IDENT .Or. lLast
		 						RecLock("SC8",.F.,.T.)
								SC8->C8_NUMPED  := ""
								SC8->C8_ITEMPED := ""
								SC8->C8_MOTIVO  := ""
								MsUnlock()
								PcoDetLan("000052","02","MATA121",.T.) 
							EndIf 
						Next nX
                	EndIf
				EndIf
			EndIf
		EndIf
	ElseIf SC7->(FieldPos("C7_CODED")) > 0 .And. !Empty((cAliasSC7)->C7_CODED) //-- Pedido gerado por edital, volta SCs
		SC1->(dbOrderNickName("GCP01"))
		cFilSC1 := xFilial("SC1",If(SC7->(FieldPos("C7_FISCORI")) == 0,NIL,(cAliasSC7)->C7_FISCORI))
		SC1->(dbSeek(cFilSC1+(cAliasSC7)->(C7_CODED+C7_NUMPR+C7_PRODUTO)))
		While !SC1->(EOF()) .And. SC1->(C1_FILIAL+C1_CODED+C1_NUMPR+C1_PRODUTO) == xFilial("SC1")+(cAliasSC7)->(C7_CODED+C7_NUMPR+C7_PRODUTO)
			MaAvalSC("SC1",7,,cAliasSC7)
			SC1->(dbSkip())
		End
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Exclui o documento se gerado na CPM                      ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
	If AliasInDic("CPM")
		A181EXCCPM(If((cAliasSC7)->C7_TIPO == 1,'2','3'),(cAliasSC7)->C7_NUM)
	EndIf		
		
	If !lAcumulados
		If ( lLast ) .And. lContinua
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Verifica se tem SCR gravado faz o estorno.                   ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SCR")
			dbSetOrder(2)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
			//?A rotina a seguir garante o funcionamento correto na base historica dos clientes, ?
			//?pois com a implementacao do parametro MV_AEAPROV que estende o controle de alcadas?
			//?para a AE, em 22/07/04 foi alterada a gravacao do tipo do doc para PC e AE afim   ?
			//?de diferenciar o tipo de doc nos arquivos SC7 e SCR sem afetar o funcionamento ant?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
			cTipo := "PC" 
			MsSeek(xFilial() + cTipo + (cAliasSC7)->C7_NUM)
			
			If SCR->( Eof() ) 
				cTipo := "AE" 
				MsSeek(xFilial() + cTipo + (cAliasSC7)->C7_NUM)
			EndIf 

			While !Eof() .And. SCR->CR_FILIAL+Substr(SCR->CR_NUM,1,len((cAliasSC7)->C7_NUM)) == ;
			xFilial("SCR")+Substr((cAliasSC7)->C7_NUM,1,len((cAliasSC7)->C7_NUM)) .And. SCR->CR_TIPO == cTipo 

				If SCR->CR_STATUS == "03"
					MaAlcDoc({SCR->CR_NUM, cTipo,SCR->CR_VALLIB,,,(cAliasSC7)->C7_APROV},SCR->CR_DATALIB,3)
				EndIf
				Reclock("SCR",.F.,.T.)
				dbDelete()
				dbSkip()
			EndDo
			
			cTipo := "IP" 
			MsSeek(xFilial() + cTipo + (cAliasSC7)->C7_NUM)
			
			While !Eof() .And. SCR->CR_FILIAL+Substr(SCR->CR_NUM,1,len((cAliasSC7)->C7_NUM)) == ;
			xFilial("SCR")+Substr((cAliasSC7)->C7_NUM,1,len((cAliasSC7)->C7_NUM)) .And. SCR->CR_TIPO == "IP" 

				If SCR->CR_STATUS == "03"
					MaAlcDoc({SCR->CR_NUM, cTipo,SCR->CR_VALLIB,,,(cAliasSC7)->C7_APROV},SCR->CR_DATALIB,3)
				Else
					//Exclui registros dos itens da alcada 
					If AliasInDic("DBM")
						MaAlcItEC(SCR->CR_NUM,cTipo,,,,,,3)
					EndIf
				EndIf
				Reclock("SCR",.F.,.T.)
				dbDelete()
				dbSkip()
			EndDo
			
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Neogrid - Verifica a existencia da Administracao colaborativa de Pedidos?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ( NeoEnable("001") )
				NeoEnvPC(cNumPC,2)
			EndIf
		EndIf
		If ExistBlock("MT120EXC")
			ExecBlock("MT120EXC",.f.,.f.)
		Endif
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza os arquivos do SIGAPMS                                         ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If GetMV("MV_INTPMS",,"N") == "S"
		PMSWritePC(3,cAliasSC7)
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If AllTrim( Upper( ProcName(1) ) ) # "MA215PROC"	
		If (cAliasSC7)->C7_TIPO != 2
			If Empty((cAliasSC7)->C7_NUMCOT)
				If FieldPos("C7_CODED") >0
					If !Empty(((cAliasSC7)->C7_CODED))
			   			LancaPCO("SC7","000052","07","MATA121",.T.)
					Else
				   		LancaPCO("SC7","000052","01","MATA121",.T.)
					EndIf
				Else
					LancaPCO("SC7","000052","01","MATA121",.T.)
				EndIf
				If lLast
					LancaPCO("SC7","000052","03","MATA121",.T.)
				EndIf
			Else
				LancaPCO("SC7","000052","02","MATA121",.T.)
			Endif
		Else
			If Empty((cAliasSC7)->C7_NUMCOT)
				LancaPCO("SC7","000053","01","MATA122",.T.)
				If lLast
					LancaPCO("SC7","000053","03","MATA122",.T.)
				EndIf
			Else                
				LancaPCO("SC7","000053","02","MATA122",.T.)
			Endif
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de um pre-documento de entrada                              ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 6
	If !Empty((cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEMPC)
		dbSelectArea("SC7")
		dbSetOrder(19)
		If !(xFilial("SC7")==SC7->C7_FILENT .And. SC7->C7_NUM==(cAliasSD1)->D1_PEDIDO .And. SC7->C7_ITEM==(cAliasSD1)->D1_ITEMPC .And. SC7->C7_PRODUTO==(cAliasSD1)->D1_COD  )
			MsSeek(xFilial("SC7")+(cAliasSD1)->D1_COD+ (cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEMPC)
		EndIf
		If !(Empty(SubStr(SC7->C7_ITEM,3)) .And. !Empty(SC7->C7_SEQUEN))
			RecLock("SC7",.F.)
			SC7->C7_QTDACLA += (cAliasSD1)->D1_QUANT
		EndIf
	EndIf	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Estorno de um pre-documento de entrada                                  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 7
	If !Empty((cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEMPC)
		dbSelectArea("SC7")
		dbSetOrder(19)
		If !(xFilial("SC7")==SC7->C7_FILENT .And. SC7->C7_NUM==(cAliasSD1)->D1_PEDIDO .And. SC7->C7_ITEM==(cAliasSD1)->D1_ITEMPC .And. SC7->C7_PRODUTO==(cAliasSD1)->D1_COD)
			MsSeek(xFilial("SC7")+(cAliasSD1)->D1_COD+ (cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEMPC)
		EndIf
		If !(Empty(SubStr(SC7->C7_ITEM,3)) .And. !Empty(SC7->C7_SEQUEN))
			RecLock("SC7",.F.)
			SC7->C7_QTDACLA -= (cAliasSD1)->D1_QUANT
		EndIf		
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de um documento de entrada                                  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 8
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualiza dados do Pedido de Compra/Autorizacao de Entrega?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !Empty((cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEMPC)
		dbSelectArea("SC7")
		dbSetOrder(19)
		If !(xFilial("SC7")==SC7->C7_FILENT .And. SC7->C7_NUM==(cAliasSD1)->D1_PEDIDO .And. SC7->C7_ITEM==(cAliasSD1)->D1_ITEMPC .And. SC7->C7_PRODUTO==(cAliasSD1)->D1_COD )
			MsSeek(xFilial("SC7")+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEMPC)
		EndIf
		If !(Empty(SubStr(SC7->C7_ITEM,3)) .And. !Empty(SC7->C7_SEQUEN))
			RecLock("SC7",.F.)
			SC7->C7_QUJE 	+= SD1->D1_QTDPEDI
			SC7->C7_ENCER 	:= IIF(C7_QUANT-C7_QUJE>0," ","E")
			dbSelectArea("SB2")
			dbSetOrder(1)
			If !(cEntrega==SB2->B2_FILIAL .And. SC7->C7_PRODUTO==SB2->B2_COD .And. SC7->C7_LOCAL==SB2->B2_LOCAL)
				If !MsSeek(cEntrega+SC7->C7_PRODUTO+SC7->C7_LOCAL)
					CriaSB2(SC7->C7_PRODUTO,SC7->C7_LOCAL,cEntrega)
				EndIf
			EndIf
			RecLock("SB2",.F.)
			
			If (cAliasSC7)->(FieldPos("C7_ESTOQUE"))> 0  .And. lSb1TES .And. !Empty((cAliasSC7)->C7_NUMSC)
				SC1->(dbSetOrder(2))
				SC1->(MsSeek(xFilial("SC1")+SC7->C7_PRODUTO+SC7->C7_NUMSC))				
				
				If SC1->(FieldPos("C1_ESTOQUE"))> 0
					If (SF4->F4_ESTOQUE=="S" .And. SC1->C1_ESTOQUE=="S") .Or. (SF4->F4_ESTOQUE=="S" .And. Empty(SC1->C1_ESTOQUE))
						SB2->B2_SALPEDI -= SD1->D1_QTDPEDI
						SB2->B2_SALPED2 -= ConvUm(SD1->D1_COD,SD1->D1_QTDPEDI,0,2)
					EndIf
				EndIf
			Else
				// Verifica se TES do pedido atualiza estoque. Se estiver em branco tambem atualiza o saldo previsto.
				dbSelectArea("SF4")
				dbSetOrder(1)
				If (MsSeek(xFilial("SF4")+(cAliasSC7)->C7_TES) .And. SF4->F4_ESTOQUE=="S") .Or.;
						Empty((cAliasSC7)->C7_TES)
					SB2->B2_SALPEDI -= SD1->D1_QTDPEDI
					SB2->B2_SALPED2 -= ConvUm(SD1->D1_COD,SD1->D1_QTDPEDI,0,2)
				EndIf
			EndIf 
			 
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Atualiza o arquivo de pre-requisicoes.                   ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nQtdALib := SD1->D1_QUANT
			dbSelectArea("SCQ")
			dbSetOrder(2)					
			#IFDEF TOP
				cAliasSCQ := "MAAVALSD1"
				lQuery    := .T.
				Do Case
				Case !Empty(SC7->C7_NUMCOT)
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ, "
					cQuery += RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_COTACAO='"+SC7->C7_NUMCOT+"' AND "
					cQuery += "SC1.C1_PRODUTO='"+SC7->C7_PRODUTO+"' AND "
					cQuery += "SC1.D_E_L_E_T_=' ' AND "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMSC=SC1.C1_NUM AND "
					cQuery += "SCQ.CQ_ITSC=SC1.C1_ITEM AND "
					cQuery += "SCQ.CQ_QUANT > SCQ.CQ_QTDISP AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
					cQuery += "ORDER BY SC1.C1_FILIAL,SC1.C1_DATPRF "
				Case SC7->C7_TIPO == 2
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ "	
					cQuery += "WHERE "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMAE='"+SC7->C7_NUM+"' AND "
					cQuery += "SCQ.CQ_ITAE='"+SC7->C7_ITEM+"' AND "
					cQuery += "SCQ.CQ_QUANT > SCQ.CQ_QTDISP AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
				OtherWise
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ, "	
					cQuery += RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_NUM='"+SC7->C7_NUMSC+"' AND "
					cQuery += "SC1.C1_ITEM='"+SC7->C7_ITEMSC+"' AND "					
					cQuery += "SC1.C1_PRODUTO='"+SC7->C7_PRODUTO+"' AND "
					cQuery += "SC1.D_E_L_E_T_=' ' AND "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMSC=SC1.C1_NUM AND "
					cQuery += "SCQ.CQ_ITSC=SC1.C1_ITEM AND "
					cQuery += "SCQ.CQ_QUANT > SCQ.CQ_QTDISP AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
					cQuery += "ORDER BY SC1.C1_FILIAL,SC1.C1_DATPRF "					
				EndCase
				
				cQuery := ChangeQuery(cQuery)
				
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSCQ)
				
				dbSelectArea(cAliasSCQ)										
				While !Eof()
					If nQtdALib > 0
						SCQ->(MsGoto((cAliasSCQ)->SCQRECNO))
						If !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QUANT-SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP += nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA += nQtdLib
						EndIf	
					Else
						Exit
					EndIf
					dbSelectArea(cAliasSCQ)
					dbSkip()
				EndDo
				If lQuery
					dbSelectArea(cAliasSCQ)
					dbCloseArea()
					dbSelectArea("SCQ")
				EndIf
			#ELSE
				Do Case
				Case !Empty(SC7->C7_NUMCOT)
					dbSelectArea("SC1")
					dbSetOrder(5)
					MsSeek(xFilial("SC1") + SC7->C7_NUMCOT + SC7->C7_PRODUTO)
					While !Eof() .And. xFilial("SC1") == SC1->C1_FILIAL .And.;
							SC7->C7_NUMCOT == SC1->C1_COTACAO .And.;
							SC1->C1_PRODUTO == SC7->C7_PRODUTO
						AADD( aLibera,{SC1->C1_DATPRF,SC1->C1_QUJE,SC1->(RecNo())})
						dbSelectArea("SC1")
						dbSkip()
					EndDo
					aLibera:=aSort( aLibera,,, { | x , y | x[1] < y[1] } )
					For nX := Len(aLibera) To 1 STEP -1
						SC1->(MsGoto(aLibera[nx][3]))
						dbSelectArea("SCQ")
						dbSetOrder(2) //CQ2_FILIAL+CQ_NUMSC+CQ_ITEMSC
						MsSeek(xFilial("SCQ")+SC1->C1_NUM+SC1->C1_ITEM)
						While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
								SCQ->CQ_NUMSC == SC1->C1_NUM .And.;
								SCQ->CQ_ITSC == SC1->C1_ITEM
							If nQtdALib > 0 .And. SCQ->CQ_QUANT > SCQ->CQ_QTDISP .And. Empty(SCQ->CQ_NUMREQ) .And. !Localiza(SCQ->CQ_PRODUTO)
								RecLock("SCQ",.F.)			
								nQtdLib := Min(SCQ->CQ_QUANT-SCQ->CQ_QTDISP,nQtdALib)
								nQtdALib-= nQtdLib
								SCQ->CQ_QTDISP += nQtdLib
								SCQ->CQ_STATUSC:= ""
								dbSelectArea("SB2")
								dbSetOrder(1)
								MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
								Reclock("SB2",.F.)
								SB2->B2_QEMPSA += nQtdLib
							EndIf
							dbSelectArea("SCQ")
							dbSkip()
						EndDo
					Next nX
				Case SC7->C7_TIPO==2
					dbSelectArea("SCQ")
					dbSetOrder(3)
					MsSeek(xFilial()+SC7->C7_NUM+SC7->C7_ITEM)
					While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
							SCQ->CQ_NUMAE == SC7->C7_NUM .And.;
							SCQ->CQ_ITAE == SC7->C7_ITEM
						If nQtdALib > 0 .And. !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QUANT-SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP += nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA += nQtdLib
						Else
							Exit
						EndIf
						dbSelectArea(cAliasSCQ)
						dbSkip()
					EndDo
				OtherWise
					dbSelectArea("SC1")
					dbSetOrder(1)
					If MsSeek(xFilial()+SC7->C7_NUMSC+SC7->C7_ITEMSC)
						dbSelectArea("SCQ")
						dbSetOrder(2)
						If MsSeek(xFilial()+SC1->C1_NUM+SC1->C1_ITEM)
							cCondicao := "CQ_FILIAL+CQ_NUMSC+CQ_ITSC==xFilial('SCQ')+SC1->C1_NUM+SC1->C1_ITEM"
							While !Eof() .And. &(cCondicao) .And. nQtdaLib > 0
								If Empty(CQ_NUMREQ) .And. !Localiza(CQ_PRODUTO)
									RecLock("SCQ",.F.)
									nQtdLib := Min(SCQ->CQ_QUANT-SCQ->CQ_QTDISP,nQtdALib)
									nQtdALib-= nQtdLib
									SCQ->CQ_QTDISP += nQtdLib
									SCQ->CQ_STATUSC:= ""
									dbSelectArea("SB2")
									dbSetOrder(1)
									MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
									Reclock("SB2",.F.)
									SB2->B2_QEMPSA += nQtdLib 
									MsUnlock()
								EndIf
								dbSelectArea(cAliasSCQ)
								dbSkip()
							EndDo
						EndIf
					EndIf
				EndCase
			#ENDIF
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			LancaPCO("SC7","000054","15","MATA103")
			If lLast
				LancaPCO("SC7","000054","17","MATA103")
			EndIf
		EndIf
	EndIf
	
	// Efetua liberação do pedido de vendas, amarrado a solicitação de compras
	If getversao(.F.) >= "12"
		aArea2:= getarea()
		aAreaSC1:=  SC1->(getarea())
		aAreaSC6:=  SC6->(getarea())
		dbSelectArea("SC1")
		dbSetOrder(1)  //
		If MsSeek(xFilial()+(cAliasSC7)->C7_NUMSC+(cAliasSC7)->C7_ITEMSC)
				dbSelectArea("SC6")
				dbSetOrder(12)   //Filial + Ped. Venda + Produto + Sol.Compra
				If MsSeek(xFilial()+SC1->C1_PEDRES+SC1->C1_PRODUTO+SC1->C1_NUM)
					Ma410LbNfs(2,Nil,Nil)
					RecLock("SC6",.F.)
					Replace SC6->C6_QTDLIB With (SC6->C6_QTDLIB + SC7->C7_QUJE)
					MsUnlock()
					AtuSC5(SC1->C1_PEDRES)
				Endif
		Endif
		restarea(aAreaSC6)
		restarea(aAreaSC1)
		restarea(aArea2)
	Endif	
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Estorno de um documento de entrada                                      ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 9
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Estorna dados do Pedido de Compra/Autorizacao de Entrega ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !Empty((cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEMPC)		
		dbSelectArea("SC7")
		dbSetOrder(19)
		If !(xFilial("SC7")==SC7->C7_FILENT .And. SC7->C7_NUM==(cAliasSD1)->D1_PEDIDO .And. SC7->C7_ITEM==(cAliasSD1)->D1_ITEMPC .And. SC7->C7_PRODUTO==(cAliasSD1)->D1_COD )
			MsSeek(xFilial("SC7")+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEMPC)
		EndIf
		If !(Empty(SubStr(SC7->C7_ITEM,3)) .And. !Empty(SC7->C7_SEQUEN))
			RecLock("SC7",.F.)
			If !Empty(SC7->C7_RESIDUO)
				nQuantRes	:= (SC7->C7_QUANT - SC7->C7_QUJE)
			EndIf
			SC7->C7_QUJE 	-= SD1->D1_QTDPEDI            
			SC7->C7_ENCER 	:= ""
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Atualiza o Saldo em Pedido do SB2                        ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SB2")
			dbSetOrder(1)
			If !(cEntrega==SB2->B2_FILIAL .And. SC7->C7_PRODUTO==SB2->B2_COD .And.SC7->C7_LOCAL==SB2->B2_LOCAL)
				If !MsSeek(cEntrega+SC7->C7_PRODUTO+SC7->C7_LOCAL)
					CriaSB2(SC7->C7_PRODUTO,SC7->C7_LOCAL,cEntrega)
				Endif
			EndIf
			If !SB2->(Eof())
				RecLock("SB2",.F.)
				If !Empty(SC7->C7_RESIDUO) 
					SC7->C7_RESIDUO	:= ""
					If SF4->F4_ESTOQUE=="S" //Atualiza se TES movimentar o Estoque
						SB2->B2_SALPEDI += SD1->D1_QTDPEDI + nQuantRes
						SB2->B2_SALPED2 += ConvUm(SD1->D1_COD,(SD1->D1_QTDPEDI + nQuantRes),0,2)	
					EndIf
				Else       
					If (cAliasSC7)->(FieldPos("C7_ESTOQUE"))> 0 .And. lSb1TES .And. !Empty((cAliasSC7)->C7_NUMSC)
						SC1->(dbSetOrder(2))
						SC1->(MsSeek(xFilial("SC1")+SC7->C7_PRODUTO+SC7->C7_NUMSC))				
						If SC1->(FieldPos("C1_ESTOQUE"))> 0
							If (SF4->F4_ESTOQUE=="S" .And. SC1->C1_ESTOQUE=="S") .Or. (SF4->F4_ESTOQUE=="S" .And. Empty(SC1->C1_ESTOQUE))
								SB2->B2_SALPEDI += SD1->D1_QTDPEDI
								SB2->B2_SALPED2 += ConvUm(SD1->D1_COD,SD1->D1_QTDPEDI,0,2)
							EndIf
						EndIf
					Else
						// Verifica se TES do pedido atualiza estoque. Se estiver em branco tambem atualiza o saldo previsto.
						dbSelectArea("SF4")
						dbSetOrder(1)
						If (MsSeek(xFilial("SF4")+(cAliasSC7)->C7_TES) .And. SF4->F4_ESTOQUE=="S") .Or.;
								Empty((cAliasSC7)->C7_TES)
							SB2->B2_SALPEDI += SD1->D1_QTDPEDI
							SB2->B2_SALPED2 += ConvUm(SD1->D1_COD,SD1->D1_QTDPEDI,0,2)
						EndIf
					EndIf
				EndIf
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Estorna o arquivo de pre-requisicoes.                    ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nQtdALib := SD1->D1_QUANT
			dbSelectArea("SCQ")
			dbSetOrder(2)					
			#IFDEF TOP
				cAliasSCQ := "MAAVALSD1"
				lQuery    := .T.
				Do Case
				Case !Empty(SC7->C7_NUMCOT)
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ, "
					cQuery += RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_COTACAO='"+SC7->C7_NUMCOT+"' AND "
					cQuery += "SC1.C1_PRODUTO='"+SC7->C7_PRODUTO+"' AND "
					cQuery += "SC1.D_E_L_E_T_=' ' AND "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMSC=SC1.C1_NUM AND "
					cQuery += "SCQ.CQ_ITSC=SC1.C1_ITEM AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
					cQuery += "ORDER BY SC1.C1_FILIAL,SC1.C1_DATPRF "
				Case SC7->C7_TIPO == 2
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ "	
					cQuery += "WHERE "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMAE='"+SC7->C7_NUM+"' AND "
					cQuery += "SCQ.CQ_ITAE='"+SC7->C7_ITEM+"' AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
				OtherWise
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ, "	
					cQuery += RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_NUM='"+SC7->C7_NUMSC+"' AND "
					cQuery += "SC1.C1_ITEM='"+SC7->C7_ITEMSC+"' AND "					
					cQuery += "SC1.C1_PRODUTO='"+SC7->C7_PRODUTO+"' AND "
					cQuery += "SC1.D_E_L_E_T_=' ' AND "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMSC=SC1.C1_NUM AND "
					cQuery += "SCQ.CQ_ITSC=SC1.C1_ITEM AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
					cQuery += "ORDER BY SC1.C1_FILIAL,SC1.C1_DATPRF "					
				EndCase
				
				cQuery := ChangeQuery(cQuery)
				
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSCQ)
				
				dbSelectArea(cAliasSCQ)										
				While !Eof()
					If nQtdALib > 0
						SCQ->(MsGoto((cAliasSCQ)->SCQRECNO))
						If !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP -= nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA -= nQtdLib
						EndIf	
					Else
						Exit
					EndIf
					dbSelectArea(cAliasSCQ)
					dbSkip()
				EndDo
				If lQuery
					dbSelectArea(cAliasSCQ)
					dbCloseArea()
					dbSelectArea("SCQ")
				EndIf
			#ELSE
				Do Case
				Case !Empty(SC7->C7_NUMCOT)
					dbSelectArea("SC1")
					dbSetOrder(5)
					MsSeek(xFilial("SC1") + SC7->C7_NUMCOT + SC7->C7_PRODUTO)
					While !Eof() .And. xFilial("SC1") == SC1->C1_FILIAL .And.;
							SC7->C7_NUMCOT == SC1->C1_COTACAO .And.;
							SC1->C1_PRODUTO == SC7->C7_PRODUTO
						AADD( aLibera,{SC1->C1_DATPRF,SC1->C1_QUJE,SC1->(RecNo())})
						dbSelectArea("SC1")
						dbSkip()
					EndDo
					aLibera:=aSort( aLibera,,, { | x , y | x[1] < y[1] } )
					For nX := Len(aLibera) To 1 STEP -1
						SC1->(MsGoto(aLibera[nx][3]))
						dbSelectArea("SCQ")
						dbSetOrder(2) //CQ_FILIAL+CQ_NUMSC+CQ_ITEMSC
						MsSeek(xFilial("SCQ")+SC1->C1_NUM+SC1->C1_ITEM)
						While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
								SCQ->CQ_NUMSC == SC1->C1_NUM .And.;
								SCQ->CQ_ITSC == SC1->C1_ITEM
							If nQtdALib > 0 .And. Empty(SCQ->CQ_NUMREQ) .And. !Localiza(SCQ->CQ_PRODUTO)
								RecLock("SCQ",.F.)
								nQtdLib := Min(SCQ->CQ_QTDISP,nQtdALib)
								nQtdALib-= nQtdLib
								SCQ->CQ_QTDISP -= nQtdLib
								SCQ->CQ_STATUSC:= ""
								dbSelectArea("SB2")
								dbSetOrder(1)
								MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
								Reclock("SB2",.F.)
								SB2->B2_QEMPSA -= nQtdLib
							EndIf
							dbSelectArea("SCQ")
							dbSkip()
						EndDo
					Next nX
				Case SC7->C7_TIPO==2
					dbSelectArea("SCQ")
					dbSetOrder(3)
					MsSeek(xFilial()+SC7->C7_NUM+SC7->C7_ITEM)
					While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
							SCQ->CQ_NUMAE == SC7->C7_NUM .And.;
							SCQ->CQ_ITAE == SC7->C7_ITEM
						If nQtdALib > 0 .And. Empty(SCQ->CQ_NUMREQ) .And. !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP -= nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA -= nQtdLib
						Else
							Exit
						EndIf
						dbSelectArea(cAliasSCQ)
						dbSkip()
					EndDo
				OtherWise
					dbSelectArea("SC1")
					dbSetOrder(1)
					MsSeek(xFilial()+SC7->C7_NUMSC+SC7->C7_ITEMSC)
					dbSelectArea("SCQ")
					MsSeek(xFilial()+SC1->C1_NUM+SC1->C1_ITEM)
					While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
							SCQ->CQ_NUMSC == SC1->C1_NUM .And.;
							SCQ->CQ_ITSC == SC1->C1_ITEM
						If nQtdALib > 0 .And. Empty(SCQ->CQ_NUMREQ) .And. !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP -= nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA -= nQtdLib
						Else                                    
							Exit
						EndIf
						dbSelectArea(cAliasSCQ)                 
						dbSkip()
					EndDo
				EndCase
			#ENDIF			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Grava os lancamentos nas contas orcamentarias SIGAPCO    ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			LancaPCO("SC7","000054","16","MATA103")
			If lLast
				LancaPCO("SC7","000054","18","MATA103")
			EndIf
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de um documento de entrada - Average                        ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 10
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualiza dados do Pedido de Compra/Autorizacao de Entrega?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !Empty(SWN->WN_PO_NUM)
		dbSelectArea("SC7")
		dbSetOrder(1)
		If MsSeek(xFilial("SC7")+SubStr(SWN->WN_PO_NUM,1,6)+'01  '+SWN->WN_ITEM)
			RecLock("SC7",.F.)
			SC7->C7_QUJE 	+= SWN->WN_QUANT
			SC7->C7_ENCER 	:= IIF(C7_QUANT-C7_QUJE>0," ","E")
			dbSelectArea("SB2")
			dbSetOrder(1)
			If !(cEntrega==SB2->B2_FILIAL .And. SC7->C7_PRODUTO==SB2->B2_COD .And. SC7->C7_LOCAL==SB2->B2_LOCAL)
				If !MsSeek(cEntrega+SC7->C7_PRODUTO+SC7->C7_LOCAL)
					CriaSB2(SC7->C7_PRODUTO,SC7->C7_LOCAL,cEntrega)
				EndIf
			EndIf
			RecLock("SB2",.F.)
			SB2->B2_SALPEDI -= SWN->WN_QUANT
			SB2->B2_SALPED2 -= ConvUm(SWN->WN_PRODUTO,SWN->WN_QUANT,0,2)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Atualiza o arquivo de pre-requisicoes.                   ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nQtdALib := SWN->WN_QUANT
			dbSelectArea("SCQ")
			dbSetOrder(2)					
			#IFDEF TOP
				cAliasSCQ := "MAAVALSD1"
				lQuery    := .T.
				Do Case
				Case !Empty(SC7->C7_NUMCOT)
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ, "
					cQuery += RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_COTACAO='"+SC7->C7_NUMCOT+"' AND "
					cQuery += "SC1.C1_PRODUTO='"+SC7->C7_PRODUTO+"' AND "
					cQuery += "SC1.D_E_L_E_T_=' ' AND "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMSC=SC1.C1_NUM AND "
					cQuery += "SCQ.CQ_ITSC=SC1.C1_ITEM AND "
					cQuery += "SCQ.CQ_QUANT > SCQ.CQ_QTDISP AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
					cQuery += "ORDER BY SC1.C1_FILIAL,SC1.C1_DATPRF "
				Case SC7->C7_TIPO == 2
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ "	
					cQuery += "WHERE "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMAE='"+SC7->C7_NUM+"' AND "
					cQuery += "SCQ.CQ_ITAE='"+SC7->C7_ITEM+"' AND "
					cQuery += "SCQ.CQ_QUANT > SCQ.CQ_QTDISP AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
				OtherWise
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ, "	
					cQuery += RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_NUM='"+SC7->C7_NUMSC+"' AND "
					cQuery += "SC1.C1_ITEM='"+SC7->C7_ITEMSC+"' AND "					
					cQuery += "SC1.C1_PRODUTO='"+SC7->C7_PRODUTO+"' AND "
					cQuery += "SC1.D_E_L_E_T_=' ' AND "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMSC=SC1.C1_NUM AND "
					cQuery += "SCQ.CQ_ITSC=SC1.C1_ITEM AND "
					cQuery += "SCQ.CQ_QUANT > SCQ.CQ_QTDISP AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
					cQuery += "ORDER BY SC1.C1_FILIAL,SC1.C1_DATPRF "					
				EndCase
				
				cQuery := ChangeQuery(cQuery)
				
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSCQ)
				
				dbSelectArea(cAliasSCQ)										
				While !Eof()
					If nQtdALib > 0
						SCQ->(MsGoto((cAliasSCQ)->SCQRECNO))
						If !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QUANT-SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP += nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA += nQtdLib
						EndIf	
					Else
						Exit
					EndIf
					dbSelectArea(cAliasSCQ)
					dbSkip()
				EndDo
				If lQuery
					dbSelectArea(cAliasSCQ)
					dbCloseArea()
					dbSelectArea("SCQ")
				EndIf
			#ELSE
				Do Case
				Case !Empty(SC7->C7_NUMCOT)
					dbSelectArea("SC1")
					dbSetOrder(5)
					MsSeek(xFilial("SC1") + SC7->C7_NUMCOT + SC7->C7_PRODUTO)
					While !Eof() .And. xFilial("SC1") == SC1->C1_FILIAL .And.;
							SC7->C7_NUMCOT == SC1->C1_COTACAO .And.;
							SC1->C1_PRODUTO == SC7->C7_PRODUTO
						AADD( aLibera,{SC1->C1_DATPRF,SC1->C1_QUJE,SC1->(RecNo())})
						dbSelectArea("SC1")
						dbSkip()
					EndDo
					aLibera:=aSort( aLibera,,, { | x , y | x[1] < y[1] } )
					For nX := Len(aLibera) To 1 STEP -1
						SC1->(MsGoto(aLibera[nx][3]))
						dbSelectArea("SCQ")
						dbSetOrder(1)
						MsSeek(xFilial("SCQ")+SC1->C1_NUM+SC1->C1_ITEM)
						While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
								SCQ->CQ_NUMSC == SC1->C1_NUM .And.;
								SCQ->CQ_ITSC == SC1->C1_ITEM
							If nQtdALib > 0 .And. SCQ->CQ_QUANT > SCQ->CQ_QTDISP .And. Empty(SCQ->CQ_NUMREQ) .And. !Localiza(SCQ->CQ_PRODUTO)
								RecLock("SCQ",.F.)			
								nQtdLib := Min(SCQ->CQ_QUANT-SCQ->CQ_QTDISP,nQtdALib)
								nQtdALib-= nQtdLib
								SCQ->CQ_QTDISP += nQtdLib
								SCQ->CQ_STATUSC:= ""
								dbSelectArea("SB2")
								dbSetOrder(1)
								MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
								Reclock("SB2",.F.)
								SB2->B2_QEMPSA += nQtdLib
							EndIf
							dbSelectArea("SCQ")
							dbSkip()
						EndDo
					Next nX
				Case SC7->C7_TIPO==2
					dbSelectArea("SCQ")
					dbSetOrder(3)
					MsSeek(xFilial()+SC7->C7_NUM+SC7->C7_ITEM)
					While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
							SCQ->CQ_NUMAE == SC7->C7_NUM .And.;
							SCQ->CQ_ITAE == SC7->C7_ITEM
						If nQtdALib > 0 .And. !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QUANT-SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP += nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA += nQtdLib
						Else
							Exit
						EndIf
						dbSelectArea(cAliasSCQ)
						dbSkip()
					EndDo
				OtherWise
					dbSelectArea("SC1")
					dbSetOrder(1)
					MsSeek(xFilial()+SC7->C7_NUMSC+SC7->C7_ITEMSC)
					dbSelectArea("SCQ")
					MsSeek(xFilial()+SC1->C1_NUM+SC1->C1_ITEM)
					cCondicao := "CQ_FILIAL+CQ_NUMSC+CQ_ITSC==xFilial()+SC1->C1_NUM+SC1->C1_ITEM"
					While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
							SCQ->CQ_NUMSC == SC1->C1_NUM .And.;
							SCQ->CQ_ITSC == SC1->C1_ITEM
						If nQtdALib > 0 .And. !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QUANT-SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP += nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA += nQtdLib
						Else
							Exit
						EndIf
						dbSelectArea(cAliasSCQ)
						dbSkip()
					EndDo
				EndCase
			#ENDIF
		EndIf
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Estorno de um documento de entrada                                      ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 11
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Estorna dados do Pedido de Compra/Autorizacao de Entrega ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !Empty(SWN->WN_PO_NUM)
		dbSelectArea("SC7")
		dbSetOrder(1)
		If MsSeek(xFilial("SC7")+SubStr(SWN->WN_PO_NUM,1,6)+'01  '+SWN->WN_ITEM)
			RecLock("SC7",.F.)
			SC7->C7_QUJE 	-= SWN->WN_QUANT
			SC7->C7_ENCER 	:= ""
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Atualiza o Saldo em Pedido do SB2                        ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SB2")
			dbSetOrder(1)
			If !(cEntrega==SB2->B2_FILIAL .And. SC7->C7_PRODUTO==SB2->B2_COD .And.SC7->C7_LOCAL==SB2->B2_LOCAL)
				If !MsSeek(cEntrega+SC7->C7_PRODUTO+SC7->C7_LOCAL)
					CriaSB2(SC7->C7_PRODUTO,SC7->C7_LOCAL,cEntrega)
				Endif
			EndIf
			If !SB2->(Eof())
				RecLock("SB2",.F.)
				SB2->B2_SALPEDI += SWN->WN_QUANT
				SB2->B2_SALPED2 += ConvUm(SWN->WN_PRODUTO,SWN->WN_QUANT,0,2)
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Estorna o arquivo de pre-requisicoes.                    ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nQtdALib := SWN->WN_QUANT
			dbSelectArea("SCQ")
			dbSetOrder(2)
			#IFDEF TOP
				cAliasSCQ := "MAAVALSD1"
				lQuery    := .T.
				Do Case
				Case !Empty(SC7->C7_NUMCOT)
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ, "
					cQuery += RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_COTACAO='"+SC7->C7_NUMCOT+"' AND "
					cQuery += "SC1.C1_PRODUTO='"+SC7->C7_PRODUTO+"' AND "
					cQuery += "SC1.D_E_L_E_T_=' ' AND "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMSC=SC1.C1_NUM AND "
					cQuery += "SCQ.CQ_ITSC=SC1.C1_ITEM AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
					cQuery += "ORDER BY SC1.C1_FILIAL,SC1.C1_DATPRF "
				Case SC7->C7_TIPO == 2
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ "	
					cQuery += "WHERE "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMAE='"+SC7->C7_NUM+"' AND "
					cQuery += "SCQ.CQ_ITAE='"+SC7->C7_ITEM+"' AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
				OtherWise
					cQuery := "SELECT SCQ.R_E_C_N_O_ SCQRECNO "
					cQuery += "FROM "+RetSqlName("SCQ")+" SCQ, "	
					cQuery += RetSqlName("SC1")+" SC1 "
					cQuery += "WHERE SC1.C1_FILIAL='"+xFilial("SC1")+"' AND "
					cQuery += "SC1.C1_NUM='"+SC7->C7_NUMSC+"' AND "
					cQuery += "SC1.C1_ITEM='"+SC7->C7_ITEMSC+"' AND "					
					cQuery += "SC1.C1_PRODUTO='"+SC7->C7_PRODUTO+"' AND "
					cQuery += "SC1.D_E_L_E_T_=' ' AND "
					cQuery += "SCQ.CQ_FILIAL='"+xFilial("SCQ")+"' AND "
					cQuery += "SCQ.CQ_NUMSC=SC1.C1_NUM AND "
					cQuery += "SCQ.CQ_ITSC=SC1.C1_ITEM AND "
					cQuery += "SCQ.CQ_NUMREQ = '"+Space(Len(SCQ->CQ_NUMREQ))+"' AND "
					cQuery += "SCQ.D_E_L_E_T_=' ' "
					cQuery += "ORDER BY SC1.C1_FILIAL,SC1.C1_DATPRF "					
				EndCase
				
				cQuery := ChangeQuery(cQuery)
				
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSCQ)
				
				dbSelectArea(cAliasSCQ)										
				While !Eof()
					If nQtdALib > 0
						SCQ->(MsGoto((cAliasSCQ)->SCQRECNO))
						If !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP -= nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA -= nQtdLib
						EndIf	
					Else
						Exit
					EndIf
					dbSelectArea(cAliasSCQ)
					dbSkip()
				EndDo
				If lQuery
					dbSelectArea(cAliasSCQ)
					dbCloseArea()
					dbSelectArea("SCQ")
				EndIf
			#ELSE
				Do Case
				Case !Empty(SC7->C7_NUMCOT)
					dbSelectArea("SC1")
					dbSetOrder(5)
					MsSeek(xFilial("SC1") + SC7->C7_NUMCOT + SC7->C7_PRODUTO)
					While !Eof() .And. xFilial("SC1") == SC1->C1_FILIAL .And.;
							SC7->C7_NUMCOT == SC1->C1_COTACAO .And.;
							SC1->C1_PRODUTO == SC7->C7_PRODUTO
						AADD( aLibera,{SC1->C1_DATPRF,SC1->C1_QUJE,SC1->(RecNo())})
						dbSelectArea("SC1")
						dbSkip()
					EndDo
					aLibera:=aSort( aLibera,,, { | x , y | x[1] < y[1] } )
					For nX := Len(aLibera) To 1 STEP -1
						SC1->(MsGoto(aLibera[nx][3]))
						dbSelectArea("SCQ")
						dbSetOrder(1)
						MsSeek(xFilial("SCQ")+SC1->C1_NUM+SC1->C1_ITEM)
						While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
								SCQ->CQ_NUMSC == SC1->C1_NUM .And.;
								SCQ->CQ_ITSC == SC1->C1_ITEM
							If nQtdALib > 0 .And. Empty(SCQ->CQ_NUMREQ) .And. !Localiza(SCQ->CQ_PRODUTO)
								RecLock("SCQ",.F.)
								nQtdLib := Min(SCQ->CQ_QTDISP,nQtdALib)
								nQtdALib-= nQtdLib
								SCQ->CQ_QTDISP -= nQtdLib
								SCQ->CQ_STATUSC:= ""
								dbSelectArea("SB2")
								dbSetOrder(1)
								MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
								Reclock("SB2",.F.)
								SB2->B2_QEMPSA -= nQtdLib
							EndIf
							dbSelectArea("SCQ")
							dbSkip()
						EndDo
					Next nX
				Case SC7->C7_TIPO==2
					dbSelectArea("SCQ")
					dbSetOrder(3)
					MsSeek(xFilial()+SC7->C7_NUM+SC7->C7_ITEM)
					While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
							SCQ->CQ_NUMAE == SC7->C7_NUM .And.;
							SCQ->CQ_ITAE == SC7->C7_ITEM
						If nQtdALib > 0 .And. Empty(SCQ->CQ_NUMREQ) .And. !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP -= nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA -= nQtdLib
						Else
							Exit
						EndIf
						dbSelectArea(cAliasSCQ)
						dbSkip()
					EndDo
				OtherWise
					dbSelectArea("SC1")
					dbSetOrder(1)
					MsSeek(xFilial()+SC7->C7_NUMSC+SC7->C7_ITEMSC)
					dbSelectArea("SCQ")
					MsSeek(xFilial()+SC1->C1_NUM+SC1->C1_ITEM)
					While !Eof() .And. SCQ->CQ_FILIAL == xFilial("SCQ") .And.;
							SCQ->CQ_NUMSC == SC1->C1_NUM .And.;
							SCQ->CQ_ITSC == SC1->C1_ITEM
						If nQtdALib > 0 .And. Empty(SCQ->CQ_NUMREQ) .And. !Localiza(SCQ->CQ_PRODUTO)
							RecLock("SCQ",.F.)
							nQtdLib := Min(SCQ->CQ_QTDISP,nQtdALib)
							nQtdALib-= nQtdLib
							SCQ->CQ_QTDISP -= nQtdLib
							SCQ->CQ_STATUSC:= ""
							dbSelectArea("SB2")
							dbSetOrder(1)
							MsSeek(cEntrega+SCQ->CQ_PRODUTO+SCQ->CQ_LOCAL)
							Reclock("SB2",.F.)
							SB2->B2_QEMPSA -= nQtdLib
						Else
							Exit
						EndIf
						dbSelectArea(cAliasSCQ)
						dbSkip()
					EndDo
				EndCase
			#ENDIF
		EndIf
	EndIf
EndCase
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Chamada do CodeBlock de Contabilizacao                   ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
LancaCTB(bCtbOnLine,nEvento)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Restaura a integridade da rotina                         ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
RestArea(aAreaSF4)
RestArea(aAreaSCR)
RestArea(aArea)
Return(.T.)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaUltForn ?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Avalia os ultimos fornecimentos de materiais ( entrada )     ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpA1 := MaUltForn(ExpC1,ExpA2,ExpA3,ExpN1,ExpL1)			   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do Produto                                     ³±?
±±?         ³ExpA2: Array de retorno dos titulos dos campos definidos em  ³±?
±±?         ?      ExpA3.                                                ³±?
±±?         ³ExpA3: Array com a estrutura dos campos a serem retornados   ³±?
±±?         ?      [1] Nome do Campo                                     ³±?
±±?         ?      [2] Tipo do campo                                     ³±?
±±?         ?      [3] Tamanho do campo                                  ³±?
±±?         ?      [4] Numero de decimais do campo                       ³±?
±±?         ?      * Somente do SD1                                      ³±?
±±?         ³ExpN1: Quantidade de ultimos fornecimentos (Default 4)       ³±?
±±?         ³ExpL1: Efetua a conversao para a picture contida no diciona- ³±?
±±?         ?      rio de dados.                                         ³±?
±±?         ?      * DEFAULT .T.                                         ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: Array contendo os ultimos fornecimentos com os campos ³±?
±±?         ?      solicitados no parametro ExpA2.                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo avaliar as ultimas <ExpN1>     ³±?
±±?         ³entregas do produto <ExpC1> retornando os campos ExpA3.      ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaUltForn(cProduto,aTitles,aCampos,nQtUltFor,lPicture)

Local aArea    := GetArea()
Local aAreaSD1 := SD1->(GetArea())
Local aAreaSX3 := SX3->(GetArea())
Local aUltFor  := {}
Local cAliasSD1:= ""
Local nX       := 0
Local nY	      := 0
#IFDEF TOP
	Local cQuery := ""
#ENDIF
DEFAULT aTitles     := {}
DEFAULT aCampos 	:= {}
DEFAULT nQtUltFor	:= 4
DEFAULT lPicture    := .T.
cAliasSD1:= "SD1"
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Inicializa a estrutura default da rotina                     ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ( Empty(aCampos) )
	dbSelectArea("SX3")
	dbSetOrder(2)
	MsSeek("D1_EMISSAO")
	aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("D1_QUANT")
	aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("D1_VUNIT")
	aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("D1_TOTAL")
	aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	If cPaisLoc == "BRA"
		MsSeek("D1_VALIPI")
		aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	Endif
	MsSeek("D1_CUSTO")
	aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("D1_FORNECE")
	aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	MsSeek("D1_LOJA")
	aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	dbSelectArea("SX3")
	dbSetOrder(1)
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Avalia os ultimos fornecimentos do material                  ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
#IFDEF TOP
	If ( TcSrvType()<>"AS/400" )
		cAliasSD1 := "MAULTFOR"
		For nX := 1 To Len(aCampos)
			cQuery += ","+aCampos[nX][1]
		Next nX
		cQuery := "SELECT "+SubStr(cQuery,2)+" "
		cQuery += "FROM "+RetSqlName("SD1")+" SD1 "
		cQuery += "WHERE SD1.D1_FILIAL='"+xFilial("SD1")+"' AND "
		cQuery += "SD1.D1_COD='"+cProduto+"' AND "
		cQuery += "SD1.D1_TIPO='N' AND "
		cQuery += "SD1.D_E_L_E_T_=' ' "
		cQuery += "ORDER BY SD1.R_E_C_N_O_ DESC "
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSD1,.T.,.T.)
		For nX := 1 To Len(aCampos)
			If ( aCampos[nX][2]<>"C" )
				TcSetField(cAliasSD1,aCampos[nX,1],aCampos[nX,2],aCampos[nX,3],aCampos[nX,4])
			EndIf
		Next nX

		SX3->(dbSetOrder(2))
		SX3->(MsSeek("A2_NOME"))
		aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
		SX3->(dbSetOrder(1))
		
		While ( !Eof() )
			aadd(aUltFor,Array(Len(aCampos)))
			nY++
			For nX := 1 To Len(aCampos)
				aUltFor[nY][nX] := FieldGet(FieldPos(aCampos[nX][1]))
				aUltFor[nY][Len(aCampos)] := IIF(SA2->(MsSeek(xFilial("SA2")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)),SA2->A2_NOME,"")
			Next nX
			If ( Len(aUltFor)>=nQtUltFor )
				Exit
			EndIf			
			dbSelectArea(cAliasSD1)
			dbSkip()
		EndDo	
		dbSelectArea(cAliasSD1)
		dbCloseArea()
		dbSelectArea("SD1")
	Else
#ENDIF
	SX3->(dbSetOrder(2))
	SX3->(MsSeek("A2_NOME"))
	aadd(aCampos,{Trim(SX3->X3_CAMPO),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL})
	SX3->(dbSetOrder(1))
	
	dbSelectArea("SD1")
	dbSetOrder(5)
	MsSeek(xFilial("SD1")+cProduto,.T.)
	While ( !Eof() .And. SD1->D1_FILIAL == xFilial("SD1") .And.;
			SD1->D1_COD == cProduto )			
		If ( SD1->D1_TIPO == "N" )
			If ( Len(aUltFor)<nQtUltFor )
				aadd(aUltFor,Array(Len(aCampos)))
				nY++
			Else
				For nY := 1 To nQtUltFor-1
					aUltFor[nY] := aClone(aUltFor[nY+1])
				Next nY
				nY := nQtUltFor
			EndIf
			For nX := 1 To Len(aCampos)
				aUltFor[nY][nX] := FieldGet(FieldPos(aCampos[nX][1]))
				aUltFor[nY][Len(aCampos)] := IIF(SA2->(MsSeek(xFilial("SA2")+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)),SA2->A2_NOME,"")
			Next nX
		EndIf
		dbSelectArea("SD1")
		dbSkip()			
	EndDo
	#IFDEF TOP
	EndIf
	#ENDIF
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Obtem os titulos com base no dicionario de dados             ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ( lPicture )
	If ( Len(aUltFor) == 0 )
		aadd(aUltFor,{})
		For nX := 1 To Len(aCampos)
			aadd(aUltFor[1],"")
		Next nX
	EndIf
	dbSelectArea("SX3")
	dbSetOrder(2)
	For nX := 1 To Len(aCampos)
		MsSeek(Trim(aCampos[nX][1]))
		aadd(aTitles,X3Titulo())
		For nY := 1 To Len(aUltFor)
			aUltFor[nY][nX] := TransForm(aUltFor[nY][nX],SX3->X3_PICTURE)
		Next nY
	Next nX
EndIf
RestArea(aAreaSX3)
RestArea(aAreaSD1)
RestArea(aArea)
Return(aUltFor)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaAvCotVen?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Avalia as cotacoes em aberto e seleciona a melhor cotacao    ³±?
±±?         ³segundo os parametros da rotina                              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpA1 := MaAvCotVen(ExpA1,ExpA2,ExpA3,ExpA4,ExpL1,ExpN1, 	   ³±?
±±? 		 ?				  ExpL2,ExpL3)			 				   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpA1: Array das cotacoes em aberto  ( SC8 )                 ³±?
±±?         ?   [x][01] Ok - Indica se a cotacao foi selecionada (XX)    ³±?
±±?         ?   [x][02] Codigo do fornecedor                             ³±?
±±?         ?   [x][03] Loja do fornecedor                               ³±?
±±?         ?   [x][04] Nome reduzido                                    ³±?
±±?         ?   [x][05] Numero da proposta                               ³±?
±±?         ?   [x][06] Valor presente                                   ³±?
±±?         ?   [x][07] Data de Necessidade                              ³±?
±±?         ?   [x][08] Data de Entrega                                  ³±?
±±?         ?   [x][09] Desvio                                           ³±?
±±?         ?   [x][10] Nota do Fornecedor                               ³±?
±±?         ?   [x][11] Observacao                                       ³±?
±±?         ?   [x][12]0-Cotacao pode ser selecionada automaticamente    ³±?
±±?         ?          1-Cotacao nao pode ser selecionada automaticamente³±?
±±?         ³ExpA2: Array das cotacoes em aberto  ( SC8 )                 ³±?
±±?         ?   [x][01] Nome do campo                                    ³±?
±±?         ?   [x][02] Conteudo do campo                                ³±?
±±?         ³ExpA3: Array das cotacoes vencedoras ( SCE )                 ³±?
±±?         ?      [x] Array com os produtos da Cotacao                  ³±?
±±?         ?   [x][y] Array com a estrutura do acols                    ³±?
±±?         ³ExpA4: Array com a estrutura do aheader do SCE               ³±?
±±?         ³ExpL1: Considera prazo de entrega                       (OPC)³±?
±±?         ?      DEFAULT = .F.							               ³±?
±±?         ³ExpN1: atraso tolerado  		                          (OPC)³±?
±±?         ?      DEFAULT = 0							               ³±?
±±?         ³ExpL2: Verifica a nota do fornecedor                    (OPC)³±?
±±?         ?      DEFAULT = .F.							               ³±?
±±?         ³ExpL3: Selec.o melhor fornecedor das cotacoes validas   (OPC)³±?
±±?         ?      DEFAULT = .F.							               ³±?
±±?         ³ExpL4: Indica se a analise  da cotacao e por cotacao ou (OPC)³±?
±±?         ?      por produto. DEFAULT = .T. (Por Cotacao)              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: retorna atualizada com o Vencedor pelo Sistema 	   ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Avalia as cotacoes em aberto e seleciona a melhor cotacao    ³±?
±±?         ³segundo os parametros da rotina                              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaAvCotVen(aPlanilha,aCotacao,aSCE,aHeadSCE,lEntrega,nAtraso,lNota,lFornec,lProceCot,aCpoSC8,lSelFor)

Local aArea 	:= GetArea()
Local aAreaSA5  := SA5->(GetArea())
Local aFornec   := {}
Local aCalc     := aClone(aPlanilha)
Local nScan     := 0
Local nCalc     := 0
Local nFornec   := 0
Local nX    	:= 0
Local nY    	:= 0
Local nX1       := 1
Local nG        := 0
Local nPProd    := aScan(aCotacao[1][1],{|x| Trim(x[1])=="C8_PRODUTO"})
Local nPQtdSC8  := aScan(aCotacao[1][1],{|x| Trim(x[1])=="C8_QUANT"})

Local nSC8Recno := aScan(aCotacao[1][1],{|x| Trim(x[1])=="SC8RECNO"})
Local nPNumSC   := aScan(aCotacao[1][1],{|x| Trim(x[1])=="C8_NUMSC"})
Local nPItemSC  := aScan(aCotacao[1][1],{|x| Trim(x[1])=="C8_ITEMSC"})
Local lBloqPco  := .F., aBloqPco := {}

Local nPQtdSCE  := aScan(aHeadSCE,{|x| Trim(x[2])=="CE_QUANT"})
Local nPMotSCE  := aScan(aHeadSCE,{|x| Trim(x[2])=="CE_MOTIVO"})
Local nPRegSCE  := aScan(aHeadSCE,{|x| Trim(x[2])=="CE_REGIST"})
Local lSelec    := .F.
Local lM160COTVE:= ExistBlock("M160COTV") 

Local nPlanOK     := aScan(aCpoSC8,"PLN_OK")
Local nPlanForn   := aScan(aCpoSC8,"PLN_FORNECE")
Local nPlanLoja   := aScan(aCpoSC8,"PLN_LOJA")
Local nPlanNumPro := aScan(aCpoSC8,"PLN_NUMPRO")
Local nPlanTotal  := aScan(aCpoSC8,"PLN_TOTAL")
Local nPlanDtPrf  := aScan(aCpoSC8,"PLN_DATPRF")
Local nPlanDatPRZ := aScan(aCpoSC8,"PLN_DATPRZ")
Local nPlanNota   := aScan(aCpoSC8,"PLN_NOTA")
Local nPlanFlag   := aScan(aCpoSC8,"PLN_FLAG")
Local nPlanItem   := aScan(aCpoSC8,"PLN_ITEM")
Local nPlanVisto  := aScan(aCpoSC8,"PLN_VISTO")
Local lMa160PCOK  :=.T.
Local aCotxCot	 := {} 
Local cForn		 := ""
Local cProp       := ""
Local nFvlr		 := 0
Local l1st		  := .T.
Local cFornVenc	 := ""
Local cPropVenc	:= ""
Local nZ		  := 0  
Local nPosF		 := 0
Local cLoja		:= ""
Local aVencedor	:= {}
Local cLojaVenc	:= ""
Local dPrazo	:= STOD("")
Local aFornVenc	:= {}
Local nA		  := 0
Local nB		  := 0
Local nXvenc
Local nPosFor:=0

DEFAULT lEntrega:= .F.
DEFAULT lNota	:= .F.
DEFAULT lFornec := .F.
DEFAULT nAtraso := 0
DEFAULT lProceCot:= .T.
DEFAULT lSelFor := .F.
If lProceCot .Or. lFornec
	nX1 := 1
Else
	nX1 := Len(aPlanilha)
Endif

// Inicializa a seleção Manual por Item
If Len(aSelManual) < Len(aPlanilha)
	For nX:=Len(aSelManual) To Len(aPlanilha)
		Aadd(aSelManual,.F.)
	Next nX
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Seleciona os fornecedores validos para a cotacao             ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
For nX := nX1 To Len(aPlanilha)
	For nY := 1 To Len(aPlanilha[nX])
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Inclui todos os fornecedores antes de iniciar a analise      ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If nPlanFlag > 0
			aPlanilha[nX][nY][nPlanFlag] := 0

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Verifica se os precos que nao foram digitados                ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ( nPlanTotal > 0 .And. aPlanilha[nX][nY][nPlanTotal] == 0 )
				aPlanilha[nX][nY][nPlanFlag] := 1
				For nA := 1 To Len(aPlanilha)
					For nB := 1 To Len(aPlanilha[nA]) 
						If (lFornec .And. aPlanilha[nX][nY][2] == aPlanilha[nA][nB][2])
							aPlanilha[nA][nB][nPlanFlag] := 1
						EndIf
					Next nB
				Next nA
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Verifica as propostas validas                                ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			For nA := 1 To Len(aPlanilha)
				For nB := 1 To Len(aPlanilha[nA]) 
					If (aPlanilha[nX][nY][2] == aPlanilha[nA][nB][2] .And. aPlanilha[nX][nY][3] == aPlanilha[nA][nB][3] .And. aPlanilha[nX][nY][5] < aPlanilha[nA][nB][5] .And. !lEntrega)
						aPlanilha[nX][nY][nPlanFlag] := 1
					EndIf
				Next nB
			Next nA
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Verifica o prazo de entrega e o atraso tolerado              ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ( lEntrega .And. nPlanDatPRZ > 0 .And. nPlanDtPrf > 0)
				If ( aPlanilha[nX][nY][nPlanDatPRZ] > (aPlanilha[nX][nY][nPlanDtPrf]+nAtraso) )
					For nA := 1 To Len(aPlanilha)
						For nB := 1 To Len(aPlanilha[nA]) 
							If aPlanilha[nX][nY][nPlanDatPRZ] > aPlanilha[nA][nB][nPlanDatPRZ]
								aPlanilha[nX][nY][nPlanFlag] := 1
							EndIf
						Next nB
					Next nA
				EndIf
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Verifica a nota do fornecedor                                ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ( lNota )
				dbSelectArea("SB1")
				dbSetOrder(1)
				MsSeek(xFilial("SB1")+aCotacao[nX][1][nPProd][2])
				If ( nPlanNota > 0 .And. aPlanilha[nX][nY][nPlanNota] < SB1->B1_NOTAMIN )
					aPlanilha[nX][nY][nPlanFlag] := 1
				EndIf
			EndIf
		EndIf
		If !lProceCot .And. !lFornec .And. nPlanVisto > 0
			If !Empty(aPlanilha[nX][nY][nPlanVisto]) .And. nPlanFlag > 0
				aPlanilha[nX][nY][nPlanFlag] := 1
			Endif
			aPlanilha[nX][nY][nPlanVisto] := "X"
		Endif	
	Next nY
Next nX
If ( lFornec )
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Seleciona o melhor fornecedor das cotacoes validas           ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If nPlanFlag > 0 .And. nPlanForn > 0 .And. nPlanLoja > 0 .And. nPlanTotal > 0
		For nX := nX1 To Len(aPlanilha)
			For nY := 1 To Len(aPlanilha[nX])
				If ( aPlanilha[nX][nY][nPlanFlag] == 0 )
					nFornec := aScan(aFornec,{|x| x[1]==aPlanilha[nX][nY][nPlanForn] .And. x[2]==aPlanilha[nX][nY][nPlanLoja]})
					If ( nFornec == 0 )
						aadd(aFornec,{aPlanilha[nX][nY][nPlanForn],aPlanilha[nX][nY][nPlanLoja],aPlanilha[nX][nY][nPlanTotal],nX,aPlanilha[nX][nY][nPlanTotal],aPlanilha[nX][nY][nPlanNumPro]})
					Else
						If ( nX == aFornec[nFornec][4] )
							aFornec[nFornec][3] -= aFornec[nFornec][5]
							aFornec[nFornec][3] += Min(aPlanilha[nX][nY][nPlanTotal],aFornec[nFornec][5])
							aFornec[nFornec][4] := nX
							aFornec[nFornec][5] := Min(aPlanilha[nX][nY][nPlanTotal],aFornec[nFornec][5])
						Else
							aFornec[nFornec][3] += aPlanilha[nX][nY][nPlanTotal]
							aFornec[nFornec][4] := nX
							aFornec[nFornec][5] := aPlanilha[nX][nY][nPlanTotal]
						EndIf
					EndIf
				EndIf
			Next nY
		Next nX
	EndIf
	If ( Len(aFornec) > 0 .And. nPlanForn > 0 .And. nPlanLoja > 0 .And. nPlanFlag > 0)
		aFornec := aSort(aFornec,,,{|x,y| x[3] < y[3]})
		For nX := 1 To Len(aPlanilha)
			nFornec := 0
			For nY := 1 To Len(aFornec)
				nFornec := aScan(aPlanilha[nX],{|x| x[nPlanForn]==aFornec[nY][1] .And. x[nPlanLoja]==aFornec[nY][2]})
				If ( nFornec > 0 )
					nFornec := nY
					Exit
				EndIf
			Next nY
			For nY := 1 To Len(aPlanilha[nX])
			   	If nFornec > 0 .And. ; // Fornecedor localizado
			   	aPlanilha[nX][nY][nPlanForn] == aFornec[nFornec][1] .And. ; // Verifica codigo do fornecedor
			   	aPlanilha[nX][nY][nPlanLoja] == aFornec[nFornec][2] .And. ; // Verifica codigo da Loja
			   	aPlanilha[nX][nY][nPlanTotal]>0  .And. ; // Verifica se o valor total eh maior que 0,00
			   	aPlanilha[nX][nY][nPlanNumPro] == aFornec[nFornec][6] // Verifica Numero do Produto
			  			aPlanilha[nX][nY][nPlanFlag] := 0					
				ElseIf !aSelManual[nX]		// Redefine vencedor somente se a proposta não foi alterada manualmente
					aPlanilha[nX][nY][nPlanFlag] := 1
				EndIf 
			Next nY
		Next nX
	EndIf
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Seleciona o melhor custo dos fornecedores selecionados       ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

If (nPlanForn > 0 .And. nPlanLoja > 0 .And. nPlanNumPro > 0 .And. nPlanFlag > 0 .And. nPlanOK > 0 .And. nPlanItem > 0 .And. nPlanDatPRZ > 0)
	For nX := nX1 To Len(aPlanilha)		
		For nY := 1 To Len(aPlanilha[nX])   
		    If aPlanilha[nX][nY][nPlanTotal]>0  .And. aPlanilha[nX][nY][nPlanFlag] == 0
				aPlanilha[nX][nY][nPlanFlag] := 0					
			Else	                              
				aPlanilha[nX][nY][nPlanFlag] := 1
			Endif
		Next nY
			
		aCalc[nX] := aSort(aCalc[nX],,,{|x,y| Str(x[nPlanTotal],18,2)+Dtos(x[nPlanDatPRZ])+Str(x[nPlanFlag],2,0) < Str(y[nPlanTotal],18,2)+Dtos(y[nPlanDatPRZ])+Str(y[nPlanFlag],2) })
		lSelec := .F. 
		nZ := Len(aCalc[nX])
		For nY := 1 To nZ
			//Verifica se o valor da melhor posição do aCalc ?diferente de 0
			//se for igual ele passa para a proxima
			For nXvenc:= nY To nZ 
			  If aCalc[nX][nXvenc][6] <> 0 //valor total da cotação diferente de 0
				Exit
			  EndIf
			Next   
			// Se nao encontrou valor, mantem o primeiro item (melhor) ja classificado no aCalc pelo aSort
			If nXvenc > nZ
				nXvenc := 1
			EndIf
			cForn := alltrim(aCalc[nX][nXvenc][2])
			nFvlr := aCalc[nX][nXvenc][6]
			cLoja := alltrim(aCalc[nX][nXvenc][3])
			cProp := alltrim(aCalc[nX][nXvenc][5])
			dPrazo:= aCalc[nX][nXvenc][nPlanDatPRZ] 
			
			//Posição do fornecedor e proposta
			nPosfor := aScan(aPlanilha[nX],{|x| alltrim(x[nPlanForn])==cforn .And. alltrim(x[nPlanLoja])==cLoja .And. alltrim(x[nPlanNumPro])==cProp})
			
			If (aPlanilha[nx][nPosfor][12]) == 0 .And. aPlanilha[nX][nPosfor][nPlanTotal]>0 
		   		cFornVenc := ""
				cLojaVenc := ""
				cPropVenc := ""
				If l1st
					aadd(aCotxCot,{cForn,nFvlr,cLoja,cProp,dPrazo})
				Else
					nPosF := aScan(aCotxCot, {|x| x[1] == cForn .And. x[3] == cLoja .And. x[4] == cProp})
					//Estruturação dos dados do Fornecedor para escolha do Vencedor.
					If  nPosF == 0
						aadd(aCotxCot,{cForn,nFvlr,cLoja,cProp,dPrazo})
					Endif										
				Endif				
				l1st := .F. 
				aVencedor := FVencedor(lFornec,aCotxCot,lEntrega)
				cFornVenc := aVencedor[1]
				cLojaVenc := aVencedor[2]
				cPropVenc := aVencedor[3]
		    EndIf
			nCalc  := aScan(aPlanilha[nX],{|x| x[nPlanForn]==aCalc[nX][nY][nPlanForn] .And. x[nPlanLoja]==aCalc[nX][nY][nPlanLoja] .And. x[nPlanNumPro]==aCalc[nX][nY][nPlanNumPro] })
			If ( aPlanilha[nX][nCalc][nPlanFlag] == 0 .And. !lSelec )
				//Se vier marcado o vencedor valida se nao bloqueia pelo modulo PCO
				If SuperGetMV("MV_PCOINTE",.F.,"2")=="1"
					//Variaveis para analise de orcamento
					SC8->(MsGoTo(aCotacao[nX][nCalc][nSC8Recno][2]))
					SC1->(DbSetOrder(1))
					SC1->(MsSeek(xFilial("SC1")+aCotacao[nX][nCalc][nPNumSC][2]+aCotacao[nX][nCalc][nPItemSC][2]))
					
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Ponto de Entrada para ser validado antes  do tratamento do PCO          ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				   	If ExistBlock("MA160PCOK")
				   		lMa160PCOK:= ExecBlock("MA160PCOK",.F.,.F.,{aCotacao})
  					    If Valtype(lMa160PCOK) <> "L" 
					    	lMa160PCOK:=.T.
					    EndIf
				  	EndIf	
					          
					IF lMa160PCOK
						If !PcoVldLan('000052','02',"MATA160")                 
		                    lBloqPco := .T.
	    	                aAdd(aBloqPco, { nX, nCalc, nPQtdSCE,nPMotSCE,nPRegSCE })
	        	        EndIf
	     			EndIf  
	     			 
				EndIf
				If !aSelManual[nX]		// Redefine vencedor somente se a proposta não foi alterada manualmente
					IIf(lFornec,aPlanilha[nX][nCalc][nPlanOK]:="XX",aPlanilha[nX][nCalc][nPlanOK]:="")
					aSCE[nX][nCalc][nPQtdSCE] := aCotacao[nX][1][nPQtdSC8][2]
					aSCE[nX][nCalc][nPMotSCE] := Padr(STR0001,Len(aSCE[nX][nCalc][nPMotSCE])) //"ENCERRADO AUTOMATICAMENTE"
					aSCE[nX][nCalc][nPRegSCE] := 1 // Identifica o Vencedor Indicado pelo Sistema 
				EndIf
	
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				//?Se vencedor e o Produto for de Grade alimenta a Quantidade do item de Grade com a quantidade do SC8.?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				nScan := aScan(aCotaGrade, {|z| z[1] + z[2] + z[3] + z[4] == ;
				aPlanilha[nX][nCalc][nPlanForn] + aPlanilha[nX][nCalc][nPlanLoja] + aPlanilha[nX][nCalc][nPlanNumPro] + aPlanilha[nX][nCalc][nPlanItem] })
	
		   		If Len(aCotaGrade[nScan][6]) > 0
					For nG := 1 To Len(aCotaGrade[nScan][6])
						aCotaGrade[nScan][6][nG][2] := aCotaGrade[nScan][6][nG][6]
					Next nG
				EndIf
				
			  	lSelec := .T.
			Else
				If lProceCot .or. lFornec
					If !aSelManual[nX]
						aSCE[nX][nCalc][nPQtdSCE] := 0 				
						aPlanilha[nX][nCalc][nPlanOK]:="" 								
					EndIf
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					//?Se nao for o vencedor e o Produto for de Grade zera a Quantidade do item de Grade.                  ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					nScan := aScan(aCotaGrade, {|z| z[1] + z[2] + z[3] + z[4] == ;
					aPlanilha[nX][nCalc][nPlanForn] + aPlanilha[nX][nCalc][nPlanLoja] + aPlanilha[nX][nCalc][nPlanNumPro] + aPlanilha[nX][nCalc][nPlanItem] })
		
					If Len(aCotaGrade[nScan][6]) > 0
						For nG := 1 To Len(aCotaGrade[nScan][6])
							aCotaGrade[nScan][6][nG][2] := 0
						Next nG
					EndIf
				Else
					If nPlanVisto > 0 .And. Empty(aPlanilha[nX][nCalc][nPlanVisto])
						aSCE[nX][nCalc][nPQtdSCE] := 0
						aPlanilha[nX][nCalc][nPlanOK] := ""			
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
						//?Se nao for o vencedor e o Produto for de Grade zera a Quantidade do item de Grade.                  ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
						nScan := aScan(aCotaGrade, {|z| z[1] + z[2] + z[3] + z[4] == ;
						aPlanilha[nX][nCalc][nPlanForn] + aPlanilha[nX][nCalc][nPlanLoja] + aPlanilha[nX][nCalc][nPlanNumPro] + aPlanilha[nX][nCalc][nPlanItem] })
			
						If Len(aCotaGrade[nScan][6]) > 0
							For nG := 1 To Len(aCotaGrade[nScan][6])
								aCotaGrade[nScan][6][nG][2] := 0
							Next nG
						EndIf
					Endif	
				Endif	
			EndIf
			If lSelFor .And. aPlanilha[nX][nY][nPlanTotal] > 0 .And. !lFornec
				For nA := 1 To Len(aPlanilha)
					For nB := 1 To Len(aPlanilha[nA]) 
						If (aPlanilha[nX][nY][2] == aPlanilha[nA][nB][2] .And. aPlanilha[nX][nY][3] == aPlanilha[nA][nB][3])
							If(aPlanilha[nX][nY][5] < aPlanilha[nA][nB][5])
								aPlanilha[nX][nY][nPlanFlag] := 1
							Else
								aPlanilha[nX][nY][nPlanFlag] := 0
							Endif
						EndIf
					Next nB
				Next nA
			EndIf
			If lM160COTVE
				SC8->(MsGoTo(aCotacao[nX][nCalc][nSC8Recno][2]))
				aRet := ExecBlock("M160COTV",.F.,.F.,{aPlanilha[nX][nCalc][nPlanOK],aSCE[nX][nCalc][nPQtdSCE]})
				If ValType(aRet) == "A" .And. Len(aRet) > 0
					aPlanilha[nX][nCalc][nPlanOK]   := aRet[1]
					aSCE[nX][nCalc][nPQtdSCE] := aRet[2]
				Endif
			Endif			
		Next nY
		aCotxCot := {}    
	    aaDD(aFornVenc,{cFornVenc,cLojaVenc,cPropVenc})
	Next nX
EndIf
If lBloqPco .And. nPlanOK > 0
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Retira as marcas caso seja bloqueado pelo PCO                ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	For nX := 1 To Len(aBloqPco)
		aPlanilha[ aBloqPco[nX,1], aBloqPco[nX,2], nPlanOK] := ""
		aSCE[ aBloqPco[nX,1], aBloqPco[nX,2], aBloqPco[nX,3]] := 0
		aSCE[ aBloqPco[nX,1], aBloqPco[nX,2], aBloqPco[nX,4]] := ""
		aSCE[ aBloqPco[nX,1], aBloqPco[nX,2], aBloqPco[nX,5]] := 0
	Next //nX	 
EndIf
If ExistBlock("M160VENC") 
	aRet160PLN := ExecBlock("M160VENC",.F.,.F.,{aSCE,aPlanilha,aCotacao})
    aSCE       := aRet160PLN[1]
    aPlanilha  := aRet160PLN[2]
EndIf

// Inicializa a seleção Manual por Item
If Len(aSelManual) < Len(aPlanilha)
	For nX:=Len(aSelManual) To Len(aPlanilha)
		Aadd(aSelManual,.F.)
	Next nX
Endif

If !lFornec
	For nX := nX1 to len(aPlanilha)
		For nY := 1 to len(aPlanilha[nX])
			If lProceCot .Or. lFornec 
		  		cFornVenc := aFornVenc[nX][1] 
				cLojaVenc := aFornVenc[nX][2] 
				cPropVenc := aFornVenc[nX][3]
			Else
		  		cFornVenc := aFornVenc[len(aFornVenc)][1] 
				cLojaVenc := aFornVenc[len(aFornVenc)][2] 
				cPropVenc := aFornVenc[len(aFornVenc)][3]
			EndIf   
			
		    If alltrim(aPlanilha[nX][nY][2])==cFornVenc .And. alltrim(aPlanilha[nX][nY][3])==cLojaVenc .And. alltrim(aPlanilha[nX][nY][5])== cPropVenc ;
		    .And. !aSelManual[nX] // Verifica se selecionou o fornecedor manualmente
		   		aPlanilha[nX][nY][nPlanOK] := "XX"
	       Else
			    aPlanilha[nX][nY][nPlanOK] := ""
	       Endif
	    Next nY
	Next nX
Endif 
RestArea(aArea)
RestArea(aAreaSA5)
Return(aPlanilha)

/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ?FVencedorºAutor  ³Julio Saraiva       ?Data ? 23/04/12   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDesc.     ?Escolhe qual vencedor tem a cotacao mais barata.           º±?
±±?         ?                                                           º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?SIGACOM                                                    º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
*/

Function FVencedor(lFornec,aCotxCot,lEntrega)
Local cFornv := ""
Local cLojaV := ""	
Local cPropV := ""

Default lEntrega := .T.

If !lFornec
	If lEntrega
		asort(aCotxCot,,, {|x,y| Str(x[2])+Dtos(x[5]) < Str(y[2])+Dtos(y[5]) })
	Else
		asort(aCotxCot,,, {|x,y| x[2] < y[2] }) 
	EndIf
	cFornV := aCotxCot[1][1] // Fornecedor vencedor
	cLojaV := aCotxCot[1][3] // Loja vencedora
	cPropV := aCotxCot[1][4] // Proposta vencedora
Endif
Return ({cFornV,cLojaV,cPropV})

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaValPres ?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Funcao de calculo do valor presente                          ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpN1 := MaValPres(ExpN2,ExpD1,ExpN3,ExpN4)			 	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpN2: Valor base a ser calculado                            ³±?
±±?         ³ExpD1: Data de pagamento                                     ³±?
±±?         ³ExpN3: Taxa a ser utilizada(%)                               ³±?
±±?         ?      * DEFAULT MV_JUROS                                    ³±?
±±?         ³ExpN4: 1 - Valor Presente * DEFAULT                          ³±?
±±?         ?      2 - Valor Futuro    								   ³±?
±±?	   	 ³ExpD5: Data de emissao do lancamento (default : dDatabase)   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpN1: Valor presente                                        ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta funcao efetua a conversao do valor financeiro em uma    ³±?
±±?         ³determinada data, para seu correspondente na presente data   ³±?
±±?         ³como base numa taxa de juros.                                ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaValPres(nValor,dData,nTaxa,nTipo,dDtEmissao)

Local nValFut  := 0
Local nValPres := 0 
Local nPrazo   

DEFAULT nTaxa := SuperGetMV("MV_JUROS")
DEFAULT nTipo := 1
DEFAULT dDtEmissao := dDataBase 
              
nPrazo := dData-dDtEmissao
                  
If nTipo == 1 //Present Value
	nValPres := nValor/( (1+(nTaxa/100)) ** (nPrazo/30) )
Else
	nValFut  := nValor*( (1+(nTaxa/100)) ** (nPrazo/30) )
EndIf

Return(nValPres+nValFut)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaAvalRA  ?Autor ?Eduardo Riera         ?Data ?5.08.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Rotina de avaliacao dos eventos de uma pre-requisicao ao     ³±?
±±?         ³almoxarifado                                                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaValRA(ExpC1,ExpN1,ExpN2)							 	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela de solicitacao de compra              ³±?
±±?         ³ExpN1: Codigo do Evento                                      ³±?
±±?         ?      [1] Implantacao de uma pre-requisicao ao almoxarifado ³±?
±±?         ?      [2] Estorno de uma pre-requisicao ao almoxarifado     ³±?
±±?         ³ExpN2: Quantidade da Soma                                    ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ?T.                                                          ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar os eventos vinculados³±?
±±?         ³a uma pre-requisicao                                         ³±?
±±?         ³A) Atualizacao das tabelas complementares.                   ³±?
±±?         ³B) Atualizacao das informacoes complementares a Requisicao ao³±?
±±?         ³almoxarifado                                                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaAvalRA(cAliasSCQ,nEvento,nQtdSoma)

Local aArea 	:= GetArea()
DEFAULT cAliasSCQ := "SCQ"
DEFAULT nQtdSoma  := 0
Do Case
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Implantacao de uma pre-requisicao ao almoxarifado                       ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 1 .Or. nEvento == 3
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza as tabelas auxiliares                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SB2")
	dbSetOrder(1)
	If ( !MsSeek(xFilial("SB2")+(cAliasSCQ)->CQ_PRODUTO+(cAliasSCQ)->CQ_LOCAL) )
		CriaSB2((cAliasSCQ)->CQ_PRODUTO,(cAliasSCQ)->CQ_LOCAL)
	EndIf
	RecLock("SB2")
	SB2->B2_QEMPSA += If(nEvento==1,(cAliasSCQ)->CQ_QTDISP,nQtdSoma)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Cancelamento de uma pre-requisicao ao almoxarifado                      ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 2
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Atualiza as tabelas auxiliares                                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SB2")
	dbSetOrder(1)
	If ( !MsSeek(xFilial("SB2")+(cAliasSCQ)->CQ_PRODUTO+(cAliasSCQ)->CQ_LOCAL) )
		CriaSB2((cAliasSCQ)->CQ_PRODUTO,(cAliasSCQ)->CQ_LOCAL)
	EndIf
	RecLock("SB2")
	SB2->B2_QEMPSA -= (cAliasSCQ)->CQ_QTDISP
EndCase
RestArea(aArea)
Return(.T.)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaSAPreReq?Autor ³Edson Maricate         ?Data ?5.08.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Rotina de conversao de uma Solicitacao ao Almoxarifado para  ³±?
±±?         ³uma prerequisicao                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaSAPreReq(ExpL1,ExpL2,ExpB1,ExpL3,ExpL4,ExpL5,ExpC1,ExpC2,  ³±?
±±?         ?		 ExpL6,ExpL7,ExpL8)                                ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpL1: Indica se a rotina deve avaliar a selecao da Markbrow-³±?
±±?         ?      se ou deve avaliar todos os registros                 ³±?
±±?         ³ExpL2: Indica se a rotina deve ser avaliada por data de neces³±?
±±?         ?      ssidade ou por data de emissao                        ³±?
±±?         ³ExpB1: Expressao de filtro a ser avaliada para cada registro ³±?
±±?         ?      do SCP.                                               ³±?
±±?         ³ExpL3: Indica se considera ou nao Prev.Entrada (SC)     (OPC)³±?
±±?         ?      DEFAULT = .F.                                         ³±?
±±?         ³ExpL4: Indica se a rotina devera gerar ou nao Solicitacao de ³±?
±±?         ?      Compras no SC1                                        ³±?
±±?         ³ExpL5: Considera Armazem da SA                               ³±?
±±?         ³ExpC1: Saldo do Armazem a considerar a necessidade           ³±?
±±?         ³ExpC2: Saldo ate o Armazem a considerar a necessidade        ³±?
±±?         ³ExpL6: Considerar o Lote Economico na geracacao da SC        ³±?
±±?         ³ExpL7: Considerar o saldo ja empenhado qdo baixa de OP       ³±?
±±?         ³ExpN1: Indica se aglutina ou nao as SC's  (OPC) DEFAULT = 1  ³±?
±±?         ³ExpL8: 													   ³±?
±±?         ³ExpL9: 													   ³±?
±±?         ³ExpA1: 													   ³±?
±±?         ³ExpL10: Indica se existe rateio na solicitacao ao armazem	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ?T.	                                                       ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ?                                                            ³±?
±±?         ?                                                            ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaSAPreReq(lMarkB,lDtNec,BFiltro,lConsSPed,lGeraSC1,lAmzSA,cSldAmzIni,cSldAmzFim,lLtEco,lConsEmp,nAglutSC,lAuto,lEstSeg,aRecSCP,lRateio)

Local aArea     := GetArea()
Local aLotes    := {}
Local aSCs      := {}
Local aCampos	:= {}
Local aCTBEnt   := If(FindFunction("CTBEntArr"),CTBEntArr(),{})
Local lQuery    := .F.
Local cNumSC    := ""
Local cNumSA    := ''
Local cItemSC   := ""
Local cCursor   := "SCP"
Local cQuery    := ""
Local cSeq      := "01"
Local nX        := 0
Local nQtde     := 0
Local nQtdPre   := 0
Local nEstoque  := 0
Local nSCs      := 0
Local nQtdEmSC  := 0
Local nQtdSC    := 0
Local nLoteSC   := 0
Local nSaveSX8  := GetSX8Len()
Local nEstSeg	:= 0 
Local lVldPE    := 0
Local cMsgSC    := ""
Local cSeekSCP  := ""
Local cSeekSCQ  := ""
Local lIncluiReg:= .T.
Local nRegSemSC := 0
Local aMT106SCQ := {}
Local lContinua	:= .T.
Local cMsg		:= ""
Local nAchoSC   := 0
Local aDadosGer := {Nil,Nil,Nil,Nil}
Local lAglutSA  := .F.
Local uLoteSC   := Nil 
Local lVLCP 	:= .T.
Local cTpSC     := Iif(FindFunction("ValidaCNI") .And. ValidaCNI(),GETMV("MV_TPSCAX"),Nil)// FSW - TIPO DE SC 
Local lEsp      := Iif(FindFunction("ValidaCNI") .And. ValidaCNI(),GETMV("MV_SEQESP"),Nil)  // FSW - Parametro especifico/padrao
Local lPrjCni   := FindFunction("ValidaCNI") .And. ValidaCNI()
Local lSaGerAe	:= SuperGetMv("MV_SAGERAE",.F.,.T.) //Gerar Autorizacao de Entrega com saldo em estoque
Local aCabSC	:= {}
Local aLinha	:= {}
Local aItemSC	:= {}
Local aColsSCX	:= {}
Local cChaveRat	:= ""
Local lErrAutSC	:= .F.
local aCPAgl	:= {}
Local lMT106SCA := ExistBlock("MT106SCA")
Local lCtrVld	:= .T.
Private lxCont  := .F.                 // FSW - Controle de numeração SC

DEFAULT lMarkb  := .F.
DEFAULT lDtNec  := .F.
DEFAULT bFiltro := {|| .T.}
DEFAULT lLtEco  := .T.
DEFAULT lConsEmp:= .F.
DEFAULT nAglutSC:=  1      
DEFAULT lAuto	:= .F.
DEFAULT lEstSeg	:= .F.
DEFAULT aRecSCP	:= {}
DEFAULT lRateio	:= .F.


// Checa versao do programa COMXFUN
If !(FindFunction("MATA106_V") .And. MATA106_V() >= 20060224)
	Final(STR0096)
EndIf

lConsSPed:=If(Valtype(lConsSPed) # "L",.F.,lConsSPed)
lGeraSC1 :=If(lGeraSC1== NIL,.T.,lGeraSC1)

If lGeraSC1
	PcoIniLan("000051")
EndIf

dbSelectArea("SCP")
If lDtNec
	dbSetOrder(3)
Else
	dbSetOrder(4)
EndIf
#IFDEF TOP
	If ( TcSrvType()<>"AS/400")
		SCP->(dbCommit())
		cCursor := GetNextAlias()
		lQuery  := .T.
		cQuery  := "SELECT CP_FILIAL,R_E_C_N_O_ SCPRECNO "
		cQuery  += "FROM "+RetSqlName("SCP")+" SCP "
		cQuery  += "WHERE CP_FILIAL='"+xFilial("SCP")+"' AND "
		cQuery  += "CP_PREREQU<>'S' AND "
		cQuery  += "D_E_L_E_T_=' ' "
		If ( lMarkb )
			If ( ThisInv() )
				cQuery += "AND CP_OK<>'"+ThisMark()+"' "
			Else
				cQuery += "AND CP_OK='"+ThisMark()+"' "
			EndIf
		EndIf

		If ExistBlock("MT106QRY")
		   c106Qry := ExecBlock("MT106QRY",.F.,.F.,{lAuto})
		   If ValType(c106Qry) == "C"
			   cQuery += c106Qry
		   EndIf	   
		EndIf

		cQuery += "ORDER BY "+SqlOrder(SCP->(IndexKey()))
		
		cQuery := ChangeQuery( cQuery )
		
		dbUseArea( .T., "TOPCONN", TcGenQry( ,,cQuery ), cCursor, .F., .T. ) 		
		
	Else
#ENDIF
	MsSeek(xFilial("SCP"))
	#IFDEF TOP
	EndIf
	#ENDIF
While ( !Eof() .And. (cCursor)->CP_FILIAL == xFilial("SCP") )
	If ( lQuery )
		dbSelectArea(cCursor)
		SCP->(MsGoto((cCursor)->SCPRECNO))
	EndIf
	SB1->(dbSetOrder(1))
	SB1->(MsSeek(xFilial("SB1")+SCP->CP_PRODUTO))
	
	dbSelectArea("SCP")
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Calcula a Necessidade de uma Solicitacao de Compra/Autorizacao de Entrega  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If	SCP->CP_PREREQU<>"S"                
		If !lQuery
			If ThisInv()
				If SCP->CP_OK == ThisMark()
					dbSelectArea("SCP")
					dbSkip()
					Loop
				EndIf
			Else
				If AllTrim(SCP->CP_OK) <> ThisMark()
					dbSelectArea("SCP")
					dbSkip()
					Loop
				EndIf
			EndIf		
		EndIf
		If lMarkb
			 IsMark("CP_OK",ThisMark(),ThisInv())
		EndIf
		If SB1->B1_MSBLQL == "1" // Verifica tambem se o produto nao esta bloqueado
			If !lAuto
				Aviso("B1_MSBLQL",OemtoAnsi(STR0091)+Alltrim(SB1->B1_COD)+OemtoAnsi(STR0092),{"Ok"})
			EndIf
		Else
			If ( Eval(bFiltro) )
				lIncluiReg	:=.T.
				cMsg		:= ""
				Begin Transaction
					dbSelectArea("SB2")
					dbSetOrder(1)
					If lAmzSA
						cSeekSCP := xFilial()+SCP->CP_PRODUTO+SCP->CP_LOCAL
					Else
						cSeekSCP := xFilial()+SCP->CP_PRODUTO
					EndIf
					nSaldo := 0
					If MsSeek(cSeekSCP)
						If SCP->(FieldPos("CP_CONSEST")) == 0 .Or. SCP->CP_CONSEST == "1" //-- Considera Estoque que produto possui
							RecLock("SB2")
							If lAmzSA
					   			nSaldo  := SaldoSB2(.F.,lConsEmp)+If(lConsSPed,AvalSalPed(SCP->CP_PRODUTO,SCP->CP_LOCAL),0)
							Else
								While !Eof() .And. cSeekSCP == SB2->B2_FILIAL+SB2->B2_COD
									If SB2->B2_LOCAL < cSldAmzIni .Or. SB2->B2_LOCAL > cSldAmzFim
										SB2->(dbSkip())
										Loop
									EndIf
									nSaldo += SaldoSB2(.F.,lConsEmp)+If(lConsSPed,AvalSalPed(SB2->B2_COD,SB2->B2_LOCAL),0)
									SB2->(dbSkip())
								EndDo
							EndIf
						Else
							lGeraSC1:= .T.
							nSaldo:= 0
						EndIf
					EndIf
					If ExistBlock("MT106GRV")
						ExecBlock("MT106GRV",.F.,.F.)
					EndIf
                   	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//?Calcula se possui estoque de segurança ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ       
					if lEstSeg
				   		nEstSeg   := CalcEstSeg( RetFldProd(SB1->B1_COD,"B1_ESTFOR","SB1") )
	                    If nEstSeg > 0
	                    	nSaldo:= nSaldo - nEstSeg 
	                    EndIf 
					EndIf
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//?Ponto de entrada que permite validar se deve ou nao ser  ?
					//?gerada a pre-requisicao de solicitacao ao armazem.       ?			
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If ExistBlock("MT106VGR") 
						If (Valtype(lContinua := ExecBlock("MT106VGR",.F.,.F.,{lAmzSA,nSaldo,lConsEmp,lConsSPed}))=='L') .And. !lContinua
						    //Quando executado o break o mesmo pulara para o final da funcao
						    //executando la o DbSkip() sem a necessesidade de se colocar um dbSkip loop aqui.
							DisarmTransaction()
						    break
						EndIf				
					EndIf						
					nQtde	:= SCP->CP_QUANT
					nEstoque:= 0
					cSeq    := "01"
					nQtdPre := nQtde
					uLoteSC := Nil
					While nQtde > 0
						nSaldo  := Max(0,nSaldo)
						nEstoque:= Min(nSaldo,nQtde)
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//?Verifica se pode gerar pre-requisicao com saldo negativo ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If GetMv("MV_ESTNEG")=="S" .And. !lGeraSC1 .And. !(Rastro(SCP->CP_PRODUTO) .Or. Localiza(SCP->CP_PRODUTO))
							nEstoque := nQtde
						EndIf
	
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//?Grava Pre-Requisicao         ?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						nRegSemSC:=0
						dbSelectArea("SCQ")
						dbSetOrder(1)
						cSeekSCQ:=xFilial("SCQ")+SCP->CP_NUM+SCP->CP_ITEM
						dbSeek(cSeekSCQ)
						While !Eof() .And. cSeekSCQ == CQ_FILIAL+CQ_NUM+CQ_ITEM
							If Empty(CQ_NUMSC) .And. Empty(CQ_NUMAE)
								nRegSemSC := Recno()
								nQtdPre   -= SCQ->CQ_QTDISP
								nQtde     -= SCQ->CQ_QTDISP
								Exit
							EndIf						
							dbSkip()
						End
				
						If !lGeraSC1 .And. nRegSemSC > 0
							msGoto(nRegSemSC)
							RecLock("SCQ",.F.)
							SCQ->CQ_QTDISP := SCQ->CQ_QTDISP+nEstoque
							MsUnlock()
							lIncluiReg:=.F.
							MaAvalRA("SCQ",3,nEstoque)
						Else
							RecLock("SCQ",.T.)					
							SCQ->CQ_FILIAL := xFilial("SCQ")
							SCQ->CQ_NUM    := SCP->CP_NUM
							SCQ->CQ_ITEM   := SCP->CP_ITEM
							SCQ->CQ_PRODUTO:= SCP->CP_PRODUTO
							SCQ->CQ_LOCAL  := SCP->CP_LOCAL
							SCQ->CQ_UM     := SCP->CP_UM
							SCQ->CQ_QUANT  := nQtdPre
							SCQ->CQ_QTSEGUM:= SCP->CP_QTSEGUM
							SCQ->CQ_SEGUM  := SCP->CP_SEGUM
							SCQ->CQ_QTDISP := nEstoque
							SCQ->CQ_NUMSQ  := cSeq
							SCQ->CQ_DATPRF := SCP->CP_DATPRF
							SCQ->CQ_DESCRI := SCP->CP_DESCRI
							SCQ->CQ_CC     := SCP->CP_CC
							SCQ->CQ_CONTA  := SCP->CP_CONTA
							SCQ->CQ_ITEMCTA:= SCP->CP_ITEMCTA
							SCQ->CQ_CLVL   := SCP->CP_CLVL
							SCQ->CQ_OP	   := SCP->CP_OP 	
							
							For nX := 1 To Len(aCTBEnt)
								If SCQ->(FieldPos("CQ_EC"+aCTBEnt[nX]+"CR")) > 0 .And. SCP->(FieldPos("CP_EC"+aCTBEnt[nX]+"CR")) > 0
									SCQ->&("CQ_EC"+aCTBEnt[nX]+"CR") := SCP->&("CP_EC"+aCTBEnt[nX]+"CR")
									SCQ->&("CQ_EC"+aCTBEnt[nX]+"DB") := SCP->&("CP_EC"+aCTBEnt[nX]+"DB")
								EndIf
							Next nX
							
							//aMT106SCQ utilizada no P.E. MT106PRE
							aAdd(aMT106SCQ,{SCQ->CQ_FILIAL,SCQ->CQ_NUM,SCQ->CQ_ITEM,SCQ->CQ_NUMSQ,SCQ->CQ_PRODUTO,SCQ->CQ_LOCAL,SCQ->CQ_QUANT})
	
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
							//?Ponto de Entrada MA106SCQ     |
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
							If Existblock("MA106SCQ")
							   uLoteSC := ExecBlock("MA106SCQ",.F.,.F.)
							   If Valtype(uLoteSC) == "N" .And. uLoteSC > 0
							   		nLoteSC := uLoteSC
							   	EndIf	
							Endif
							MaAvalRA("SCQ",1)
						EndIf					
						nLoteSC := IIf(uLoteSC <> Nil,nLoteSC,(SCQ->CQ_QUANT-SCQ->CQ_QTDISP))
						nLot2SC := ConvUm(SCP->CP_PRODUTO,nLoteSC,0,2)
						cMsgSC  := OemToAnsi(STR0002)+IIF(!Empty(SCP->CP_OBS)," - "+Left(SCP->CP_OBS,(Len(SC1->C1_OBS))-(Len(STR0002)+3)),"") //"SC gerada por SA"
	
						// Avalia empenho ja existente a fim de nao gerar SCS/AES caso ja tenha saldo empenhado
						If lConsEmp .And. AvalEmpSCP(SCP->CP_PRODUTO,SCP->CP_LOCAL,SCP->CP_OP,nQtdPre) 
							Reclock("SCP",.F.)
							SCP->CP_PREREQU := "S"
							MsUnlock()
							Exit
						// Qdo nao gera SC
						ElseIf !lGeraSC1
							If QtdComp(nLoteSC) > QtdComp(0)
								cMsg := STR0086+" "+SCP->CP_NUM+" / "+SCP->CP_ITEM
							EndIf
							Reclock("SCP",.F.)
							SCP->CP_PREREQU := "S"
							MsUnlock()
							Exit
						EndIf	

						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
						//³Ponto de Entrada para gerar contrato de parceria ou nao?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
						If ExistBlock("MASAVLCP")
							lVLCP := ExecBlock("MASAVLCP",.F.,.F.) 
							If Valtype(lVLCP) <> "L"
								lVLCP := .T.
							ElseIf !lVLCP  
								Reclock("SCP",.F.)
								SCP->CP_PREREQU := "S"
								MsUnlock()
							Endif
						EndIf	
						If ((nQtdPre - nEstoque) <= 0) .And. !lSaGerAe
							lVLCP := .F.
							Reclock("SCP",.F.)
							SCP->CP_PREREQU := "S"
							MsUnlock()
						EndIf
						// Verifica se existe contrato valido, caso contrario processa a geracao de SC no MATA106
						If SB1->B1_CONTRAT $ "A|" 
							lCtrVld := MatPesqCtr(.T.,SB1->B1_COD,SB1->B1_PROC,SB1->B1_LOJPROC)
						EndIf
						If SB1->B1_CONTRAT $ "SA" .And. lVLCP .And. lCtrVld
							If lGeraSC1
								aAdd(aCampos,{"CONTA",SCQ->CQ_CONTA})
								aAdd(aCampos,{"CC",SCQ->CQ_CC})
								aAdd(aCampos,{"CLVL",SCQ->CQ_CLVL})
								aAdd(aCampos,{"ITEMCTA",SCQ->CQ_ITEMCTA})
								For nX := 1 To Len(aCTBEnt)
									If SCQ->(FieldPos("CQ_EC"+aCTBEnt[nX]+"CR")) > 0 
										aAdd(aCampos,{"EC"+aCTBEnt[nX]+"CR",SCQ->&("CQ_EC"+aCTBEnt[nX]+"CR")})
										aAdd(aCampos,{"EC"+aCTBEnt[nX]+"DB",SCQ->&("CQ_EC"+aCTBEnt[nX]+"DB")})
									EndIf
								Next nX
							EndIf
							aAdd(aCampos,{"NUMSA",SCQ->CQ_NUM})
							If	lSaGerAe					
								MatGeraAE(SCP->CP_PRODUTO,nQtdPre,aCampos,"MATA106")
							Else
								MatGeraAE(SCP->CP_PRODUTO,(nQtdPre - nEstoque),aCampos,"MATA106")
							EndIf
							//-- Se gerou AE, atualiza pre req. com o numero
							If SC7->(FieldPos("C7_NUMSA")) > 0
								If SC7->C7_NUMSA == SCQ->CQ_NUM
									RecLock("SCQ",.F.)
									SCQ->CQ_NUMAE := SC7->C7_NUM
									SCQ->CQ_ITAE  := SC7->C7_ITEM
									SCQ->(MsUnLock())
									If SCP->(FieldPos("CP_NUMSC")) > 0 .And. SCP->(FieldPos("CP_ITSC")) > 0
										Reclock("SCP",.F.)
										SCP->CP_NUMSC := SC3->C3_NUM
										SCP->CP_ITSC  := SC3->C3_ITEM
										SCP->(MsUnLock())
									EndIf
								Else
									RecLock("SCQ",.F.)
									SCQ->CQ_NUMSC := SC1->C1_NUM
									SCQ->CQ_ITSC  := SC1->C1_ITEM
									SCQ->(MsUnLock())
									Reclock("SCP",.F.)
									SCP->CP_NUMSC := SC1->C1_NUM
									SCP->CP_ITSC  := SC1->C1_ITEM
									SCP->(MsUnLock())
								EndIf
							EndIf

							// Informacoes para envio ao RDMAKE
							aDadosGer := {"SC7",SC7->C7_NUM,SC7->C7_ITEM,SC7->(Recno())}										

							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//?Efetua a Baixa na Solicitacao ao almoxarifado                          ?
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							Reclock("SCP",.F.)
							SCP->CP_PREREQU := "S"
						EndIf	
						
						If ExistBlock("MT106CQ")
							Execblock("MT106CQ",.f.,.f.,aDadosGer)
						EndIf
						nQtde -= nQtdPre
						nSaldo-= nEstoque
						cSeq  := Soma1(cSeq,Len(SCQ->CQ_NUMSQ))
						
						lVldPE := .T.
						If ExistBlock("MASAVLSC")
							lVldPE := ExecBlock("MASAVLSC",.F.,.F.,{SB1->B1_COD,SB1->B1_LOCPAD,SB1->B1_CONTRAT}) 
							If Valtype(lVldPE) <> "L"
								lVldPE := .T.
							ElseIf !lVldPE  
								Reclock("SCP",.F.)
								SCP->CP_PREREQU := "S"
								MsUnlock() 
							EndIf
						EndIf	
						
						If SB1->B1_CONTRAT $ " |N" .Or. (!lCtrVld .And. SB1->B1_CONTRAT $ "A|")
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//?Calcula a Necessidade de uma Solicitacao de Compra                     ?
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							
							If lGeraSC1 .And. lVldPE
								If lPrjCni 
									If (lEsp == .T.)  
										If (VALSCPRE(cTpSC, .F.) == .F.) 
										   Exit
										EndIf  
									EndIf
								EndIf
								nQtdEmSC:= 0
								nQtdSc  := 0
								For nX := 1 To Len(aSCs)
									If ( If(nAglutSC == 1,.T.,aSCs[nX][11] == SCQ->CQ_NUM .And. If(nAglutSC == 2,aSCs[nX][12] == SCQ->CQ_ITEM,.T.)) .And. aSCs[nX][1] == SCQ->CQ_PRODUTO .And. aSCs[nX][2] == SCQ->CQ_LOCAL )
										nQtdEmSC += aSCs[nX][09]
										nQtdSC   += aSCs[nX][10]
									EndIf
								Next nX
								nLoteSC -= (nQtdSC - nQtdEmSC)
								
								//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
								//?Calcula a quantidade conforme o Lote Economico, conforme parametro 8   ?
								//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
								If lLtEco
									If ( nLoteSC > 0 )
										aLotes := CalcLote(SCQ->CQ_PRODUTO,nLoteSC,"C")
										nLoteSC:= 0
										For nX := 1 To Len(aLotes)
											nLoteSC += aLotes[nX]
										Next nX
									Else
										nLoteSC := 0
									EndIf
								EndIf	
	
								nSCs := aScan(aSCs,{|x| IIf(nAglutSC == 4,.T.,x[1]==SCP->CP_PRODUTO).And.;
									x[2]==SCP->CP_LOCAL.And.;
									x[3]==SCP->CP_DESCRI.And.;
									x[4]==SCP->CP_DATPRF.And.;
									x[5]==SCP->CP_CC .And.;
									IIf(!lMT106SCA,.T.,IF( len(aCPAgl)>0,x[13]== &(aCPAgl[1]),.T.)) .And.;
									IIf(nAglutSC == 1,.T.,x[11]==SCP->CP_NUM .And. If(nAglutSC == 2 .Or. nAglutSC == 4,x[12]==SCP->CP_ITEM,.T.))})
								If ( nLoteSC > 0 )
									If ( nSCs == 0 )                                 
										nSCs := IIf(nAglutSC == 1,Len(aSCs),nSCs)
										If ( nSCs == 0 )
											cItemSC := Repl("z",Len(SC1->C1_ITEM))
										Else
											cItemSC := Soma1(aSCs[nSCs][7],Len(SC1->C1_ITEM))
										EndIf
										If ( cItemSC > Repl("9",Len(SC1->C1_ITEM)) )
											If nAglutSC == 3 .Or. nAglutSC == 4
												// Ordena por numero + solicitacao + item
												aSort( aSCs,,, { |x,y| x[11]+x[6]+x[7] < y[11]+y[6]+y[7] } )
												nAchoSC   := aScan(aSCs,{|x| x[11]==SCP->CP_NUM})
                                                If nAchoSC > 0
													// Numero da solicitacao
													cNumSC  := aSCs[nAchoSC][6]						
													cItemSC := aSCs[nAchoSC][7]						
													// Calcula item da solicitacao
													While nAchoSC <= Len(aSCs) .And. aSCs[nAchoSC,11]+aSCs[nAchoSC,6] == SCP->CP_NUM+cNumSC			
														cItemSC := Soma1(aSCs[nAchoSC][7],Len(SC1->C1_ITEM))										
												   		nAchoSC++
												   	End		
												Else
													cItemSC := StrZero(1,Len(SC1->C1_ITEM))
													cNumSc  := CriaVar("C1_NUM",.T.)
													While ( GetSX8Len() > nSaveSX8 )
														ConfirmSx8()
													EndDo
													If ( Empty(cNumSC) )
														cNumSC := GetNumSC1()
													EndIf											
												EndIf
											Else
												cItemSC := StrZero(1,Len(SC1->C1_ITEM))
												cNumSc  := CriaVar("C1_NUM",.T.)
												While ( GetSX8Len() > nSaveSX8 )
													ConfirmSx8()
												EndDo
												If ( Empty(cNumSC) )
													cNumSC := GetNumSC1()
												EndIf
											EndIf
										Else
											cNumSC := aSCs[nSCs][6]						
										EndIf
										nSCs := IIf(nAglutSC == 1,nSCs,Len(aSCs))      
										aSCsAux:= {}
										aSCsAux:= {SCP->CP_PRODUTO,SCP->CP_LOCAL,SCP->CP_DESCRI,SCP->CP_DATPRF,SCP->CP_CC,"","", 0, 0, 0,SCP->CP_NUM,SCP->CP_ITEM}
										        // 01              02            03             04             05         06 07 08 09 10 11          12
	  									If lMT106SCA
								  			aCPAgl := Execblock("MT106SCA",.f.,.f.)
					                        If Valtype(aCPAgl) == "A"
					        				   aSCsAux:= {SCP->CP_PRODUTO,SCP->CP_LOCAL,SCP->CP_DESCRI,SCP->CP_DATPRF,SCP->CP_CC,"","", 0, 0, 0,SCP->CP_NUM,SCP->CP_ITEM,aCPAgl[2]}
											           // 01               02             03             04             05         06 07 08 09 10 11          12         Campo PE  
											EndIf 						
										Endif 

										aadd(aSCs,aSCsAux)
										
/*										aadd(aSCs,{SCP->CP_PRODUTO,; //01
											SCP->CP_LOCAL,;  //02
											SCP->CP_DESCRI,; //03
											SCP->CP_DATPRF,; //04
											SCP->CP_CC,;     //05
											"",;             //06
											"",;             //07
											0,;              //08
											0,;              //09									
											0,;              //10									
											SCP->CP_NUM,;    //11
											SCP->CP_ITEM})   //12
*/											
										nSCs++
										If !lRateio
											RecLock("SC1",.T.)
										EndIf
										aSCS[nSCs][06] := cNumSC
										aSCS[nSCs][07] := cItemSC
										aSCS[nSCs][08] := SC1->(RecNo())
										// Informacoes para envio ao RDMAKE
										aDadosGer :={"SC1",cNumSC,cItemSC,aSCS[nSCs][08]}
									Else
										cNumSC := aSCS[nSCs][06]
										cItemSC:= aSCS[nSCs][07]
										SC1->(MsGoto(aSCS[nSCs][08]))
										RecLock("SC1",.F.)
										MaAvalSC("SC1",2)

     									lAglutSA := If( nAglutSC == 1 , .T. , .F.)

									EndIf					
									aSCS[nSCs][09] += (SCQ->CQ_QUANT-SCQ->CQ_QTDISP)
									aSCS[nSCs][10] += nLoteSC

									If !lRateio
										SC1->C1_FILIAL := xFilial("SC1")
										If lPrjCni
											If (lEsp == .T.) 
											 	VALSCPRE(cTpSC, .T.) 
		
												SC1->C1_XTIPOSC:= cTpSC 
											Else
										   		SC1->C1_NUM    := cNumSC
											EndIf
										Else
											SC1->C1_NUM    := cNumSC
										EndIf
										SC1->C1_ITEM   := cItemSC
										SC1->C1_PRODUTO:= SCQ->CQ_PRODUTO
										SC1->C1_UM     := SCQ->CQ_UM
										SC1->C1_QUANT  += nLoteSC
										SC1->C1_SEGUM  := SCQ->CQ_SEGUM
										SC1->C1_QTSEGUM+= ConvUm(SCP->CP_PRODUTO,nLoteSC,0,2)
										SC1->C1_DATPRF := SCQ->CQ_DATPRF
										SC1->C1_LOCAL  := SCQ->CQ_LOCAL
										SC1->C1_OBS    := cMsgSC
										SC1->C1_CC     := SCQ->CQ_CC
										SC1->C1_CONTA  := SCQ->CQ_CONTA
										SC1->C1_ITEMCTA:= SCQ->CQ_ITEMCTA
										SC1->C1_CLVL   := SCQ->CQ_CLVL
										//S?grava o campo C1_OP se estiver integrado ao SIGAMNT.
										If AllTrim(GetMV("MV_NGMNTES")) == "S" .And. NGIFDBSEEK("STJ",SubStr(SCP->CP_OP,1,TAMSX3("TJ_ORDEM")[1]),1);
											.And. AllTrim(SubStr(SCP->CP_OP,TAMSX3("TJ_ORDEM")[1]+1)) == "OS001" .And. AllTrim(SCQ->CQ_PRODUTO) $ 'MANUTENCAO|TERCEIROS'
									   		SC1->C1_OP 	 := SCQ->CQ_OP
										EndIf
										For nX := 1 To Len(aCTBEnt)
											If SC1->(FieldPos("C1_EC"+aCTBEnt[nX]+"CR")) > 0 .And. SCQ->(FieldPos("CQ_EC"+aCTBEnt[nX]+"CR")) > 0
												SC1->&("C1_EC"+aCTBEnt[nX]+"CR") := SCQ->&("CQ_EC"+aCTBEnt[nX]+"CR")
												SC1->&("C1_EC"+aCTBEnt[nX]+"DB") := SCQ->&("CQ_EC"+aCTBEnt[nX]+"DB")
											EndIf
										Next nX
										SC1->C1_DESCRI := SCQ->CQ_DESCRI
										SC1->C1_EMISSAO:= dDataBase
										If lPrjCni
											PSWOrder(2)
											PSWSeek(SCP->CP_SOLICIT, .T.)									
											SC1->C1_SOLICIT:= cUserName						
											SC1->C1_XSOL   := PSWRet()[1][1]				
											SC1->C1_XPZCONT:= SCP->CP_XPZCONT				
											SC1->C1_XSTATUS:= SCP->CP_XSTATUS				
											SC1->C1_XCLASSI:= .T.            				
											SC1->C1_XSTGCT := "2"							
										Else
									   		SC1->C1_SOLICIT:= If(lAglutSA,STR0098,SCP->CP_SOLICIT) //"SA AGLUTINADA"
									   	EndIf							
										SC1->C1_FILENT := xFilEnt(SC1->C1_FILIAL)
		                                SC1->C1_IMPORT := SB1->B1_IMPORT
		                                SC1->C1_COTACAO:= If(SB1->B1_IMPORT=="S","IMPORT","")
		                                SC1->C1_FORNECE:= SB1->B1_PROC
		                                SC1->C1_LOJA   := SB1->B1_LOJPROC
										SC1->C1_CONTA  := SCQ->CQ_CONTA
										SC1->C1_ORIGEM := "MATA106"
										If SCP->(FieldPos("CP_VUNIT")) > 0
											SC1->C1_VUNIT := SCP->CP_VUNIT
										EndIf
										MaAvalSC("SC1",1)
										
										If lPrjCni
											SC1->C1_APROV  := "B"
											//Caio.Santos - 11/01/13 - Req.72
											RSTSCLOG("SOL",1,/*cUsrWF*/)
										EndIf  
									Else
																				// Monta Header para rotina automatica de solicitacao de compras
										aCabSC := {}
										If lPrjCni
											If (lEsp == .T.)
												VALSCPRE(cTpSC, .T.)
												aAdd(aCabSC,{"C1_XTIPOSC"	,cTpSC			,Nil})
											Else
												aAdd(aCabSC,{"C1_NUM"		,cNumSC			,Nil})
											EndIf
										Else
											aAdd(aCabSC,{"C1_NUM"			,cNumSC			,Nil})
										EndIf
										If lPrjCni
											PSWOrder(2)
											PSWSeek(SCP->CP_SOLICIT, .T.)
											aAdd(aCabSC,{"C1_SOLICIT"		,cUserName		,Nil})
										Else
											aAdd(aCabSC,{"C1_SOLICIT"	,If(lAglutSA,STR0098,SCP->CP_SOLICIT)	,Nil})
										EndIf
										aAdd(aCabSC,{"C1_EMISSAO"	,dDataBase				,Nil})
										aAdd(aCabSC,{"C1_FILENT"	,xFilEnt(SC1->C1_FILIAL),Nil})

										// Monta Itens para rotina automatica de solicitacao de compras
										aLinha := {}
										aAdd(aLinha,{"C1_ITEM"		,cItemSC				,Nil})
										aAdd(aLinha,{"C1_PRODUTO"	,SCQ->CQ_PRODUTO		,Nil})
										aAdd(aLinha,{"C1_UM"		,SCQ->CQ_UM				,Nil})
										aAdd(aLinha,{"C1_QUANT"		,nLoteSC				,Nil})
										aAdd(aLinha,{"C1_SEGUM"		,SCQ->CQ_SEGUM			,Nil})
										aAdd(aLinha,{"C1_QTSEGUM"	,ConvUm(SCP->CP_PRODUTO,nLoteSC,0,2)	,Nil})
										aAdd(aLinha,{"C1_DATPRF"	,SCQ->CQ_DATPRF			,Nil})
										aAdd(aLinha,{"C1_LOCAL"		,SCQ->CQ_LOCAL			,Nil})
										aAdd(aLinha,{"C1_OBS"		,cMsgSC					,Nil})
										aAdd(aLinha,{"C1_CC"		,SCQ->CQ_CC				,Nil})
										aAdd(aLinha,{"C1_CONTA"		,SCQ->CQ_CONTA			,Nil})
										aAdd(aLinha,{"C1_ITEMCTA"	,SCQ->CQ_ITEMCTA		,Nil})
										aAdd(aLinha,{"C1_CLVL"		,SCQ->CQ_CLVL			,Nil})
										If AllTrim(GetMV("MV_NGMNTES")) == "S" .And. NGIFDBSEEK("STJ",SubStr(SCP->CP_OP,1,TAMSX3("TJ_ORDEM")[1]),1);
											.And. AllTrim(SubStr(SCP->CP_OP,TAMSX3("TJ_ORDEM")[1]+1)) == "OS001" .And. AllTrim(SCQ->CQ_PRODUTO) $ 'MANUTENCAO|TERCEIROS'
											aAdd(aLinha,{"C1_OP"	,SCQ->CQ_OP				,Nil})
										EndIf
										For nX := 1 To Len(aCTBEnt)
											If SC1->(FieldPos("C1_EC"+aCTBEnt[nX]+"CR")) > 0 .And. SCQ->(FieldPos("CQ_EC"+aCTBEnt[nX]+"CR")) > 0
												cCampo := ""
												cCampo := "SC1->" + &("C1_EC"+aCTBEnt[nX]+"CR")
												aAdd(aLinha,{cCampo	,SCQ->&("CQ_EC"+aCTBEnt[nX]+"CR")	,Nil})
												cCampo := ""
												cCampo := "SC1->" + &("C1_EC"+aCTBEnt[nX]+"DB")
												aAdd(aLinha,{cCampo	,SCQ->&("CQ_EC"+aCTBEnt[nX]+"DB")	,Nil})
											EndIf
										Next nX
										aAdd(aLinha,{"C1_DESCRI"	,SCQ->CQ_DESCRI			,Nil})
										If lPrjCni
											PSWOrder(2)
											PSWSeek(SCP->CP_SOLICIT, .T.)
											aAdd(aLinha,{"C1_XSOL"		,PSWRet()[1][1]		,Nil})
											aAdd(aLinha,{"C1_XPZCONT"	,SCP->CP_XPZCONT	,Nil})
											aAdd(aLinha,{"C1_XSTATUS"	,SCP->CP_XSTATUS	,Nil})
											aAdd(aLinha,{"C1_XCLASSI"	,.T.				,Nil})
											aAdd(aLinha,{"C1_XSTGCT"	,"2"				,Nil})
										EndIf
										aAdd(aLinha,{"C1_IMPORT"	,SB1->B1_IMPORT			,Nil})
										aAdd(aLinha,{"C1_COTACAO"	,If(SB1->B1_IMPORT=="S","IMPORT","")	,Nil})
										aAdd(aLinha,{"C1_FORNECE"	,SB1->B1_PROC			,Nil})
										aAdd(aLinha,{"C1_LOJA"		,SB1->B1_LOJPROC		,Nil})
										aAdd(aLinha,{"C1_CONTA"		,SCQ->CQ_CONTA			,Nil})
										aAdd(aLinha,{"C1_ORIGEM"	,"MATA106"				,Nil})
										If SCP->(FieldPos("CP_VUNIT")) > 0
											aAdd(aLinha,{"C1_VUNIT"	,SCP->CP_VUNIT				,Nil})
										EndIf
										If lPrjCni
											aAdd(aLinha,{"C1_APROV"	,"B"					,Nil})
											RSTSCLOG("SOL",1,/*cUsrWF*/)
										EndIf
										aItemSC := {}
										aAdd(aItemSC,aLinha)

										// Dispara rotina automatica uma vez para cada item pois nao deve aglutinar itens quando tiver rateio
										If !Empty(aCabSC) .And. !Empty(aItemSC)
											//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
											//?Carrega o rateio da solicitacao de compra para o pedido  ?
											//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
											If AliasIndic("SGS")
												cChaveRat := SCP->(CP_NUM+CP_ITEM)
												SAGeraSGX(cChaveRat,@aColsSCX)
											EndIf
											lMsErroAuto :=.F.
											MSExecAuto({|v,x,y,z| MATA110(v,x,y,,,z)},aCabSC,aItemSC,3,aColsSCX)
											If !lMsErroAuto
												ConOut(OemToAnsi("Incluido com sucesso! ")+cNumSC)
											Else
												aErrPCAuto	:= GETAUTOGRLOG()
												lErrAutSC	:= .T.
												ConOut(OemToAnsi("Erro na inclusao!"))
											EndIf
										EndIf
									EndIf

									If ExistBlock("MT106SC1")
										Execblock("MT106SC1",.f.,.f.,aDadosGer)
									Endif
									If SCP->(FieldPos("CP_NUMSC")) > 0 .And. SCP->(FieldPos("CP_ITSC")) > 0
										RecLock("SCP",.F.)
										SCP->CP_NUMSC  := cNumSC
										SCP->CP_ITSC   := cItemSC					
									EndIf
									RecLock("SCQ",.F.)
									SCQ->CQ_NUMSC  := cNumSC
									SCQ->CQ_ITSC   := cItemSC
									SCQ->CQ_STATUSC:= "B"				

									lAglutSA := .F.

								Else
									If ( nSCs > 0 )
										aSCS[nSCs][09] += (SCQ->CQ_QUANT-SCQ->CQ_QTDISP)
										If SCP->(FieldPos("CP_NUMSC")) > 0 .And. SCP->(FieldPos("CP_ITSC")) > 0
											RecLock("SCP",.F.)
											SCP->CP_NUMSC  := cNumSC
											SCP->CP_ITSC   := cItemSC					
										EndIf
										RecLock("SCQ",.F.)
										SCQ->CQ_NUMSC  := aSCS[nSCs][06]
										SCQ->CQ_ITSC   := aSCS[nSCs][07]
										SCQ->CQ_STATUSC:= "B"
									EndIf
								EndIf
								Reclock("SCP",.F.)
								SCP->CP_PREREQU := "S"
								MsUnlock()
								//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
								//?Envia e-mail na inclusao de SC's     ?
								//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
								dbSelectarea("SXI")
								SXI->(dbsetorder(2))
								cEventID  := "035"
								IF cNumSA <> SC1->C1_NUM
									If msSeek('002' + '001' + cEventID) .And. !lRateio
										cMensagem:=STR0136+" - "+SC1->C1_NUM+" - "+STR0137
										EventInsert(FW_EV_CHANEL_ENVIRONMENT, FW_EV_CATEGORY_MODULES, cEventID,FW_EV_LEVEL_INFO,""/*cCargo*/,STR0138,cMensagem,.T./*lPublic*/)
										cNumSA := SC1->C1_NUM
									Else
										If !lRateio
											MEnviaMail("035",{SC1->C1_NUM})
											cNumSA := SC1->C1_NUM
										EndIf
								    EndIf
								EndIf 
							EndIf	
						EndIf 
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
						//³Ponto de Entrada para permitir a geração de Ordem de Produção pela Pr?Requisição?
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
						If ExistBlock("MASAVLOP")
							 ExecBlock("MASAVLOP",.F.,.F.)
						EndIf	
						// Se houve erro na geracao da rotina automatica da solicitacao de compra desfaz alteracoes
						If lErrAutSC .And. !IsBlind()
							AVISO(STR0116,STR0117,{STR0118})
							DisarmTransaction()
							Exit
						EndIf
					EndDo
				End Transaction
				If !Empty(cMsg) .And. !lAuto
					Aviso(STR0014,cMsg,{STR0087},1)			
				EndIf
				If	Empty(cMsg)
					AAdd(aRecSCP,SCP->(Recno()))
				EndIf
			EndIf
		EndIf
	EndIf
	dbSelectArea(cCursor)
	dbSkip()
	lVLCP := .T. // Ativa variavel para validar novo item da Geracao de pre req. ao armazem 
EndDo
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³P.E. Apos a geracao completa da Pre-Requisicao	   ?
//³PARAMIXB[1] := CQ_FILIAL   PARAMIXB[2] := CQ_NUM    ?
//³PARAMIXB[3] := CQ_ITEM     PARAMIXB[4] := CQ_NUMSQ  ?
//³PARAMIXB[5] := CQ_PRODUTO  PARAMIXB[6] := CQ_LOCAL  ?
//³PARAMIXB[7] := CQ_QUANT                             ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ExistBlock("MT106PRE")
	ExecBlock("MT106PRE",.F.,.F.,aMT106SCQ)
EndIf
If ( lQuery )
	dbSelectArea(cCursor)
	dbCloseArea()
	dbSelectArea("SCP")
EndIf
If lGeraSC1
	PcoFinLan("000051")
EndIf
RestArea(aArea)
Return(.T.)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ³MaCanAltSA?Autor ³Eduardo Riera          ?Data ?7.03.2000³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ³Verifica se eh possivel alterar a Solic.ao almoxarifado     ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ³ExpL1 := MaCanAltSA(ExpL2)  							   	  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros³ExpL2: Indica se consiste SCP->CP_NUMOS (OPC) DEFAULT = .T. ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ³ExpL1: .T. se Ok                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ³Generico                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Function MaCanAltSA(lMata105)

Local lRetorno := .T.
DEFAULT lMata105 := .T.

Do Case
Case ( SCP->CP_PREREQU=="S" )
	lRetorno := .F.
Case ( SCP->(FieldPos("CP_NUMOS")) != 0 .And. !Empty(SCP->CP_NUMOS) .And. lMata105 .And. (FindFunction("ExistOS") .And. ExistOS(SCP->CP_NUMOS)))
	lRetorno := .F.
EndCase

Return(lRetorno)


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ³MaCanDelSA?Autor ³Eduardo Riera          ?Data ?7.03.2000³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ³Verifica se eh possivel excluir a Solic.ao almoxarifado     ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ³ExpL1 := MaCanDelSA(ExpL2)  							   	  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros³ExpL2: Indica se consiste SCP->CP_NUMOS (OPC) DEFAULT = .T. ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ³ExpL1: .T. se Ok                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ³Generico                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Function MaCanDelSA(lMata105)

Local lRetorno := MaCanAltSA(lMata105)
DEFAULT lMata105 := .T.

Return(lRetorno)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaComView?Autor ?Edson Maricate          ?Data ?3.11.2000³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³Cria uma tela de consulta das ultimas compras, cotacoes ,    ³±?
±±?         ³consumos de um determinado produto.                          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaComView(ExpC1)			   							   	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do Produto                                     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaComView(cProduto)

Local aArea		:= GetArea()
Local aAreaSX3	:= SX3->(GetArea())
Local aAreaSB1	:= SB1->(GetArea())
Local aCpos		:= {}
Local nCntFor
Local nRecSB1
Local oBold
Local oDlg
Local lContCT  := .T.
Local lContPC  := .T.
Local lContNF  := .T.

Private aTELA[0][0],aGETS[0]
Private lRefresh	:= .T.
Private Inclui		:= .F.
Private Altera		:= .F.
Private aViewSC8
Private aViewSC7
Private aViewNF
Private aRecSD1
Private lPasMCV := .T. //passou no macomview, esta variavel serve para tratar erro na visualização ultimas faturas no historico de produto

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Ponto de Entrada para tratamento de visualizacao de dados              ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ                
If ExistBlock( "MC050CNT" )
	If Valtype( aRet := Execblock( "MC050CNT", .F., .F., (cProduto) ) ) == "A"
		If Valtype(aRet[1]) == "L"
			lContCT := aRet[1]  
		EndIf
		If Valtype(aRet[2]) == "L"
			lContPC := aRet[1]
		EndIf
		If Valtype(aRet[3]) == "L"
			lContNF := aRet[3]
		EndIf
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Posiciona o cadastro de produtos                                       ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea('SB1')
dbSetOrder(1)
If MsSeek(xFilial()+cProduto)

	dbSelectArea("SX3")
	dbSetOrder(1)
	If MsSeek("SB1")
		While ( !Eof() .And. SX3->X3_ARQUIVO == "SB1" )
			If X3USO(X3_USADO) .And. cNivel >= X3_NIVEL .And. !(AllTrim(X3_CAMPO)$"B1_COD/B1_DESC")
				aAdd(aCpos,X3_CAMPO)
			EndIf
			dbSkip()
		Enddo
		RegToMemory("SB1", .F., .F. )
		DEFINE FONT oBold NAME "Arial" SIZE 0, -12 BOLD
		DEFINE MSDIALOG oDlg FROM 0,0  TO 340,600 TITLE OemToAnsi(STR0074) Of oMainWnd PIXEL      //   'Historico de Compras'
		EnChoice("SB1", nRecSB1, iif(Len(aRotina)>1,2,1), , , , aCpos ,{20,2,150,298} , ,3 )
		@ 157 ,10  BUTTON STR0063 SIZE 45 ,10  FONT oDlg:oFont ACTION MaComViewPC(SB1->B1_COD,lContPC)  OF oDlg PIXEL  //"Ultimos Pedidos"
		@ 157 ,56  BUTTON STR0064 SIZE 45 ,10  FONT oDlg:oFont ACTION MaComViewCT(SB1->B1_COD,lContCT)  OF oDlg PIXEL  //"Ultimas Cotacoes"
		@ 157 ,102 BUTTON STR0035 SIZE 45 ,10  FONT oDlg:oFont ACTION MaComViewSm(SB1->B1_COD)  OF oDlg PIXEL  //"Consumo"
		@ 157 ,148 BUTTON STR0065 SIZE 45 ,10  FONT oDlg:oFont ACTION MaComViewNF(SB1->B1_COD,lContNF)  OF oDlg PIXEL  //"Ultimas N.Fiscais"
		@ 157 ,194 BUTTON STR0066 SIZE 49 ,10  FONT oDlg:oFont ACTION MaViewSB2(SB1->B1_COD)  OF oDlg PIXEL  //"Consulta Estoques"
		@ 157 ,244 BUTTON STR0067 SIZE 45 ,10  FONT oDlg:oFont ACTION (oDlg:End())  OF oDlg PIXEL  //"Sair"
		@ 4  ,10   SAY Alltrim(cProduto)+ " - "+SB1->B1_DESC Of oDlg PIXEL SIZE 245 ,9 FONT oBold
		@ 13, 4 To 14,302 Label "" of oDlg PIXEL
		ACTIVATE MSDIALOG oDlg CENTERED
	EndIf
Endif

RestArea(aAreaSX3)
RestArea(aAreaSB1)
RestArea(aArea)
Return Nil


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaComViewPC?Autor ?Edson Maricate       ?Data ?3.11.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³Cria uma tela de consulta com os ultimos Pedidos de Compras. ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaComViewPC(ExpC1)		   							   	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do Produto                                     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³Materiais                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaComViewPC(cProduto,lContPC)

Local aArea		:= GetArea()
Local aAreaSC7	:= SC7->(GetArea())
Local aNew      := {}
Local aRecSC7	:= {}
Local aHeadCpos	:= {STR0006,STR0007,STR0008,STR0009,STR0010,STR0011,STR0088,STR0012,STR0013}
Local cCursor
Local cQuery
Local oBold
Local cDescProd := ""
Local cQueryPE	:= ""
Local cFiltroPE := ""

#IFDEF TOP
	Local nLoop := 0
#ENDIF
Local lPcAdColH := ExistBlock("PCADCOLH") // Ponto de entrada para adicionar o Header ao adicionar mais colunas na listbox de consulta
Local lPcAdHead := ExistBlock("PCADHEAD") // Ponto de entrada para adicionar colunas ao Header
Local lPcAdLine := ExistBlock("PCADLINE") // Ponto de entrada para adicionar mais colunas na listbox de consulta
Local lPcAdFil	:= ExistBlock("PCADFIL")  // Ponto de entrada para manipulacao da query/filtro
Default lContPC := .T.
 
If lContPC
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona o cadastro de produtos                                       ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea('SB1')
	dbSetOrder(1)
	If MsSeek(xFilial()+cProduto)
		cDescProd:=SB1->B1_DESC
		If aViewSC7 == Nil
			aViewSC7 := {}
			#IFDEF TOP
				If TcSrvType() != "AS/400"
					cCursor:= GetNextAlias()
					lQuery := .T.
					cQuery := ""
					cQuery += "SELECT * FROM "+RetSqlName("SC7")+" WHERE "
					cQuery += "C7_FILIAL='"+xFilial("SC7")+"' AND "
					cQuery += "C7_PRODUTO='"+cProduto+"' AND "
					cQuery += "D_E_L_E_T_ <> '*' "
					cQuery += "ORDER BY C7_DATPRF DESC"          
					If lPcAdFil
					   cQueryPE := Execblock('PCADFIL', .F., .F., {cQuery})
					   cQuery   := If(ValType(cQueryPE)=='C', cQueryPE, "")
					EndIf
					cQuery := ChangeQuery(cQuery)
					SC7->(dbCommit())
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cCursor,.T.,.T.)
					aStruQuery	:= SC7->(dbStruct())
					For nLoop := 1 To Len( aStruQuery )
						If aStruQuery[nLoop,2] <> "C"
							TCSetField(cCursor,AllTrim(aStruQuery[nLoop,1]),aStruQuery[nLoop,2],aStruQuery[nLoop,3],aStruQuery[nLoop,4])
						EndIf 										
					Next nLoop
					While ( !Eof() )
						dbSelectArea("SE4")
						MsSeek(xFilial()+(cCursor)->C7_COND)
						dbSetOrder(1)
						dbSelectArea("SA2")
						dbSetOrder(1)
						MsSeek(xFilial()+(cCursor)->C7_FORNECE+(cCursor)->C7_LOJA)
						dbSelectArea(cCursor)		
						aAdd(aViewSC7,{C7_NUM,C7_ITEM,SA2->A2_NOME,TransForm(C7_QUANT,PesqPict("SC7","C7_QUANT")),TransForm(C7_PRECO,PesqPict("SC7","C7_PRECO")),TransForm(C7_QUJE,PesqPict("SC7","C7_QUJE")),C7_RESIDUO,C7_COND+" - "+SE4->E4_DESCRI,C7_DATPRF})
	
						If lPcAdLine
							aNew := ExecBlock("PCADLINE", .F., .F., aViewSC7[Len(aViewSC7)])
							If ValType(aNew) == "A"
								aViewSC7[Len(aViewSC7)] := aNew
							Endif	
						Endif
						
						dbSkip()					
					EndDo
				Else
			#ENDIF
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Seleciona os registros do SC8 - DBF / INDREGUA                         ?
				//?Abre um novo Alias para evitar problemas com filtros ja existentes.    ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				cIndex := CriaTrab(,.F.)
				ChkFile("SC7",.F.,"TMP")
				dbSelectArea("TMP")
				cFiltro := ""
				cFiltro += "C7_FILENT=='"+xFilial("SC7")+"'.AND."
				cFiltro += "C7_PRODUTO=='"+cProduto+"'"
				If lPcAdFil
				   cFiltroPE := Execblock('PCADFIL', .F., .F., {cFiltro})
				   cFiltro   := If(ValType(cFiltroPE)=='C', cFiltroPE, "")
				EndIf
				
				IndRegua("TMP",cIndex,"C7_FILENT+DTOS(C7_DATPRF)",,cFiltro,STR0004) //"Selecionando Registros..."
				#IFNDEF TOP
					dbSetIndex(cIndex+OrdBagExt())
				#ENDIF
				dbGoBottom()
				While !Bof().And.Len(aViewSC7)<200
					dbSelectArea("SE4")
					MsSeek(xFilial()+TMP->C7_COND)
					dbSetOrder(1)
					dbSelectArea("SA2")
					dbSetOrder(1)
					MsSeek(xFilial()+TMP->C7_FORNECE+TMP->C7_LOJA)
					dbSelectArea("TMP")
					aAdd(aViewSC7,{C7_NUM,C7_ITEM,SA2->A2_NOME,TransForm(C7_QUANT,PesqPict("SC7","C7_QUANT")),TransForm(C7_PRECO,PesqPict("SC7","C7_PRECO")),TransForm(C7_QUJE,PesqPict("SC7","C7_QUJE")),C7_RESIDUO,C7_COND+" - "+SE4->E4_DESCRI,C7_DATPRF})
					
					If lPcAdLine
						aNew := ExecBlock("PCADLINE", .F., .F., aViewSC7[Len(aViewSC7)])
						If ValType(aNew) == "A"
							aViewSC7[Len(aViewSC7)] := aNew
						Endif	
					Endif
					
					dbSkip(-1)
				End
				dbSelectArea("TMP")
				dbClearFilter()
				dbCloseArea()
				Ferase(cIndex+OrdBagExt())
				#IFDEF TOP
				EndIf
				#ENDIF
			
			If lPcAdColH
				aNew := ExecBlock("PCADCOLH", .F., .F., aHeadCpos[Len(aHeadCpos)])
				If ValType(aNew) == "A"
					aHeadCpos[Len(aHeadCpos)] := aNew
				Endif	
			Endif 		
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
			//?Ponto de entrada para manipular as colunas da consulta de ultimos     ?
			//?pedidos                                                               ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
			If lPcAdHead
				aNew := ExecBlock("PCADHEAD", .F., .F., aHeadCpos)
				If ValType(aNew) == "A"
					aHeadCpos := aNew
				Endif	
			Endif 		
		EndIf
		If !Empty(aViewSC7)
			DEFINE FONT oBold NAME "Arial" SIZE 0, -12 BOLD
			DEFINE MSDIALOG oDlg FROM 0,0  TO 340,600 TITLE STR0005 Of oMainWnd PIXEL //"Historico de compras - Ultimos Pedidos"
			@ 13, 4 To 14,302 Label "" of oDlg PIXEL
			oListBox := TWBrowse():New( 20,2,298,130,,aHeadCpos,,oDlg,,,,,,,,,,,,.F.,,.T.,,.F.,,,) //"Pedido"###"Item"###"Fornecedor"###"Quantidade"###"Preco Unit."###"Qtde. Entregue"###"Cond. Pagto."###"Previsao Entr."
			oListBox:SetArray(aViewSC7)
			oListBox:bLine := { || aViewSC7[oListBox:nAT]}
			@ 4  ,10   SAY Alltrim(cProduto)+ " - "+cDescProd Of oDlg PIXEL SIZE 245 ,9 FONT oBold
			@ 157 ,194  BUTTON STR0068 SIZE 45 ,10  FONT oDlg:oFont ACTION MaViewPC(aViewSC7[oListBox:nAT][1]) OF oDlg PIXEL  //"Visualizar"
			@ 157 ,244  BUTTON STR0016 SIZE 45 ,10  FONT oDlg:oFont ACTION (oDlg:End())  OF oDlg PIXEL  //"Voltar"
			ACTIVATE MSDIALOG oDlg CENTERED
		Else
			Aviso(STR0014,STR0015,{STR0016},2) //"Atencao"###"Nao existem pedidos colocados para este produto."###"Voltar"
		EndIf
	EndIf	
	RestArea(aAreaSC7)
	RestArea(aArea)
	Return Nil
EndIf



/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaComViewCT?Autor ?Edson Maricate       ?Data ?3.11.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³Cria uma tela de consulta com os ultimas Cotacoes do Prod.   ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaComViewCT(ExpC1)		   							   	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do Produto                                     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                       ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³Materiais                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaComViewCT(cProduto,lContCT)

Local aArea		:= GetArea()
Local aAreaSC8	:= SC8->(GetArea())
Local aRecSC8	:= {}
Local aNew      := {}
Local aHeadCpos	:= {STR0018,STR0007,STR0008,STR0009,STR0010,STR0054,STR0012,STR0013,STR0079,STR0080,STR0081,STR0082,STR0083,STR0090,STR0097}
Local oBold
Local lCtAdColH := ExistBlock("CTADCOLH") // Ponto de entrada para adicionar o Header ao adicionar mais colunas na listbox de consulta
Local lCtAdLine := ExistBlock("CTADLINE") // Ponto de entrada para adicionar mais colunas na listbox de consulta
Local lCtAdFil	:= ExistBlock("CTADFIL")  // Ponto de entrada para manipulacao da query/filtro
Local cDescProd := ""
Local cFiltroPE	:= ""
Local cQueryPE	:= ""

#IFDEF TOP
	Local nLoop := 0
#ENDIF
Default lContCT := .T.

If lContCT
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona o cadastro de produtos                                       ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea('SB1')
	dbSetOrder(1)
	If MsSeek(xFilial()+cProduto)
		cDescProd := SB1->B1_DESC
		If aViewSC8 == Nil
			aViewSC8 := {}
			#IFDEF TOP
				If TcSrvType() != "AS/400"
					cCursor:= CriaTrab(,.F.)
					lQuery := .T.
					cQuery := ""
					cQuery += "SELECT * FROM "+RetSqlName("SC8")+" WHERE "
					cQuery += "C8_FILIAL='"+xFilial("SC8")+"' AND "
					cQuery += "C8_PRODUTO='"+cProduto+"' AND "
					cQuery += "C8_PRECO <> 0  AND "
					cQuery += "D_E_L_E_T_ <> '*' "
					cQuery += "ORDER BY C8_DATPRF DESC"
					If lCtAdFil
					   cQueryPE := Execblock('CtAdFil', .F., .F., {cQuery})
					   cQuery   := If(ValType(cQueryPE)=='C', cQueryPE, "")
					EndIf					
					cQuery := ChangeQuery(cQuery)
					SC8->(dbCommit())
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cCursor,.T.,.T.)
					aStruQuery	:= SC8->(dbStruct())
					For nLoop := 1 To Len( aStruQuery )
						If aStruQuery[nLoop,2] <> "C"
							TCSetField(cCursor,AllTrim(aStruQuery[nLoop,1]),aStruQuery[nLoop,2],aStruQuery[nLoop,3],aStruQuery[nLoop,4])
						EndIf 										
					Next nLoop
					While ( !Eof() )
						dbSelectArea("SE4")
						MsSeek(xFilial()+(cCursor)->C8_COND)
						dbSetOrder(1)
						dbSelectArea("SA2")
						dbSetOrder(1)
						MsSeek(xFilial()+(cCursor)->C8_FORNECE+(cCursor)->C8_LOJA)
						dbSelectArea(cCursor)		
					    SC8->(dBGoto((cCursor)->(R_E_C_N_O_))) 
						aAdd(aViewSC8,{C8_NUM,C8_ITEM,SA2->A2_NOME,TransForm(C8_QUANT,PesqPict("SC8","C8_QUANT")),TransForm(C8_PRECO,PesqPict("SC8","C8_PRECO")),;
							TransForm(C8_TOTAL,PesqPict("SC8","C8_TOTAL")),C8_COND+" - "+SE4->E4_DESCRI,C8_DATPRF,C8_EMISSAO,;
							TransForm(C8_VALIPI,PesqPict("SC8","C8_VALIPI")),TransForm(C8_ALIIPI,PesqPict("SC8","C8_ALIIPI")+" %"),;
							TransForm(C8_VALICM,PesqPict("SC8","C8_VALICM")),TransForm(C8_PICM,PesqPict("SC8","C8_PICM")+" %"),C8_MOTIVO,SC8->C8_OBS})
	
						If lCtAdLine
							aNew := ExecBlock("CTADLINE", .F., .F., aViewSC8[Len(aViewSC8)])
							If ValType(aNew) == "A"
								aViewSC8[Len(aViewSC8)] := aNew
							Endif	   
						Endif 
	
						dbSkip()					
					EndDo
					dbSelectArea(cCursor)
					dbCloseArea()
					dbSelectArea("SC8")
				Else
			#ENDIF
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Seleciona os registros do SC8 - DBF / INDREGUA                         ?
				//?Abre um novo Alias para evitar problemas com filtros ja existentes.    ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				cIndex := CriaTrab(,.F.)
				ChkFile("SC8",.F.,"TMP")
				dbSelectArea("TMP")
				cFiltro := ""
				cFiltro += "C8_FILIAL=='"+xFilial("SC8")+"'.AND."
				cFiltro += "C8_PRODUTO=='"+cProduto+"'.AND."
				cFiltro += "C8_PRECO<>0"
				If lCtAdFil
				   cFiltroPE := Execblock('CTADFIL', .F., .F., {cFiltro})
				   cFiltro   := If(ValType(cFiltroPE)=='C', cFiltroPE, "")
				EndIf
				IndRegua("TMP",cIndex,"C8_FILIAL+DTOS(C8_DATPRF)",,cFiltro,STR0004) //"Selecionando Registros..."
				#IFNDEF TOP
					dbSetIndex(cIndex+OrdBagExt())
				#ENDIF
				dbGoBottom()
				While !Bof().And.Len(aViewSC8)<200
					dbSelectArea("SE4")
					MsSeek(xFilial()+TMP->C8_COND)
					dbSetOrder(1)
					dbSelectArea("SA2")
					dbSetOrder(1)
					MsSeek(xFilial()+TMP->C8_FORNECE+TMP->C8_LOJA)
					dbSelectArea("TMP")
					aAdd(aViewSC8,{C8_NUM,C8_ITEM,SA2->A2_NOME,TransForm(C8_QUANT,PesqPict("SC8","C8_QUANT")),TransForm(C8_PRECO,PesqPict("SC8","C8_PRECO")),;
						TransForm(C8_TOTAL,PesqPict("SC8","C8_TOTAL")),C8_COND+" - "+SE4->E4_DESCRI,C8_DATPRF,C8_EMISSAO,;
						TransForm(C8_VALIPI,PesqPict("SC8","C8_VALIPI")),TransForm(C8_ALIIPI,PesqPict("SC8","C8_ALIIPI")+" %"),;
						TransForm(C8_VALICM,PesqPict("SC8","C8_VALICM")),TransForm(C8_PICM,PesqPict("SC8","C8_PICM")+" %"),C8_MOTIVO,C8_OBS})
	
					If lCtAdLine
						aNew := ExecBlock("CTADLINE", .F., .F., aViewSC8[Len(aViewSC8)])
						If ValType(aNew) == "A"
							aViewSC8[Len(aViewSC8)] := aNew
						Endif	   
					Endif 
					
					dbSkip(-1)
				End
				dbSelectArea("TMP")
				dbClearFilter()
				dbCloseArea()
				Ferase(cIndex+OrdBagExt())
				#IFDEF TOP
				EndIf
				#ENDIF
			
				If lCtAdColH
					aNew := ExecBlock("CTADCOLH", .F., .F., aHeadCpos)
					If ValType(aNew) == "A"
						aHeadCpos := aNew
					Endif	   
				Endif 		
		EndIf
		
		If !Empty(aViewSC8)
			DEFINE FONT oBold NAME "Arial" SIZE 0, -12 BOLD
			DEFINE MSDIALOG oDlg FROM 0,0  TO 340,600 TITLE STR0017 Of oMainWnd PIXEL //"Historico de compras - Ultimas Cotacoes"
			@ 13, 4 To 14,302 Label "" of oDlg PIXEL
			oListBox := TWBrowse():New( 20,2,298,130,,aHeadCpos,,oDlg,,,,,,,,,,,,.F.,,.T.,,.F.,,,)  //"Cotacao"###"Item"###"Fornecedor"###"Quantidade"###"Preco Unit."###"Total"###"Cond. Pagto."###"Previsao Entr."###"Data Emissao##Aliq IPI##Valor IPI###Aliq ICMS##Valor ICMS"
			oListBox:SetArray(aViewSC8)
			oListBox:bLine := { || aViewSC8[oListBox:nAT]}
			@ 4  ,10   SAY Alltrim(cProduto)+ " - "+cDescProd Of oDlg PIXEL SIZE 245 ,9 FONT oBold
			@ 157 ,244  BUTTON STR0016 SIZE 45 ,10  FONT oDlg:oFont ACTION (oDlg:End())  OF oDlg PIXEL  //"Voltar"
			ACTIVATE MSDIALOG oDlg CENTERED
		Else
			Aviso(STR0014,STR0019,{STR0016},2)	 //"Atencao"###"Nao existem cotacoes colocadas para este produto."###"Voltar"
		EndIf	
	EndIf
	
	RestArea(aAreaSC8)
	RestArea(aArea)
	Return Nil
EndIf	

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaComViewSm ?Autor ?Edson Maricate      ?Data ?3.11.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³Cria uma tela de consulta com os ultimos consumos do Produto ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaComViewSm(ExpC1)		   							   	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do Produto                                     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³Materiais                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaComViewSm(cProduto)

Local aHeaderCsm	:= {}
Local aViewAuxCsm	:= {}
Local aViewCsm		:= {}
Local aMeses		:= {STR0020,STR0021,STR0022,STR0023,STR0024,STR0025,STR0026,STR0027,STR0028,STR0029,STR0030,STR0031} //"Jan"###"Fev"###"Mar"###"Abr"###"Mai"###"Jun"###"Jul"###"Ago"###"Set"###"Out"###"Nov"###"Dez"
Local nX          := 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Posiciona o cadastro de produtos                                       ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea('SB1')
dbSetOrder(1)
If MsSeek(xFilial()+cProduto)
	dbSelectArea("SB3")
	dbSetOrder(1)
	If MsSeek(xFilial()+cProduto)
		cMeses	:= SPACE(3)
		nAno	:= YEAR(dDataBase)
		nMes	:= MONTH(dDataBase)
		aOrdem	:= {}
		nAno--
		For nx := nMes+1 To 12
			aADD(aViewCsm,{aMeses[nx],Str(nAno,4),&("B3_Q"+StrZero(nx,2))})
		Next nx
		nAno++
		For nx	:= 1 to nMes
			aADD(aViewCsm,{aMeses[nx],Str(nAno,4),&("B3_Q"+StrZero(nx,2))})
		Next nx
	EndIf
	If !Empty(aViewCsm)
		DEFINE FONT oBold NAME "Arial" SIZE 0, -12 BOLD
		DEFINE MSDIALOG oDlg FROM 0,0  TO 350,273 TITLE STR0032 Of oMainWnd PIXEL //"Consumos"
		@ 13, 4 To 14,302 Label "" of oDlg PIXEL
		oListBox := TWBrowse():New( 20,4,132,130,,{STR0033,STR0034,STR0035},{17,60,40},oDlg,,,,,,,,,,,,.F.,,.T.,,.F.,,,) //"Mes"###"Ano"###"Consumo"
		oListBox:SetArray(aViewCsm)
		oListBox:bLine := { || {aViewCsm[oListBox:nAT][1],aViewCsm[oListBox:nAT][2],TransForm(aViewCsm[oListBox:nAt][3],PesqPict("SB3","B3_Q01")) }}
		If TamSX3("B1_COD")[1] > 15
			@ 4  ,10   SAY Alltrim(cProduto) Of oDlg PIXEL SIZE 245 ,9 FONT oBold
			@ 12 ,10   SAY SB1->B1_DESC      Of oDlg PIXEL SIZE 245 ,9 FONT oBold
		Else
	   		@ 4  ,10   SAY Alltrim(cProduto)+ " - "+SB1->B1_DESC Of oDlg PIXEL SIZE 245 ,9 FONT oBold
		EndIf
		@ 160 ,80  BUTTON STR0016 SIZE 45 ,10  FONT oDlg:oFont ACTION (oDlg:End())  OF oDlg PIXEL  //"Voltar"
		ACTIVATE MSDIALOG oDlg CENTERED
	Else
		Aviso(STR0014,STR0036,{STR0016},2) //"Atencao"###"Nao existe registros de consumo para este produto."###"Voltar"
	EndIf	
EndIf

Return Nil
    

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaComViewNF?Autor ?Edson Maricate       ?Data ?3.11.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³Cria uma tela de consulta com os ultimas Cotacoes do Prod.   ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaComViewNF(ExpC1)		   							   	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do Produto                                     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                       ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³Materiais                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaComViewNF(cProduto,lContNF)

Local aArea		:= GetArea()
Local cDescProd := ""
Local aRet  
Local cFiltroSD1 := SD1->(dbFilter())
#IFDEF TOP
	Local nLoop := 0
#ENDIF
Default lContNF := .T.

If lContNF
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona o cadastro de produtos                                       ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea('SB1')
	dbSetOrder(1)
	If MsSeek(xFilial()+cProduto)
		cDescProd:=SB1->B1_DESC
		If aViewNF == Nil
			aViewNF := {}
			aRecSD1	:= {}
			#IFDEF TOP
				If TcSrvType() != "AS/400"
					cCursor:= CriaTrab(,.F.)
					lQuery := .T.
					cQuery := ""
					cQuery += "SELECT SD1.*,SD1.R_E_C_N_O_ SD1RECNO FROM "+RetSqlName("SD1")+" SD1 WHERE "
					cQuery += "D1_FILIAL='"+xFilial("SD1")+"' AND "
					cQuery += "D1_COD='"+cProduto+"' AND "
					cQuery += "D1_TES <> '"+SPACE(LEN(SD1->D1_TES))+"'  AND "
					cQuery += "D_E_L_E_T_ <> '*' "
					cQuery += "ORDER BY D1_NUMSEQ DESC"
					cQuery := ChangeQuery(cQuery)
					SD1->(dbCommit())
					dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cCursor,.T.,.T.)
					aStruQuery	:= SD1->(dbStruct())
					For nLoop := 1 To Len( aStruQuery )
						If aStruQuery[nLoop,2] <> "C"
							TCSetField(cCursor,AllTrim(aStruQuery[nLoop,1]),aStruQuery[nLoop,2],aStruQuery[nLoop,3],aStruQuery[nLoop,4])
						EndIf 										
					Next nLoop
					While ( !Eof() )
						If D1_TIPO $"DB"
							dbSelectArea("SA1")
							dbSetOrder(1)
							MsSeek(xFilial()+(cCursor)->D1_FORNECE+(cCursor)->D1_LOJA)
						Else
							dbSelectArea("SA2")
							dbSetOrder(1)
							MsSeek(xFilial()+(cCursor)->D1_FORNECE+(cCursor)->D1_LOJA)
						EndIf
						dbSelectArea(cCursor)
						aAdd(aViewNF,{D1_DTDIGIT,D1_TIPO,D1_DOC,D1_SERIE,If(D1_TIPO$"DB",SA1->A1_NOME,SA2->A2_NOME),TransForm(D1_QUANT,PesqPict("SD1","D1_QUANT")),;
						TransForm(IIF(D1_TIPO$"NDB",((D1_TOTAL-D1_VALDESC)/D1_QUANT),D1_VUNIT),PesqPict("SD1","D1_VUNIT")),D1_EMISSAO})
						aAdd(aRecSD1,SD1RECNO)
						dbSkip()
					EndDo
				Else
			#ENDIF
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Seleciona os registros do SD1 - DBF / INDREGUA                         ?
				//?Abre um novo Alias para evitar problemas com filtros ja existentes.    ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				SD1->(dbClearFilter())
				cIndex := CriaTrab(,.F.)
				ChkFile("SD1",.F.,"TMP")
				dbSelectArea("TMP")
				cFiltro := ""
				cFiltro += "D1_FILIAL=='"+xFilial("SD1")+"'.AND."
				cFiltro += "D1_COD=='"+cProduto+"'.AND."
				cFiltro += "D1_TES<>'"+SPACE(LEN(D1_TES))+"'"
				IndRegua("TMP",cIndex,"D1_FILIAL+DTOS(D1_DTDIGIT)",,cFiltro,STR0004) //"Selecionando Registros..."
				#IFNDEF TOP
					dbSetIndex(cIndex+OrdBagExt())
				#ENDIF
				dbGoBottom()
				While !Bof().And.Len(aViewNF)<200
					If D1_TIPO $"DB"
						dbSelectArea("SA1")
						dbSetOrder(1)
						MsSeek(xFilial()+TMP->D1_FORNECE+TMP->D1_LOJA)
					Else
						dbSelectArea("SA2")
						dbSetOrder(1)
						MsSeek(xFilial()+TMP->D1_FORNECE+TMP->D1_LOJA)
					EndIf
					dbSelectArea("TMP")
					aAdd(aViewNF,{D1_DTDIGIT,D1_TIPO,D1_DOC,D1_SERIE,If(D1_TIPO$"DB",SA1->A1_NOME,SA2->A2_NOME),TransForm(D1_QUANT,PesqPict("SD1","D1_QUANT")),;
					TransForm(IIF(D1_TIPO$"NDB",((D1_TOTAL-D1_VALDESC)/D1_QUANT),D1_VUNIT),PesqPict("SD1","D1_VUNIT")),D1_EMISSAO})
					aAdd(aRecSD1,Recno())
					dbSkip(-1)
				End
				dbSelectArea("TMP")
				dbClearFilter()
				dbCloseArea()
				Ferase(cIndex+OrdBagExt())
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³Restaura o conteudo do filtro da tabela SD1	 			 ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If !Empty(cFiltroSD1)
					SD1->(dbSetFilter({||&cFiltroSD1},cFiltroSD1))
				EndIF	
				#IFDEF TOP
				EndIf
				#ENDIF
		EndIf
		
		If Existblock("MTULTNFE")
			aRet := ExecBlock("MTULTNFE",.F.,.F.,{aViewNF,aRecSD1})
			If ValType(aRet) == "A"
				If ValType(aRet[1]) == "A"
					aViewNF := aRet[1]
				Endif	
				If ValType(aRet[2]) == "A"
					aRecSD1 := aRet[2]
				Endif				
			Endif	
		EndIf	
		
		If !Empty(aViewNF)
			DEFINE FONT oBold NAME "Arial" SIZE 0, -12 BOLD
			DEFINE MSDIALOG oDlg FROM 0,0  TO 340,600 TITLE STR0037 Of oMainWnd PIXEL //"Historico de compras - Ultimas N.Fiscais"
			@ 13, 4 To 14,302 Label "" of oDlg PIXEL
			oListBox := TWBrowse():New( 20,2,298,130,,{STR0038,STR0039,STR0040,STR0041,STR0042,STR0009,STR0043,STR0089},,oDlg,,,,,,,,,,,,.F.,,.T.,,.F.,,,)  //"Dt. Entrada"###"Tipo NF"###"Documento"###"Serie"###"Fornecedor/Cliente"###"Quantidade"###"Vlr. Unitario"###"Dt. Emissao"
			oListBox:SetArray(aViewNF)
			oListBox:bLine := { || aViewNF[oListBox:nAT]}
			@ 4  ,10   SAY Alltrim(cProduto)+ " - "+cDescProd Of oDlg PIXEL SIZE 245 ,9 FONT oBold
			@ 157 ,194  BUTTON STR0068 SIZE 45 ,10  FONT oDlg:oFont ACTION MaViewNF(aRecSD1[oListBox:nAt]) OF oDlg PIXEL  //"Visualizar"
			@ 157 ,244  BUTTON STR0016 SIZE 45 ,10  FONT oDlg:oFont ACTION (oDlg:End())  OF oDlg PIXEL  //"Voltar"
			ACTIVATE MSDIALOG oDlg CENTERED
		Else
			Aviso(STR0014,STR0044,{STR0016},2) //"Atencao"###"Nao existem Notas Fiscais de Entrada cadastradas para este produto."###"Voltar"
		EndIf	
	EndIf
	
	RestArea(aArea)
	Return Nil
EndIf

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaViewSB2  ?Autor ?Edson Maricate       ?Data ?3.11.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao ³Cria uma tela de consulta com os saldos atuais               ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³MaViewSB2(ExpC1,ExpC2,ExpC3)							   	   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do Produto                                     ³±?
±±?         ³ExpC2: Filial de Consulta                                    ³±?
±±?         ³ExpC3: Local (almox.)de Consulta (OPC) DEFAULT = ""          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ?T.                                                          ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³Materiais                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaViewSB2(cProduto,cFilCon,cAlmox)

Local aArea		:= GetArea()
Local aAreaSB1	:= SB1->(GetArea())
Local aAreaSB2	:= SB2->(GetArea())
Local aAreaSM0	:= SM0->(GetArea())
Local aViewB2	:= {}
Local aStruSB2  := {}
Local aNewSaldo := {}
Local oCursor	:= LoadBitMap(GetResources(),"LBNO")
Local nTotDisp	:= 0
Local nTotExecDisp:=0
Local nSaldo	:= 0
Local nQtPV		:= 0
Local nQemp		:= 0
Local nSalpedi	:= 0
Local nReserva	:= 0
Local nQempSA	:= 0
Local nSaldoSB2:=0
Local nQtdTerc :=0
Local nQtdNEmTerc:=0
Local nSldTerc :=0
Local nQEmpN :=0
Local nQAClass :=0
Local nQEmpPrj  := 0
Local nQEmpPre  := 0
Local nX        := 0
Local nB2_QATU  := 0,nB2_QPEDVEN := 0,nB2_QEMP := 0,nB2_SALPEDI := 0,nB2_QEMPSA := 0,nB2_RESERVA :=0
Local nB2_QTNP  := 0,nB2_QNPT := 0,	nB2_QTER := 0,nB2_QEMPN := 0,nB2_QACLASS := 0,nB2_QPRJ := 0, nB2_QPRE := 0

Local cFilialSB2:= xFilial("SB2")
Local cFilialSB1:= xFilial("SB1")
Local lViewSB2  := .T.
Local lRetPEAux := .T.
Local lMTVIEWFIL:= ExistBlock("MTVIEWFIL")
Local nAtIni    := 1
Local oListBox, oDlg, oBold
Local nHdl      := GetFocus()

Static lViewSB2PE
Static lViewSaldo

DEFAULT cAlmox := ""

If ValType(lViewSB2PE) # "L"
	lViewSB2PE	:= ExistBlock("MVIEWSB2SL")
EndIf

If ValType(lViewSaldo) # "L"
	lViewSaldo	:= ExistBlock("MVIEWSALDO")
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Ponto de entrada para impedir a apresentacao da Dialog de Saldos do SB2?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ExistBlock("MTVIEWB2")
	lViewSB2 := ExecBlock("MTVIEWB2",.F.,.F.)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Verifica a filial de pesquisa do saldo                                 ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !Empty(cFilCon)
	If !Empty(cFilialSB2)
		cFilialSB2 := cFilCon
	EndIf
	dbSelectArea("SM0")
	dbSetOrder(1)
	MsSeek(cEmpAnt+cFilCon)
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Posiciona o cadastro de produtos                                       ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea('SB1')
dbSetOrder(1)
If MsSeek(cFilialSB1+cProduto) .And. lViewSB2
	#IFDEF TOP
		If TcSrvType() != "AS/400"
			cCursor  := "MAVIEWSB2"
			lQuery   := .T.
			aStruSB2 := SB2->(dbStruct())		
			
			cQuery := ""
			cQuery += "SELECT * FROM "+RetSqlName("SB2")+" WHERE "
			cQuery += "B2_FILIAL='"+cFilialSB2+"' AND "
			cQuery += "B2_COD='"+cProduto+"' AND "
			cQuery += "B2_STATUS <> '2' AND "
			cQuery += "D_E_L_E_T_ <> '*' "
			cQuery += "ORDER BY B2_LOCAL "
			
			cQuery := ChangeQuery(cQuery)
			
			SB2->(dbCommit())			
			
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cCursor,.T.,.T.)
			
			For nX := 1 To Len(aStruSB2)
				If aStruSB2[nX][2]<>"C"
					TcSetField(cCursor,aStruSB2[nX][1],aStruSB2[nX][2],aStruSB2[nX][3],aStruSB2[nX][4])
				EndIf
			Next nX
			
			dbSelectArea(cCursor)
			While ( !Eof() )
				nSaldoSB2:=SaldoSB2(,,,,,cCursor)
				// Executa o ponto de entrada para alterar o saldo disponivel pelo usuario
				If lViewSB2PE
					nTotExecDisp:=ExecBlock("MVIEWSB2SL",.F.,.F.,{(cCursor)->B2_COD,(cCursor)->B2_LOCAL,nSaldoSB2})
					If ValType(nTotExecDisp) == "N"
						nSaldoSB2 := nTotExecDisp		
					EndIf
				EndIf		

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Ponto de Entrada para alterar os itens da Consulta ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If lMTVIEWFIL
					lRetPE:=ExecBlock("MTVIEWFIL",.F.,.F.,{(cCursor)->B2_COD,(cCursor)->B2_LOCAL}) 
					If ValType(lRetPE)=="L" .And. lRetPE
						dbSelectArea(cCursor)
						dbSkip()
						Loop
					EndIf
				EndIf

				nB2_QATU    := (cCursor)->B2_QATU
				nB2_QPEDVEN := (cCursor)->B2_QPEDVEN
				nB2_QEMP    := (cCursor)->B2_QEMP
				nB2_SALPEDI := (cCursor)->B2_SALPEDI
				nB2_QEMPSA  := (cCursor)->B2_QEMPSA
				nB2_RESERVA := (cCursor)->B2_RESERVA
				nB2_QTNP    := (cCursor)->B2_QTNP
				nB2_QNPT    := (cCursor)->B2_QNPT
				nB2_QTER    := (cCursor)->B2_QTER
				nB2_QEMPN   := (cCursor)->B2_QEMPN
				nB2_QACLASS := (cCursor)->B2_QACLASS
				nB2_QPRJ 	:= (cCursor)->B2_QEMPPRJ
				nB2_QPRE 	:= (cCursor)->B2_QEMPPRE
				If lViewSaldo
					aNewSaldo := {}
					aAdd(aNewSaldo,{nSaldoSB2,nB2_QATU,nB2_QPEDVEN,nB2_QEMP,nB2_SALPEDI,nB2_QEMPSA,nB2_RESERVA,nB2_QTNP,;
					                nB2_QNPT,nB2_QTER,nB2_QEMPN,nB2_QACLASS,nB2_QPRJ,nB2_QPRE})				
					
					If ValType(aNewSaldo:=ExecBlock("MVIEWSALDO",.F.,.F.,{(cCursor)->B2_COD,(cCursor)->B2_LOCAL,aNewSaldo}))=="A" .And. Len(aNewSaldo) > 0
						nSaldoSB2   := aNewSaldo[1,1]
						nB2_QATU    := aNewSaldo[1,2]
						nB2_QPEDVEN := aNewSaldo[1,3]
						nB2_QEMP    := aNewSaldo[1,4]
						nB2_SALPEDI := aNewSaldo[1,5]
						nB2_QEMPSA  := aNewSaldo[1,6]
						nB2_RESERVA := aNewSaldo[1,7]
						nB2_QTNP    := aNewSaldo[1,8]
						nB2_QNPT    := aNewSaldo[1,9]
						nB2_QTER    := aNewSaldo[1,10]
						nB2_QEMPN   := aNewSaldo[1,11]
						nB2_QACLASS := aNewSaldo[1,12]
						nB2_QPRJ    := aNewSaldo[1,13]
						nB2_QPRE    := aNewSaldo[1,14]
                    Endif
				EndIf						

				aAdd(aViewB2,{TransForm((cCursor)->B2_LOCAL,PesqPict("SB2","B2_LOCAL")),;
					TransForm(nSaldoSB2,PesqPict("SB2","B2_QATU")),;
					TransForm(nB2_QATU,PesqPict("SB2","B2_QATU")),;
					TransForm(nB2_QPEDVEN,PesqPict("SB2","B2_QPEDVEN")),;
					TransForm(nB2_QEMP,PesqPict("SB2","B2_QEMP")),;
					TransForm(nB2_SALPEDI,PesqPict("SB2","B2_SALPEDI")),;
					TransForm(nB2_QEMPSA,PesqPict("SB2","B2_QEMPSA")),;
					TransForm(nB2_RESERVA,PesqPict("SB2","B2_RESERVA")),;
					TransForm(nB2_QTNP,PesqPict("SB2","B2_QTNP")),;
				    TransForm(nB2_QNPT,PesqPict("SB2","B2_QNPT")),;
					TransForm(nB2_QTER,PesqPict("SB2","B2_QTER")),;
					TransForm(nB2_QEMPN,PesqPict("SB2","B2_QEMPN")),;
					TransForm(nB2_QACLASS,PesqPict("SB2","B2_QACLASS")),;
					TransForm(nB2_QPRJ,PesqPict("SB2","B2_QEMPPRJ")),;
					TransForm(nB2_QPRE,PesqPict("SB2","B2_QEMPPRE"))})
					
				If !Empty(cAlmox) .And. cAlmox == (cCursor)->B2_LOCAL
					nAtIni := Len(aViewB2)
				EndIf
				nTotDisp	+= nSaldoSB2
				nSaldo		+= nB2_QATU
				nQtPV		+= nB2_QPEDVEN
				nQemp		+= nB2_QEMP
				nSalpedi	+= nB2_SALPEDI
				nReserva	+= nB2_RESERVA
				nQempSA		+= nB2_QEMPSA
				nQtdTerc	+= nB2_QTNP
				nQtdNEmTerc	+= nB2_QNPT
				nSldTerc	+= nB2_QTER
				nQEmpN		+= nB2_QEMPN
				nQAClass	+= nB2_QACLASS
				nQEmpPrj    += nB2_QPRJ
				nQEmpPre    += nB2_QPRE
				dbSelectArea(cCursor)
				dbSkip()
			EndDo
			If lQuery
				dbSelectArea(cCursor)
				dbCloseArea()
				dbSelectArea("SB2")
			EndIf
		Else
	#ENDIF
		dbSelectArea("SB2")
		dbSetOrder(1)
		MsSeek(cFilialSB2+cProduto)
		While !Eof() .And. cFilialSB2+cProduto == SB2->B2_FILIAL+SB2->B2_COD
			If !(SB2->B2_STATUS=='2')
				nSaldoSB2:=SaldoSB2(,,,,,"SB2")
				// Executa o ponto de entrada para alterar o saldo disponivel pelo usuario
				If lViewSB2PE
					nTotExecDisp:=ExecBlock("MVIEWSB2SL",.F.,.F.,{SB2->B2_COD,SB2->B2_LOCAL,nSaldoSB2})
					If ValType(nTotExecDisp) == "N"
						nSaldoSB2 := nTotExecDisp		
					EndIf
				EndIf      
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Ponto de Entrada para alterar os itens da Consulta ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If lMTVIEWFIL
					lRetPE:=ExecBlock("MTVIEWFIL",.F.,.F.,{SB2->B2_COD,SB2->B2_LOCAL}) 
					If ValType(lRetPE)=="L" .And. lRetPE
						dbSelectArea("SB2")
						dbSkip()
						Loop
					EndIf
				EndIf	
				
				nB2_QATU    := SB2->B2_QATU
				nB2_QPEDVEN := SB2->B2_QPEDVEN
				nB2_QEMP    := SB2->B2_QEMP
				nB2_SALPEDI := SB2->B2_SALPEDI
				nB2_QEMPSA  := SB2->B2_QEMPSA
				nB2_RESERVA := SB2->B2_RESERVA
				nB2_QTNP    := SB2->B2_QTNP
				nB2_QNPT    := SB2->B2_QNPT
				nB2_QTER    := SB2->B2_QTER
				nB2_QEMPN   := SB2->B2_QEMPN
				nB2_QACLASS := SB2->B2_QACLASS
				nB2_QPRJ    := SB2->B2_QEMPPRJ
				nB2_QPRE    := SB2->B2_QEMPPRE
				
				If lViewSaldo
					aNewSaldo := {}
					aAdd(aNewSaldo,{nSaldoSB2,nB2_QATU,nB2_QPEDVEN,nB2_QEMP,nB2_SALPEDI,nB2_QEMPSA,nB2_RESERVA,nB2_QTNP,;
					                nB2_QNPT,nB2_QTER,nB2_QEMPN,nB2_QACLASS,nB2_QPRJ,nB2_QPRE})				
					
					If ValType(aNewSaldo:=ExecBlock("MVIEWSALDO",.F.,.F.,{SB2->B2_COD,SB2->B2_LOCAL,aNewSaldo}))=="A" .And. Len(aNewSaldo) > 0
						nSaldoSB2   := aNewSaldo[1,1]
						nB2_QATU    := aNewSaldo[1,2]
						nB2_QPEDVEN := aNewSaldo[1,3]
						nB2_QEMP    := aNewSaldo[1,4]
						nB2_SALPEDI := aNewSaldo[1,5]
						nB2_QEMPSA  := aNewSaldo[1,6]
						nB2_RESERVA := aNewSaldo[1,7]
						nB2_QTNP    := aNewSaldo[1,8]
						nB2_QNPT    := aNewSaldo[1,9]
						nB2_QTER    := aNewSaldo[1,10]
						nB2_QEMPN   := aNewSaldo[1,11]
						nB2_QACLASS := aNewSaldo[1,12]
						nB2_QPRJ    := aNewSaldo[1,13]
						nB2_QPRE    := aNewSaldo[1,14]
                    Endif
				EndIf						

				aAdd(aViewB2,{TransForm(SB2->B2_LOCAL,PesqPict("SB2","B2_LOCAL")),;
					TransForm(nSaldoSB2,PesqPict("SB2","B2_QATU")),;
					TransForm(nB2_QATU,PesqPict("SB2","B2_QATU")),;
					TransForm(nB2_QPEDVEN,PesqPict("SB2","B2_QPEDVEN")),;
					TransForm(nB2_QEMP,PesqPict("SB2","B2_QEMP")),;
					TransForm(nB2_SALPEDI,PesqPict("SB2","B2_SALPEDI")),;
					TransForm(nB2_QEMPSA,PesqPict("SB2","B2_QEMPSA")),;
					TransForm(nB2_RESERVA,PesqPict("SB2","B2_RESERVA")),;
					TransForm(nB2_QTNP,PesqPict("SB2","B2_QTNP")),;
				    TransForm(nB2_QNPT,PesqPict("SB2","B2_QNPT")),;
					TransForm(nB2_QTER,PesqPict("SB2","B2_QTER")),;
					TransForm(nB2_QEMPN,PesqPict("SB2","B2_QEMPN")),;
					TransForm(nB2_QACLASS,PesqPict("SB2","B2_QACLASS")),;
					TransForm(nB2_QPRJ,PesqPict("SB2","B2_QEMPPRJ")),;
					TransForm(nB2_QPRE,PesqPict("SB2","B2_QEMPPRE"))})
					
				If !Empty(cAlmox) .And. cAlmox == SB2->B2_LOCAL
					nAtIni := Len(aViewB2)
				EndIf
					
				nTotDisp	+= nSaldoSB2
				nSaldo		+= nB2_QATU
				nQtPV		+= nB2_QPEDVEN
				nQemp		+= nB2_QEMP
				nSalpedi	+= nB2_SALPEDI
				nReserva	+= nB2_RESERVA
				nQempSA		+= nB2_QEMPSA
				nQtdTerc	+= nB2_QTNP
				nQtdNEmTerc	+= nB2_QNPT
				nSldTerc	+= nB2_QTER
				nQEmpN		+= nB2_QEMPN
				nQAClass	+= nB2_QACLASS
				nQEmpPrj    += nB2_QPRJ
				nQEmpPre    += nB2_QPRE
			EndIf	
			dbSelectArea("SB2")
			dbSkip()
		EndDo
		#IFDEF TOP
		EndIf
		#ENDIF
	If !Empty(aViewB2)
		
		DEFINE FONT oBold NAME "Arial" SIZE 0, -12 BOLD
		DEFINE MSDIALOG oDlg FROM 000,000  TO 500,600 TITLE STR0045 Of oMainWnd PIXEL //"Saldos em Estoque"
		@ 023,004 To 24,296 Label "" of oDlg PIXEL
		@ 113,004 To 114,296 Label "" of oDlg PIXEL
		oListBox := TWBrowse():New( 30,2,297,69,,{STR0046,STR0047,STR0048,STR0049,STR0050,STR0051,STR0052,STR0053,RetTitle("B2_QTNP"),RetTitle("B2_QNPT"),RetTitle("B2_QTER"),RetTitle("B2_QEMPN"),RetTitle("B2_QACLASS"),RetTitle("B2_QEMPPRJ"),RetTitle("B2_QEMPPRE")},{17,55,55,55,55,55,55,55},oDlg,,,,,,,,,,,,.F.,,.T.,,.F.,,,)  //"Local"###"Qtd.Disponivel"###"Sld.Atual"###"Qtd.Pedido de Vendas"###"Qtd. Empenhada"###"Qtd. Prevista Entrada"###"Qtd.Empenhada S.A."###"Qtd. Reservada"
		oListBox:SetArray(aViewB2)
		oListBox:bLine := { || aViewB2[oListBox:nAT]}
		oListBox:nAt   := Max(1,nAtIni)
		@ 004,010 SAY SM0->M0_CODIGO+"/"+FWCodFil()+" - "+SM0->M0_FILIAL+"/"+SM0->M0_NOME  Of oDlg PIXEL SIZE 245,009
		@ 014,010 SAY Alltrim(cProduto)+ " - "+SB1->B1_DESC Of oDlg PIXEL SIZE 245,009 FONT oBold
		@ 104,010 SAY STR0054 Of oDlg PIXEL SIZE 30 ,9 FONT oBold  //"TOTAL "
		
		@ 120,007 SAY STR0055 of oDlg PIXEL //"Quantidade Disponivel    "
		@ 119,075 MsGet nTotDisp Picture PesqPict("SB2","B2_QATU") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 120,155 SAY STR0059 of oDlg PIXEL //"Quantidade Empenhada "
		@ 119,223 MsGet nQemp Picture PesqPict("SB2","B2_QEMP") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 135,007 SAY STR0056 of oDlg PIXEL //"Saldo Atual   "
		@ 134,075 MsGet nSaldo Picture PesqPict("SB2","B2_QATU") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 135,155 SAY STR0060 of oDlg PIXEL //"Qtd. Entrada Prevista"
		@ 134,223 MsGet nSalPedi Picture PesqPict("SB2","B2_SALPEDI") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 150,007 SAY STR0057 of oDlg PIXEL //"Qtd. Pedido de Vendas  "
		@ 149,075 MsGet nQtPv Picture PesqPict("SB2","B2_QPEDVEN") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 150,155 SAY STR0061 of oDlg PIXEL //"Qtd. Reservada  "
		@ 149,223 MsGet nReserva Picture PesqPict("SB2","B2_RESERVA") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 165,007 SAY STR0058 of oDlg PIXEL //"Qtd. Empenhada S.A."
		@ 164,075 MsGet nQEmpSA Picture PesqPict("SB2","B2_QEMPSA") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 165,155 SAY RetTitle("B2_QTNP") of oDlg PIXEL
		@ 164,223 MsGet nQtdTerc Picture PesqPict("SB2","B2_QTNP") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 180,007 SAY RetTitle("B2_QNPT") of oDlg PIXEL
		@ 179,075 MsGet nQtdNEmTerc Picture PesqPict("SB2","B2_QNPT") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 180,155 SAY RetTitle("B2_QTER") of oDlg PIXEL 
		@ 179,223 MsGet nSldTerc Picture PesqPict("SB2","B2_QTER") of oDlg PIXEL SIZE 070,009 When .F.

		@ 195,007 SAY RetTitle("B2_QEMPN") of oDlg PIXEL 
		@ 194,075 MsGet nQEmpN Picture PesqPict("SB2","B2_QEMPN") of oDlg PIXEL SIZE 070,009 When .F.

		@ 195,155 SAY RetTitle("B2_QACLASS") of oDlg PIXEL 
		@ 194,223 MsGet nQAClass Picture PesqPict("SB2","B2_QACLASS") of oDlg PIXEL SIZE 070,009 When .F.

		@ 210,007 SAY RetTitle("B2_QEMPPRJ") of oDlg PIXEL 
		@ 209,075 MsGet nQEmpPrj Picture PesqPict("SB2","B2_QEMPPRJ") of oDlg PIXEL SIZE 070,009 When .F.
		
		@ 210,155 SAY RetTitle("B2_QEMPPRE") of oDlg PIXEL 
		@ 209,223 MsGet nQEmpPre Picture PesqPict("SB2","B2_QEMPPRE") of oDlg PIXEL SIZE 070,009 When .F.
   
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Ponto de entrada para incluir campos na grid  e edits na tela de Consulta ao estoque ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ExistBlock("MTGRDVW")                                   
			ExecBlock("MTGRDVW",.F.,.F.,{@aViewB2,@oListBox,@oDlg})
		Endif 
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Ponto de entrada para incluir Botao do Usuario na Dialog Saldos do SB2 ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ExistBlock("BVIEWSB2") 
			@ 230,190 BUTTON STR0100 SIZE 045,010  FONT oDlg:oFont ACTION (ExecBlock("BVIEWSB2",.F.,.F.)) Of oDlg PIXEL //"Especifico"
		Endif

		@ 230,244  BUTTON STR0016 SIZE 045,010  FONT oDlg:oFont ACTION (oDlg:End())  OF oDlg PIXEL  //"Voltar"

		ACTIVATE MSDIALOG oDlg CENTERED
	Else
		Aviso(STR0014,STR0062,{STR0016},2) //"Atencao"###"Nao registro de estoques para este produto."###"Voltar"
	EndIf	
EndIf
RestArea(aAreaSM0)
RestArea(aAreaSB2)
RestArea(aAreaSB1)
RestArea(aArea)
SetFocus(nHdl)
Return(.T.)

 
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MaViewPC ?Autor ?Edson Maricate        ?Data ?5.10.1998³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Programa de visualiza‡ao do pedido de compras.             ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?Void MaViewPc(ExpC1)                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpC1 = Numero do Pedido                                   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ?T.                                                         ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?MaViewPC                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function MaViewPC(cPedido)

Local aArea		:= GetArea()
Local aAreaSC7	:= SC7->(GetArea())
Local aAreaSB1	:= SB1->(GetArea())
Private aRotina	:= {{ , , 0 , 2 }}
Private nTipoPed	:= 1
Private l120Auto	:= .F.

dbSelectArea("SC7")
dbSetOrder(1)
If MsSeek(xFilial()+cPedido)
	MatA120(SC7->C7_TIPO,,,2)
EndIf

RestArea(aAreaSC7)
RestArea(aAreaSB1)
RestArea(aArea)

Return(.T.)


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MaViewNF ?Autor ?Edson Maricate        ?Data ?5.10.1998³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Programa de visualiza‡ao da NF de Entrada                  ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?Void MaViewNF(ExpN1)                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpN1 = Numero do registro de SD1                          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ?Nenhum                                                     ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?MaViewNF                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function MaViewNF(nRecSD1)

Local aArea		:= GetArea()
Local aAreaSD1	:= SD1->(GetArea())
Local aAreaSF1	:= SF1->(GetArea())

dbSelectArea("SD1")
MsGoto(nRecSD1)

SF1->( DbSetOrder( 1 ) )
cSeekSF1:=xFilial("SF1")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA
If SF1->( dbSeek( cSeekSF1 ) )
	If cPaisLoc == "BRA"
		Private aRotina    := {{ ,"A103NFiscal", 0, 2}}
        Private l103Auto   := .F.
        Private aAutoCab   := {}
        Private aAutoItens := {}
		A103NFiscal( "SF1", SF1->( Recno() ), 1 )
	Else
		VisualNfRem( "SF1", SF1->( Recno() ) )
	Endif
EndIf

RestArea(aAreaSD1)
RestArea(aAreaSF1)
RestArea(aArea)

Return Nil

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MaViewSC ?Autor ?Edson Maricate        ?Data ?5.10.1998³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Programa de visualiza‡ao das solicitacoes de compras.      ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe e ?Void MaViewSC(ExpC1)                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpC1 = Numero da Solicitacao                              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ?T.                                                         ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?MaViewSC                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function MaViewSC(cNumSC)

Local aArea		:= GetArea()
Local aAreaSC1	:= SC1->(GetArea())

dbSelectArea("SC1")
dbSetOrder(1)
If dbSeek(xFilial()+cNumSC)
	MATA110(,,2)
EndIf

RestArea(aAreaSC1)
RestArea(aArea)
Return(.T.)


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MaViewSA ?Autor ?Edson Maricate        ?Data ?5.10.1998³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Programa de visualiza‡ao das solicitacoes ao Almox.        ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?Void MaViewSA(ExpC1)                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpC1 = Numero da Solicitacao                              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ?T.                                                         ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?MaViewSA                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function MaViewSA(cNumSA)

Local aArea		:= GetArea()
Local aAreaSCP	:= SCP->(GetArea())

dbSelectArea("SCP")
dbSetOrder(1)
If dbSeek(xFilial()+cNumSA)
	MATA105(,,2)
EndIf

RestArea(aAreaSCP)
RestArea(aArea)
Return(.T.)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MaViewCT ?Autor ?Julio C.Guerato       ?Data ?0.08.2011³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Programa de visualiza‡ao do Contrato de Parceria	          ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?Void MaViewCT(ExpC1)                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpC1 = Numero do Contrato                                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ?T.                                                         ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?MaViewCT                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function MaViewCT(cNumCT)

Local aArea		:= GetArea()
Local aAreaSC3	:= SC3->(GetArea())

dbSelectArea("SC3")
dbSetOrder(1)
If dbSeek(xFilial()+cNumCT)
	MATA125(,,2)
EndIf

RestArea(aAreaSC3)
RestArea(aArea)
Return(.T.)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaAtuSB6  ?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Rotina de atualizacao do Poder de Terceiros                  ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpA1 := MaAtuSB6(ExpC1,ExpN1,ExpL1)                         ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias da tabela de origem                             ³±?
±±?         ³ExpN1: Codigo do Evento da Rotina                            ³±?
±±?         ?      [1] Implantacao de um item do documento de entrada    ³±?
±±?         ?      [2] Estorno de um item do documento de entrada        ³±?
±±?         ?      [3] Implantacao de um item do documento de saida      ³±?
±±?         ?      [4] Estorno de um item do documento de saida          ³±?
±±?         ³ExpL1: Indica se a chamada ocorre por refaz SB6              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpA1: array com valores dos custos 	                       ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo atualizar o saldo de poder de  ³±?
±±?         ³terceiros e em terceiros conforme os parametros da rotina    ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaAtuSB6(cAlias,nEvento,lRefaz)

Local aArea     := GetArea()
Local aAreaSD2  := SD2->(GetArea())
Local aSb6      := {}
Local aStruSB6  := {}
Local aCustoSB6 := {0,0,0,0,0}
Local cAliasSB6 := "SB6"
Local lQuery    := .F.
Local cEstoque  := ""
Local nX        := 0
Local nQtdSB6   := 0
Local nSldSB6   := 0
Local nQtd2SB6  := 0
Local nSld2SB6  := 0
Local nRegSB6   := 0
Local nAuxReg   := 0
Local nQtdSB6Ori:= 0
Local cLocalSB2 := ""
#IFDEF TOP
	Local cQuery    := ""
#ENDIF

Default lRefaz := .F.

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?A460TESN3 - Ponto de entrada para considerar TES com atualiza estoque "N"  |
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Static lA460TESN3 := ExistBlock("A460TESN3")


Do Case
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualizacao do SB6 com base no SD1                                     ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 1
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona registros                                                    ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SF4")
	dbSetOrder(1)
	If xFilial("SF4")+(cAlias)->D1_TES <> SF4->F4_FILIAL+SF4->F4_CODIGO
		MsSeek(xFilial("SF4")+(cAlias)->D1_TES)
	EndIf
	cLocalSB2 := (cAlias)->D1_LOCAL
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica o tipo de poder de terceiro                                   ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Do Case
	Case SF4->F4_PODER3 == "R"
		RecLock("SB6",.T.)
		SB6->B6_FILIAL  := xFilial("SB6")
		SB6->B6_CLIFOR  := (cAlias)->D1_FORNECE
		SB6->B6_LOJA    := (cAlias)->D1_LOJA
		SB6->B6_PRODUTO	:= (cAlias)->D1_COD
		SB6->B6_LOCAL	:= (cAlias)->D1_LOCAL
		SB6->B6_PRUNIT 	:= (cAlias)->D1_VUNIT
		SB6->B6_TIPO	:= IIf(SF4->F4_PODER3=="R","D","E")
		SB6->B6_DOC 	:= (cAlias)->D1_DOC
		SB6->B6_SERIE	:= (cAlias)->D1_SERIE
		SB6->B6_EMISSAO	:= (cAlias)->D1_EMISSAO
		SB6->B6_DTDIGIT	:= (cAlias)->D1_DTDIGIT
		SB6->B6_TES     := (cAlias)->D1_TES
		SB6->B6_QUANT	:= (cAlias)->D1_QUANT
		SB6->B6_UM		:= (cAlias)->D1_UM
		SB6->B6_QTSEGUM	:= (cAlias)->D1_QTSEGUM
		SB6->B6_SEGUM   := (cAlias)->D1_SEGUM
		SB6->B6_PODER3 	:= SF4->F4_PODER3
		SB6->B6_TPCF    := IIf((cAlias)->D1_TIPO$"DB","C","F")
		SB6->B6_IDENT	:= (cAlias)->D1_NUMSEQ
		SB6->B6_SALDO	:= SB6->B6_QUANT
		If (cAlias)->D1_TIPO$"CIP" .And. SB6->(FieldPos("B6_IDENTB6"))>0
			If (cAlias)->D1_IDENTB6 <> SB6->B6_IDENT
				SB6->B6_IDENTB6 := (cAlias)->D1_IDENTB6
			EndIf
			If Empty(SB6->B6_IDENTB6)
				nAuxReg := (cAlias)->(RecNo())
				dbSelectArea("SD1")
				dbSetOrder(1)
				If MsSeek(xFilial("SD1")+(cAlias)->D1_NFORI+(cAlias)->D1_SERIORI+(cAlias)->D1_FORNECE+(cAlias)->D1_LOJA+(cAlias)->D1_COD+(cAlias)->D1_ITEMORI)
					SB6->B6_IDENTB6 := (cAlias)->D1_IDENTB6
				EndIf
				(cAlias)->(MsGoto(nAuxReg))
			EndIf
		EndIf
		SB6->B6_ESTOQUE := SF4->F4_ESTOQUE
		cEstoque := SB6->B6_ESTOQUE
		If cEstoque == "S" .Or. lA460TESN3
			SB6->B6_CUSTO1 := (cAlias)->D1_CUSTO
			SB6->B6_CUSTO2 := (cAlias)->D1_CUSTO2
			SB6->B6_CUSTO3 := (cAlias)->D1_CUSTO3
			SB6->B6_CUSTO4 := (cAlias)->D1_CUSTO4
			SB6->B6_CUSTO5 := (cAlias)->D1_CUSTO5
			SB6->B6_CUSFF1 := (cAlias)->D1_CUSFF1
			SB6->B6_CUSFF2 := (cAlias)->D1_CUSFF2
			SB6->B6_CUSFF3 := (cAlias)->D1_CUSFF3
			SB6->B6_CUSFF4 := (cAlias)->D1_CUSFF4
			SB6->B6_CUSFF5 := (cAlias)->D1_CUSFF5
		EndIf
		If ExistBlock("SB6GRAVA")
			ExecBlock("SB6GRAVA",.F.,.F.)
		EndIf
		aCustoSB6 := {SB6->B6_CUSTO1,;
			SB6->B6_CUSTO2,;
			SB6->B6_CUSTO3,;
			SB6->B6_CUSTO4,;
			SB6->B6_CUSTO5}
		SB6->(MsUnLock())
	Case SF4->F4_PODER3 == "D"
		
		aStruSB6  := SB6->(dbStruct())
		
		dbSelectArea("SB6")
		dbSetOrder(3)
		#IFDEF TOP
			lQuery := .T.
			cAliasSB6 := "MaAtuSB6"
			
			cQuery := "SELECT SB6.*,R_E_C_N_O_ SB6RECNO "
			cQuery += "FROM "+RetSqlName("SB6")+" SB6 "
			cQuery += "WHERE SB6.B6_FILIAL='"+xFilial("SB6")+"' AND "
			cQuery += "SB6.B6_IDENT = '"+(cAlias)->D1_IDENTB6+"' AND "
			cQuery += "SB6.B6_PRODUTO = '"+(cAlias)->D1_COD+"' AND "
			cQuery += "SB6.B6_SALDO > 0 AND "
			cQuery += "SB6.B6_PODER3 = 'R' AND "
			cQuery += "SB6.D_E_L_E_T_=' ' "
			cQuery += "ORDER BY "+SqlOrder(SB6->(IndexKey()))
			
			cQuery := ChangeQuery(cQuery)
			
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSB6,.T.,.T.)
			
			For nX := 1 To Len(aStruSB6)
				If aStruSB6[nX][2] <> "C"
					TcSetField(cAliasSB6,aStruSB6[nX][1],aStruSB6[nX][2],aStruSB6[nX][3],aStruSB6[nX][4])
				EndIf
			Next nX
		#ELSE
			MsSeek(xFilial("SB6")+(cAlias)->D1_IDENTB6+(cAlias)->D1_COD+"R")
		#ENDIF
		
		nSldSB6  := (cAlias)->D1_QUANT
		nSld2SB6 := (cAlias)->D1_QTSEGUM
		
		While !Eof() .And. 	xFilial("SB6") == (cAliasSB6)->B6_FILIAL .And.;
				(cAliasSB6)->B6_IDENT == (cAlias)->D1_IDENTB6 .And.;
				(cAliasSB6)->B6_PRODUTO == (cAlias)->D1_COD .And.;
				nSldSB6 > 0
			If (cAliasSB6)->B6_SALDO > 0 .And. (cAliasSB6)->B6_PODER3 == "R"
				cLocalSB2 := (cAliasSB6)->B6_LOCAL
				nQtdSB6Ori:=(cAliasSB6)->B6_QUANT
				nQtdSB6  := Min((cAliasSB6)->B6_SALDO,nSldSB6)
				nQtd2SB6 := nSld2SB6
				nSldSB6  -= nQtdSB6
				If lQuery
					SB6->(MsGoto((cAliasSB6)->SB6RECNO))
				Else
					nRegSB6 := SB6->(RecNo())
				EndIf
				RecLock("SB6",.F.)
				aSB6 := {}
				For nX := 1 To Len(aStruSB6)
					aadd(aSB6,FieldGet(FieldPos(aStruSB6[nX][1])))
				Next nX
				SB6->B6_SALDO  -= nQtdSB6
				SB6->B6_UENT   := (cAlias)->D1_DTDIGIT
				SB6->B6_ATEND  := IIf(SB6->B6_SALDO<=0,"S","")
				cEstoque       := SB6->B6_ESTOQUE
				
				RecLock("SB6",.T.)
				For nX := 1 To Len(aStruSB6)
					FieldPut(nX,aSB6[nX])
				Next nX
				SB6->B6_CLIFOR  := (cAlias)->D1_FORNECE
				SB6->B6_LOJA    := (cAlias)->D1_LOJA
                SB6->B6_LOCAL   := (cAlias)->D1_LOCAL
				SB6->B6_SERIE   := (cAlias)->D1_SERIE
				SB6->B6_DOC     := (cAlias)->D1_DOC
				SB6->B6_TES     := (cAlias)->D1_TES
				SB6->B6_DTDIGIT := (cAlias)->D1_DTDIGIT
				SB6->B6_EMISSAO := (cAlias)->D1_EMISSAO
				SB6->B6_PODER3 	:= IIF(SB6->B6_PODER3=="R","D","R")
				SB6->B6_QUANT   := nQtdSB6
				SB6->B6_QTSEGUM := nQtd2SB6
				SB6->B6_UENT    := Ctod("")		
				SB6->B6_CUSTO1*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSTO2*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSTO3*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSTO4*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSTO5*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSFF1*= (nQtdSB6/nQtdSB6Ori)  
				SB6->B6_CUSFF2*= (nQtdSB6/nQtdSB6Ori)  
				SB6->B6_CUSFF3*= (nQtdSB6/nQtdSB6Ori)  
				SB6->B6_CUSFF4*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSFF5*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_SALDO   := 0
				SB6->B6_QULIB   := 0
				If ExistBlock("SB6GRAVA")
					ExecBlock("SB6GRAVA",.f.,.f.)
				EndIf
				aCustoSB6 := {SB6->B6_CUSTO1,;
					SB6->B6_CUSTO2,;
					SB6->B6_CUSTO3,;
					SB6->B6_CUSTO4,;
					SB6->B6_CUSTO5}						
				SB6->(MsUnLock())
				If !lQuery
					SB6->(MsGoto(nRegSB6))
					SB6->(MsUnLock())
				EndIf
			EndIf					
			dbSelectArea(cAliasSB6)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasSB6)
			dbCloseArea()
			dbSelectArea("SB6")
		EndIf
	EndCase		
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualiza os acumulados do poder de terceiro                            ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SB2")
	dbSetOrder(1)
	If xFilial("SB2")+(cAlias)->D1_COD+cLocalSB2 <> SB2->B2_FILIAL+SB2->B2_COD+SB2->B2_LOCAL
		If !MsSeek(xFilial("SB2")+(cAlias)->D1_COD+cLocalSB2)
			CriaSb2((cAlias)->D1_COD,cLocalSB2)
		EndIf
	EndIf
	RecLock("SB2")
	If ( SF4->F4_PODER3 $ "DR" )
		If ( SF4->F4_PODER3 == "D" )
			If IIf(Empty(cEstoque),SF4->F4_ESTOQUE,cEstoque)=="N"
				SB2->B2_QTER -= (cAlias)->D1_QUANT
			Else
				SB2->B2_QNPT -= (cAlias)->D1_QUANT
			EndIf
		Else
			If IIf(Empty(cEstoque),SF4->F4_ESTOQUE,cEstoque)=="N"
				SB2->B2_QTER += (cAlias)->D1_QUANT
			Else
				SB2->B2_QTNP += (cAlias)->D1_QUANT
			EndIf
		EndIf
	EndIf
	SB2->(MsUnLock())
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualiza o identificador de poder de terceiro                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cAlias=="SD1" .And. SF4->F4_PODER3=="R"
		RecLock("SD1")
		SD1->D1_IDENTB6 := SD1->D1_NUMSEQ
		If lRefaz
			MsUnlock()		
		EndIf
	EndIf
Case nEvento == 2    

	cLocalSB2 := (cAlias)->D1_LOCAL

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona registros                                                    ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SF4")
	dbSetOrder(1)
	If xFilial("SF4")+(cAlias)->D1_TES <> SF4->F4_FILIAL+SF4->F4_CODIGO .And. (cAlias)->D1_TES<="500"
		MsSeek(xFilial("SF4")+(cAlias)->D1_TES)
	EndIf
	dbSelectArea("SB2")
	dbSetOrder(1)
	If xFilial("SB2")+(cAlias)->D1_COD+(cAlias)->D1_LOCAL <> SB2->B2_FILIAL+SB2->B2_COD+SB2->B2_LOCAL
		If !MsSeek(xFilial("SB2")+(cAlias)->D1_COD+(cAlias)->D1_LOCAL)
			CriaSb2((cAlias)->D1_COD,(cAlias)->D1_LOCAL)
		EndIf
	EndIf		
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica o tipo de poder de terceiro                                   ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Do Case
	Case SF4->F4_PODER3=="R"
		dbSelectArea("SB6")
		dbSetOrder(3)
		If MsSeek(xFilial("SB6")+(cAlias)->D1_NUMSEQ+(cAlias)->D1_COD+"R")
			RecLock("SB6",.F.,.T.)
			cEstoque := SB6->B6_ESTOQUE
			dbDelete()
			MsUnlock()
		EndIf
	Case SF4->F4_PODER3=="D"
		dbSelectArea("SB6")
		dbSetOrder(3)
		If MsSeek(xFilial()+(cAlias)->D1_IDENTB6+(cAlias)->D1_COD+"R")
			RecLock("SB6",.F.)
			cEstoque := SB6->B6_ESTOQUE
			SB6->B6_UENT	:= Ctod("")
			SB6->B6_SALDO	:= SB6->B6_SALDO + (cAlias)->D1_QUANT
			SB6->B6_ATEND	:= IIf(SB6->B6_SALDO <= 0,"S","N")
			MsUnLock()
			
			aStruSB6  := SB6->(dbStruct())
			
			dbSelectArea("SB6")
			dbSetOrder(3)
			#IFDEF TOP
				lQuery := .T.
				cAliasSB6 := "MaAtuSB6"
				
				cQuery := "SELECT SB6.*,R_E_C_N_O_ SB6RECNO "
				cQuery += "FROM "+RetSqlName("SB6")+" SB6 "
				cQuery += "WHERE SB6.B6_FILIAL='"+xFilial("SB6")+"' AND "
				cQuery += "SB6.B6_IDENT = '"+(cAlias)->D1_IDENTB6+"' AND "
				cQuery += "SB6.B6_PRODUTO = '"+(cAlias)->D1_COD+"' AND "
				cQuery += "SB6.B6_PODER3 = 'D' AND "
				cQuery += "SB6.B6_SERIE = '"+(cAlias)->D1_SERIE+"' AND "
				cQuery += "SB6.B6_DOC = '"+(cAlias)->D1_DOC+"' AND "
				cQuery += "SB6.D_E_L_E_T_=' ' "
				cQuery += "ORDER BY "+SqlOrder(SB6->(IndexKey()))
				
				cQuery := ChangeQuery(cQuery)
				
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSB6,.T.,.T.)
				
				For nX := 1 To Len(aStruSB6)
					If aStruSB6[nX][2] <> "C"
						TcSetField(cAliasSB6,aStruSB6[nX][1],aStruSB6[nX][2],aStruSB6[nX][3],aStruSB6[nX][4])
					EndIf
				Next nX
			#ELSE
				MsSeek(xFilial("SB6")+(cAlias)->D1_IDENTB6+(cAlias)->D1_COD)
			#ENDIF				
			While !Eof() .And. 	xFilial("SB6") == (cAliasSB6)->B6_FILIAL .And.;
					(cAliasSB6)->B6_IDENT == (cAlias)->D1_IDENTB6 .And.;
					(cAliasSB6)->B6_PRODUTO == (cAlias)->D1_COD
				
				If (cAliasSB6)->B6_SERIE == (cAlias)->D1_SERIE .And.;
						(cAliasSB6)->B6_DOC == (cAlias)->D1_DOC .And.;
						(cAliasSB6)->B6_PODER3 == "D"
					
					If lQuery
						SB6->(MsGoto((cAliasSB6)->SB6RECNO))
					EndIf
					
					RecLock("SB6",.F.)
					dbDelete()
					MsUnlock()
					
					Exit
					
				EndIf
				dbSelectArea(cAliasSB6)
				dbSkip()
			EndDo
			If lQuery
				dbSelectArea(cAliasSB6)
				dbCloseArea()
				dbSelectArea("SB6")
			EndIf
		EndIf
	EndCase
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualiza os acumulados do poder de terceiro                            ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ( SF4->F4_PODER3 $ "DR" )
		If ( SF4->F4_PODER3 == "D" )
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//?Busca o local original do SB6 para atualizar o armazem correto         ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SB6")
			dbSetOrder(3)
			If MsSeek(xFilial("SB6")+(cAlias)->D1_IDENTB6+(cAlias)->D1_COD+"R")		
				cLocalSB2 := SB6->B6_LOCAL
			Endif				

			dbSelectArea("SB2")
			dbSetOrder(1)
			If MsSeek(xFilial("SB2")+(cAlias)->D1_COD+cLocalSB2)
		
				RecLock("SB2")					
				If IIf(Empty(cEstoque),SF4->F4_ESTOQUE,cEstoque)=="N"
					SB2->B2_QTER += (cAlias)->D1_QUANT
				Else
					SB2->B2_QNPT += (cAlias)->D1_QUANT
				EndIf
			Endif	
			
		Else
		
			RecLock("SB2")
			If IIf(Empty(cEstoque),SF4->F4_ESTOQUE,cEstoque)=="N"
				SB2->B2_QTER -= (cAlias)->D1_QUANT
			Else
				SB2->B2_QTNP -= (cAlias)->D1_QUANT
			EndIf
		EndIf
	EndIf
	SB2->(MsUnLock())
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualizacao do SB6 com base no SD2                                     ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Case nEvento == 3
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona registros                                                    ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SF4")
	dbSetOrder(1)
	If xFilial("SF4")+(cAlias)->D2_TES <> SF4->F4_FILIAL+SF4->F4_CODIGO
		MsSeek(xFilial("SF4")+(cAlias)->D2_TES)
	EndIf
	cLocalSB2 := (cAlias)->D2_LOCAL
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica o tipo de poder de terceiro                                   ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Do Case
	Case SF4->F4_PODER3 == "R"
		RecLock("SB6",.T.)
		SB6->B6_FILIAL  := xFilial("SB6")
		SB6->B6_CLIFOR  := (cAlias)->D2_CLIENTE
		SB6->B6_LOJA    := (cAlias)->D2_LOJA
		SB6->B6_PRODUTO	:= (cAlias)->D2_COD
		SB6->B6_LOCAL	:= (cAlias)->D2_LOCAL
		SB6->B6_PRUNIT 	:= (cAlias)->D2_PRCVEN
		SB6->B6_TIPO	:= IIf(SF4->F4_PODER3=="R","E","D")
		SB6->B6_DOC 	:= (cAlias)->D2_DOC
		SB6->B6_SERIE	:= (cAlias)->D2_SERIE
		SB6->B6_EMISSAO	:= (cAlias)->D2_EMISSAO
		SB6->B6_DTDIGIT	:= (cAlias)->D2_EMISSAO
		SB6->B6_TES     := (cAlias)->D2_TES
		SB6->B6_QUANT	:= (cAlias)->D2_QUANT
		SB6->B6_UM		:= (cAlias)->D2_UM
		SB6->B6_QTSEGUM	:= (cAlias)->D2_QTSEGUM
		SB6->B6_SEGUM   := (cAlias)->D2_SEGUM
		SB6->B6_PODER3 	:= SF4->F4_PODER3
		SB6->B6_TPCF    := IIf((cAlias)->D2_TIPO$"DB","F","C")
		SB6->B6_IDENT	:= (cAlias)->D2_NUMSEQ
		SB6->B6_SALDO	:= SB6->B6_QUANT
		If (cAlias)->D2_TIPO$"CIP" .And. SB6->(FieldPos("B6_IDENTB6"))>0
			If (cAlias)->D2_IDENTB6 <> SB6->B6_IDENT
				SB6->B6_IDENTB6 := (cAlias)->D2_IDENTB6
			EndIf
			If Empty(SB6->B6_IDENTB6)
				nAuxReg := (cAlias)->(RecNo())
				dbSelectArea("SD2")
				dbSetOrder(3)
				If MsSeek(xFilial("SD2")+(cAlias)->D2_NFORI+(cAlias)->D2_SERIORI+(cAlias)->D2_CLIENTE+(cAlias)->D2_LOJA+(cAlias)->D2_COD+(cAlias)->D2_ITEMORI)
					SB6->B6_IDENTB6 := SD2->D2_IDENTB6
				EndIf
				(cAlias)->(MsGoto(nAuxReg))
			EndIf
		EndIf
		SB6->B6_ESTOQUE := SF4->F4_ESTOQUE
		cEstoque := SB6->B6_ESTOQUE
		If cEstoque == "S" .Or. lA460TESN3
			SB6->B6_CUSTO1 := (cAlias)->D2_CUSTO1
			SB6->B6_CUSTO2 := (cAlias)->D2_CUSTO2
			SB6->B6_CUSTO3 := (cAlias)->D2_CUSTO3
			SB6->B6_CUSTO4 := (cAlias)->D2_CUSTO4
			SB6->B6_CUSTO5 := (cAlias)->D2_CUSTO5
			SB6->B6_CUSFF1 := (cAlias)->D2_CUSFF1
			SB6->B6_CUSFF2 := (cAlias)->D2_CUSFF2
			SB6->B6_CUSFF3 := (cAlias)->D2_CUSFF3
			SB6->B6_CUSFF4 := (cAlias)->D2_CUSFF4
			SB6->B6_CUSFF5 := (cAlias)->D2_CUSFF5
		EndIf
		If ExistBlock("SB6GRAVA")
			ExecBlock("SB6GRAVA",.F.,.F.)
		EndIf
		aCustoSB6 := {SB6->B6_CUSTO1,;
			SB6->B6_CUSTO2,;
			SB6->B6_CUSTO3,;
			SB6->B6_CUSTO4,;
			SB6->B6_CUSTO5}
		SB6->(MsUnLock())
	Case SF4->F4_PODER3 == "D"
		
		aStruSB6  := SB6->(dbStruct())
		
		dbSelectArea("SB6")
		dbSetOrder(3)
		#IFDEF TOP
			lQuery := .T.
			cAliasSB6 := "MaAtuSB6"
			
			cQuery := "SELECT SB6.*,R_E_C_N_O_ SB6RECNO "
			cQuery += "FROM "+RetSqlName("SB6")+" SB6 "
			cQuery += "WHERE SB6.B6_FILIAL='"+xFilial("SB6")+"' AND "
			cQuery += "SB6.B6_IDENT = '"+(cAlias)->D2_IDENTB6+"' AND "
			cQuery += "SB6.B6_PRODUTO = '"+(cAlias)->D2_COD+"' AND "
			cQuery += "SB6.B6_SALDO > 0 AND "
			cQuery += "SB6.B6_PODER3 = 'R' AND "
			cQuery += "SB6.D_E_L_E_T_=' ' "
			cQuery += "ORDER BY "+SqlOrder(SB6->(IndexKey()))
			
			cQuery := ChangeQuery(cQuery)
			
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSB6,.T.,.T.)
			
			For nX := 1 To Len(aStruSB6)
				If aStruSB6[nX][2] <> "C"
					TcSetField(cAliasSB6,aStruSB6[nX][1],aStruSB6[nX][2],aStruSB6[nX][3],aStruSB6[nX][4])
				EndIf
			Next nX
		#ELSE
			MsSeek(xFilial("SB6")+(cAlias)->D2_IDENTB6+(cAlias)->D2_COD+"R")
		#ENDIF
		
		nSldSB6  := (cAlias)->D2_QUANT
		nSld2SB6 := (cAlias)->D2_QTSEGUM
		
		While !Eof() .And. 	xFilial("SB6") == (cAliasSB6)->B6_FILIAL .And.;
				(cAliasSB6)->B6_IDENT == (cAlias)->D2_IDENTB6 .And.;
				(cAliasSB6)->B6_PRODUTO == (cAlias)->D2_COD .And.;
				nSldSB6 > 0
			If (cAliasSB6)->B6_SALDO > 0 .And. (cAliasSB6)->B6_PODER3 == "R"
				nQtdSB6Ori:=(cAliasSB6)->B6_QUANT
				nQtdSB6  := Min((cAliasSB6)->B6_SALDO,nSldSB6)
				nQtd2SB6 := nSld2SB6
				nSldSB6  -= nQtdSB6
				cLocalSB2:= (cAliasSB6)->B6_LOCAL
				If lQuery
					SB6->(MsGoto((cAliasSB6)->SB6RECNO))
				Else
					nRegSB6 := SB6->(RecNo())
				EndIf
				
				RecLock("SB6",.F.)
				If SB6->B6_QULIB > 0
					SB6->B6_QULIB -= nQtdSB6
				EndIf
				SB6->B6_SALDO  -= nQtdSB6
				SB6->B6_UENT   := (cAlias)->D2_EMISSAO
				SB6->B6_ATEND  := IIf(SB6->B6_SALDO<=0,"S","")
				cEstoque       := SB6->B6_ESTOQUE
				
				aSB6 := {}
				For nX := 1 To Len(aStruSB6)
					aadd(aSB6,FieldGet(FieldPos(aStruSB6[nX][1])))
				Next nX				
				RecLock("SB6",.T.)
				For nX := 1 To Len(aStruSB6)
					FieldPut(nX,aSB6[nX])
				Next nX
				SB6->B6_CLIFOR  := (cAlias)->D2_CLIENTE
				SB6->B6_LOJA    := (cAlias)->D2_LOJA				
				SB6->B6_SERIE   := (cAlias)->D2_SERIE
				SB6->B6_DOC     := (cAlias)->D2_DOC
				SB6->B6_TES     := (cAlias)->D2_TES
				SB6->B6_DTDIGIT := (cAlias)->D2_EMISSAO
				SB6->B6_EMISSAO	:= (cAlias)->D2_EMISSAO
				SB6->B6_PODER3 	:= IIF(SB6->B6_PODER3=="R","D","R")
				SB6->B6_QUANT   := nQtdSB6
				SB6->B6_QTSEGUM := nQtd2SB6
				SB6->B6_UENT    := Ctod("")						
				SB6->B6_CUSTO1*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSTO2*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSTO3*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSTO4*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSTO5*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSFF1*= (nQtdSB6/nQtdSB6Ori)  
				SB6->B6_CUSFF2*= (nQtdSB6/nQtdSB6Ori)  
				SB6->B6_CUSFF3*= (nQtdSB6/nQtdSB6Ori)  
				SB6->B6_CUSFF4*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_CUSFF5*= (nQtdSB6/nQtdSB6Ori)
				SB6->B6_SALDO   := 0						
				SB6->B6_UENT   := Ctod("")
				SB6->B6_ATEND  := ""
				SB6->B6_QULIB  := 0
				If ExistBlock("SB6GRAVA")
					ExecBlock("SB6GRAVA",.f.,.f.)
				EndIf
				aCustoSB6 := {SB6->B6_CUSTO1,;
					SB6->B6_CUSTO2,;
					SB6->B6_CUSTO3,;
					SB6->B6_CUSTO4,;
					SB6->B6_CUSTO5}						
				SB6->(MsUnLock())
				If !lQuery
					SB6->(MsGoto(nRegSB6))
					SB6->(MsUnLock())
				EndIf
			EndIf					
			dbSelectArea(cAliasSB6)
			dbSkip()
		EndDo
		If lQuery
			dbSelectArea(cAliasSB6)
			dbCloseArea()
			dbSelectArea("SB6")
		EndIf
	EndCase
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualiza os acumulados do poder de terceiro                            ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SB2")
	dbSetOrder(1)
	If xFilial("SB2")+(cAlias)->D2_COD+cLocalSB2 <> SB2->B2_FILIAL+SB2->B2_COD+SB2->B2_LOCAL
		If !MsSeek(xFilial("SB2")+(cAlias)->D2_COD+cLocalSB2)
			CriaSb2((cAlias)->D2_COD,cLocalSB2)
		EndIf
	EndIf		
	RecLock("SB2")
	If ( SF4->F4_PODER3 $ "DR" )
		If ( SF4->F4_PODER3 == "D" )
			If IIf(Empty(cEstoque),SF4->F4_ESTOQUE,cEstoque)=="N"
				SB2->B2_QTER -= (cAlias)->D2_QUANT
			Else
				SB2->B2_QTNP -= (cAlias)->D2_QUANT
			EndIf			
		Else
			If IIf(Empty(cEstoque),SF4->F4_ESTOQUE,cEstoque)=="N"
				SB2->B2_QTER += (cAlias)->D2_QUANT
			Else
				SB2->B2_QNPT += (cAlias)->D2_QUANT
			EndIf
		EndIf
	EndIf
	SB2->(MsUnLock())
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualiza o identificador de poder de terceiro                          ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cAlias=="SD2" .And. SF4->F4_PODER3=="R"
		RecLock("SD2")
		SD2->D2_IDENTB6 := SD2->D2_NUMSEQ
		If lRefaz
			MsUnlock()		
		EndIf	
	EndIf

Case nEvento == 4
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona registros                                                    ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SF4")
	dbSetOrder(1)
	If xFilial("SF4")+(cAlias)->D2_TES <> SF4->F4_FILIAL+SF4->F4_CODIGO
		MsSeek(xFilial("SF4")+(cAlias)->D2_TES)
	EndIf
	cLocalSB2 := (cAlias)->D2_LOCAL
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica o tipo de poder de terceiro                                   ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	Do Case
	Case SF4->F4_PODER3=="R"
		dbSelectArea("SB6")
		dbSetOrder(3)
		If MsSeek(xFilial("SB6")+(cAlias)->D2_NUMSEQ+(cAlias)->D2_COD+"R")
			RecLock("SB6",.F.,.T.)
			cEstoque := SB6->B6_ESTOQUE
			dbDelete()
			MsUnlock()
		EndIf
	Case SF4->F4_PODER3=="D"
		dbSelectArea("SB6")
		dbSetOrder(3)
		If MsSeek(xFilial()+(cAlias)->D2_IDENTB6+(cAlias)->D2_COD+"R")
			RecLock("SB6",.F.)
			SB6->B6_UENT	:= Ctod("")
			SB6->B6_SALDO	:= SB6->B6_SALDO + (cAlias)->D2_QUANT
			SB6->B6_ATEND	:= IIf(SB6->B6_SALDO <= 0,"S","N")
			cEstoque        := SB6->B6_ESTOQUE
			cLocalSB2       := SB6->B6_LOCAL
			MsUnLock()
			
			aStruSB6  := SB6->(dbStruct())
			
			dbSelectArea("SB6")
			dbSetOrder(3)
			#IFDEF TOP
				lQuery := .T.
				cAliasSB6 := "MaAtuSB6"
				
				cQuery := "SELECT SB6.*,R_E_C_N_O_ SB6RECNO "
				cQuery += "FROM "+RetSqlName("SB6")+" SB6 "
				cQuery += "WHERE SB6.B6_FILIAL='"+xFilial("SB6")+"' AND "
				cQuery += "SB6.B6_IDENT = '"+(cAlias)->D2_IDENTB6+"' AND "
				cQuery += "SB6.B6_PRODUTO = '"+(cAlias)->D2_COD+"' AND "
				cQuery += "SB6.B6_PODER3 = 'D' AND "
				cQuery += "SB6.B6_SERIE = '"+(cAlias)->D2_SERIE+"' AND "
				cQuery += "SB6.B6_DOC = '"+(cAlias)->D2_DOC+"' AND "
				cQuery += "SB6.D_E_L_E_T_=' ' "
				cQuery += "ORDER BY "+SqlOrder(SB6->(IndexKey()))
				
				cQuery := ChangeQuery(cQuery)
				
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSB6,.T.,.T.)
				
				For nX := 1 To Len(aStruSB6)
					If aStruSB6[nX][2] <> "C"
						TcSetField(cAliasSB6,aStruSB6[nX][1],aStruSB6[nX][2],aStruSB6[nX][3],aStruSB6[nX][4])
					EndIf
				Next nX
			#ELSE
				MsSeek(xFilial("SB6")+(cAlias)->D2_IDENTB6+(cAlias)->D2_COD)
			#ENDIF				
			While !Eof() .And. 	xFilial("SB6") == (cAliasSB6)->B6_FILIAL .And.;
					(cAliasSB6)->B6_IDENT == (cAlias)->D2_IDENTB6 .And.;
					(cAliasSB6)->B6_PRODUTO == (cAlias)->D2_COD
				
				If (cAliasSB6)->B6_SERIE == (cAlias)->D2_SERIE .And.;
						(cAliasSB6)->B6_DOC == (cAlias)->D2_DOC .And.;
						(cAliasSB6)->B6_PODER3 == "D"
					
					If lQuery
						SB6->(MsGoto((cAliasSB6)->SB6RECNO))
					EndIf
					
					RecLock("SB6",.F.)
					dbDelete()
					MsUnlock()
					
					Exit
					
				EndIf
				dbSelectArea(cAliasSB6)
				dbSkip()
			EndDo
			If lQuery
				dbSelectArea(cAliasSB6)
				dbCloseArea()
				dbSelectArea("SB6")
			EndIf
		EndIf
	EndCase
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Atualiza os acumulados do poder de terceiro                            ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SB2")
	dbSetOrder(1)
	If xFilial("SB2")+(cAlias)->D2_COD+cLocalSB2 <> SB2->B2_FILIAL+SB2->B2_COD+SB2->B2_LOCAL
		If !MsSeek(xFilial("SB2")+(cAlias)->D2_COD+cLocalSB2)
			CriaSb2((cAlias)->D2_COD,cLocalSB2)
		EndIf
	EndIf		
	RecLock("SB2")
	If ( SF4->F4_PODER3 $ "DR" )
		If ( SF4->F4_PODER3 == "D" )
			If IIf(Empty(cEstoque),SF4->F4_ESTOQUE,cEstoque)=="N"
				SB2->B2_QTER += (cAlias)->D2_QUANT
			Else
				SB2->B2_QTNP += (cAlias)->D2_QUANT
			EndIf			
		Else
			If IIf(Empty(cEstoque),SF4->F4_ESTOQUE,cEstoque)=="N"
				SB2->B2_QTER -= (cAlias)->D2_QUANT
			Else
				SB2->B2_QNPT -= (cAlias)->D2_QUANT
			EndIf
		EndIf
	EndIf
	SB2->(MsUnLock())
EndCase

RestArea(aAreaSD2)
RestArea(aArea)
Return(aCustoSB6)


/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³F4Poder3  ?Autor ?Eduardo Riera         ?Data ?7.07.2000 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?            !!! Obs.: Funcao alterada em 22/03/2006 !!!                ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Consulta as documentos de poder de/em terceiros              ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := F4Poder3(ExpC1,ExpC2,ExpC3,ExpC4,ExpC5,ExpC6,ExpN1, ³±?
±±?         ?	    	    ExpC7,ExpC8)                       		   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo do produto                                     ³±?
±±?         ³ExpC2: Almoxarifado                                          ³±?
±±?         ³ExpC3: Tipo do documento                                     ³±?
±±?         ?      [N] Normal                                            ³±?
±±?         ?      [B] Beneficiamento                                    ³±?
±±?         ³ExpC4: Tipo da operacao                                      ³±?
±±?         ?      [E] Entrada                                           ³±?
±±?         ?      [B] Saida                                             ³±?
±±?         ³ExpC5: Codigo do cliente/fornecedor                          ³±?
±±?         ³ExpC6: Loja do cliente/fornecedor                            ³±?
±±?         ³ExpN1: Codigo do registro da tabela selecionada              ³±?
±±?         ³ExpC7: tipo de atualizacao de estoque                        ³±?
±±?         ³ExpC8: Numero do pedido de venda                             ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ?T. / .F.                                                    ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo realizar a interface com r de  ³±?
±±?         ³terceiros e em terceiros conforme os parametros da rotina    ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Function F4Poder3(cProduto,cLocal,cTpNF,cES,cCliFor,cLoja,nRegistro,cEstoque,cNumPV)

Local aArea     := GetArea()
Local aOrdem    := {AllTrim(RetTitle("F2_DOC"))+"+"+AllTrim(RetTitle("F2_SERIE")),AllTrim(RetTitle("F2_EMISSAO"))}
Local aChave    := {"B6_DOC+B6_SERIE","B6_EMISSAO","B6_IDENT"}
Local aPesq     := {{Space(Len(SD1->D1_DOC+SD1->D1_SERIE)),"@!"},{Ctod(""),"@!"},{Space(Len(SB6->B6_IDENT)),"@!"}}
Local aHeadTrb  := {}
Local aStruTrb  := {}
Local aStruTrbO := {}
Local aSize     := MsAdvSize( .F. )
Local aObjects  := {}
Local aInfo     := {}
Local aPosObj   := {}
Local aNomInd   := {}
Local aSavHead  := aClone(aHeader)
Local aRegSB6   := {}
Local cTpCliFor := IIf((cES=="E" .And. !cTpNF$"DB").Or.(cES=="S" .And. cTpNF$"DB"),"F","C")
Local cAliasSD1 := "SD1"
Local cAliasSD2 := "SD2"
Local cAliasSB6 := "SB6"
Local cAliasTrb := "F4PODER3"
Local cCampo    := ""
Local cCampoTRB := ""
Local cNomeTrb  := ""
Local cQuery    := ""
Local cQuery1   := ""
Local cQuery2   := ""
Local cQuery3   := ""
Local cCombo    := ""
Local cTexto1   := ""
Local cTexto2   := ""
Local cReadVar  := ReadVar()
Local nHandle   := GetFocus()
Local nX        := 0
Local nSldQtd   := 0
Local nSldBru   := 0
Local nSldLiq   := 0
Local nOpcA     := 0
Local nPNfOri   := 0
Local nPSerOri  := 0
Local nPItemOri := 0
Local nPLocal   := 0
Local nPPrUnit  := 0
Local nPPrcVen  := 0
Local nPQuant   := 0
Local nPQuant2UM:= 0
Local nPLoteCtl := 0
Local nPNumLote := 0
Local nPDtValid := 0
Local nPPotenc  := 0
Local nPValor   := 0
Local nPValDesc := 0
Local nPDesc    := 0
Local nPIdentB6 := 0 
Local nPItem    := 0 
Local nPUnit    := 0 
Local nPTES     := 0
Local nPosLocal := 0
Local nPAlmTerc := 0
Local nPE		:= 0
Local nPos		:= 0
Local nCampos	:= 0
Local lQuery    := .F.
Local lRetorno  := .F.
Local lProcessa := .T.
Local lCria     := .F.
Local lB6Atend  := .T.
Local lMtProcP3 := ExistBlock("MTPROCP3")
Local lMtF4PD3I := ExistBlock("MTF4PD3I")
Local lMTF4P3UN := ExistBlock("MTF4P3UN") .And. ExecBlock("MTF4P3UN",.F.,.F.)
Local xPesq     := ""
Local cSeekSD7  := ""
Local cSeekSD1  := ""
Local oDlg
Local oPanel
Local oCombo
Local oGet
Local oGetDB                  
Local cLocalCQ   := GETMV("MV_CQ")
Local aArmazensCQ:= {},aTextoCQ:={}
Local aNew       := {}
Local aNewCP     := {}
Local lMtFillP3  := ExistBlock("MTFILLP3")
Local aNF        := {}
Local cNF        := ""
Local aValNFR    := {}
Local aValNFD    := {}
Local aValNf     := {}
Local nY         := 0
Local nZ         := 0
Local aA440VCOL  := {}
Local nDecSB6	 := 0
Local lB6IdentB6 := SB6->(FieldPos("B6_IDENTB6")) > 0
Local lOpTriang  := IsTriangular()
Local nDecD2Tot  := TamSx3("D2_PRCVEN")[2]
Local nDecD1Tot  := TamSx3("D1_VUNIT")[2]
Local nTamLote   := TamSx3("D1_LOTECTL")[1]
Local nTamSLote  := TamSx3("D1_NUMLOTE")[1]
Local aFiliais   := {xFilial("SD1"),xFilial("SD2"),xFilial("SB6"),xFilial("SC6")}

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?MV_VLDDATA - Valida data de emissao do documento de beneficiamento  ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
Local lVldData   := SuperGetMv("MV_VLDDATA",.F.,.T.)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?MV_DATAPD3 - numero default de dias retroativos na pesquisa das notas de poder de 3os   ?
//?Se retorno for zero, nao utiliza o filtro de data retroativa nas querys da rotina       ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
Local nDiasRetr   := Abs(SuperGetMv("MV_DATAPD3",.F.,0))
Local dPrimData   := dDataBase - nDiasRetr
Local dSegData    := dDataBase
Local lDataRetr   := nDiasRetr <> 0

DEFAULT cNumPV := "" 

If lDataRetr
	RetDataPD3(@dPrimData,@dSegData,@lDataRetr)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Montagem do arquivo temporario dos itens do SD1                     ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
SX3->( DbSetOrder(1) )
SX3->(MsSeek("SB6"))
While SX3->(!Eof()) .And. SX3->X3_ARQUIVO == "SB6"
	If ( X3USO(SX3->X3_USADO) .And. cNivel >= SX3->X3_NIVEL .And.;
			(lOpTriang .Or. Trim(SX3->X3_CAMPO) <> "B6_CLIFOR") .And.;
			(lOpTriang .Or. Trim(SX3->X3_CAMPO) <> "B6_LOJA") .And.;
			Trim(SX3->X3_CAMPO) <> "B6_PRODUTO" .And.;
			Trim(SX3->X3_CAMPO) <> "B6_QUANT" .And.;
			SX3->X3_CONTEXT<>"V" .And.;
			SX3->X3_TIPO<>"M" ) .Or.;
			Trim(SX3->X3_CAMPO) == "B6_DOC" .Or.;
			Trim(SX3->X3_CAMPO) == "B6_SERIE"  .Or.;
			Trim(SX3->X3_CAMPO) == "B6_EMISSAO" .Or.;
			Trim(SX3->X3_CAMPO) == "B6_TIPO"
		Aadd(aHeadTrb,{ TRIM(SX3->(X3Titulo())),;
			SX3->X3_CAMPO,;
			SX3->X3_PICTURE,;
			SX3->X3_TAMANHO,;
			SX3->X3_DECIMAL,;
			SX3->X3_VALID,;
			SX3->X3_USADO,;
			SX3->X3_TIPO,;
			SX3->X3_ARQUIVO,;
			SX3->X3_CONTEXT,;
    		IIf(AllTrim(SX3->X3_CAMPO)$"B6_DOC#B6_SERIE#B6_IDENT","00",SX3->X3_ORDEM) })
		aadd(aStruTRB,{SX3->X3_CAMPO,SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL,IIf(AllTrim(SX3->X3_CAMPO)$"B6_DOC#B6_SERIE","00",SX3->X3_ORDEM)})
		If Trim(SX3->X3_CAMPO) == "B6_PRUNIT"
			Aadd(aHeadTrb,{ OemToAnsi("Valor Liquido"),;
			"B6_PRCVEN",;
			SX3->X3_PICTURE,;
			SX3->X3_TAMANHO,;
			SX3->X3_DECIMAL,;
			SX3->X3_VALID,;
			SX3->X3_USADO,;
			SX3->X3_TIPO,;
			SX3->X3_ARQUIVO,;
			SX3->X3_CONTEXT,;
			SX3->X3_ORDEM})
			aadd(aStruTRB,{"B6_PRCVEN",SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL,SX3->X3_ORDEM})
		EndIf
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		//?Verifica a existencia do campo B6_LOTECLT para criar indice de pesq.?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		If Trim(SX3->X3_CAMPO)=="B6_LOTECTL"
			aadd(aChave,"B6_LOTECTL")
			aadd(aOrdem,AllTrim(RetTitle("B6_IDENT")))
			aadd(aOrdem,AllTrim(RetTitle("B6_LOTECTL")))
			aadd(aPesq,{Space(Len(SB6->B6_LOTECTL)),""})
		EndIf
	EndIf				
	SX3->(dbSkip())
EndDo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³MTF4PD3I Ponto de entrada para adicionar indices de pesquisa na comboBox?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lMTF4PD3I
	aRetPE:= ExecBlock("MTF4PD3I",.F.,.F.)
	If ValType(aRetPE) == "A" .And. Len(aRetPE) > 0
	     For nPE:= 1 to Len(aRetPE)
	     	If Ascan(aStruTRB,{|x| Trim(x[1]) == Trim(aRetPE[nPE])}) = 0
	     		MsgAlert(aRetPE[nPE]+STR0103)
	     	Else
				aadd(aChave,(aRetPE[nPE]))
				aadd(aOrdem,AllTrim(RetTitle(aRetPE[nPE])))
				aadd(aPesq,{Space(TamSX3(aRetPE[nPE])[1]),""})
			Endif
	     Next 
	EndIf
EndIf

aadd(aStruTRB,{"B6_TOTALL","N",18,If(cES == "S",nDecD2Tot,nDecD1Tot),"99"})
aadd(aStruTRB,{"B6_TOTALB","N",18,If(cES == "S",nDecD2Tot,nDecD1Tot),"99"})
aadd(aStruTRB,{"D2_NUMLOTE","C",nTamSLote,0,""})
aadd(aStruTRB,{"D2_LOTECTL","C",nTamLote,0,""})
aadd(aStruTRB,{"D1_NUMLOTE","C",nTamSLote,0,""})
aadd(aStruTRB,{"D1_LOTECTL","C",nTamLote,0,""})
aadd(aStruTrb,{"SD2RECNO" ,"N",18,0,"99"})
aadd(aStruTrb,{"SD1RECNO" ,"N",18,0,"99"})

aHeadTrb   := aSort(aHeadTrb,,,{|x,y| x[11] < y[11]})
aStruTrb   := aSort(aStruTrb,,,{|x,y| x[05] < y[05]})   
aStruTrbO  := aclone(aStruTrb)  

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?PE: MTPODER3CP - Adciona Campos ao Array de Trabalho   ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ExistBlock("MTPDR3CP") 
	aNewCP := ExecBlock("MTPDR3CP", .F., .F., {cES,aStruTRB} )
	If ValType(aNewCP) == "A" .And. Len(aNewCP) > 0
		aStruTrb := aNewCP
	Endif	   
Endif 		

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Ajuste das casas decimais conforme a rotina                         ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
If cES == "S"
	SX3->(dbSetOrder(2))
	SX3->(MsSeek("D1_VUNIT"))
	nX := aScan(aHeadTrb,{|x| AllTrim(x[2]) == "B6_PRUNIT"})
	If nX > 0
		aHeadTrb[nX][3] := SX3->X3_PICTURE
		aHeadTrb[nX][4] := 	SX3->X3_TAMANHO
		aHeadTrb[nX][5] := 	SX3->X3_DECIMAL
	EndIf
	nX := aScan(aHeadTrb,{|x| AllTrim(x[2]) == "B6_PRCVEN"})
	If nX > 0
		aHeadTrb[nX][3] := SX3->X3_PICTURE
		aHeadTrb[nX][4] := 	SX3->X3_TAMANHO
		aHeadTrb[nX][5] := 	SX3->X3_DECIMAL
	EndIf
	If Rastro(cProduto)
		If SX3->(MsSeek("D1_LOTECTL"))
			Aadd(aHeadTrb,{ TRIM(SX3->(X3Titulo())),;
				"D1_LOTECTL",;
				SX3->X3_PICTURE,;
				SX3->X3_TAMANHO,;
				SX3->X3_DECIMAL,;
				SX3->X3_VALID,;
				SX3->X3_USADO,;
				SX3->X3_TIPO,;
				SX3->X3_ARQUIVO,;
				SX3->X3_CONTEXT,;
				"98" })
		EndIf
		If SX3->(MsSeek("D1_NUMLOTE"))
			Aadd(aHeadTrb,{ TRIM(SX3->(X3Titulo())),;
				"D1_NUMLOTE",;
				SX3->X3_PICTURE,;
				SX3->X3_TAMANHO,;
				SX3->X3_DECIMAL,;
				SX3->X3_VALID,;
				SX3->X3_USADO,;
				SX3->X3_TIPO,;
				SX3->X3_ARQUIVO,;
				SX3->X3_CONTEXT,;
				"99" })
		EndIf
	EndIf
Else
	SX3->(dbSetOrder(2))
	SX3->(MsSeek("D2_PRCVEN"))
	nX := aScan(aHeadTrb,{|x| AllTrim(x[2]) == "B6_PRUNIT"})
	If nX > 0
		aHeadTrb[nX][3] := SX3->X3_PICTURE
		aHeadTrb[nX][4] := SX3->X3_TAMANHO
		aHeadTrb[nX][5] := SX3->X3_DECIMAL
	EndIf
	nX := aScan(aHeadTrb,{|x| AllTrim(x[2]) == "B6_PRCVEN"})
	If nX > 0
		aHeadTrb[nX][3] := SX3->X3_PICTURE
		aHeadTrb[nX][4] := SX3->X3_TAMANHO
		aHeadTrb[nX][5] := SX3->X3_DECIMAL
	EndIf
	If Rastro(cProduto)
		If SX3->(MsSeek("D2_LOTECTL"))
			Aadd(aHeadTrb,{ TRIM(SX3->(X3Titulo())),;
				"D2_LOTECTL",;
				SX3->X3_PICTURE,;
				SX3->X3_TAMANHO,;
				SX3->X3_DECIMAL,;
				SX3->X3_VALID,;
				SX3->X3_USADO,;
				SX3->X3_TIPO,;
				SX3->X3_ARQUIVO,;
				SX3->X3_CONTEXT,;
				"98" })
		EndIf
		If SX3->(MsSeek("D2_NUMLOTE"))
			Aadd(aHeadTrb,{ TRIM(SX3->(X3Titulo())),;
				"D2_NUMLOTE",;
				SX3->X3_PICTURE,;
				SX3->X3_TAMANHO,;
				SX3->X3_DECIMAL,;
				SX3->X3_VALID,;
				SX3->X3_USADO,;
				SX3->X3_TIPO,;
				SX3->X3_ARQUIVO,;
				SX3->X3_CONTEXT,;
				"99" })
		EndIf
	EndIf
EndIf
IF SB6->(FieldPos("B6_PRUNIT"))>0 .And. (TamSx3("B6_PRUNIT")[2])>2 .And. ;
   SD1->(FieldPos("D1_VUNIT"))>0  .And. (TamSx3("D1_VUNIT")[2])>2  .And. ;
   (TamSx3("B6_PRUNIT")[2]) = (TamSx3("D1_VUNIT")[2])
	nDecSB6 := VAL(PADR("0.",(TamSx3("B6_PRUNIT")[2]+1),"0")+"1")
Else
	nDecSB6 := 0.01
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ARQUIVO TEMPORARIO DE MEMORIA (CTREETMP)                            ?
//³A funcao MSOpenTemp ira substituir as duas linhas de codigo abaixo: ?
//|--> cNomeTrb := CriaTrab(aStruTRB,.T.)                              |
//|--> dbUseArea(.T.,__LocalDrive,cNomeTrb,cAliasTRB,.F.,.F.)          |
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
MSOpenTemp(cAliasTRB,aStruTRB,@cNomeTrb)

dbSelectArea(cAliasTRB)
For nX := 1 To Len(aChave)
	aadd(aNomInd,SubStr(cNomeTrb,1,7)+chr(64+nX))
	IndRegua(cAliasTRB,aNomInd[nX],aChave[nX])
Next nX
dbClearIndex()
For nX := 1 To Len(aNomInd)
	dbSetIndex(aNomInd[nX])
Next nX

If ExistBlock("MTPODER3") 
	aNew := ExecBlock("MTPODER3", .F., .F., {cES,aHeadTrb} )
	If ValType(aNew) == "A" .And. Len(aNew) > 0
		aHeadTrb := aNew
	Endif	   
Endif 		
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Verificacao do aHeader atual                                        ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
If cES == "S"
	nPQuant   := aScan(aHeader,{|x| AllTrim(x[2])=="C6_QTDVEN"})
	nPValor   := aScan(aHeader,{|x| AllTrim(x[2])=="C6_VALOR"})
	nPIdentB6 := aScan(aHeader,{|x| AllTrim(x[2])=="C6_IDENTB6"})
	nPItem    := GDFieldPos( "C6_ITEM" ) 
	nPUnit    := GDFieldPos( "C6_PRCVEN" ) 
	nPTES     := GDFieldPos( "C6_TES" )
Else
	nPQuant   := aScan(aHeader,{|x| AllTrim(x[2])=="D1_QUANT"})
	nPValor   := aScan(aHeader,{|x| AllTrim(x[2])=="D1_TOTAL"})
	nPIdentB6 := aScan(aHeader,{|x| AllTrim(x[2])=="D1_IDENTB6"})
	nPTES     := GDFieldPos( "D1_TES" )	
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Atualizacao do arquivo temporario com base nos itens do SD1         ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?		
SB6->(dbSetOrder(2))
#IFDEF TOP
	If TcSrvType()<>"AS/400" .And. TcSrvType()<>"iSeries" .And. !("POSTGRES" $ TCGetDB())
		lQuery    := .T.
		cAliasSB6 := "F4PODER3_SQL"
		cAliasSD1 := "F4PODER3_SQL"
		cAliasSD2 := "F4PODER3_SQL"
	
		If cES == "E"
			cQuery := "SELECT DISTINCT(0) SD1RECNO,SB6.R_E_C_N_O_ SB6RECNO,0 D1_VUNIT,0 D1_TOTAL,0 D1_VALDESC,SD2.R_E_C_N_O_ SD2RECNO,D2_PRCVEN,D2_TOTAL,D2_DESCON, D2_NUMLOTE NUMLOTE,D2_LOTECTL LOTECTL,D2_TIPO,'' D1_TIPO, "
		Else
			cQuery := "SELECT DISTINCT(SD1.R_E_C_N_O_) SD1RECNO,SB6.R_E_C_N_O_ SB6RECNO,D1_VUNIT,D1_TOTAL,D1_VALDESC,0 SD2RECNO,0 D2_PRCVEN,0 D2_TOTAL,0 D2_DESCON,D1_NUMLOTE NUMLOTE,D1_LOTECTL LOTECTL,'' D2_TIPO,D1_TIPO, "
		EndIf
		If !lB6IdentB6
			cQuery += "B6_FILIAL,B6_PRODUTO,B6_CLIFOR,B6_LOJA,B6_PODER3,B6_TPCF,B6_QUANT,B6_QULIB "
		Else
			cQuery += "B6_FILIAL,B6_PRODUTO,B6_CLIFOR,B6_LOJA,B6_PODER3,B6_IDENTB6,B6_TPCF,B6_QUANT,B6_QULIB "
		EndIf
		For nX := 1 To Len(aHeadTRB)
			If aHeadTRB[nX][2]<>"B6_PRCVEN"    .AND.;
				aHeadTRB[nX][2]<>"D2_NUMLOTE"  .AND.;
				aHeadTRB[nX][2]<>"D2_LOTECTL"  .And.;
				aHeadTRB[nX][2]<>"D2_TIPO"     .And.;
				aHeadTRB[nX][2]<>"D1_NUMLOTE"  .AND.;
				aHeadTRB[nX][2]<>"D1_LOTECTL"  .And.;
				aHeadTRB[nX][2]<>"D1_TIPO"     .And.;
				aHeadTRB[nX][2]<>"B6_CLIFOR"   .And.;
				aHeadTRB[nX][2]<>"B6_LOJA"     .And.;
				aHeadTRB[nX][2]<>"B6_PODER3"   .And.;  
				aHeadTRB[nX][2]<>"B6_QULIB"    
					
				cQuery += ","+aHeadTRB[nX][2]+" "
			EndIf
		Next nX
		cQuery1:= " FROM "+RetSqlName("SB6")+" SB6 ,"
		If cES=="S"
			cQuery1 += RetSqlName("SD1")+" SD1 "
		Else
			cQuery1 += RetSqlName("SD2")+" SD2 "	
		EndIf
		cQuery1 += "WHERE SB6.B6_FILIAL='"+aFiliais[3]+"' AND "
		cQuery1 += "SB6.B6_PRODUTO    = '"+cProduto+"' AND "
		If !lOpTriang
			cQuery1 += "SB6.B6_CLIFOR = '"+cCliFor+"' AND "
			cQuery1 += "SB6.B6_LOJA   = '"+cLoja+"' AND "
		EndIf
		cQuery1 += "SB6.B6_PODER3  = 'R' AND "
		cQuery1 += "SB6.B6_TPCF    = '"+cTpCliFor+"' AND "
		cQuery1 += "SB6.D_E_L_E_T_ = ' ' AND SB6.B6_ATEND <> 'S' AND "
		If cES=="S"
			cQuery1 += "SB6.B6_TIPO   = 'D' AND "
			cQuery1 += "SD1.D1_FILIAL = '"+aFiliais[1]+"' AND "
			cQuery1 += "SD1.D1_NUMSEQ = SB6.B6_IDENT AND "
			If lVldData
				If lDataRetr
					cQuery1 += "SD1.D1_DTDIGIT >= '" + DTOS(dPrimData) + "' AND "
				EndIf
				cQuery1 += "SD1.D1_DTDIGIT <= '" + DTOS(dSegData) + "' AND "
			EndIf	
			cQuery1 += "SD1.D_E_L_E_T_=' ' "
		Else
			cQuery1 += "SB6.B6_TIPO    = 'E' AND "
			cQuery1 += "SD2.D2_FILIAL  = '"+aFiliais[2]+"' AND "
			cQuery1 += "SD2.D2_NUMSEQ  = SB6.B6_IDENT AND "
			If lVldData
				If lDataRetr
					cQuery1 += "SD2.D2_EMISSAO >= '" + DTOS(dPrimData) + "' AND "
				EndIf
				cQuery1 += "SD2.D2_EMISSAO <= '" + DTOS(dSegData) + "' AND "
			EndIf	
			cQuery1 += "SD2.D_E_L_E_T_=' ' "	
		EndIf
		cQuery += cQuery1 + " UNION ALL "
		If cES == "E"
			cQuery += "SELECT DISTINCT(SD1.R_E_C_N_O_) SD1RECNO,SB6.R_E_C_N_O_ SB6RECNO,D1_VUNIT,D1_TOTAL,D1_VALDESC,0 SD2RECNO,0 D2_PRCVEN,0 D2_TOTAL,0 D2_DESCON, D1_NUMLOTE NUMLOTE,D1_LOTECTL LOTECTL,'' D2_TIPO, D1_TIPO, "
		Else
			cQuery += "SELECT DISTINCT(0) SD1RECNO,SB6.R_E_C_N_O_ SB6RECNO,0 D1_VUNIT,0 D1_TOTAL,0 D1_VALDESC,SD2.R_E_C_N_O_ SD2RECNO,D2_PRCVEN,D2_TOTAL,D2_DESCON,D2_NUMLOTE NUMLOTE,D2_LOTECTL LOTECTL, D2_TIPO,'' D1_TIPO, "
		EndIf
		If !lB6IdentB6
			cQuery += "B6_FILIAL,B6_PRODUTO,B6_CLIFOR,B6_LOJA,B6_PODER3,B6_TPCF,B6_QUANT,B6_QULIB "
		Else
			cQuery += "B6_FILIAL,B6_PRODUTO,B6_CLIFOR,B6_LOJA,B6_PODER3,B6_IDENTB6,B6_TPCF,B6_QUANT,B6_QULIB "
		EndIf
		For nX := 1 To Len(aHeadTRB)
			If aHeadTRB[nX][2]<>"B6_PRCVEN"    .AND.;
				aHeadTRB[nX][2]<>"D2_NUMLOTE"  .AND.;
				aHeadTRB[nX][2]<>"D2_LOTECTL"  .And.;                              
				aHeadTRB[nX][2]<>"D2_TIPO"     .And.;
				aHeadTRB[nX][2]<>"D1_NUMLOTE"  .AND.;           
				aHeadTRB[nX][2]<>"D1_LOTECTL"  .And.;
				aHeadTRB[nX][2]<>"D1_TIPO"     .And.;
				aHeadTRB[nX][2]<>"B6_CLIFOR"   .And.;
    			aHeadTRB[nX][2]<>"B6_LOJA"     .And.;
				aHeadTRB[nX][2]<>"B6_PODER3"   .And.;  
				aHeadTRB[nX][2]<>"B6_QULIB"   
				
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Adiciona campos na Query que foram implementados atraves do PE: MTPODER3CP ?
				//| Caso o campo nao existir no Array Original, o mesmo ser?adicionado e sera |
				//| atribuido o conteudo padrao ao mesmo de acordo com o seu tipo.             |
				//| Esta situacao se faz necessaria, pois ao efetuar o Select Union, a tabela  |
				//| relacionada nao se encontrara na clausa From devido a inversão de tabelas  |
				//| em relação ao Select antes do Union.										   |
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
				If Len(aNewCP)>0
					nPos:=aScan(aStruTrbO,{|x| Trim(x[1])==Trim(aHeadTRB[nX][2])})
					If nPos>0  
						cQuery += ","+aHeadTRB[nX][2]+" "
					Else     
						nPos:=aScan(aStruTrb,{|x| Trim(x[1])==Trim(aHeadTRB[nX][2])})
						cQuery += ","+IIF(aStruTrb[nPos][2]$"CDM","''",0)+" "+aHeadTRB[nX][2]+" "
					EndIf
				Else
					cQuery += ","+aHeadTRB[nX][2]+" "
				EndIf
			EndIf
		Next nX
		cQuery2:= " FROM "+RetSqlName("SB6")+" SB6 ,"
		If cES=="S"
			cQuery2 += RetSqlName("SD2")+" SD2 "			
		Else
			cQuery2 += RetSqlName("SD1")+" SD1 "
		EndIf
		cQuery2 += "WHERE SB6.B6_FILIAL = '"+aFiliais[3]+"' AND "
		cQuery2 += "SB6.B6_PRODUTO	   = '"+cProduto+"' AND "
		cQuery2 += "SB6.B6_PODER3	   = 'D' AND "
		cQuery2 += "SB6.B6_TPCF         = '"+cTpCliFor+"' AND "
		cQuery2 += "SB6.D_E_L_E_T_	   = ' ' AND SB6.B6_ATEND <> 'S' AND "
		
		If !lOpTriang
			cQuery2 += "SB6.B6_CLIFOR='"+cCliFor+"' AND "
			cQuery2 += "SB6.B6_LOJA='"+cLoja+"' AND "
		EndIf
		
		If cES=="S"
			cQuery2 += "SB6.B6_TIPO    ='D' AND "
			cQuery2 += "SD2.D2_FILIAL  ='"+aFiliais[2]+"' AND "
			cQuery2 += "SD2.D2_DOC	  = SB6.B6_DOC AND "
			cQuery2 += "SD2.D2_SERIE   = SB6.B6_SERIE AND "
			cQuery2 += "SD2.D2_CLIENTE = SB6.B6_CLIFOR AND "
			cQuery2 += "SD2.D2_LOJA    = SB6.B6_LOJA AND " 
			cQuery2 += "SD2.D2_COD     = SB6.B6_PRODUTO AND "
			cQuery2 += "SD2.D2_IDENTB6 = SB6.B6_IDENT AND "
			cQuery2 += "SD2.D2_QUANT	  = SB6.B6_QUANT AND "
			If lVldData
				If lDataRetr
					cQuery2 += "SD2.D2_EMISSAO >= '" + DTOS(dPrimData) + "' AND "
				EndIf
				cQuery2 += "SD2.D2_EMISSAO <= '" + DTOS(dSegData) + "' AND "
			EndIf	
			cQuery2 += "SD2.D_E_L_E_T_=' ' "	
		Else
			cQuery2 += "SB6.B6_TIPO     = 'E' AND "
			cQuery2 += "SD1.D1_FILIAL   = '"+aFiliais[1]+"' AND "
			cQuery2 += "SD1.D1_DOC	    = SB6.B6_DOC    AND "
			cQuery2 += "SD1.D1_SERIE    = SB6.B6_SERIE  AND "  
	  	    cQuery2 += "SD1.D1_FORNECE  = SB6.B6_CLIFOR AND "
			cQuery2 += "SD1.D1_LOJA     = SB6.B6_LOJA   AND "
			cQuery2 += "SD1.D1_COD	   = SB6.B6_PRODUTO AND "
			cQuery2 += "SD1.D1_IDENTB6  = SB6.B6_IDENT   AND "
			cQuery2 += "SD1.D1_QUANT    = SB6.B6_QUANT   AND "
			If lVldData
				If lDataRetr
					cQuery2 += "SD1.D1_DTDIGIT >= '" + DTOS(dPrimData) + "' AND "
				EndIf
				cQuery2 += "SD1.D1_DTDIGIT <= '" + DTOS(dSegData) + "' AND "
			EndIf	
			cQuery2 += "SD1.D_E_L_E_T_=' ' "
		EndIf                     
		
		cQuery := cQuery + cQuery2
		cQuery := ChangeQuery(cQuery)
	
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSB6,.T.,.F.)
		
		For nX := 1 To Len(aStruTRB)
			If aStruTRB[nX][2] <> "C" .And. FieldPos(aStruTRB[nX][1])<>0
				TcSetField(cAliasSB6,aStruTRB[nX][1],aStruTRB[nX][2],aStruTRB[nX][3],aStruTRB[nX][4])
			EndIf
		Next nX
	
		TcSetField(cAliasSD1,"D1_TOTAL","N",TamSx3("D1_TOTAL")[1], TamSx3("D1_TOTAL")[2] )
		TcSetField(cAliasSD1,"D1_VALDESC","N",TamSx3("D1_VALDESC")[1], TamSx3("D1_TOTAL")[2] )
		TcSetField(cAliasSD1,"D2_TOTAL","N",TamSx3("D2_TOTAL")[1], TamSx3("D2_TOTAL")[2] )	
		TcSetField(cAliasSD1,"D2_DESCON","N",TamSx3("D2_DESCON")[1], TamSx3("D2_DESCON")[2] )	
		TcSetField(cAliasSD1,"SD1RECNO","N",12, 0 )	
		TcSetField(cAliasSD1,"SD2RECNO","N",12, 0 )		
	Else
#ENDIF
	If lOpTriang
		SB6->(MsSeek(aFiliais[3]+cProduto))
	Else
		SB6->(MsSeek(aFiliais[3]+cProduto+cCliFor+cLoja,.F.))
	EndIf
#IFDEF TOP
	EndIf
#ENDIF    

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//| Esta rotina, verifica se existem Produtos com Códigos e Quantidades iguais na Nota      |
//| para definir se ir?gerar uma nova tabela através da montagem de um Array para          |    
//| obter os precos reais de movimentação na SD1                                            |
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
If lQuery    
	If cES=="E"	
	   cQuery3:="SELECT DISTINCT(SD1.R_E_C_N_O_),COUNT(*) REGISTROS "+cQuery2+" GROUP BY SD1.R_E_C_N_O_ HAVING COUNT(*)>1"
   	   cQuery3 := ChangeQuery(cQuery3)
  	   dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery3),"REGISTROS",.T.,.F.)
  	   dbSelectArea("REGISTROS") 
  	   If !EOF()
	       lCria:=.T.
	   EndIf     
	   dbCloseArea()	   
	EndIf
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//| Esta rotina, ira gerar um Array com a mesma Estrutura da Query e buscar os registros    |
//| com os valores de movimentações reais. Isto ?necessário, pois em situações onde existe |
//| o mesmo código do produto com quantidades iguais, porém com valores diferentes, a função|
//| apontava o 1a registro encontrado gerando divergências de valores entre as funcoes      |
//| F4PODER3 x CALCTERC 																	|
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
If lQuery .And. lCria
	(cAliasSB6)->(dbGotop())
	
	nCampos := (cAliasSB6)->(FCount())
	
	SD1->(dbSetOrder(1))
	
	While (cAliasSB6)->(!Eof())
	    If (cAliasSB6)->B6_PODER3 == "D"
	    	If cSeekSD1 != aFiliais[1]+(cAliasSB6)->B6_DOC+(cAliasSB6)->B6_SERIE+(cAliasSB6)->B6_CLIFOR+(cAliasSB6)->B6_LOJA+(cAliasSB6)->B6_PRODUTO
				SD1->(MsSeek(cSeekSD1 := aFiliais[1]+(cAliasSB6)->B6_DOC+(cAliasSB6)->B6_SERIE+(cAliasSB6)->B6_CLIFOR+(cAliasSB6)->B6_LOJA+(cAliasSB6)->B6_PRODUTO))
			EndIf
			While SD1->(!Eof()) .And. ;
			        (cAliasSB6)->B6_FILIAL    == SD1->D1_FILIAL  .And.;
					(cAliasSB6)->B6_DOC       == SD1->D1_DOC     .And.;
		  			(cAliasSB6)->B6_SERIE     == SD1->D1_SERIE   .And.;
					(cAliasSB6)->B6_CLIFOR    == SD1->D1_FORNECE .And.;
					(cAliasSB6)->B6_LOJA      == SD1->D1_LOJA    .And.;
					(cAliasSB6)->B6_PRODUTO   == SD1->D1_COD     
					
				cNF:= SD1->D1_FILIAL+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_COD+SD1->D1_ITEM
				If (cAliasSB6)->B6_IDENT==SD1->D1_IDENTB6 
				    If Ascan(aNF,cNF) = 0 .And. Ascan(aValNFD,{|x| x[1] = (cAliasSB6)->SD1RECNO}) = 0 .And. Ascan(aValNFD,{|x| x[2] = (cAliasSB6)->SB6RECNO}) = 0
						aadd(aNF,cNF)        
						aadd(aValNFD,Array(nCampos))
						For nZ:=1 To nCampos
							cCampoTRB := (cAliasSB6)->(FieldName(nZ))
						    If cCampoTRB $ "SD2RECNO$D2_PRCVEN$D2_TOTAL$D2_DESCON"
							    aValNFD[Len(aValNFD),nZ]:=0
							Else
							 	aValNFD[Len(aValNFD),nZ] := (cAliasSB6)->(&(cCampoTRB))
							EndIf
						Next nZ
						Exit
					EndIf
				EndIf
				SD1->(dbSkip())
			EndDo   
		Else
			aadd(aValNFR,Array(nCampos))
			For nZ:=1 To nCampos
				cCampoTRB := (cAliasSB6)->(FieldName(nZ))
			    If cCampoTRB $"D1_VUNIT$D1_TOTAL$D1_VALDESC"
				    aValNFR[Len(aValNFR),nZ]:=0
				Else
				 	aValNFR[Len(aValNFR),nZ] := (cAliasSB6)->(&(cCampoTRB))
				EndIf
			Next nZ
		EndIf
		(cAliasSB6)->(dbSkip())
	EndDo
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//| Cria arquivo de trabalho com os dados obtidos através do array que foi gerado  |
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
   	aStruSB6 := (cAliasSB6)->(dbStruct())  
   	SX3->(DbSetOrder(2))
    
	For nX = 1 To Len(aStruSB6)
	    cCampo:=aStruSB6[nX][1]               
	    nY:=aScan(aStruTrb,{|x| AllTrim(x[1])==cCampo})
	    If nY>0
	    	aStruSB6[nX][3]:=aStruTrb[nY][3]
	    	aStruSB6[nX][4]:=aStruTrb[nY][4]
	    Else   
	       If Rat("RECNO",cCampo)>0
      	       aStruSB6[nX][3]:=18
  		       aStruSB6[nX][4]:=0 
  		   Else
  		       SX3->(MsSeek(cCampo))
  		       If SX3->(!Eof())
          	       aStruSB6[nX][3]:=SX3->(X3_TAMANHO)
          	       aStruSB6[nX][4]:=SX3->(X3_DECIMAL)
          	   EndIf
       	EndIf
	    EndIf
	Next nX
		    
	(cAliasSB6)->(dbCloseArea())
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ARQUIVO TEMPORARIO DE MEMORIA (CTREETMP)                            ?
	//³A funcao MSOpenTemp ira substituir as duas linhas de codigo abaixo: ?
	//|--> cNomeTrb := CriaTrab(aStruTRB,.T.)                              |
	//|--> dbUseArea(.T.,__LocalDrive,cNomeTrb,cAliasTRB,.F.,.F.)          |
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	cNomeTrb := ""
	MSOpenTemp(cAliasSB6,aStruSB6,@cNomeTrb)

	dbSelectArea(cAliasSB6)  
		
	For nX = 1 to 2  
	     aValNF:={}
	     aValNF:=iif(nX==1, aValNFR, aValNFD)
	     For nY :=1 To Len(aValNF)
		 	 RecLock(cAliasSB6,.T.)
	 			 For nZ := 1 TO nCampos
					FieldPut(nZ, aValNF[nY,nZ])
				 Next nZ
	 		 MsUnlock()
		 Next nY
	Next nX	
EndIf
	
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//| Inicia Processo de Calculo  |
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ? 
If lQuery
	(cAliasSB6)->(dbGotop())
EndIf

(cAliasTRB)->(dbSetOrder(3))

While (cAliasSB6)->(!Eof()) .And. (cAliasSB6)->B6_FILIAL = aFiliais[3] .And.;
		(cAliasSB6)->B6_PRODUTO == cProduto .And.;
		IIF(lOpTriang,.T.,IIf(lQuery,.T.,(cAliasSB6)->B6_CLIFOR == cCliFor .And.;
		(cAliasSB6)->B6_LOJA == cLoja ))

	lProcessa := .T.		
	If lMtProcP3
		lProcessa := ExecBlock("MTPROCP3",.F.,.F.,{cAliasSB6,lQuery})
	Endif

	If lProcessa
		
		If !lQuery
			lProcessa := aScan(aRegSB6,SB6->(RecNo()))==0
		Else
			lProcessa := aScan(aRegSB6,(cAliasSB6)->SB6RECNO)==0		
		EndIf
	
	EndIf	
		
	//Se não possuir saldo não processa
	If (cAliasSB6)->B6_SALDO <= 0
		lProcessa := .F.
	EndIf
			
	If lProcessa
	
		If ((cES == "E" .And. (cAliasSB6)->B6_TIPO == "E") .Or. (cES == "S" .And. (cAliasSB6)->B6_TIPO == "D") ) .And.;
				(cAliasSB6)->B6_TPCF==cTpCliFor
			If !lQuery
				aadd(aRegSB6,SB6->(RecNo()))
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				//?Verificar qual eh a tabela de origem do poder de terceiros          ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				If ((cAliasSB6)->B6_TIPO=="D" .And. (cAliasSB6)->B6_PODER3 == "R" ) .Or. ((cAliasSB6)->B6_TIPO=="E" .And. (cAliasSB6)->B6_PODER3 == "D")
					If (cAliasSB6)->B6_PODER3 == "R"
						SD1->(dbSetOrder(4))
						SD1->(MsSeek(aFiliais[1]+(cAliasSB6)->B6_IDENT))
					Else
						SD1->(dbSetOrder(1))
						SD1->(MsSeek(aFiliais[1]+(cAliasSB6)->B6_DOC+(cAliasSB6)->B6_SERIE+(cAliasSB6)->B6_CLIFOR+(cAliasSB6)->B6_LOJA+(cAliasSB6)->B6_PRODUTO))
						While SD1->(!Eof()) .And. aFiliais[1] == SD1->D1_FILIAL .And.;
								(cAliasSB6)->B6_DOC       == SD1->D1_DOC .And.;
								(cAliasSB6)->B6_SERIE     == SD1->D1_SERIE .And.;
								(cAliasSB6)->B6_CLIFOR    == SD1->D1_FORNECE .And.;
								(cAliasSB6)->B6_LOJA      == SD1->D1_LOJA .And.;
								(cAliasSB6)->B6_PRODUTO   == SD1->D1_COD
								
							If (cAliasSB6)->B6_IDENT==SD1->D1_IDENTB6 .And. (cAliasSB6)->B6_QUANT=SD1->D1_QUANT
								Exit
							EndIf
							
							SD1->(dbSkip())
						EndDo
					EndIf
				Else
					If (cAliasSB6)->B6_PODER3=="R"
						SD2->(dbSetOrder(4))
						SD2->(MsSeek(aFiliais[2]+(cAliasSB6)->B6_IDENT))
					Else
						SD2->(dbSetOrder(3))
						SD2->(MsSeek(aFiliais[2]+(cAliasSB6)->B6_DOC+(cAliasSB6)->B6_SERIE+(cAliasSB6)->B6_CLIFOR+(cAliasSB6)->B6_LOJA+(cAliasSB6)->B6_PRODUTO))
						While SD2->(!Eof()) .And. aFiliais[2] == SD2->D2_FILIAL .And.;
								(cAliasSB6)->B6_DOC == SD2->D2_DOC .And.;
								(cAliasSB6)->B6_SERIE == SD2->D2_SERIE .And.;
								(cAliasSB6)->B6_CLIFOR == SD2->D2_CLIENTE .And.;
								(cAliasSB6)->B6_LOJA == SD2->D2_LOJA .And.;
								(cAliasSB6)->B6_PRODUTO == SD2->D2_COD
							If (cAliasSB6)->B6_IDENT==SD2->D2_IDENTB6 .And. (cAliasSB6)->B6_QUANT=SD2->D2_QUANT
								Exit
							EndIf
							SD2->(dbSkip())
						EndDo
					EndIf					
				EndIf
			Else
				aadd(aRegSB6,(cAliasSB6)->SB6RECNO)
			EndIf			                          
			
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
			//?Calculo do saldo em valor e quantidade para devolucao de terceiros  ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?		
			nSldQtd := 0
			nSldBru := 0
			nSldLiq := 0
			If ((cAliasSB6)->B6_TIPO=="D" .And. (cAliasSB6)->B6_PODER3 == "R" ) .Or. ((cAliasSB6)->B6_TIPO=="E" .And. (cAliasSB6)->B6_PODER3 == "D")
				lProcessa := lProcessa .And. (cAliasSD1)->D1_TIPO<>"I"
			Else
				lProcessa := lProcessa .And. (cAliasSD2)->D2_TIPO<>"I"	
			EndIf
			If lProcessa
				If (cAliasSB6)->B6_PODER3 == "R" .And. (!lB6IdentB6 .Or. Empty((cAliasSB6)->B6_IDENTB6))
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					//?Na primeira remessa deve-se tirar os valores contidos na interface  ?
					//?para evitar baixa de saldo maior que o disponivel                   ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?		
					If cES == "E"
						For nX := 1 To Len(aCols)
							If nX <> N .And. !aCols[nX][Len(aHeader)+1] .And. aCols[nX][nPIdentB6]==(cAliasSB6)->B6_IDENT
								nSldQtd -= aCols[nX][nPQuant]
								nSldBru -= aCols[nX][nPValor]
							EndIf
						Next nX
					Else
						For nX := 1 To Len(aCols)
							If nX <> N .And. !aCols[nX][Len(aHeader)+1] .And. aCols[nX][nPIdentB6]==(cAliasSB6)->B6_IDENT
								nSldQtd -= aCols[nX][nPQuant]
								nSldLiq -= aCols[nX][nPValor]
															 
								//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
								//?Desconsidera a quantidade ja faturada                               ?
								//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
								If !Empty( cNumPV )
									SC6->( dbSetOrder( 1 ) ) 
									If SC6->( MsSeek( aFiliais[4] + cNumPv + aCols[nX, nPItem ] ) )  
										nSldQtd += SC6->C6_QTDENT 
										nSldLiq += aCols[nX,nPUnit] * SC6->C6_QTDENT 
										nSldLiq := A410Arred( nSldLiq, "C6_VALOR" ) 
									EndIf 
								EndIf 								
	
							EndIf
						Next nX
					EndIf
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					//?Calculo do saldo do poder de terceiros                              ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					nSldQtd  += (cAliasSB6)->B6_SALDO
				Else
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					//?Calculo do saldo do poder de terceiros                              ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					nSldQtd  -= (cAliasSB6)->B6_SALDO
				EndIf
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				//?Verificar qual eh a tabela de origem do poder de terceiros e calcula?
				//?o valor total do saldo de poder de/em terceiros                     ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				If ((cAliasSB6)->B6_TIPO=="D" .And. (cAliasSB6)->B6_PODER3 == "R" ) .Or. ((cAliasSB6)->B6_TIPO=="E" .And. (cAliasSB6)->B6_PODER3 == "D")
					If (cAliasSB6)->B6_PODER3 == "R"
						nSldLiq += ((cAliasSD1)->D1_VUNIT * (cAliasSB6)->B6_SALDO)-(((cAliasSD1)->D1_VALDESC/(cAliasSB6)->B6_QUANT)*(cAliasSB6)->B6_SALDO)
						nSldBru += nSldLiq+A410Arred(nSldLiq*(cAliasSD1)->D1_VALDESC/(((cAliasSD1)->D1_VUNIT * (cAliasSB6)->B6_QUANT)-(cAliasSD1)->D1_VALDESC),"C6_VALOR")
					Else
						nSldLiq -= ((cAliasSD1)->D1_VUNIT * (cAliasSB6)->B6_SALDO)-(((cAliasSD1)->D1_VALDESC/(cAliasSB6)->B6_QUANT)*(cAliasSB6)->B6_SALDO)
						nSldBru -= Abs(nSldLiq)+A410Arred(Abs(nSldLiq)*(cAliasSD1)->D1_VALDESC/(((cAliasSD1)->D1_VUNIT * (cAliasSB6)->B6_QUANT)-(cAliasSD1)->D1_VALDESC),"C6_VALOR")				
					EndIf
				Else	
					If (cAliasSB6)->B6_PODER3 == "R"
						nSldBru += ((cAliasSD2)->D2_PRCVEN * (cAliasSB6)->B6_SALDO) + (((cAliasSD2)->D2_DESCON/(cAliasSB6)->B6_QUANT)*(cAliasSB6)->B6_SALDO) 
						nSldLiq += nSldBru-A410Arred(nSldBru*(cAliasSD2)->D2_DESCON/(((cAliasSD2)->D2_PRCVEN * (cAliasSB6)->B6_QUANT)+(cAliasSD2)->D2_DESCON),"C6_VALOR")
					Else
						nSldBru -= ((cAliasSD2)->D2_PRCVEN * (cAliasSB6)->B6_SALDO)+ (((cAliasSD2)->D2_DESCON/(cAliasSB6)->B6_QUANT)*(cAliasSB6)->B6_SALDO) 
						nSldLiq -= Abs(nSldBru)-A410Arred(Abs(nSldBru)*(cAliasSD2)->D2_DESCON/(((cAliasSD2)->D2_PRCVEN * (cAliasSB6)->B6_QUANT)+(cAliasSD2)->D2_DESCON),"C6_VALOR")
					EndIf
				EndIf
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				//?Atualiza o arquivo temporario com os dados do poder de terceiro     ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
				
				If nSldQtd <> 0 .Or. nSldLiq <> 0
					If (cAliasSB6)->(lB6IdentB6 .And. !Empty((cAliasSB6)->B6_IDENTB6))
						(cAliasTRB)->(MsSeek((cAliasSB6)->B6_IDENTB6))
					Else
						(cAliasTRB)->(MsSeek((cAliasSB6)->B6_IDENT))
					EndIf		 		
					If (cAliasTRB)->(!Found())
						RecLock(cAliasTRB,.T.)
						For nX := 1 To Len(aStruTRB)
							If !AllTrim(aStruTRB[nX][1])$"B6_SALDO#B6_TOTALL#B6_TOTALB#B6_QULIB"
								If (cAliasSB6)->(FieldPos(aStruTRB[nX][1]))<>0 .And. (cAliasTrb)->(FieldPos(aStruTRB[nX][1]))<>0
									(cAliasTRB)->(FieldPut(nX,(cAliasSB6)->(FieldGet(FieldPos(aStruTRB[nX][1])))))
								EndIf
							EndIf	 		    	
						Next nX
					Else
						RecLock(cAliasTRB)
					EndIf
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					//?Verifica o documento original para obter alguns dados posteriores   ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					If (cAliasSB6)->B6_PODER3 == "R" .And. (!lB6IdentB6 .Or. Empty((cAliasSB6)->B6_IDENTB6))
						For nX := 1 To Len(aStruTRB)
							If !AllTrim(aStruTRB[nX][1])$"B6_SALDO#B6_TOTALL#B6_TOTALB#B6_QULIB#B6_CUSTO1"
								If (cAliasSB6)->(FieldPos(aStruTRB[nX][1]))<>0 .And. (cAliasTrb)->(FieldPos(aStruTRB[nX][1]))<>0
									(cAliasTRB)->(FieldPut(nX,(cAliasSB6)->(FieldGet(FieldPos(aStruTRB[nX][1])))))
								EndIf
							EndIf
						Next nX
						If (cAliasSB6)->B6_TIPO=="D"
							(cAliasTRB)->SD1RECNO := IIf(lQuery,(cAliasSD1)->SD1RECNO,SD1->(RecNo()))
						Else
							(cAliasTRB)->SD2RECNO := IIf(lQuery,(cAliasSD2)->SD2RECNO,SD2->(RecNo()))
						EndIf
					EndIf
					(cAliasTRB)->B6_SALDO += a410Arred(nSldQtd,"C6_QTDVEN")
					(cAliasTRB)->B6_QULIB += a410Arred((cAliasSB6)->B6_QULIB,"C6_QTDVEN")
					(cAliasTRB)->B6_TOTALL+= nSldLiq
					(cAliasTRB)->B6_TOTALB+= nSldBru
					(cAliasTRB)->B6_CUSTO1:= ((cAliasSB6)->B6_CUSTO1 / (cAliasSB6)->B6_QUANT) * (cAliasSB6)->B6_SALDO
									
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					//?Calcula o valor unitario do poder de terceiros                      ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					(cAliasTRB)->B6_PRCVEN:= a410Arred((cAliasTRB)->B6_TOTALL/((cAliasTRB)->B6_SALDO),"D2_PRCVEN")
					
					(cAliasTRB)->B6_PRUNIT:= a410Arred((cAliasTRB)->B6_TOTALB/((cAliasTRB)->B6_SALDO),"D2_PRCVEN")
					If cES == "E"
						If (cAliasTRB)->B6_PRUNIT == (cAliasTRB)->B6_PRCVEN .And. Abs((cAliasTRB)->B6_PRCVEN-(cAliasSD2)->D2_PRCVEN)<=nDecSB6
							(cAliasTRB)->B6_PRUNIT := A410Arred((cAliasSD2)->D2_PRCVEN,"C6_PRCVEN")
							(cAliasTRB)->B6_PRCVEN := A410Arred((cAliasSD2)->D2_PRCVEN,"C6_PRCVEN")
		            	ElseIf (cAliasTRB)->B6_PRUNIT == (cAliasTRB)->B6_PRCVEN .And. lMTF4P3UN
							(cAliasTRB)->B6_PRUNIT := A410Arred((cAliasSD2)->D2_PRCVEN,"C6_PRCVEN")
							(cAliasTRB)->B6_PRCVEN := A410Arred((cAliasSD2)->D2_PRCVEN,"C6_PRCVEN")
						EndIf					
						(cAliasTRB)->D2_LOTECTL:= IIf(lQuery,(cAliasSD2)->LOTECTL,(cAliasSD2)->D2_LOTECTL)
						(cAliasTRB)->D2_NUMLOTE:= IIf(lQuery,(cAliasSD2)->NUMLOTE,(cAliasSD2)->D2_NUMLOTE)
					Else	
						If (cAliasTRB)->B6_PRUNIT == (cAliasTRB)->B6_PRCVEN .And. Abs((cAliasTRB)->B6_PRCVEN-(cAliasSD1)->D1_VUNIT)<=nDecSB6
							(cAliasTRB)->B6_PRUNIT := A410Arred((cAliasSD1)->D1_VUNIT,"C6_PRCVEN")
							(cAliasTRB)->B6_PRCVEN := A410Arred((cAliasSD1)->D1_VUNIT,"C6_PRCVEN")
						ElseIf (cAliasTRB)->B6_PRUNIT == (cAliasTRB)->B6_PRCVEN .And. lMTF4P3UN
							(cAliasTRB)->B6_PRUNIT := A410Arred((cAliasSD1)->D1_VUNIT,"C6_PRCVEN")
							(cAliasTRB)->B6_PRCVEN := A410Arred((cAliasSD1)->D1_VUNIT,"C6_PRCVEN")
						EndIf

						(cAliasTRB)->D1_LOTECTL:= IIf(lQuery,(cAliasSD1)->LOTECTL,(cAliasSD1)->D1_LOTECTL)
						(cAliasTRB)->D1_NUMLOTE:= IIf(lQuery,(cAliasSD1)->NUMLOTE,(cAliasSD1)->D1_NUMLOTE)
					EndIf

					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
					//?Permite alterar os valores do arquivo de trabalho                   ?
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?				
					If lMtFillP3
						ExecBlock("MTFILLP3",.F.,.F.,{aStruTRB,cAliasTRB,cAliasSB6,cAliasSD2,cAliasSD1,cES})
					EndIf

					MsUnLock()
				EndIf
			EndIf
		EndIf
	EndIf
	(cAliasSB6)->(dbSkip())
EndDo

If lQuery
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ARQUIVO TEMPORARIO DE MEMORIA (CTREETMP)                            ?
	//³A funcao MSCloseTemp ira substituir a linha de codigo abaixo:       ?
	//|--> dbCloseArea()                                                   |
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
	MSCloseTemp(cAliasSB6,cNomeTrb)
	
	dbSelectArea("SB6")
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Retira os documentos totalmente devolvidos                          ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
lB6Atend := (cAliasTRB)->(FieldPos("B6_ATEND")) > 0
dbSelectArea(cAliasTRB)
dbClearIndex()
dbGotop()
While !Eof()
	If (cAliasTRB)->B6_SALDO<=0 .Or. (IIF(!lB6Atend,.F.,(cAliasTRB)->B6_ATEND == "S"))
		dbDelete()
	EndIf
	dbSkip()
EndDo
Pack
aNomInd := {}
For nX := 1 To Len(aChave)
	aadd(aNomInd,SubStr(cNomeTrb,1,7)+chr(64+nX))
	IndRegua(cAliasTRB,aNomInd[nX],aChave[nX])
Next nX
dbClearIndex()
For nX := 1 To Len(aNomInd)
	dbSetIndex(aNomInd[nX])
Next nX
dbSetOrder(1)
dbGotop()	
PRIVATE aHeader := aHeadTRB
xPesq := aPesq[(cAliasTRB)->(IndexOrd())][1]
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Posiciona registros                                                 ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
If cTpCliFor == "C"
	dbSelectArea("SA1")
	dbSetOrder(1)
	MsSeek(xFilial("SA1")+cCliFor+cLoja)
Else
	dbSelectArea("SA2")
	dbSetOrder(1)
	MsSeek(xFilial("SA2")+cCliFor+cLoja)
EndIf
dbSelectArea("SB1")
dbSetOrder(1)
MsSeek(xFilial("SB1")+cProduto)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Calcula as coordenadas da interface                                 ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
aSize[1] /= 1.5
aSize[2] /= 1.5
aSize[3] /= 1.5
aSize[4] /= 1.3
aSize[5] /= 1.5
aSize[6] /= 1.3
aSize[7] /= 1.5

AAdd( aObjects, { 100, 020,.T.,.F.,.T.} )
AAdd( aObjects, { 100, 060,.T.,.T.} )
AAdd( aObjects, { 100, 020,.T.,.F.} )
aInfo   := { aSize[ 1 ], aSize[ 2 ], aSize[ 3 ], aSize[ 4 ], 3, 3 }
aPosObj := MsObjSize( aInfo, aObjects,.T.)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Interface com o usuario                                             ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
If !(cAliasTRB)->(Eof())
	DEFINE MSDIALOG oDlg TITLE OemToAnsi(STR0075) FROM aSize[7],000 TO aSize[6],aSize[5] OF oMainWnd PIXEL //"Documentos de Origem"
	@ aPosObj[1,1],aPosObj[1,2] MSPANEL oPanel PROMPT "" SIZE aPosObj[1,3],aPosObj[1,4] OF oDlg CENTERED LOWERED
	If !lOpTriang
		If cTpCliFor == "C"
			cTexto1 := AllTrim(RetTitle("F2_CLIENTE"))+"/"+AllTrim(RetTitle("F2_LOJA"))+": "+SA1->A1_COD+"/"+SA1->A1_LOJA+"  -  "+RetTitle("A1_NOME")+": "+SA1->A1_NOME
		Else
			cTexto1 := AllTrim(RetTitle("F1_FORNECE"))+"/"+AllTrim(RetTitle("F1_LOJA"))+": "+SA2->A2_COD+"/"+SA2->A2_LOJA+"  -  "+RetTitle("A2_NOME")+": "+SA2->A2_NOME	
		EndIf
	Else
		cTexto1 := STR0076 //"Operacao Triangular"
	EndIf    

	@ 002,005 SAY cTexto1 SIZE aPosObj[1,3],008 OF oPanel PIXEL
	cTexto2 := AllTrim(RetTitle("B1_COD"))+": "+SB1->B1_COD+"/"+SB1->B1_DESC
	@ 012,005 SAY cTexto2 SIZE aPosObj[1,3],008 OF oPanel PIXEL	
	oGetDb := MsGetDB():New(aPosObj[2,1],aPosObj[2,2],aPosObj[2,3],aPosObj[2,4],1,"Allwaystrue","allwaystrue","",.F., , ,.F., ,cAliasTRB,,,,,,.T.)

	DEFINE SBUTTON FROM aPosObj[3,1]+000,aPosObj[3,4]-030 TYPE 1 ACTION (nOpcA := 1,oDlg:End()) ENABLE OF oDlg
	DEFINE SBUTTON FROM aPosObj[3,1]+012,aPosObj[3,4]-030 TYPE 2 ACTION (nOpcA := 0,oDlg:End()) ENABLE OF oDlg

	@ aPosObj[3,1]+00,aPosObj[3,2]+00 SAY OemToAnsi(STR0077) PIXEL //"Pesquisar por:"
	@ aPosObj[3,1]+12,aPosObj[3,2]+00 SAY OemToAnsi(STR0078) PIXEL //"Localizar"
	@ aPosObj[3,1]+00,aPosObj[3,2]+40 MSCOMBOBOX oCombo VAR cCombo ITEMS aOrdem SIZE 100,044 OF oDlg PIXEL ;
		VALID ((cAliasTRB)->(dbSetOrder(oCombo:nAt)),(cAliasTRB)->(dbGotop()),xPesq := aPesq[(cAliasTRB)->(IndexOrd())][1],.T.)
	@ aPosObj[3,1]+12,aPosObj[3,2]+40 MSGET oGet VAR xPesq Of oDlg PICTURE aPesq[(cAliasTRB)->(IndexOrd())][2] PIXEL ;
		VALID ((cAliasTRB)->(MsSeek(Iif(ValType(xPesq)=="C",AllTrim(xPesq),xPesq),.T.)),.T.).And.IIf(oGetDb:oBrowse:Refresh()==Nil,.T.,.T.)
	
	ACTIVATE MSDIALOG oDlg CENTERED
Else
	Help(" ",1,"F4NAONOTA")
	lRetorno := .F.
EndIf
If nOpcA == 1
	lRetorno := .T.
	aHeader   := aClone(aSavHead)
	If cES == "S"
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		//?Verifica os campos a serem atualizados                              ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		nPNfOri   := aScan(aHeader,{|x| AllTrim(x[2])=="C6_NFORI"})
		nPSerOri  := aScan(aHeader,{|x| AllTrim(x[2])=="C6_SERIORI"})
		nPItemOri := aScan(aHeader,{|x| AllTrim(x[2])=="C6_ITEMORI"})
		nPLocal   := aScan(aHeader,{|x| AllTrim(x[2])=="C6_LOCAL"})
		nPPrUnit  := aScan(aHeader,{|x| AllTrim(x[2])=="C6_PRUNIT"})
		nPPrcVen  := aScan(aHeader,{|x| AllTrim(x[2])=="C6_PRCVEN"})
		nPQuant   := aScan(aHeader,{|x| AllTrim(x[2])=="C6_QTDVEN"})
		nPQuant2UM:= aScan(aHeader,{|x| AllTrim(x[2])=="C6_UNSVEN"})
		nPLoteCtl := aScan(aHeader,{|x| AllTrim(x[2])=="C6_LOTECTL"})
		nPNumLote := aScan(aHeader,{|x| AllTrim(x[2])=="C6_NUMLOTE"})
		nPDtValid := aScan(aHeader,{|x| AllTrim(x[2])=="C6_DTVALID"})
		nPPotenc  := aScan(aHeader,{|x| AllTrim(x[2])=="C6_POTENCI"})
		nPValor   := aScan(aHeader,{|x| AllTrim(x[2])=="C6_VALOR"})
		nPValDesc := aScan(aHeader,{|x| AllTrim(x[2])=="C6_VALDESC"})
		nPIdentB6 := aScan(aHeader,{|x| AllTrim(x[2])=="C6_IDENTB6"})
		nPosLocal := aScan(aHeader,{|x| AllTrim(x[2])=="C6_LOCAL"})
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		//?Posiciona registros                                                 ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		SD1->(MsGoto((cAliasTRB)->SD1RECNO))
		SF4->(dbSetOrder(1))
		SF4->(MsSeek(xFilial("SF4")+aCols[n][nPTES]))
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		//?Preenche acols                                                      ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		If nPIdentB6 <> 0
			aCols[N][nPIdentB6] := (cAliasTRB)->B6_IDENT
		EndIf		
		If nPNfOri <> 0
			aCols[N][nPNfOri] := SD1->D1_DOC
		EndIf
		If nPSerOri <> 0
			aCols[N][nPSerOri] := SD1->D1_SERIE
		EndIf
		If nPItemOri <> 0
			aCols[N][nPItemOri] := SD1->D1_ITEM
		EndIf
		If nPPrUnit <> 0
			If (cAliasTRB)->B6_PRUNIT == (cAliasTRB)->B6_PRCVEN .And. Abs((cAliasTRB)->B6_PRCVEN-SD1->D1_VUNIT)<=nDecSB6
				aCols[N][nPPrUnit] := 0
			Else
				aCols[N][nPPrUnit] := A410Arred((cAliasTRB)->B6_PRUNIT,"C6_PRUNIT")
			EndIf
		EndIf
		If nPPrcVen <> 0
			If (cAliasTRB)->B6_PRUNIT == (cAliasTRB)->B6_PRCVEN .And. Abs((cAliasTRB)->B6_PRCVEN-SD1->D1_VUNIT)<=nDecSB6
				aCols[N][nPPrcVen] := A410Arred(SD1->D1_VUNIT,"C6_PRCVEN")
			Else
				aCols[N][nPPrcVen] := A410Arred((cAliasTRB)->B6_PRCVEN,"C6_PRCVEN")
			EndIf
		EndIf
		If nPQuant <> 0 .And. (aCols[N][nPQuant] > (cAliasTRB)->B6_SALDO .Or. aCols[N][nPQuant] == 0 )
			aCols[N][nPQuant] := Min((cAliasTRB)->B6_SALDO,A410SNfOri(cCliFor,cLoja,SD1->D1_DOC,SD1->D1_SERIE,"",SD1->D1_COD,(cAliasTRB)->B6_IDENT,aCols[n][nPosLocal])[1])
			If nPQuant2UM <> 0
				aCols[N][nPQuant2UM] := ConvUm(cProduto,aCols[N][nPQuant],0,2)
			EndIf
		EndIf
		If Rastro(cProduto) .And. SF4->F4_ESTOQUE=="S"
			If nPLoteCtl <> 0
				aCols[N][nPLoteCtl] := SD1->D1_LOTECTL
			EndIf
			If nPNumLote <> 0
				aCols[N][nPNumLote] := SD1->D1_NUMLOTE
			EndIf
			If nPDtValid <> 0 .Or. nPPotenc <> 0
				dbSelectArea("SB8")
				dbSetOrder(3)
				If MsSeek(xFilial("SB8")+cProduto+aCols[N][nPLocal]+aCols[n][nPLoteCtl]+IIf(Rastro(cProduto,"S"),aCols[N][nPNumLote],""))
					If nPDtValid <> 0
						aCols[n][nPDtValid] := SB8->B8_DTVALID
					EndIf
					If nPPotenc <> 0
						aCols[n][nPPotenc] := SB8->B8_POTENCI
					EndIf
				EndIf
			EndIf
		EndIf
		A410MultT("C6_QTDVEN",aCols[N,nPQuant])	
		A410MultT("C6_PRCVEN",aCols[N,nPPrcVen])
		If nPValDesc <> 0 .And. nPPrUnit > 0
			If aCols[n][nPPrUnit]<>0
				aCols[n][nPValDesc] := a410Arred((aCols[n][nPPrUnit]-aCols[n][nPPrcVen])*IIf(aCols[n][nPQuant]==0,1,aCols[n][nPQuant]),"C6_VALDESC")
				A410MultT("C6_VALDESC",aCols[n][nPValDesc])
			EndIf
		EndIf
		If nPLocal <> 0
			aCols[N][nPLocal] := SD1->D1_LOCAL
			// Pesquisa os armazens dos movimentos do controle de qualidade
			If SD1->D1_LOCAL == cLocalCQ
				// Monta array com os armazens tratados na movimentacao do CQ
				cSeekSD7   := xFilial('SD7')+SD1->D1_NUMCQ+SD1->D1_COD+SD1->D1_LOCAL
				SD7->(dbSetOrder(1))
				SD7->(dbSeek(cSeekSD7))
				Do While !SD7->(Eof()) .And. cSeekSD7 == SD7->D7_FILIAL+SD7->D7_NUMERO+SD7->D7_PRODUTO+SD7->D7_LOCAL
					If SD7->D7_TIPO >= 1 .And. SD7->D7_TIPO <= 2 .And. SD7->D7_ESTORNO # 'S'
						If aScan(aArmazensCQ,SD7->D7_LOCDEST) == 0
							AADD(aArmazensCQ,SD7->D7_LOCDEST)						
						EndIf
					EndIf	        
					SD7->(dbSkip())
                EndDo
				// Monta texto para apresentacao no combobox
				If Len(aArmazensCQ) > 1
					nOpca:=0
					For nx:=1 to Len(aArmazensCQ)
						AADD(aTextoCQ,OemToAnsi(STR0046)+" "+aArmazensCQ[nx])
					Next nx
					DEFINE MSDIALOG oDlg TITLE OemToAnsi(STR0084) From 130,70 To 270,360 OF oMainWnd PIXEL
					@ 05,13 SAY OemToAnsi(STR0085) OF oDlg PIXEL SIZE 110,9
					@ 17,13 TO 42,122 LABEL "" OF oDlg  PIXEL
					@ 23,17 MSCOMBOBOX oCombo VAR cCombo ITEMS aTextoCQ SIZE 100,044 OF oDlg PIXEL ON CHANGE (cLocalCQ:=aArmazensCQ[oCombo:nAt]) 
					DEFINE SBUTTON FROM 50,072 TYPE 1 Action (nOpca:=1,oDlg:End()) ENABLE OF oDlg PIXEL
					DEFINE SBUTTON FROM 50,099 TYPE 2 ACTION oDlg:End() ENABLE OF oDlg PIXEL
					ACTIVATE MSDIALOG oDlg
					// Utiliza armazem relacionado ao movimento do CQ			
					If nOpca == 1
						aCols[N][nPLocal] := cLocalCQ
					EndIf
				ElseIf Len(aArmazensCQ) > 0
					aCols[N][nPLocal] := aArmazensCQ[1]
				EndIf
			EndIf	
		EndIf		
	Else
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		//?Verifica os campos a serem atualizados                              ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		nPNfOri   := aScan(aHeader,{|x| AllTrim(x[2])=="D1_NFORI"})
		nPSerOri  := aScan(aHeader,{|x| AllTrim(x[2])=="D1_SERIORI"})
		nPItemOri := aScan(aHeader,{|x| AllTrim(x[2])=="D1_ITEMORI"})
		nPLocal   := aScan(aHeader,{|x| AllTrim(x[2])=="D1_LOCAL"})
		nPPrcVen  := aScan(aHeader,{|x| AllTrim(x[2])=="D1_VUNIT"})
		nPQuant   := aScan(aHeader,{|x| AllTrim(x[2])=="D1_QUANT"})
		nPQuant2UM:= aScan(aHeader,{|x| AllTrim(x[2])=="D1_QTSEGUM"})
		nPLoteCtl := aScan(aHeader,{|x| AllTrim(x[2])=="D1_LOTECTL"})
		nPNumLote := aScan(aHeader,{|x| AllTrim(x[2])=="D1_NUMLOTE"})
		nPDtValid := aScan(aHeader,{|x| AllTrim(x[2])=="D1_DTVALID"})
		nPPotenc  := aScan(aHeader,{|x| AllTrim(x[2])=="D1_POTENCI"})
		nPValor   := aScan(aHeader,{|x| AllTrim(x[2])=="D1_TOTAL"})
		nPValDesc := aScan(aHeader,{|x| AllTrim(x[2])=="D1_VALDESC"})
		nPDesc    := aScan(aHeader,{|x| AllTrim(x[2])=="D1_DESC"})	
		nPIdentB6 := aScan(aHeader,{|x| AllTrim(x[2])=="D1_IDENTB6"})
		If SD1->(FieldPos("D1_ALMTERC")) > 0 .And. SD2->(FieldPos("D2_ALMTERC")) > 0
			nPAlmTerc := aScan(aHeader,{|x| AllTrim(x[2])=="D1_ALMTERC"})
		EndIf
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		//?Posiciona registros                                                 ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		SD2->(MsGoto((cAliasTRB)->SD2RECNO))
		nRegistro := (cAliasTRB)->SD2RECNO
		SF4->(dbSetOrder(1))
		SF4->(MsSeek(xFilial("SF4")+aCols[n][nPTES]))
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		//?Preenche acols                                                      ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
		If nPIdentB6 <> 0   
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
			//?Libera a trava obtida                                               ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
			cAntB6Ident := aCols[ n, nPIdentB6 ] 
			If !Empty( cAntB6Ident ) .And. cAntB6Ident <> (cAliasTRB)->B6_IDENT
				Leave1Code( "SD1_D1_IDENTB6" + cAntB6Ident ) 				
			EndIf 				
			aCols[N][nPIdentB6] := (cAliasTRB)->B6_IDENT
		EndIf     	
		If nPNfOri <> 0
			aCols[N][nPNfOri] := SD2->D2_DOC
		EndIf
		If nPSerOri <> 0
			aCols[N][nPSerOri] := SD2->D2_SERIE
		EndIf
		If nPItemOri <> 0
			aCols[N][nPItemOri] := SD2->D2_ITEM
		EndIf
		If nPLocal <> 0
			aCols[N][nPLocal] := SD2->D2_LOCAL
		EndIf
		If nPAlmTerc <> 0
			aCols[N][nPAlmTerc] := SD2->D2_ALMTERC
		EndIf	
		If nPPrcVen <> 0
			aCols[N][nPPrcVen] := A410Arred((cAliasTRB)->B6_PRUNIT,"D1_VUNIT")
		EndIf
		If nPQuant <> 0 .And. ( aCols[N][nPQuant] > (cAliasTRB)->B6_SALDO .Or. aCols[N][nPQuant]==0 )
			aCols[N][nPQuant] := (cAliasTRB)->B6_SALDO
			If nPQuant2UM <> 0
				aCols[N][nPQuant2UM] := ConvUm(cProduto,aCols[N][nPQuant],0,2)
			EndIf
		EndIf
		If Rastro(cProduto) .And. SF4->F4_ESTOQUE=="S"
			If nPLoteCtl <> 0
				aCols[N][nPLoteCtl] := SD2->D2_LOTECTL
			EndIf
			If nPNumLote <> 0
				aCols[N][nPNumLote] := SD2->D2_NUMLOTE
			EndIf
			If nPDtValid <> 0 .Or. nPPotenc <> 0
				dbSelectArea("SB8")
				dbSetOrder(3)
				If MsSeek(xFilial("SB8")+cProduto+aCols[N][nPLocal]+aCols[n][nPLoteCtl]+IIf(Rastro(cProduto,"S"),aCols[N][nPNumLote],""))
					If nPDtValid <> 0
						aCols[n][nPDtValid] := SB8->B8_DTVALID
					EndIf
					If nPPotenc <> 0
						aCols[n][nPPotenc] := SB8->B8_POTENCI
					EndIf
				EndIf
			EndIf
		EndIf
		If nPValDesc <> 0 .And. nPQuant <> 0 .And. nPDesc <> 0
			aCols[n][nPValDesc] := a410Arred(((cAliasTRB)->B6_PRUNIT-(cAliasTRB)->B6_PRCVEN)*IIf(aCols[n][nPQuant]==0,1,aCols[n][nPQuant]),"D1_VALDESC")
		EndIf
		aCols[n][nPValor] := a410Arred(IIf(aCols[n][nPQuant]==0,1,aCols[n][nPQuant])*aCols[n][nPPrcVen],"D1_TOTAL")
	EndIf         
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
	//³Ponto de Entrada para customizar o aCols.  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
	If ExistBlock("A440VCOL")
		aA440VCOL:= ExecBlock("A440VCOL",.f.,.f.,{aHeader,aCols})
		If ValType(aA440VCOL)=="A"
			aCols:= aClone(aA440VCOL)
		EndIf
	Endif             
	
	If !Empty(cReadVar)                                            
	
		Do Case                                       
		Case cReadVar $ "M->C6_QTDVEN"
			&(cReadVar) := aCols[n][nPQuant]
		Case cReadVar $ "M->C6_UNSVEN"
			&(cReadVar) := aCols[n][nPQuant2UM]
		OtherWise	
			&(cReadVar) := aCols[n][nPQuant]		
		EndCase
	EndIf
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
//?Restaura a integridade da rotina                                    ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ?
dbSelectArea(cAliasTRB)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ARQUIVO TEMPORARIO DE MEMORIA (CTREETMP)                            ?
//³A funcao MSCloseTemp ira substituir a linha de codigo abaixo:       ?
//|--> dbCloseArea()                                                   |
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
MSCloseTemp(cAliasTRB,cNomeTrb)

RestArea(aArea)
SetFocus(nHandle)
Return(lRetorno)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaTesSel  ?Autor ?Rodrigo Sartorio      ?Data ?9.11.2001 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?         ³Rotina de verificacao da quantidade digitada conforme a TES  ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ExpL1 := MaTesSel(ExpC1)									   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Codigo da TES                                         ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³ExpL1: .T. - A quantidade nao eh necessaria                  ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo verificar se a quantidade do   ³±?
±±?         ³produto deve ser informada ou nao.                           ³±?
±±?         ?                                                            ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MaTesSel(cCodTes)

Local lRet    := .F.
Local aArea   := GetArea()
Local aAreaSF4:= SF4->(GetArea())
dbSelectArea('SF4')
dbSetOrder(1)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Verifica se a TES PERMITE QUANTIDADE ZERO                    ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If SF4->F4_CODIGO == cCodTes .Or. MsSeek(xFilial()+cCodTes)
	If FieldPos("F4_QTDZERO") > 0 .And. F4_QTDZERO == "1"
		lRet:=.T.	
	EndIf
EndIf
RestArea(aAreaSF4)
RestArea(aArea)
RETURN(lRet)
    

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ³AvalEmpSCP?Autor ³Rodrigo de A Sartorio  ?Data ?0/06/2004³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Funcao para verificar o empenho relacionado ao SCP         ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?ExpL1 := AvalEmpSCP(ExpC1,ExpC2,ExpC3,ExpN1)	              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpC1: Produto                                        	  ³±?
±±?         ?ExpC2: Armazem                                        	  ³±?
±±?         ?ExpC3: Ordem de Producao                               	  ³±?
±±?         ?ExpN1: Quantidade                                     	  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ³ExpL1: .T. - Se qtde.empenhada >= qtde. informada    		  ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?MATA185                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function AvalEmpSCP(cProduto,cLocal,cOP,nQuant)

Local lRet:=.F.
Local aArea:=GetArea()
Local cSeek:=xFilial("SD4")+cProduto+cOP
Local cCompara:="D4_FILIAL+D4_COD+D4_OP"
Local nQtdOri:=0  
If !Empty(cOp)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Verifica se existe empenho para o produto              ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SD4")
	dbSetOrder(1)
	dbSeek(cSeek)
	While !EOF() .And. cSeek == &(cCompara)
		If D4_LOCAL == cLocal
			nQtdOri+=D4_QUANT
		EndIf
		dbSkip()
	End
	RestArea(aArea)
	lRet:=QtdComp(nQtdOri)>=QtdComp(nQuant)
EndIf
Return(lRet)


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ³AvalSalPed?Autor ³Marcos V. Ferreira     ?Data ?8/11/2005³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Funcao utilizada para verificar Previsao de Entrada, campo ³±?
±±?		 | B2_SALPEDI, verificando as SC's geradas por Solicitacao ao ³±?
±±?		 | Armazem e SC's geradas pelo MRP.							  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?ExpN1 := AvalSalPed(ExpC1,ExpC2)				              ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpC1: Produto                                       	  ³±?
±±?         ?ExpC2: Armazem                                         	  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ?ExpN1: qtde prevista - reservas para SA e MRP. 			  ³±?
±±?         ?                                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?COMXFUN                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function AvalSalPed(cProd,cLocal)

Local aAreaAnt  := GetArea()
Local aAreaSB2  := SB2->(GetArea())
Local nQtdPrev  := 0
Local lQuery    := .F.
Local lFieldOP  := SC1->(FieldPos("C1_OP")) > 0
Local cQuery    := ''
Local cAliasSC1 := 'SC1'
Local nLE       := RetFldProd(cProd,"B1_LE")

Default cProd   := ''
Default cLocal  := ''

dbSelectArea('SB2')
dbSetOrder(1)
If dbSeek(xFilial()+cProd+cLocal)
	nQtdPrev := SB2->B2_SALPEDI
	If nQtdPrev > 0 .And. nLE <= 0
		dbSelectArea('SC1')
		dbSetOrder(2)
		#IFDEF TOP
			lQuery := .T.
			cAliasSC1:= GetNextAlias()
			cQuery += "SELECT C1_QUANT,C1_QUJE,C1_ORIGEM,C1_SEQMRP"
			cQuery += IIf(lFieldOP,",C1_OP "," ")
			cQuery +=   "FROM "+RetSqlName("SC1")+" "
			cQuery +=  "WHERE C1_FILIAL='"+xFilial("SC1")+"' "
			cQuery +=   " AND C1_PRODUTO='"+cProd+"' "
			cQuery +=   " AND C1_LOCAL='"+cLocal+"' "
			cQuery +=   " AND C1_QUJE < C1_QUANT "
			cQuery +=   " AND D_E_L_E_T_ = ' ' "
			cQuery := ChangeQuery(cQuery)
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSC1,.T.,.T.)
		#ELSE
			dbSeek(cSeek := xFilial('SC1')+cProd)
		#ENDIF
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Analisa quantidade prevista para entrada ja reservada para SA ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		While !(cAliasSC1)->(Eof()) .And. IIf(lQuery,.T.,cSeek==(cAliasSC1)->C1_FILIAL+(cAliasSC1)->C1_PRODUTO)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Verifica se nao deve considerar a solicitacao de compras      ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If !lQuery
				If (cAliasSC1)->C1_LOCAL <> cLocal .Or. (cAliasSC1)->C1_QUJE >= (cAliasSC1)->C1_QUANT
					dbSkip()
					Loop
				EndIf
			EndIf
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Subtrai da quantidade prevista das reservas para SA e MRP.    ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If AllTrim((cAliasSC1)->C1_ORIGEM) == "MATA106" .Or. !Empty((cAliasSC1)->C1_SEQMRP) .Or. (lFieldOP .And. !Empty((cAliasSC1)->C1_OP))
				nQtdPrev -= (cAliasSC1)->C1_QUANT-(cAliasSC1)->C1_QUJE
			EndIf
			dbSkip()
		EndDo 
		If lQuery
			(cAliasSC1)->(dbCloseArea())
		EndIf
	EndIf
EndIf	

RestArea(aAreaSB2)
RestArea(aAreaAnt)
Return(nQtdPrev)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ³COMXFUN_V  ?Autor ³Rodrigo de A Sartorio ?Data ?24/02/06 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Funcao utilizada para verificar a ultima versao do fonte   ³±?
±±?		 ?COMXFUN.PRX aplicado no rpo do cliente, assim verificando  ³±?
±±?		 ?a necessidade de uma atualizacao neste fonte.			  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?EST/PCP/FAT/COM	                                          ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function COMXFUN_V
Local nRet := 20120701 // 22 de maio de 2007     
Return nRet 

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ³MatPesqCtr?Autor ³Nereu Humberto Junior  ?Data ?8/04/2006³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Funcao utilizada para verificar se a pesquisa do contrato  ³±?
±±?		 | de parceria deve ocorrer por fornecedor+loja padrao ou por ³±?
±±?		 | produto somente.                 						  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?ExpN1 := MatPesqCtr(ExpL1,ExpC1,ExpC2,ExpC3,ExpC4)         ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpL1: Indica se pesquisa ou somente testa o parametro     ³±?
±±?         ?ExpC1: Fornecedor Padrao                               	  ³±?
±±?         ?ExpC2: Loja Padrao                                   	  ³±?
±±?         ?ExpC3: Produto                                             ³±?
±±?         ?ExpC3: Chave de pesquisa utilizada no laco                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ?ExpL1: .T. -> Se achou um contrato valido.    			  ³±?
±±?         ?       .F. -> Se nao achou um contrato valido.             ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?COMXFUN/MATA650/MATA710/MATA712                            ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function MatPesqCtr(lSeek,cProd,cForn,cLoja,cChaveSC3)

Local lRet  := .F.
Local lPesqForn := IIF(GetNewPar("MV_PESQCTP","F")=="F",.T.,.F.) //F - Pesquisa por Fornecedor  /  P - Pesquisa por Produto

If cChaveSC3 == Nil
	cChaveSC3 := ""
Endif

If lSeek 
	//--Utilizar indice que considera a filial de entrega, visando avaliar corretamente o saldo de acordo com a filial que recebera o material
	SC3->(dbSetOrder(4))
	If lPesqForn
		If SC3->(dbSeek(xFilial("SC3")+SB1->B1_COD+SB1->B1_PROC+SB1->B1_LOJPROC))
			lRet := .T.   
			//--Utilizar a filial de entrega na chave de pesquisa
			cChaveSC3 := 'SC3->C3_FILENT+SC3->C3_PRODUTO+SC3->C3_FORNECE+SC3->C3_LOJA == xFilial("SC3")+SB1->B1_COD+SB1->B1_PROC+SB1->B1_LOJPROC'
		Endif	
	Else
		If SC3->(dbSeek(xFilial("SC3")+SB1->B1_COD))
			lRet := .T.
			cChaveSC3 := 'SC3->C3_FILENT+SC3->C3_PRODUTO == xFilial("SC3")+SB1->B1_COD'
		Endif	
	Endif
Else
	lRet := lPesqForn
Endif	

Return(lRet)
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³ATUSA5    ºAutor  ³Patricia D. Aguiar  ?Data ? 03/09/07   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDesc.     ³Atualiza Amarracao Produto x fornecedor                     º±?
±±?         ?                                                           º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºParametros?ExpC1= Codigo do fornecedor                                º±?
±±?         ?ExpC2= Loja fornecedor                                     º±?
±±?         ?ExpC3= Codigo do produto                                   º±?
±±?         ?ExpL4= Indica de grava SA5 pelo codigo do produto ou pela  º±?
±±?         ?       referencia de grade                                 º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/

Function AtuSA5(cFornece,cLoja,cProduto,lIncRef)

Local cProdRef    := " "
Local lReferencia := .F.
Local lGrade      := MaGrade()
Local lAchou      := .F.
DEFAULT lIncRef   := .F.

cProdRef := cProduto
If lGrade
	lReferencia:= MatGrdPrRf(@cProdRef,.T.)
Endif

dbSelectArea("SA5")
dbSetOrder(1)
lAchou := MsSeek(xFilial("SA5")+cFornece+cLoja+cProduto,.F.)

If !lAchou
	If lReferencia
		dbSelectArea("SA5")
		dbSetOrder(9)
		lAchou :=MsSeek(xFilial("SA5")+cFornece+cLoja+cProdRef,.F.)
	Endif
	If (!lAchou .And. !lIncRef) .Or. (!lAchou .And. !lReferencia)
		RecLock("SA5",.T.)
		SA5->A5_FILIAL  := xFilial("SA5")
		SA5->A5_FORNECE := cFornece
		SA5->A5_LOJA    := cLoja
		SA5->A5_NOMEFOR := Posicione("SA2",1,xFilial("SA2")+cFornece+cLoja,"A2_NOME")
		SA5->A5_PRODUTO := cProduto
		SA5->A5_NOMPROD := Posicione("SB1",1,xFilial("SB1")+cProduto,"B1_DESC")
		MsUnlock()
	Elseif !lAchou .And. lIncRef .And. lReferencia
		RecLock("SA5",.T.)
		SA5->A5_FILIAL  := xFilial("SA5")
		SA5->A5_FORNECE := cFornece
		SA5->A5_LOJA    := cLoja
		SA5->A5_NOMEFOR := Posicione("SA2",1,xFilial("SA2")+cFornece+cLoja,"A2_NOME")
		SA5->A5_REFGRD  := cProdRef
		SA5->A5_DESREF  := DescPrRF(cProdRef)
		MsUnlock()
	Endif
Endif
Return(cProdRef)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³aColsGradeºAutor  ³Marcelo Iuspa       ?Data ? 12/02/07   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDesc.     ?Monta acols aglutinado                                     º±?
±±?         ?                                                           º±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?oGrade     = Objeto grade previamente criado               ³±?
±±?         ?aCols      = aCols original conforme alimentado pelo WT    ³±?
±±?         ?aHeader    = aHeader para pesquisa de campos lidos no aCols³±?
±±?         ?cProduto   = Campo com o produto (Ex.: "C1_PRODUTO")       ³±?
±±?         ?cItem      = Campo com o item (Ex.: "C1_ITEM")             ³±?
±±?         ?cItemGrd   = Campo com o item da grade (Ex.: "C1_ITEMGRD") ³±?
±±?         ?nPosCodDes = Posicao do aHeader para descricao do produto  ³±?
±±?         ?nAcolsAnt = Tamanho do aCols antes da importação dos itens ³±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±³Retorno   ?Array para ser usado como aCols e alimentacao de itens     ³±?
±±?         ?de grade no objeto grade informado                         ³±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?Tratamento de aCols gerado pelo WT (sem grade) aglutinando º±?
±±?         ?itens de grade e ao mesmo tempo alimentando o objeto grade ³±?
±±?         ?com os respectivos campos migrados da aCols original       ³±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function aColsGrade(oGrade, aCols, aHeader, cProduto, cItem, cItemGrd,nPosCodDes,lZerou, nAcolsAnt)

Local nLoop
Local nLoop2
Local aColsGrade := {}
Local nItem      := aScan(aHeader,{|z| AllTrim(z[2]) == AllTrim(cItem   )})
Local nItemGrd   := aScan(aHeader,{|z| AllTrim(z[2]) == AllTrim(cItemGrd)})
Local nProduto   := aScan(aHeader,{|z| AllTrim(z[2]) == AllTrim(cProduto)})
Local lRefer     := .F.
Local cProdRef   := Nil
Local cCodProd   := Nil
Local aColsRet   := {}
Local nItGrade   := Nil  
Local lReferencia := .F.
Local nA  		 := 1
DEFAULT nPosCodDes:= 0
DEFAULT lZerou     := .F.

aEval(oGrade:aCposCtrlGrd, {|z,w| Aadd(aColsGrade, {z[1], GDFieldPos(z[1], aHeader), TamSX3(z[1])[3], w})})

If ValType(nAcolsAnt)=="N" .And. nAcolsAnt < Len(aCols)
	For nA:= 1 To nAcolsAnt
		Aadd(aColsRet, aCols[nA])//igualando o aCols para atualizar o MontaGrade apenas nos itens novos
	Next
EndIf

For nLoop := nA to Len(aCols)  
    cProdRef:=aCols[nLoop, nProduto]
    lReferencia:= IIF(__lpyme,MatGrdPrrf(@cProdRef,.T.),!Empty(cItemGrd))
   	If Empty(cProdRef) .Or. (! lReferencia) .Or. Empty(aCols[nLoop, nItemGrd])
		Aadd(aColsRet, aCols[nLoop])  
		oGrade:cProdRef := cProdRef
	  	oGrade:MontaGrade(Len(aColsRet), aCols[nLoop, nProduto],,,.F.,lZerou)
	Else
		IIF(!__lpyme,MatGrdPrrf(@cProdRef,.T.),NIL) 
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Inicializa o aHeadGrade e o AcolsGrade                                  ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		cCodProd := aCols[nLoop, nProduto]      
		oGrade:cProdRef := cProdRef

		If (nItGrade := aScan(aColsRet, {|z| z[nItem] == aCols[nLoop, nItem]})) == 0
			Aadd(aColsRet, aClone(aCols[nLoop]))
			nItGrade := Len(aColsRet)
			aColsRet[nItGrade, nProduto] := Pad(cProdRef, Len(SB1->B1_COD))
			If nPosCodDes >0
				aColsRet[nItGrade, nPosCodDes] := oGrade:GetDescProd(cProdRef)
			EndIf
			If !(Alltrim(cCodProd)==Alltrim(cProdRef))
				For nLoop2 := 1 to Len(aColsGrade)
					If aColsGrade[nLoop2,2]>0 		    
						If aColsGrade[nLoop2, 3] == "N"   
							aColsRet[nItGrade, aColsGrade[nLoop2, 2]] := 0
						ElseIf	aColsGrade[nLoop2, 3] == "D"
							If aColsGrade[nLoop2,2]>0 		    
								aColsRet[nItGrade, aColsGrade[nLoop2, 2]] := Ctod("")
							Endif
						EndIf
					EndIf
				Next
		
				oGrade:MontaGrade(nItGrade,@cProdRef,,,,lZerou)
				
			Endif
		EndIf

		cLinha   := AllTrim(Substr(cCodProd,oGrade:TamRef(nItGrade)+1,oGrade:TamLin(nItgrade)))
		cColuna  := AllTrim(Substr(cCodProd,oGrade:TamRef(nItgrade)+oGrade:TamLin(nItgrade)+1,oGrade:TamCol(nItgrade)))

		nColuna := oGrade:RetPosCol(nItGrade,cColuna)
		nLinha  := oGrade:RetPosLin(nItGrade,cLinha)

		If ( nColuna<>0 .And. nLinha <> 0 )
			nColuna++
			For nLoop2 := 1 to Len(aColsGrade)
				If aColsGrade[nLoop2,2]>0 		    
					If  aColsGrade[nLoop2, 3] == "N"
						aColsRet[nItGrade, aColsGrade[nLoop2, 2]] += aCols[nLoop, aColsGrade[nLoop2, 2]]
					ElseIf aColsGrade[nLoop2, 3] == "D"
						aColsRet[nItGrade, aColsGrade[nLoop2, 2]] := Max(aCols[nLoop, aColsGrade[nLoop2, 2]], aColsRet[nItGrade, aColsGrade[nLoop2, 2]])
					EndIf
	
					If aColsGrade[nLoop2, 3] == "N"
						oGrade:aColsGrade[nItGrade][nLinha][nColuna][oGrade:GetFieldGrdPos(aColsGrade[nLoop2, 1])] += aCols[nLoop, aColsGrade[nLoop2, 2]]
					ElseIf	aColsGrade[nLoop2, 3] == "C"
						oGrade:aColsGrade[nItGrade][nLinha][nColuna][oGrade:GetFieldGrdPos(aColsGrade[nLoop2, 1])] := aCols[nLoop, aColsGrade[nLoop2, 2]]
					ElseIf	aColsGrade[nLoop2, 3] == "D"
						oGrade:aColsGrade[nItGrade][nLinha][nColuna][oGrade:GetFieldGrdPos(aColsGrade[nLoop2, 1])] := Max(oGrade:aColsGrade[nItGrade][nLinha][nColuna][oGrade:GetFieldGrdPos(aColsGrade[nLoop2, 1])], aCols[nLoop, aColsGrade[nLoop2, 2]])
					EndIf
				EndIf
			Next
		EndIf
		If aScan(aHeader, {|z| "_REC_WT" $ z[2]}) > 0 .And. Len(aCols[nLoop]) >= Len(aHeader) .And. nColuna <>0 .And. nLinha <> 0
			oGrade:SetRecNo(nItGrade,nLinha,nColuna, aCols[nLoop,Len(aHeader)])
		Endif	
	EndIf 
Next

Return(aClone(aColsRet))

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³aGradeColsºAutor  ³Marcelo Iuspa       ?Data ? 12/02/07   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDesc.     ?Monta acols expandido com os itens da grade                º±?
±±?         ?                                                           º±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?oGrade     = Objeto grade usado na getdados                ³±?
±±?         ?aCols      = aCols resultante da edicao via getdados       ³±?
±±?         ?aHeader    = aHeader para pesquisa de campos lidos no aCols³±?
±±?         ?cProduto   = Campo com o produto (Ex.: "C1_PRODUTO")       ³±?
±±?         ?cItemGrd   = Campo com o item da grade (Ex.: "C1_ITEMGRD") ³±?
±±?         ?cQuant     = Campo com a quantidade (Ex.: "C1_QUANT")      ³±?
±±?         ?                                                           ³±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±³Retorno   ?Array retornado a forma usual pronto para uso nas rotinas  ³±?
±±?         ?de gravacao sem qualquer alteracao nas mesmas.             º±?
±±?         ?As informacoes dos itens da grade serao lidas diretamente  º±?
±±?         ?no objeto grade informado                                  º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?Tratamento de aCols editado via GetDados concatenando      º±?
±±?         ?dados com os itens de grade editados via objeto grade      ³±?
±±?         ?informado                                                  ³±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function aGradeCols(oGrade, aCols, aHeader, cProduto, cItemGrd, cQuant, cItem)

Local nLoop       := Nil
Local nLoop2      := Nil
Local nLoop3	  := Nil
Local nItemGrd    := aScan(aHeader,{|z| AllTrim(z[2]) == AllTrim(cItemGrd)})
Local nProduto    := aScan(aHeader,{|z| AllTrim(z[2]) == AllTrim(cProduto)})
Local nPosQuant   := 0
Local nPosItem    := 0
Local aColsRet    := {}
Local nLinha      := Nil
Local nColuna     := Nil
Local nField      := Nil
Local nPosField   := Nil
Local nLenAcols   := Nil
Local lWalkThru   := aScan(aHeader, {|z| "_REC_WT" $ z[2]}) > 0
Local cNewItemGr  := StrZero(1,TamSX3(cItemGrd)[1])
Local lProcessa   := .T.

For nLoop := 1 to Len(aCols)
	If Empty(aCols[nLoop, nItemGrd])
		Aadd(aColsRet, aCols[nLoop])
	Else

		oGrade:cProdRef := GDFieldGet(cProduto,nLoop,,aHeader,aCols)
		oGrade:nPosLinO := nLoop

		For nLinha := 1 to Len(oGrade:aColsGrade[nLoop])
			For nColuna := 2 to Len(oGrade:aHeadGrade[nLoop])
				If ValType(cQuant) == "A"
					For nLoop2 := 1 To Len(cQuant)
						nPosQuant := aScan(oGrade:aCposCtrlGrd,{|x| AllTrim(x[1]) == cQuant[nLoop2]})
						If Empty(oGrade:aColsGrade[nLoop, nLinha, nColuna, nPosQuant])
							lProcessa := .F.
						Else
							lProcessa := .T.
							Exit
						Endif
					Next nLoop2
				Else
					nPosQuant := aScan(oGrade:aCposCtrlGrd,{|x| AllTrim(x[1]) == cQuant})
					If Empty(oGrade:aColsGrade[nLoop, nLinha, nColuna, nPosQuant])
						lProcessa := .F.
					Else
						lProcessa := .T.
					Endif					
				EndIf
				If !lProcessa
					Loop
				EndIf
				Aadd(aColsRet, aClone(aCols[nLoop]))
		   		nLenAcols := Len(aColsRet)				
				For nField := 1 to Len(oGrade:aCposCtrlGrd)
					nPosField := aScan(aHeader, {|z| AllTrim(z[2]) == AllTrim(oGrade:aCposCtrlGrd[nField, 1])})
					If !Empty(nPosField)
						aColsRet[nLenAcols, nPosField] := oGrade:aColsGrade[nLoop, nLinha, nColuna, nField]
					EndIf
				Next
				aColsRet[nLenAcols, nProduto] := oGrade:GetNameProd(AllTrim(aColsRet[nLenAcols, nProduto]),nLinha,nColuna)
				If lWalkThru .And. Len(aCols[nLoop]) >= Len(aHeader)
					aColsRet[nLenAcols, Len(aHeader)] := oGrade:GetRecNo(nLoop,nLinha,nColuna, aCols[nLoop,Len(aHeader)])
				Endif	
			Next
		Next	
		
		//Ajusta ordem e itemgrd
		If !Empty(cItem)
			nPosItem := aScan(aHeader,{|z| AllTrim(z[2]) == AllTrim(cItem)})
			aSort(aColsRet,,,{|x,y | x[nPosItem]+x[nProduto] < y[nPosItem]+y[nProduto] } )
			cNewItemGr := StrZero(1,TamSX3(cItemGrd)[1])
			
			For nLoop3 := 1 to Len(aColsRet)
				If AllTrim(oGrade:cProdRef) $ aColsRet[nLoop3,nProduto] .And. !Empty(aColsRet[nLoop3,nItemGrd])
					aColsRet[nLoop3,nItemGrd] := cNewItemGr
					cNewItemGr := Soma1(cNewItemGr)
				EndIf
			Next nLoop3
		EndIf
	Endif
Next

Return(aClone(aColsRet))

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?VldHead      ?Autor ?Ricardo Berti      	?Data ?27/06/07 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Valida todos os campos do aCols via validacao do aHeader		  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?VldHead(ExpA1,ExpA2,ExpN1,ExpO1)		                          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpA1 = Array aCols									          ³±?
±±?         ?ExpA2 = Array aHeader										  ³±?
±±?         ?ExpN1 = (Linha do aCols a validar):  Quando informada, valida  ³±?
±±?         ?  somente a linha, quando nao informada, validara' todo o aCols³±?
±±?         ?ExpO1 = obj da getdados										  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Retorno   ?.T. = Validacao OK			                                  ³±?
±±?         ?.F. = Validacao nao OK.                                        ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?Generico                                                  	  ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Function VldHead(aCols,aHeader,nLinha,oGetH)

Local cVar
Local cCampo
Local bBlock	:= {}
Local lRet		:= .T.
Local nX
Local nY
Local nLenACols := If(ValType(nLinha)=="N",nLinha,Len(aCols))

DEFAULT nLinha	 := 1
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?O parametro MV_VLDHEAD e' usado para validar ou nao o aCols          ?
//?(uma linha ou todo), a partir das validacoes do aHeader -> VldHead() ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
lVldHead:= If(ValType(lVldHead) == "L",lVldHead, GetNewPar( "MV_VLDHEAD",.T. ) )

Private lGatilha := .F.  // Para nao alterar o conteudo dos campos do aCols, somente valida-lo

If lVldHead .And. ValType(aHeader)=="A" .And.ValType(aCols)=="A"
	For nX := nLinha to nLenACols
		If !GdDeleted(nX,aHeader,aCols)
			n := nX   
			For nY := 1 to Len(aHeader)
				// criar todas variaveis de memoria
				cVar  := "M->"+Upper(AllTrim(aHeader[nY,2]))
				&cVar := aCols[nX,nY]
			Next
			For nY := 1 to Len(aHeader)
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//?Nao consiste campos visuais ou cujas validacoes modifiquem o aCols ou com validacoes fiscais ?
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				cVar  := Upper(AllTrim(aHeader[nY,2]))
			    If !Empty(aCols[nX][nY]) .And. !Empty(aHeader[nY,6 ]) .And. ;
					!cVar$"C1_PRODUTO,C1_CODGRP,C1_CODITE,C1_UM,C1_QUANT,C1_SEGUM,C1_QTDSEGUM,C1_TAREFA,C1_PROJETO,C1_APROV,"+;
					      "C7_PRODUTO,C7_CODGRP,C7_CODITE,C7_UM,C7_QUANT,C7_SEGUM,C7_QTDSEGUM,C7_FRETE,C7_NUMCOT,C7_GRADE,C7_BASESOL" .And. ;
					!"MAFIS"$Upper(aHeader[nY,6 ])

					cCampo:= aCols[nX,nY]
					If aHeader[nY][8] == "C"
						cCampo := Padr(cCampo,aHeader[nY][4])
					EndIf
					__READVAR := "M->" + cVar
					&(__READVAR) := cCampo

					bBlock := &( "{ || " + AllTrim( aHeader[ny,6 ] ) + " }" )
					If ! Eval( bBlock )
						If ValType(oGetH) == "O"
  							oGetH:nAt:=nX
							oGetH:Refresh()
							oGetH:SetFocus()
						EndIf
						lRet :=.F.
						Exit
					EndIf
				EndIf
			Next
		EndIf
	Next
EndIf
Return(lRet)
  
	
/*/
______________________________________________________________________________
¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦
¦¦+------------------------------------------------------------------------+¦¦
¦¦¦Funcao    ? VALSCPRE    ?Autor ?Bruna Paola       ?Data ?20/05/11  ¦¦?
¦¦+----------+-------------------------------------------------------------¦¦?
¦¦¦Descricao ?Funcao de validacao do campo C1_XTIPOSC.					   ¦¦?
¦¦+----------+-------------------------------------------------------------¦¦?
¦¦¦Uso       ?Exclusivo TOTVS.								   			   ¦¦?
¦¦+----------+-------------------------------------------------------------¦¦?
¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦¦
¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯
/*/  
Function VALSCPRE(cTipoSC, lFlag)

Local cChave 	:= "" 
Local cQuery 	:= ""
Local cNum   	:= ""
Local nControle := 0
Local cMsg		:= ""
Local lParam	:= GETMV("MV_SEQESP")
Local cTpAx 	:= GETMV("MV_TPSCAX")

If(lParam == .F.)
	Return (.T.)
EndIf

DbSelectArea("COD")
DbSetOrder(1)  
                   
// Verifica se existe range cadastrado para o tipo de documento escolhido
If !( DbSeek(xFilial("COD")+cTpAx) )   

	MsgAlert("O código que est?informado no parametro MV_TPSCAX não est?cadastrado nos tipos de documento. Favor verificar.","ATENCAO")
	
	Return (.F.)	
EndIf       


DbSelectArea("COE")
DbSetOrder(2)  //PA1_FILIAL+PA1_DOC
                   
// Verifica se existe range cadastrado para o tipo de documento escolhido
If !( DbSeek(xFilial("COE")+cTipoSC) )   

	MsgAlert("O sistema esta configurado para utilizar codificação especifica. O tipo de documento escolhido, "+;
	"nao possui um intervalo cadastrado.","ATENCAO")
	
	Return (.F.)	
EndIf       
  
// Procura qual o ultimo numero usado no C1_NUM para esse tipo de documento selecionado
cQuery  := "  SELECT MAX(C1_NUM) AS C1_NUM"
cQuery  += "  FROM " + RetSQLName('SC1') + " SC1 " 
cQuery  += "  WHERE C1_XTIPOSC = " + ValToSQL(cTipoSC) + "AND"
cQuery  += "  D_E_L_E_T_ <> '*' "

cQuery := ChangeQuery(cQuery) 

Conout(cQuery)

DbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),"TEMP",.T.,.T.)

DbSelectArea("TEMP")  

If lxCont == .T.  .And. lFlag
	DbSelectArea("SC1")    
	SC1->C1_NUM := TEMP->(C1_NUM)
	Return (.T.)
Endif 

// Incrementar 1 no C1_NUM encontrado 
If ( Empty(C1_NUM) ) // Primeiro registro de SC do tipo de documento escolhido
	cNum := COE->COE_INICIO
Else
	cNum := Soma1(C1_NUM)
EndIf

TEMP->( DbCloseArea() )

DbSelectArea("COE")
DbSetOrder(2)  //COE_FILIAL+COE_DOC 
DbSeek(xFilial("COE")+cTipoSC)

cChave := xFilial("COE")+cTipoSC 
	
Do While !( Eof() ) .And. ( xFilial("COE")+COE->COE_DOC == cChave ) // Verifica somente os ranges do tipo de documento escolhido

	If (cNum >= COE->COE_INICIO).And.(cNum <= COE->COE_FINAL) // Verifica se o numero pertence a algum range definido      
       nControle := 1 
       Exit
    ElseIf (cNum < COE->COE_INICIO) // Primeiro num do intervalo cadastrado  
    	cNum := COE->COE_INICIO
    	nControle := 1
    	Exit
	EndIf      

	DbSkip()
EndDo     
	
// Nao existe intervalo cadastrado para o tipo de documento(acabou o range dos cadastrados)
If (nControle == 0)
          
	cMsg := "Um novo intervalo deve ser cadastrado para esse tipo de documento."
	
	MsgAlert(cMsg,"ATENCAO")
	
	Return (.F.)
EndIf    

If (lFlag == .T.)
	// Atribui ao objeto Num da SC o valor definido pelo tipo de documento.   
	DbSelectArea("SC1")    
	SC1->C1_NUM := cNum  
	lxCont := .T.  
EndIf

Return (.T.) 

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MaGeraAE     ?Autor ?Andre dos Anjos      	?Data ?18/06/12 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Gera as autorizacoes de entrega por contrato para um produto   ³±?
±±?		 ?e sua necessidade.											  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?cProduto:codigo do produto									  ³±?
±±?         ?nNecess: necessidade de compra   							  ³±?
±±?         ?aCampos: campos especificos a serem gravados por rotinas.	  ³±?
±±?         ?cRotina: identifica a rotina chamadora da funcao.			  ³±?
±±?         ?cPV: numero do pedido de venda relacionado (exclusivo MATA650).³±?
±±?         ?cItemPV: item do pedido de venda relacionado (exclus. MATA650).³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?Generico                                                  	  ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Function MatGeraAE(cProduto,nNecess,aCampos,cRotina,cPV,cItemPV)
Local nSaldoFor 	:= 0
Local nPercTot  	:= 0
Local nPosCtr		:= 0
Local nX			:= 0
Local nY			:= 0
Local nTotAEs		:= 0
Local nQtdeGera 	:= 0
Local nPosTpOp		:= 0
Local cFilTpOp  	:= "F"
Local cChave    	:= ""
Local cQuery		:= ""
Local cNumAglu  	:= ""
Local cItemAgl		:= ""
Local cLogin        := "" 
Local aAEs			:= {}
Local aUser         := {}
Local aMtGeraAe		:= {}
Local aCTBEnt		:= If(FindFunction("CTBEntArr"),CTBEntArr(),{})
Local nNecOrig  	:= nNecess
Local lAlcada		:= .T.
Local lVer116		:= Val(GetVersao(.F.)) == 11 .And. GetRpoRelease() >= "R6"  .Or.  VAL(GetVersao(.F.))  > 11
Local lMatrizF  	:= SuperGetMV("MV_MATRIZF",.F.,.F.) //-- Indica se utiliza o conceito de matriz de fornecimento
Local lCPGerSC  	:= SuperGetMV("MV_CPGERSC",.F.,.T.) .Or. SuperGetMV("MV_SCCONTR",.F.,"1") == "1" //-- Indica se gera SC na ausencia de CP
Local lRediSld  	:= SuperGetMV("MV_MFREDIS",.F.,.T.) //-- Indica se redistribui saldos remanescentes de outros fornecedores
Local lMFSaldo		:= SuperGetMV("MV_MFSLDCP",.F.,.T.) //-- Indica se simula matriz com contratos em aberto quando nao tem SDU
Local lAglutAE		:= SuperGetMV("MV_AGLUTAE",.F.,.F.) //-- Indica se aglutina AE's do mesmo contrato em um unico documento
Local dDataNec  	:= dDataBase
Local nSaldoGer		:= 0
Local aRet			:= {}
Local lGeraSA       := SuperGetMV("MV_SOLICSA",.F.,.F.) // -- Indica que o Solicitando da SA sera o mesmo na SC
Local cNewGrp		:= ""

Default aCampos	  := {}
Default cRotina	  := ""

SY1->(dbSetOrder(3))
SB1->(dbSetOrder(1))
SB5->(dbSetOrder(1))
SA5->(dbSetOrder(1))
SB2->(dbSetOrder(1))
SC3->(dbSetOrder(4))
SC7->(dbSetOrder(1))

//-- Posiciona SY1 para tratamento de alcadas
SY1->(dbSeek(xFilial("SY1")+RetCodUsr()))

//-- Posiciona no SB1 para gravar os campos B1_SEGUM/B1_CONTA/B1_CC/B1_DESC/
SB1->(dbSeek(xFilial("SB1")+cProduto))
SB5->(dbSeek(xFilial("SB5")+cProduto))

dDataNec := If(aScan(aCampos,{|x| x[1] == "DATPRF"}) == 0,dDataNec,aCampos[aScan(aCampos,{|x| x[1] == "DATPRF"}),2])

// -- Localiza usuario que gerou SA caso registro gerado pelo MATA106

IF lGeraSA .And. cRotina $ "MATA106" .And. !Empty(SCP->CP_SOLICIT) 
	FWSFLoadUser(SCP->CP_SOLICIT,,,1)
	aUser:= FWSFLoadUser(SCP->CP_SOLICIT,,,1)
	If Len (aUser) > 0 
		cLogin := aUser[2]
	EndIf
EndIf


#IFNDEF TOP
	lMatrizF := .F.
#ELSE
	lMatrizF := lMatrizF .And. TcSrvType() <> "AS/400"
#ENDIF

If Existblock("MTGERAAE")
	aMtGeraAe := ExecBlock("MTGERAAE",.F.,.F.,{cProduto,nNecess})
	//[n,1] := nro contrato
	//[n,2] := item
	//[n,3] := quantidade
	SC3->(dbSetOrder(1))
	For nX:=1 To Len(aMtGeraAe)
		If SC3->(dbSeek(xFilial("SC3")+aMtGeraAe[nX,1]+aMtGeraAe[nX,2])) .And. SC3->C3_PRODUTO == cProduto .And. SC3->C3_ENCER # "E" .And. SC3->C3_RESIDUO # "S" .And. (SC3->C3_QUANT - SC3->C3_QUJE) > 0
			nQtdeGera := Min(aMtGeraAe[nX,3],SC3->C3_QUANT - SC3->C3_QUJE) //-- Quantidade da AE
			If (nPosCtr := aScan(aAEs,{|x| x[1] == aMtGeraAe[nX,1]})) == 0
				aAdd(aAEs, {aMtGeraAe[nX,1], SC3->C3_FORNECE, SC3->C3_LOJA, nQtdeGera} )
			Else
				aAEs[nPosCtr,4] += nQtdeGera
			EndIf
			//-- Atualiza saldo do contrato
			RecLock("SC3",.F.)
			SC3->C3_QUJE += nQtdeGera
			SC3->(MsUnLock())
			nNecess := Max( 0, nQtdeGera - nNecess )
		Else
			Loop
		EndIf
	Next
	SC3->(dbSetOrder(4))
EndIf

Begin Transaction

If lVer116 .And. lMatrizF
	//-- Geracao com conceito de matriz por produto
	While cRotina # "MATA173" .And. nNecess > 0
		SDU->(dbSetOrder(1))
		lMatrizF := SDU->(dbSeek(xFilial("SDU")+cProduto))
		
		If !lMatrizF .Or. (nNecess # nNecOrig .And. !lRediSld) //-- Caso configurado para nao redistribuir saldos, sai
			Exit
		EndIf
	
		cQuery := "SELECT SDU.DU_FORNECE, SDU.DU_LOJA, SDU.DU_PERCENT, SC3.C3_NUM, SC3.C3_ITEM, "
		cQuery += "SC3.C3_QUANT, SC3.C3_QUJE "
		cQuery += "FROM " +RetSQLName("SDU") +" SDU "
		cQuery += "INNER JOIN " +RetSQLName("SC3") +" SC3 ON SC3.D_E_L_E_T_ <> '*' AND "
		cQuery += "SC3.C3_FILIAL = '" +xFilial("SC3") +"' AND "
		cQuery += "SC3.C3_PRODUTO = '" +cProduto +"' AND "
		cQuery += "SC3.C3_FORNECE = SDU.DU_FORNECE AND "
		cQuery += "SC3.C3_LOJA = SDU.DU_LOJA AND "
		cQuery += "SC3.C3_ENCER <> 'E' AND "
		cQuery += "SC3.C3_RESIDUO <> 'S' AND "
		cQuery += "SC3.C3_DATPRI <= '" +DToS(dDataBase) +"' AND "
		cQuery += "SC3.C3_DATPRF >= '" +DToS(dDataBase) +"' AND "
		cQuery += "SC3.C3_QUANT - SC3.C3_QUJE > 0 "
		If SuperGetMV("MV_APROVCP",.F.,.F.)
			cQuery += "AND SC3.C3_CONAPRO <> 'B' "
		EndIf
		cQuery += "WHERE SDU.D_E_L_E_T_ <> '*' AND "
		cQuery += "SDU.DU_FILIAL = '" +xFilial("SDU") +"' AND "
		cQuery += "SDU.DU_PRODUTO = '" +cProduto +"' AND "
		cQuery += "SDU.DU_DTINI <= '" +DToS(dDataNec) +"' AND "
		cQuery += "SDU.DU_DTFIM >= '" +DToS(dDataNec) +"'"
		cQuery += "ORDER BY SDU.DU_DTINI, SDU.DU_FORNECE, SDU.DU_LOJA, SC3.C3_EMISSAO"
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),"TMPSC3",.T.,.F.)
		
		If lRediSld //-- Se MV_MFREDIS ativo, proporcionaliza percentual da matriz conforme fornecedores com saldo no contrato
			nPercTot := 0
			TMPSC3->(dbEval({|| nPercTot += DU_PERCENT}))
			TMPSC3->(dbGoTop())
		Else
			nPercTot := 100
		EndIf
		
		//-- Caso nao haja nenhum contrato com saldo para a matriz
		If TMPSC3->(EOF())
			TMPSC3->(dbCloseArea())
			Exit
		EndIf
	
		//-- Prepara variaveis de controle de processamento
		cChave    := TMPSC3->(DU_FORNECE+DU_LOJA)
		nSaldoFor := Round(((((TMPSC3->DU_PERCENT * 100) / nPercTot) / 100)  * nNecess),TamSX3("C7_QUANT")[2])
		
		Do Case
			Case SB1->B1_TIPODEC == "A"
				nSaldoFor := Round(nSaldoFor,0)
			Case SB1->B1_TIPODEC == "I"
				nSaldoFor := Int(nSaldoFor) +If(((nSaldoFor-Int(nSaldoFor)) > 0),1,0)
			Case SB1->B1_TIPODEC == "T"
				nSaldoFor := Int(nSaldoFor)
		EndCase
		
		//-- Processa contratos disponiveis para a matriz		
		While !TMPSC3->(EOF())	
			 //-- Enquanto houver saldo e contratos
			While !TMPSC3->(EOF())	 .And. nSaldoFor > 0 .And. cChave == TMPSC3->(DU_FORNECE+DU_LOJA)
				nQtdeGera := Min(nSaldoFor,TMPSC3->C3_QUANT - TMPSC3->C3_QUJE) //-- Quantidade da AE
				
				If (nPosCtr := aScan(aAEs,{|x| x[1] == TMPSC3->C3_NUM})) == 0
					TMPSC3->(aAdd(aAEs, {TMPSC3->C3_NUM,TMPSC3->DU_FORNECE,TMPSC3->DU_LOJA,nQtdeGera} ))
				Else
					aAEs[nPosCtr,4] += nQtdeGera
				EndIf

				//-- Atualiza saldo do contrato
				SC3->(dbSeek(xFilial("SC3")+cProduto+TMPSC3->(DU_FORNECE+DU_LOJA+C3_NUM)))
				RecLock("SC3",.F.)
				SC3->C3_QUJE += nQtdeGera
				SC3->(MsUnLock())
				nSaldoFor -= nQtdeGera

				TMPSC3->(dbSkip())
			EndDo
			
			//-- Se zerou o saldo do fornecedor, troca
			While cChave == TMPSC3->(DU_FORNECE+DU_LOJA)
				TMPSC3->(dbSkip())
			End
			
			//-- Prepara dados para o prox. fornecedor
			If !TMPSC3->(EOF())
				cChave    := TMPSC3->(DU_FORNECE+DU_LOJA)
				nSaldoFor := Round(((TMPSC3->DU_PERCENT / 100) * nNecess),TamSX3("C7_QUANT")[2])
				
				Do Case
					Case SB1->B1_TIPODEC == "A"
						nSaldoFor := Round(nSaldoFor,0)
					Case SB1->B1_TIPODEC == "I"
						nSaldoFor := Int(nSaldoFor) +If(((nSaldoFor-Int(nSaldoFor)) > 0),1,0)
					Case SB1->B1_TIPODEC == "T"
						nSaldoFor := Int(nSaldoFor)
				EndCase
			EndIf	
		EndDo
		TMPSC3->(dbCloseArea())
		
		nTotAEs := 0
		aEval(aAEs,{|x| nTotAEs += x[4]})
		nNecess := nNecOrig - nTotAEs
	End
	
	//-- Geracao com conceito de matriz pelos saldos dos contratos: somente quando produto sem matriz valida
	If lMFSaldo .And. cRotina # "MATA173" .And. nNecess == nNecOrig
		cQuery := "SELECT SUM(SC3.C3_QUANT - SC3.C3_QUJE) AS SALDOTOT "
		cQuery += "FROM " +RetSQLName("SC3") +" SC3 WHERE SC3.D_E_L_E_T_ <> '*' AND "
		cQuery += "SC3.C3_FILIAL = '" +xFilial("SC3") +"' AND "
		cQuery += "SC3.C3_PRODUTO = '" +cProduto +"' AND "
		cQuery += "SC3.C3_ENCER <> 'E' AND "
		cQuery += "SC3.C3_RESIDUO <> 'S' AND "
		cQuery += "SC3.C3_DATPRI <= '" +DToS(dDataBase) +"' AND "
		cQuery += "SC3.C3_DATPRF >= '" +DToS(dDataBase) +"' AND "
		cQuery += "(SC3.C3_QUANT - SC3.C3_QUJE) > 0 "
		If SuperGetMV("MV_APROVCP",.F.,.F.)
			cQuery += " AND SC3.C3_CONAPRO <> 'B'"
		EndIf
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),"TMPSC3",.T.,.F.)
		nPercTot := TMPSC3->SALDOTOT		
		TMPSC3->(dbCloseArea())
		
		cQuery := "SELECT * 
		cQuery += "FROM " +RetSQLName("SC3") +" SC3 WHERE SC3.D_E_L_E_T_ <> '*' AND "
		cQuery += "SC3.C3_FILIAL = '" +xFilial("SC3") +"' AND "
		cQuery += "SC3.C3_PRODUTO = '" +cProduto +"' AND "
		cQuery += "SC3.C3_ENCER <> 'E' AND "
		cQuery += "SC3.C3_RESIDUO <> 'S' AND "
		cQuery += "SC3.C3_DATPRI <= '" +DToS(dDataBase) +"' AND "
		cQuery += "SC3.C3_DATPRF >= '" +DToS(dDataBase) +"' AND "
		cQuery += "SC3.C3_QUANT - SC3.C3_QUJE > 0"
		If SuperGetMV("MV_APROVCP",.F.,.F.)
			cQuery += " AND SC3.C3_CONAPRO <> 'B'"
		EndIf
		cQuery := ChangeQuery(cQuery)
		dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),"TMPSC3",.T.,.F.)
		
		nNecOrig := nNecess
		While !TMPSC3->(EOF())
			nNecess -= (TMPSC3->(C3_QUANT-C3_QUJE) / nPercTot) * Min(nNecOrig,nPercTot)
			TMPSC3->(aAdd(aAEs, {TMPSC3->C3_NUM,TMPSC3->C3_FORNECE,TMPSC3->C3_LOJA,(TMPSC3->(C3_QUANT-C3_QUJE) / nPercTot) * Min(nNecOrig,nPercTot)} ))
			
			//-- Atualiza saldo do contrato
			SC3->(dbSeek(xFilial("SC3")+cProduto+TMPSC3->(C3_FORNECE+C3_LOJA+C3_NUM)))
			RecLock("SC3",.F.)
			SC3->C3_QUJE += (TMPSC3->(C3_QUANT-C3_QUJE) / nPercTot) * Min(nNecOrig,nPercTot)
			SC3->(MsUnLock())
			
			TMPSC3->(dbSkip())
		EndDo
		TMPSC3->(dbCloseArea())
	EndIf
	
	//-- Arredonda para nao gerar SC quebrada
	If nNecess # nNecOrig
		Do Case
			Case SB1->B1_TIPODEC == "A"
				nNecess := Round(nNecess,0)
			Case SB1->B1_TIPODEC == "I"
				nNecess := Int(nNecess) +If(((nNecess-Int(nNecess)) > 0),1,0)
			Case SB1->B1_TIPODEC == "T"
				nNecess := Int(nNecess)
		EndCase
	EndIf
EndIf

//-- Gera sem o conceito de matriz de fornecimento
If !lMatrizF .And. nNecess == nNecOrig .And. MatPesqCtr(.T.,SB1->B1_COD,SB1->B1_PROC,SB1->B1_LOJPROC,@cChave)
	//-- Verifica se possui contrato
	While !SC3->(EOF()) .And. &(cChave)
		//-- Nao considera contratos de parceria encerrados ou fora da data
		If dDataNec < SC3->C3_DATPRI .Or. SC3->C3_DATPRF < dDataNec .Or.;
					 SC3->C3_QUANT <= SC3->C3_QUJE .Or. SC3->C3_ENCER == "E" .Or. SC3->C3_RESIDUO == "S"
			SC3->(dbSkip())
			Loop
		EndIf
		
		//-- Se achou contrato valido, gera AE
		nSaldoGer := Min(nNecess,SC3->(C3_QUANT - C3_QUJE))
		
		aAdd(aAEs, {SC3->C3_NUM,SC3->C3_FORNECE,SC3->C3_LOJA,nSaldoGer} )
				
		//-- Atualiza saldo do contrato
		RecLock("SC3",.F.)
		SC3->C3_QUJE += nSaldoGer
		SC3->(MsUnLock())	
		
		//-- Subtrai saldo que foi gerado
		nNecess -= nSaldoGer		
		
		Exit
	EndDo
EndIf

If Len(aAes) > 1 .And. aScan(aCampos,{|x| x[1] == "NUM"}) > 0
	aDel(aCampos,aScan(aCampos,{|x| x[1] == "NUM"}))
	aSize(aCampos,Len(aCampos)-1)
EndIf

//-- Realiza gravacao das AEs
For nX := 1 To Len(aAEs)
	SC3->(dbSetOrder(4))
	SC3->(dbSeek(xFilial("SC3")+cProduto+aAEs[nX,2]+aAEs[nX,3]+aAEs[nX,1]))
	
	lAchou := .F.
	While SC3->C3_FILENT+SC3->C3_PRODUTO+SC3->C3_FORNECE+SC3->C3_LOJA+SC3->C3_NUM == xFilial("SC3")+cProduto+aAEs[nX,2]+aAEs[nX,3]+aAEs[nX,1]
		If dDataBase < SC3->C3_DATPRI .Or. dDataBase > SC3->C3_DATPRF
			SC3->(dbSkip())
		Else
			lAchou := .T.
			Exit
		EndIf
	End
	
	If !lAchou
		Loop
	EndIf
	
	RecLock("SC7",.T.)
	//-- Inicializa os campos
	For nY := 1 To SC7->(FCount())
		SC7->&(Field(nY)) := CriaVar(SC7->(Field(nY)))
	Next nY
	
	SC7->C7_FILIAL	:= xFilial("SC7")
	SC7->C7_TIPO		:= 2		
	SC7->C7_ITEM    	:= StrZero(1,TamSX3("C7_ITEM")[1])
	IF lGeraSA .And. cRotina $ "MATA106" .And. !Empty(SCP->CP_SOLICIT) 
		SC7->C7_USER     	:= cLogin
	Else
		SC7->C7_USER     	:= RetCodUsr() 
	EndIf
	SC7->C7_FORNECE	:= aAEs[nX,2]
	SC7->C7_LOJA		:= aAes[nX,3]
	SC7->C7_NUMSC		:= SC3->C3_NUM
	SC7->C7_ITEMSC	:= SC3->C3_ITEM
	SC7->C7_COND 		:= SC3->C3_COND
	SC7->C7_CONTATO	:= SC3->C3_CONTATO
	SC7->C7_FILENT	:= SC3->C3_FILENT
	SC7->C7_IPI		:= SC3->C3_IPI
	SC7->C7_REAJUST	:= SC3->C3_REAJUST
	SC7->C7_FRETE  	:= SC3->C3_FRETE
	SC7->C7_MOEDA		:= SC3->C3_MOEDA		
	SC7->C7_TXMOEDA	:= SC3->C3_TXMOEDA
	SC7->C7_MSG	  	:= SC3->C3_MSG
	SC7->C7_TPFRETE	:= SC3->C3_TPFRETE
	SC7->C7_OBS    	:= SC3->C3_OBS
	SC7->C7_PRODUTO	:= SC3->C3_PRODUTO
	SC7->C7_LOCAL  	:= SC3->C3_LOCAL
	SC7->C7_PRECO  	:= SC3->C3_PRECO
	SC7->C7_QUANT  	:= Round(aAEs[nX,4],TamSX3("C7_QUANT")[2])
	SC7->C7_QTDSOL	:= SC7->C7_QUANT
	SC7->C7_TOTAL  	:= Round(SC7->C7_QUANT * SC7->C7_PRECO,TamSX3("C7_TOTAL")[2])
	SC7->C7_DESCRI 	:= SB1->B1_DESC
	SC7->C7_UM			:= SB1->B1_UM
	SC7->C7_SEGUM  	:= SB1->B1_SEGUM
	SC7->C7_QTSEGUM	:= ConvUm(SB1->B1_COD,SC7->C7_QUANT,0,2)
	SC7->C7_CONTA  	:= SB1->B1_CONTA
	SC7->C7_ITEMCTA 	:= SB1->B1_ITEMCC
	SC7->C7_CLVL		:= SB1->B1_CLVL
	SC7->C7_CC 		:= SB1->B1_CC
	SC7->C7_TES		:= SB1->B1_TE	
	For nY := 1 To Len(aCTBEnt)
		If SC7->(FieldPos("C7_EC"+aCTBEnt[nX]+"CR")) > 0
			SC7->&("C7_EC"+aCTBEnt[nX]+"CR") := SB1->&("B1_EC"+aCTBEnt[nX]+"CR")
			SC7->&("C7_EC"+aCTBEnt[nX]+"DB") := SB1->&("B1_EC"+aCTBEnt[nX]+"DB")
		EndIf
	Next nY
	
	If ExistBlock("MT106APV")
		cNewGrp := ExecBlock("MT106APV",.F.,.F.)
		If ValType(cNewGrp) == "C" .And. !Empty(cNewGrp)
			SC7->C7_GRUPCOM	:= cNewGrp
		Else
			SC7->C7_GRUPCOM	:= SY1->Y1_GRUPCOM
		Endif
	Else
		SC7->C7_GRUPCOM	:= SY1->Y1_GRUPCOM	
	Endif

	SC7->C7_APROV   := If(!Empty(SY1->Y1_GRAPROV),SY1->Y1_GRAPROV,SuperGetMv("MV_PCAPROV"))
	
	If lVer116
		SC7->C7_REVISAO := Posicione("SB5",1,xFilial("SB5")+cProduto,"B5_VERSAO")
	Endif
	
	//-- Grava campos especificos da rotina que chamou
	For nY := 1 To Len(aCampos)
		If SC7->(FieldPos("C7_" +aCampos[nY,1])) > 0
			SC7->&("C7_" +aCampos[nY,1]) := aCampos[nY,2]
		EndIf
	Next nY
	
	If SC7->(FieldPos("C7_DINICOM")) > 0
		SA5->(dbSeek(xFilial("SA5")+aAEs[nX,2]+aAEs[nX,3]+cProduto))
		SC7->C7_DINICQ  := SC7->C7_DATPRF - If(Empty(SB5->B5_FPRZCQ),SB5->B5_PRZCQ,Formula(SB5->B5_FPRZCQ))
		SC7->C7_DINITRA := SC7->C7_DINICQ - SA5->A5_TEMPTRA
		SC7->C7_DINICOM := SC7->C7_DINITRA - CalcPrazo(cProduto,SC7->C7_QUANT,aAEs[nX,2],aAEs[nX,3])
	EndIf
	
	SC7->(MsUnLock())
	
	//-- Gera arquivo de controle de alcadas SCR para a AE se o MV_AEAPROV estiver ativo
	If SuperGetMV("MV_AEAPROV",.F.,.T.) .And. (cRotina # "MATA650" .Or. SuperGetMv("MV_ALCADOP",.F.,.F.))
		SCR->(DbClearFilter()) //-- Limpa o Filtro do SCR caso ele exista

		lAlcada := MaAlcDoc({SC7->C7_NUM,"AE",SC7->C7_TOTAL,,,SC7->C7_APROV,,SC7->C7_MOEDA,RecMoeda(dDataBase,SC7->C7_MOEDA),dDataBase},,1)

		//-- Efetua a gravacao do campo de controle de aprovacao C7_CONAPRO
		cChave := xFilial("SC7")+SC7->C7_NUM
		SC7->(dbSeek(cChave))
		While !SC7->(EOF()) .And. SC7->(C7_FILIAL+C7_NUM) == cChave
			RecLock("SC7",.F.)
			SC7->C7_CONAPRO := If(lAlcada,"L","B")
			SC7->(MsUnlock())
			SC7->(dbSkip())
		End
		SC7->(dbSkip(-1)) //-- Volta para processar atualizacao de saldo SB2
	EndIf
	
	//-- Se aglutina AE, procura AE do mesmo contrato com condicoes iguais
	//-- (firme/previsto, liberacao de alcada etc) em aberto para incluir item
	#IFDEF TOP
		If lAglutAe .And. TcSrvType() <> "AS/400"
			If !Empty(aCampos) .And. (nPosTpOp := aScan(aCampos,{|x| AllTrim(x[1]) == "TPOP"})) > 0
				cFilTpOp := aCampos[nPosTpOp,2]
			EndIf
			
			cQuery := "SELECT MAX(C7_NUM) AS NUMERO FROM " +RetSQLName("SC7") +" WHERE "
			cQuery += "C7_FORNECE = '" +aAEs[nX,2] +"' AND C7_LOJA = '" +aAEs[nX,3] +"' AND "
			cQuery += "C7_NUMSC = '" +SC3->C3_NUM +"' AND C7_QUJE < C7_QUANT AND C7_RESIDUO <> 'S' AND "
			If SuperGetMV("MV_TPOPDOC",.F.,.F.)
				cQuery += "CASE C7_TPOP WHEN ' ' THEN 'F' ELSE C7_TPOP END = '" +cFilTpOp +"' AND "
				If SC7->(FieldPos("C7_TPCOLAB")) > 0
					cQuery += "C7_TPCOLAB <> 'PEF' AND "
				EndIf
			EndIf
			cQuery += "CASE C7_CONAPRO WHEN ' ' THEN 'L' ELSE C7_CONAPRO END = '" +If(lAlcada,"L","B") +"' AND "
			cQuery += "D_E_L_E_T_ <> '*' AND C7_FILIAL = '" +xFilial("SC7") +"' AND C7_TIPO = 2  AND C7_NUM <> '" +SC7->C7_NUM +"'"
			cQuery := ChangeQuery(cQuery)
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),"SC7NUM",.T.,.F.)

			If !Empty(SC7NUM->NUMERO)
				cQuery := "SELECT MAX(C7_ITEM) AS ITEM FROM " +RetSQLName("SC7") +" WHERE "
				cQuery += "D_E_L_E_T_ <> '*' AND C7_FILIAL = '" +xFilial("SC7") +"' AND "
				cQuery += "C7_TIPO = 2 AND C7_NUM = '" +SC7NUM->NUMERO +"'"
				cQuery := ChangeQuery(cQuery)
				dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),"SC7ITEM",.T.,.F.)
				
				cNumAglu := SC7NUM->NUMERO
				cItemAgl := Soma1(SC7ITEM->ITEM)
				
				SC7ITEM->(dbCloseArea())
			EndIf
			SC7NUM->(dbCloseArea())
			
			//-- Troca numero para aglutinar no mesmo documento
			If !Empty(cNumAglu)
				//-- Atualiza numero do documento na SC7
				SCR->(dbSetOrder(1))
				While SCR->(dbSeek(xFilial("SCR")+"AE"+SC7->C7_NUM))
					RecLock("SCR",.F.)
					SCR->CR_DOC := cNumAglu
					SCR->(MsUnLock())
				End
				
				//-- Troca numero do pedido
				RecLock("SC7",.F.)
				SC7->C7_NUM  := cNumAglu
				SC7->C7_ITEM := cItemAgl
				SC7->(MsUnLock())
				
				//-- Volta numeracao sequencial
				RollBackSX8()
			EndIf
		EndIf
	#ENDIF
	
	//-- Tratamento especifico do TOTVS Colaboracao (o envio esta dentro da MaAlcDoc)
	//-- Se nao passou pela MaAlcDoc, forca envio
	If !(SuperGetMV("MV_AEAPROV",.F.,.T.) .And. (cRotina # "MATA650" .Or. SuperGetMv("MV_ALCADOP",.F.,.F.))) .And.;
		(SuperGetMV("MV_TPOPDOC",.F.,.F.)) .And. FindFunction("FWLSEnable") .And. FWLSEnable(TOTVS_COLAB_ONDEMAND) .And.;
		FindFunction("ExpXML_PC") .And. FindFunction("ExpXML_PE") .And. SC7->(FieldPos("C7_TPCOLAB")) > 0 .And.;
		SC7->C7_TPCOLAB <> "PEF" .And. SC7->C7_TPOP == "F"
		If Empty(SC7->C7_TPCOLAB)
			ExpXML_PC(SC7->C7_NUM)
		Else
			ExpXML_PE(SC7->C7_NUM)
		EndIf
	EndIf
		
	//-- Pontos de entrada 
	If cRotina == "MATA650" .And. ExistBlock("MT650C7")
		ExecBlock("MT650C7",.F.,.F.)
	ElseIf (cRotina == "MATA710" .Or. cRotina == "MATA712") .And. ExistBlock("M711SC7")
		MatM711SC7()
	EndIf

	//-- Atualizacao do saldo SB2
	If SB2->(dbSeek(xFilial("SB2")+SC7->(C7_PRODUTO+C7_LOCAL)))
		SB2->(GravaB2Pre("+",SC7->(C7_QUANT-C7_QUJE),SC7->C7_TPOP,(SC7->(C7_QUANT-C7_QUJE))*SC7->(C7_QTSEGUM/C7_QUANT)))
	EndIf

	// Verifica se a função foi chamada pelo MRP para atualização do objeto TREE
	If cRotina == "MATA710"
		A711CriSH5(SC7->C7_DATPRF,SC7->C7_PRODUTO,Space(80),Space(3),"SC7",SC7->(Recno()),SC7->C7_NUM,SC7->C7_ITEM,SC7->C7_OP,SC7->C7_QUANT,"2",.T.,,,.T.,,,,,,,)
	ElseIf cRotina == "MATA712"
		A712CriCZI(SC7->C7_DATPRF,SC7->C7_PRODUTO,Space(80),Space(3),"SC7",SC7->(Recno()),SC7->C7_NUM,SC7->C7_ITEM,SC7->C7_OP,SC7->C7_QUANT,"2",.T.,/*13*/,/*14*/,.F.,/*16*/,/*17*/,/*18*/,/*19*/,/*20*/,/*21*/,/*22*/,/*23*/,/*24*/,/*25*/,/*26*/)
	EndIf
		
	cNumAglu := ""
	cItemAgl := ""
	
	//---------------------
	// Atualiza retorno
	// [1]- Quant
	// [2]- Documento
	//---------------------
	aAdd(aRet,{SC7->C7_QUANT,SC7->C7_NUM})
Next nX

//-- Se nao atendeu tudo atraves de contrato, gera SC
If (SB1->B1_CONTRAT == "A" .Or. lCPGerSC) .And. nNecess > 0 .And. cRotina # "MATA181"
	//-- Ajusta inicializador do C1_NUM
	SX3->(dbSetOrder(2))
	If SX3->(dbSeek("C1_NUM")) .And. AllTrim(Upper(SX3->X3_RELACAO)) == 'GETSX8NUM("SC1")'
		RecLock("SX3",.F.)
		SX3->X3_RELACAO := 'GetNumSC1()'
		SX3->(MsUnLock())
	EndIf
	
	//-- MATA650 tem tratamento para aglutinar SC (tratado no else)
	//-- Por isso se MATA650 com aglutinacao ou MATA710 pelo MAT650 com aglutinacao
	If (cRotina == "MATA650" .And. aSav650[06] # 1) .Or.;
	  ((cRotina == "MATA710" .Or. cRotina == "MATA712") .And. Type("aSav650") == "A" .And. aSav650[06] == 2)
		If aSav650[06] == 2 // Aglutina por OP
			nX := aScan(aOpC1,{|x| x[1] == cProduto .And. x[3] == aCampos[aScan(aCampos,{|x| x[1] == "OP"}),2] .And.;
						 x[8] == .T. .And. x[9] == .F. .And. x[11] == aCampos[aScan(aCampos,{|x| x[1] == "TPOP"}),2]})

			If nX == 0
				aAdd(aOpC1,{cProduto,nNecess,aCampos[aScan(aCampos,{|x| x[1] == "OP"}),2],aCampos[aScan(aCampos,{|x| x[1] == "DATPRF"}),2],,2,nNecess,.T.,.F.,SB1->B1_LOCPAD,aCampos[aScan(aCampos,{|x| x[1] == "TPOP"}),2],.T.,{}})
				aAdd(aOpC1[Len(aOpC1)][13],)								
			Else
				If aOpC1[nX,2] < aOpC1[nX,7] + nNecess
					aOpC1[nX,2] += nNecess
				EndIf
				aOpC1[nX,7] += nNecess
				aAdd(aOpC1[nX,13],{cPV,cItemPV})													
			EndIf
		Else									// Aglutina por Data de Necessidade
			nX := aScan(aDataOpC1,{|x| x[1] == cProduto .And. x[4] == aCampos[aScan(aCampos,{|x| x[1] == "DATPRF"}),2] .And.;
						 x[8] == .T. .And. x[9] == .F. .And. x[11] == aCampos[aScan(aCampos,{|x| x[1] == "TPOP"}),2]})

			If nX == 0
				aAdd(aDataOpC1,{cProduto,nNecess,aCampos[aScan(aCampos,{|x| x[1] == "OP"}),2],aCampos[aScan(aCampos,{|x| x[1] == "DATPRF"}),2],,2,nNecess,.T.,.F.,SB1->B1_LOCPAD,aCampos[aScan(aCampos,{|x| x[1] == "TPOP"}),2],.T.,{}})
				aAdd(aDataOpC1[Len(aDataOpc1)][13], {cPV,cItemPV})								
			Else
				If aDataOpC1[nX,2] < aDataOpC1[nX,7] + nNecess
					aDataOpC1[nX,2] += nNecess
				EndIf
				aDataOpC1[nX,7] += nNecess
				If aDataOpC1[nX,3] # aCampos[aScan(aCampos,{|x| x[1] == "OP"}),2]
					aDataOpC1[nX,3] := CriaVar("C1_OP")
				EndIf
				aAdd(aDataOpC1[nX,13],{cPV,cItemPV})								
			EndIf
		EndIf	
	Else
		RecLock("SC1",.T.)
	
		//-- Inicializa os campos
		For nY := 1 To SC1->(FCount())
			SC1->&(Field(nY)) := CriaVar(SC1->(Field(nY)))
		Next nY
		
		SC1->C1_FILIAL	:= xFilial("SC1")
		SC1->C1_PRODUTO	:= cProduto
		SC1->C1_ITEM	:= StrZero(1,TamSX3("C1_ITEM")[1])
		SC1->C1_QUANT	:= nNecess
		SC1->C1_UM		:= SB1->B1_UM
		SC1->C1_LOCAL	:= SB1->B1_LOCPAD
		SC1->C1_DESCRI	:= SB1->B1_DESC
		SC1->C1_SEGUM	:= SB1->B1_SEGUM
		SC1->C1_QTSEGUM	:= ConvUm(cProduto,SC1->C1_QUANT,0,2)
		SC1->C1_IMPORT  := SB1->B1_IMPORT
		SC1->C1_COTACAO	:= If(SB1->B1_IMPORT=="S","IMPORT","")
		IF lGeraSA .And. cRotina $ "MATA106" .And. !Empty(SCP->CP_SOLICIT) 
			SC1->C1_GRUPCOM	:= MaRetComSC(SB1->B1_COD,UsrRetGrp(SCP->CP_SOLICIT),cLogin)
		Else 
			SC1->C1_GRUPCOM	:= MaRetComSC(SB1->B1_COD,UsrRetGrp(),RetCodUsr())
		EndIf
		IF lGeraSA .And. cRotina $ "MATA106" .And. !Empty(SCP->CP_SOLICIT) 
			SC1->C1_USER	:= cLogin
		Else
			SC1->C1_USER	:= RetCodUsr()
		EndIf
		SC1->C1_FORNECE	:= SB1->B1_PROC
		SC1->C1_LOJA	:= SB1->B1_LOJPROC
		IF lGeraSA .And. cRotina $ "MATA106"
			SC1->C1_SOLICIT:= SCP->CP_SOLICIT
		Else 
			SC1->C1_SOLICIT	:= UsrRetName(RetCodUsr())
		EndIf 
		SC1->C1_CC		:= SB1->B1_CC
		SC1->C1_CONTA	:= SB1->B1_CONTA
		SC1->C1_ITEMCTA	:= SB1->B1_ITEMCC
		SC1->C1_CLVL	:= SB1->B1_CLVL
		For nY := 1 To Len(aCTBEnt)
			If SC1->(FieldPos("C1_EC"+aCTBEnt[nX]+"CR")) > 0
				SC1->&("C1_EC"+aCTBEnt[nX]+"CR") := SB1->&("B1_EC"+aCTBEnt[nX]+"CR")
				SC1->&("C1_EC"+aCTBEnt[nX]+"DB") := SB1->&("B1_EC"+aCTBEnt[nX]+"DB")
			EndIf
		Next nY
		SC1->C1_QTDORIG	:= SC1->C1_QUANT
		SC1->C1_FILENT	:= xFilEnt(If(Empty(SC1->C1_FILENT),SC1->C1_FILIAL,SC1->C1_FILENT))
		SC1->C1_OBS		:= STR0104 //-- Produto sem contrato válido
		
		If lVer116
			SC1->C1_REVISAO := Posicione("SB5",1,xFilial("SB5")+cProduto,"B5_VERSAO")
		Endif
			
		//-- Grava campos especificos da rotina que chamou
		For nY := 1 To Len(aCampos)
			If aCampos[nY,1] # "NUM" .And. SC1->(FieldPos("C1_" +aCampos[nY,1])) > 0
				SC1->&("C1_" +aCampos[nY,1]) := aCampos[nY,2]
			EndIf
		Next nY
		
		SC1->(MsUnlock())
		
		If cRotina $ "MATA106" .And. ExistBlock("MT106SC1")
			Execblock("MT106SC1",.f.,.f.,{"SC1",SC1->C1_NUM,SC1->C1_ITEM,SC1->(Recno())})
		EndIf
		
		//Atualização do Saldo SB2
		If SB2->(dbSeek(xFilial("SB2")+SC1->(C1_PRODUTO+C1_LOCAL)))
			SB2->(GravaB2Pre("+",SC1->(C1_QUANT-C1_QUJE),SC1->C1_TPOP,(SC1->(C1_QUANT-C1_QUJE))*SC1->(C1_QTSEGUM/C1_QUANT)))
		EndIf
		
		// Verifica se a função foi chamada pelo MRP para atualização do objeto TREE
		If cRotina == "MATA710"
			A711CriSH5(SC1->C1_DATPRF,SC1->C1_PRODUTO,Space(80),Space(3),"SC1",SC1->(Recno()),SC1->C1_NUM,SC1->C1_ITEM,SC1->C1_OP,SC1->C1_QUANT,"2",.T.,,,.T.,,,,,,,)
		ElseIf cRotina == "MATA712"
			A712CriCZI(SC1->C1_DATPRF,SC1->C1_PRODUTO,Space(80),Space(3),"SC1",SC1->(Recno()),SC1->C1_NUM,SC1->C1_ITEM,SC1->C1_OP,SC1->C1_QUANT,"2",.T.,/*13*/,/*14*/,.F.,/*16*/,/*17*/,/*18*/,/*19*/,/*20*/,/*21*/,/*22*/,/*23*/,/*24*/,/*25*/,/*26*/)
		EndIf
			
	EndIf
EndIf 

End Transaction

Return aRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MAAtuField   ?Autor ?Andrews Egas      	?Data ?07/11/12 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Verifica a ordem na SX3 dos campos passados como parametro     ³±?
±±?		 ?e retorna .T. se o campo secundario (que pode ser              ³±?
±±?		 ?automaticamente preenchido de acordo com o primario) devera    ³±?
±±?		 ?ser automaticamente preenchido . 							  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?cCamPri: Campo primario.     								  ³±?
±±?         ?cCamSec: Campo secundario (pode ser automaticamente preenchido ³±?
±±?         ?	 de acordo com o primario)									  ³±?
±±?         ?cContSec: Conteudo do campo secundario.						  ³±?
±±?         ?cTab: Tabela corrente de acordo com os campos Param1 e Param2. ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?Generico                                                  	  ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Function MAAtuField(cCamPri,cCamSec, cContSec, cTab)
Local aArea	:= {}
Local nOrdPri	:= 0 //Armazena a ordem do campo Primario
Local nOrdSec	:= 0 //Armazena a ordem do campo Secundario  
Local lRet 		:= .F.
aArea := GetArea()
dbSelectArea("SX3")
dbSetOrder(1)
MsSeek(cTab)
While !Eof()
	do Case
		Case (Trim(SX3->X3_CAMPO) == cCamPri) 
			nOrdPri :=	VAL(Trim(SX3->X3_ORDEM))				
		Case (Trim(SX3->X3_CAMPO) == cCamSec)
			nOrdSec := VAL(Trim(SX3->X3_ORDEM)) 	
	EndCase
	
	If(nOrdPri > 0 .And. nOrdSec > 0)
		Exit
	Endif
	
	dbSelectArea("SX3")
	dbSkip()
EndDo
RestArea(aArea)   

If nOrdSec < nOrdPri
	if Trim(cContSec) == "" .And. GetMv("MV_ATUBRA",,.F.)
		lRet :=.T.
	Endif
Else
	lRet := .T.
Endif	

Return lRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³MatM711SC7ºAutor  ?Andre Anjos        ?Data ? 27/11/12   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Funcao de compatibilizacao do ponto de entrada M711SC7     º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?COMXFUN                                                    º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Static Function MatM711SC7()
Local aRetPE	 := {}
Local aCampos 	 := {}
Local lValid     := .T.
Local nX	  	 := 0
Local nRecnoC7	 := SC7->(Recno())
Local aCamposMRP := {	"C7_PRODUTO","C7_QUANT","C7_QTDSOL","C7_UM","C7_QTSEGUM","C7_PRECO","C7_TOTAL","C7_NUMSC",;
						"C7_ITEMSC","C7_IPI","C7_REAJUST","C7_FRETE","C7_DATPRF","C7_LOCAL","C7_MSG","C7_TPFRETE",;
						"C7_OBS","C7_CONTA","C7_CC","C7_DESCRI","C7_SEQMRP","C7_TPOP","C7_DINICOM","C7_DINITRA",;
						"C7_DINICQ","C7_REVISAO"	}

For nX := 1 To SC7->(FCount())
	If aScan(aCamposMRP,{|x| SC7->(FieldName(nX))}) > 0
		aAdd(aCampos,{SC7->(FieldName(nX)),SC7->(FieldGet(nX)),NIL})
	EndIf
Next nX

aCampos := ExecBlock("M711SC7",.F.,.F.,aClone(aCampos))

If ValType(aRetPE) == "A"
	aEval(aCampos,{|x| lValid := lValid .And. CheckSX3(x[1],x[2])})
	If lValid
		SC7->(msGoTo(nRecnoC7))
		RecLock("SC7",.F.)
		For nX := 1 To Len(aCampos)
			SC7->(FieldPut(nX,aCampos[nX,2]))
		Next nX
		SC7->(MsUnLock())
	EndIf
EndIf

Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³MAComCent ºAutor  ³Andre Anjos		 ?Data ? 07/01/13   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Funcao para realizacao da transferencia de solicitacoes de º±?
±±?    	 ?compra entre filiais para processo de compra compartilhada.º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?MATA110, MATA130 e GCPA002                                 º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function MAComCent()
Local aAreaSM0	:= SM0->(GetArea())
Local aAreaSC1	:= SC1->(GetArea())
Local lRet		:= .T.
Local oDlg 	 	:= NIL
Local oCombo 	:= NIL
Local oBrowse	:= NIL
Local oFWFilter := NIL
Local oOk		:= LoadBitmap(GetResources(),"LBOK")
Local oNo		:= LoadBitmap(GetResources(),"LBNO")
Local cCombo 	:= ""
Local cFiltro	:= ""
Local cProg		:= AllTrim(FunName())
Local cFiltSC1  := SC1->(dbFilter())
Local aFilCent 	:= {}
Local aDados    := {}
Local aColunas  := {}
Local bLine		:= NIL
Local aColAdic 	:= {} //Colunas adicionais passadas atraves do ponto de entrada MT110COMC
Local nX			:= 0
Local nY			:= 0

//Ponto de entrada utilizado para adicionar colunas a tela de compras centralizadas
If ExistBlock("MT110COMC")
	aColAdic := ExecBlock("MT110COMC",.f.,.f.)
Endif

SM0->(dbSetOrder(1))
SM0->(dbSeek(cEmpAnt))
While SM0->(!EOF()) .And. SM0->M0_CODIGO == cEmpAnt
	If cProg # "MATA110" .And. FWCodFil() == cFilAnt
		aAdd(aFilCent,FWCodFil() +" - " +AllTrim(SM0->M0_FILIAL))
		Exit
	ElseIf cProg == "MATA110" .And. PadR(FWCodFil(),Len(AllTrim(SC1->C1_FILIAL))) <> AllTrim(SC1->C1_FILIAL)
		aAdd(aFilCent,FWCodFil() +" - " +AllTrim(SM0->M0_FILIAL))
	EndIf
	SM0->(dbSkip())
End
SM0->(RestArea(aAreaSM0))

//-- Adiciona itens que se pode transferir
If cProg == "MATA110"
	cFiltro := SC1->(C1_FILIAL+C1_NUM)
	SC1->(dbSetOrder(1))
	SC1->(dbSeek(cFiltro))
	nX := 1
	While !SC1->(EOF()) .And. SC1->(C1_FILIAL+C1_NUM) == cFiltro
		If MaCanCenSC("SC1",.T.)
			SC1->(aAdd(aDados,{.F.,C1_FILIAL,C1_NUM,C1_SOLICIT,C1_EMISSAO,C1_ITEM,C1_PRODUTO,Transform(C1_QUANT,PesqPict("SC1","C1_QUANT")),C1_DATPRF}))
			If !Empty(aColAdic) //Colunas adicionais passadas atraves do PE MT110COMC
				For nY := 1 To Len(aColAdic)
					SC1->(aAdd(aDados[nX], &(aColAdic[nY])))
				Next nY
				nX++
			EndIf
		EndIf
		SC1->(dbSkip())
	End
	aSort(aDados,,,{|x,y| x[2]+x[3]+x[6]+x[7] < y[2]+y[3]+y[6]+y[7]})
Else
	//-- Limpa o filtro do Browse para transferencia de filiais
	SC1->(dbClearFilter())

	//-- Campos que irao para o filtro
	SX3->(dbSetOrder(1))
	SX3->(dbSeek("SC1"))
	While !SX3->(EOF()) .And. SX3->X3_ARQUIVO == "SC1"
		If (X3Uso(SX3->X3_USADO) .And. cNivel >= SX3->X3_NIVEL) .Or. AllTrim(SX3->X3_CAMPO) == "C1_FILIAL"
			aAdd(aColunas,{ AllTrim(SX3->X3_CAMPO),AllTrim(X3Titulo()),SX3->X3_TIPO,SX3->X3_TAMANHO,SX3->X3_DECIMAL,;
							SX3->X3_PICTURE,Str2Arr(SX3->X3_CBOX,";"),SX3->X3_F3})
		EndIf                                
		SX3->(dbSkip())
	End
	
	oFWFilter := FWFilter():New(GetWndDefault())
	oFWFilter:SetSQLFilter()
	oFWFilter:DisableValid()
	oFWFilter:SetField(aColunas)
	oFWFilter:SetProfileID("MAComCent")
	If (lRet := oFWFilter:FilterBar())		
		cFiltro := "%AND "
		cFiltro += AllTrim(oFwFilter:GetExprSQL())
		If !(cFiltro == "%AND ")
			cFiltro += " AND "
		EndIf
		If SC1->(FieldPos("C1_TPSC")) > 0
			cFiltro += "CASE C1_TPSC WHEN ' ' THEN '1' ELSE C1_TPSC END = '" +If(cProg == "GCPA002" .Or. cProg == "GCPA200" ,"2","1") +"'"
		EndIf
		cFiltro += "%" 

	  	BeginSQL Alias "TMP"		
			SELECT SC1.*
			FROM %Table:SC1% SC1
			JOIN %Table:SB1% SB1 ON
				SB1.%NotDel% AND
				SB1.B1_FILIAL = %xFilial:SB1% AND
				SB1.B1_COD = SC1.C1_PRODUTO					
			WHERE SC1.C1_FILIAL <> %xFilial:SC1% AND 
				SC1.%NotDel% AND SC1.C1_QUJE < SC1.C1_QUANT AND
				SC1.C1_TPOP <> 'P' AND SC1.C1_APROV IN (' ','L') AND SC1.C1_RESIDUO = ' ' AND 
				SC1.C1_COTACAO = ' ' AND SC1.C1_ORIGEM <> 'TRM' AND SC1.C1_IMPORT <> 'S' AND
				SC1.C1_SCORI = ' '
				%Exp:cFiltro%
			ORDER BY SC1.C1_FILIAL, SC1.C1_NUM, SC1.C1_ITEM, SC1.C1_PRODUTO
		EndSQL
				    
		nX := 1		    
		While TMP->(!EOF())	
			TMP->(aAdd(aDados,{.F.,C1_FILIAL,C1_NUM,C1_SOLICIT,SToD(C1_EMISSAO),C1_ITEM,C1_PRODUTO,Transform(C1_QUANT,PesqPict("SC1","C1_QUANT")),SToD(C1_DATPRF)}))
			If !Empty(aColAdic) //Colunas adicionais passadas atraves do PE MT110COMC
				For nY := 1 To Len(aColAdic)
					TMP->(aAdd(aDados[nX], &(aColAdic[nY])))
				Next nY
				nX++
			EndIf
			TMP->(dbSkip())
		End
		TMP->(dbCloseArea())
		dbSelectArea("SC1")
	EndIf
EndIf

If lRet
	If !Empty(aDados)
		lRet := .F.
		DEFINE MSDIALOG oDlg FROM 0,0 TO 540,720 TITLE STR0107 PIXEL	//-- Compra Centralizada
		TSay():Create(oDlg,{|| STR0108},05,05,,,,,,.T.) //-- Empresa centralizadora:
		cCombo := aFilCent[1]
		oCombo := TComboBox():Create(oDlg,{|u|if(PCount()>0,cCombo:=u,cCombo)},15,05,aFilCent,350,20,,{||},,,,.T.,,,,{|| cProg == "MATA110"},,,,,'cCombo')
		
		aColunas := {"",RetTitle("C1_FILIAL"),RetTitle("C1_NUM"),RetTitle("C1_SOLICIT"),RetTitle("C1_EMISSAO"),RetTitle("C1_ITEM"),;
		 				RetTitle("C1_PRODUTO"),RetTitle("C1_QUANT"),RetTitle("C1_DATPRF")} 
		 								
		If !Empty(aColAdic) //Colunas adicionais passadas atraves do PE MT110COMC
		 	For nY := 1 To Len(aColAdic)
				aAdd(aColunas, RetTitle(aColAdic[nY]))
			Next nY
		EndIf
		
		TSay():Create(oDlg,{|| STR0109},30,05,,,,,,.T.) //-- Selecione os itens que serão comprados pela empresa centralizadora:
		oBrowse := TWBrowse():New(40,05,350,200,,aColunas,,oDlg,,,,,{|| ComCentMar(@oBrowse,cCombo,cProg=="MATA110",.F.)},,,,,,,,,.T.)
		oBrowse:SetArray(aDados)
		oBrowse:bLine := {|| ACCLine(oBrowse:nAt, aDados)}
		oBrowse:bHeaderClick := {|x,y| If(y == 1,ComCentMar(@oBrowse,cCombo,cProg=="MATA110",.T.),Nil)}	
		
		TButton():Create(oDlg,250,250,STR0087,{|| If(MsgYesNo(STR0111 +cCombo +STR0112),(lRet := .T., oDlg:End()),NIL)},50,10,,,,.T.)	//-- Confirmar // //-- Após esta ação, os itens selecionados serão transferidos para a empresa ##. Confirma esta operação?
		TButton():Create(oDlg,250,300,STR0110,{|| oDlg:End()},50,10,,,,.T.)	//-- Cancelar
		ACTIVATE MSDIALOG oDlg CENTERED
		
		//-- Processa transferecia das solicitacoes e elima scs origem
		If lRet
			Processa({|| MAPComCent(PadR(cCombo,FWSizeFilial()),aDados)})
		EndIf
	Else
		Help(" ",1,"RECNO")
	EndIf
EndIf

dbSelectArea("SC1")
Set Filter To &(cFiltSC1)

RestArea(aAreaSC1)
Return lRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ?ACCLine  ºAutor  ?Jose Delmondes  	?Data ? 02/09/2013 º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Atualizacao do bLine da funcao MaConCent                   º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function ACCLine(nAt, aDados)
Local oOk		:= LoadBitmap(GetResources(),"LBOK")
Local oNo		:= LoadBitmap(GetResources(),"LBNO")
Local aLine	:= {}
Local nX		:= 0

aLine := {If(aDados[nAt,1],oOk,oNo)}
		   			
For nX := 2 To Len(aDados[nAt])
	aAdd(aLine, aDados[nAt,nX])
Next nX

Return aLine
  

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³MAPComCentºAutor  ?Andre Anjos 		 ?Data ? 07/01/13   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Funcao de processamento da transferencia para compra cent. º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºParametros?cFilCen: codigo da empresa centralizadora.				  º±?
±±?		 ?aDados: array com os itens de SC selecionados para transf. º±?
±±ºÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄº±?
±±ºUso       ?MATA110                                                    º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Function MAPComCent(cFilCen,aDados,aSCComCe)
Local cFilBkp	:= cFilAnt
Local cFiltro	:= ""
Local cQuebra   := ""
Local cNumSC	:= ""
Local cNewGrp	:= ""
Local nX		:= 0
Local nPos		:= 0
Local nStack    := GetSX8Len()
Local aCamposMR := {}
Local aAreaSM0	:= SM0->(GetArea())
Local lPrjCni 	:= FindFunction("ValidaCNI") .And. ValidaCNI()

DEFAULT aSCComCe   := {} //Contém solicitações geradas pelo compra centralizada

//-- Processa somente se marcou algo
If aScan(aDados,{|x| x[1]}) > 0
	cFiltro := "%"
	For nX := 1 To Len(aDados)
		If aDados[nX,1]
			cFiltro += "'" +aDados[nX,2]+aDados[nX,3]+aDados[nX,6]+aDados[nX,7] +"',"
		EndIf
	Next nX
	cFiltro := PadR(cFiltro,Len(cFiltro)-1) +"%"

	BeginSQL Alias "SC1TMP"
		SELECT *
		FROM %Table:SC1%
		WHERE %NotDel% AND
			C1_FILIAL||C1_NUM||C1_ITEM||C1_PRODUTO IN (%Exp:cFiltro%)
		ORDER BY C1_FILENT, C1_USER, C1_NUM, C1_ITEM, C1_PRODUTO
	EndSQL
	
	//-- Conta registros para ProcRegua
	nX := 0
	SC1TMP->(dbEval({|| nX++}))
	ProcRegua(nX)
	
	SX3->(dbSetOrder(2))
	For nX := 1 To SC1->(FCount())
		SX3->(dbSeek(SC1->(FieldName(nX))))
		If SX3->X3_TIPO == "M" .And. SX3->X3_CONTEXT == "R"
			aAdd(aCamposMR,{SC1->(FieldName(nX)),NIL})
		EndIf
		TCSetField("SC1TMP",SC1->(FieldName(nX)),ValType(SC1->&(FieldName(nX))),TamSX3(SC1->(FieldName(nX)))[1],TamSX3(SC1->(FieldName(nX)))[2])
    Next nX

	Begin Transaction
	
	SC1TMP->(dbGoTop())
	While !SC1TMP->(EOF())
		cQuebra := SC1TMP->(C1_FILENT+C1_USER)
		cNumSC  := ""
		cNewGrp := ""
		cItem	:= StrZero(1,TamSX3("C1_ITEM")[1])

		While !SC1TMP->(EOF()) .And. cQuebra == SC1TMP->(C1_FILENT+C1_USER)
			IncProc()			
			SC1->(msGoTo(SC1TMP->R_E_C_N_O_))
			
			//-- Guarda conteudo de campos memos reais, pois nao vem na query
			aEval(@aCamposMR,{|x| x[2] := SC1->&(x[1])})

			 //-- Verifica novamente para evitar que a SC tenha sido manipulada
			 //-- enquanto a tela estava aberta
			If MaCanCenSC("SC1",.F.)
				//-- Elimina residuo da SC origem
				MaAvalSC("SC1",2)
				RecLock("SC1",.F.)
				SC1->C1_QTDORIG := C1_QUANT
				SC1->C1_QUANT   := C1_QUJE
				SC1->C1_RESIDUO := "S"
				SC1->C1_COMPRAC := "1"
				SC1->(MsUnlock())
	            LancaPCO("SC7",'000056','01','MATA235')
	            
	            //-- Gera nova SC na empresa centralizadora
	            SM0->(dbSetOrder(1))
	            SM0->(dbSeek(cEmpAnt+AllTrim(cFilCen)))
	            cFilAnt := FWCodFil()
	            
	            If Empty(cNumSC)
	            	cNumSC  := CriaVar("C1_NUM",.T.)

					//-- Verifica se o usuario solicitante tem grupo de compras responsavel na empresa destino
					If Empty(cNewGrp := MaRetComSC(SC1->C1_PRODUTO,UsrRetGrp(SC1->C1_USER),SC1->C1_USER))
						//-- Caso nao tenha, ve se o usuario que esta transferindo eh comprador tem algum grupo de compras
						aGrupos := UsrGrComp(RetCodUsr())
						If !Empty(aGrupos)
							cNewGrp := aGrupos[1]
						EndIf
					EndIf
				EndIf
	            
	            RecLock("SC1",.T.)
	            For nX := 1 To SC1->(FCount())
	            	If Empty((nPos := aScan(aCamposMR,{|x| x[1] == SC1->(FieldName(nX))})))
	            		SC1->&(FieldName(nX)) := SC1TMP->&(SC1->(FieldName(nX)))
	            	Else
	            		SC1->&(FieldName(nX)) := aCamposMR[nPos,2]
	            	EndIf
	            Next nX
	            SC1->C1_FILIAL	:= xFilial("SC1",cFilCen)
	            SC1->C1_NUM		:= cNumSC
	            SC1->C1_ITEM	:= cItem
	            SC1->C1_FISCORI	:= SC1TMP->C1_FILIAL
	            SC1->C1_SCORI	:= SC1TMP->C1_NUM
	            SC1->C1_ITSCORI	:= SC1TMP->C1_ITEM
	            SC1->C1_GRUPCOM	:= cNewGrp
	            SC1->(MsUnLock())
	            MaAvalSC("SC1",1)

	            aAdd( aSCComCe , { cNumSC , cItem , SC1->C1_FISCORI , SC1->C1_SCORI , SC1->C1_ITSCORI } )

	            cItem := Soma1(cItem)
	            
       			//-- Confirma os inicializadores padroes com GetSxeNum
				While GetSX8Len() > nStack 
					RollBackSX8()
				EndDo
				
				//Rodrigo Guerato - FSW - Inclusão dos logs de SC
				If lPrjCni
					//-- Log de Inclusão na Filia de Destino
					COMA080(SC1->C1_NUM,SC1->C1_ITEM,"COI",{},"COI_DTHSOL","COI_USOL",/*lEstorno*/,/*cUser*/,"COI_DOCSC",SC1->C1_NUM)

					SM0->(dbSeek(cEmpAnt+AllTrim(SC1TMP->C1_FILIAL)))
					cFilAnt := FWCodFil()
				
					//-- Log de transferencia na filial de Origem
					COMA080(SC1TMP->C1_NUM,SC1TMP->C1_ITEM,"COI",{},"COI_DTHTRA","COI_UTRA",/*lEstorno*/,/*cUser*/,"COI_DOCTRA",cNumSC,SC1->C1_ITEM,cFilCen)
				EndIf

				SM0->(RestArea(aAreaSM0))
				cFilAnt := cFilBkp
			EndIf
			SC1TMP->(dbSkip())
		End
	End
	
	End Transaction	
	
	SC1TMP->(dbCloseArea())
EndIf

Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ?LancaPCO ºAutor  ?Andre Anjos		 ?Data ? 07/01/13   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Encapsulamento da PCODetLan para tratar o novo parametro   º±?
±±?         ?MV_CFILPCO.                                                º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Static Function LancaPCO(cAlias,cProcesso,cItem,cPrograma,lDeleta)
Local aArea		:= GetArea()
Local aAreaSM0  := SM0->(GetArea())
Local lPCOFilen := SuperGetMV("MV_CFILPCO",.F.,.F.)
Local cFilBkp	:= cFilAnt
Local cFilEnt	:= AllTrim((cAlias)->&(Substr(cAlias,2,2)+"_FILENT"))

Default lDeleta := .F.

If lPCOFilen
	SM0->(dbSetOrder(1))
	SM0->(dbSeek(cEmpAnt+cFilEnt))
	cFilAnt := FWCodFil()
EndIf

PcoDetLan(cProcesso,cItem,cPrograma,lDeleta)

SM0->(RestArea(aAreaSM0))
cFilAnt := cFilBkp
RestArea(aArea)
Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ?LancaCTB ºAutor  ?Andre Anjos		 ?Data ? 07/01/13   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Encapsulamento da DetProva pra tratar novo conceito de     º±?
±±?         ?compra centralizada.                                       º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Static Function LancaCTB(bCtbOnLine,nEvento)
Local aArea    := GetArea()
Local aAreaSM0 := SM0->(GetArea())
Local cFilBkp  := cFilAnt

//-- Verifica se e originado de compra centralizada,
//-- Se sim troca empresa para execucao do lancamento
SC1->(dbSetOrder(6))
If SC1->(FieldPos("C1_SCORI")) > 0 .And. SC1->(dbSeek(xFilial("SC1")+SC7->(C7_NUM+C7_ITEM+C7_PRODUTO))) .And. !Empty(SC1->C1_SCORI)
	SM0->(dbSetOrder(1))
	SM0->(dbSeek(cEmpAnt+AllTrim(SC1->C1_FILENT)))
	cFilAnt := FWCodFil()
EndIf

Eval(bCtbOnLine,nEvento)

SM0->(RestArea(aAreaSM0))
cFilAnt := cFilBkp
RestArea(aArea)
Return

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³MaCanCenSC?Autor ?Andre Anjos			?Data ?8/01/2013 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ?Esta rotina tem como objetivo verificar se a solicitacao de ³±?
±±?         ?compra pode ser centralizada sem maiores problemas para a   ³±?
±±?         ?integridade do sistema                                      ³±?
±±?         ?IMPORTANTE: Ao atualizar esta funcao, compatibilizar filtros³±?
±±?         ?na funcao MAComCent.										   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ?ExpL1 := MaCanCenSC(ExpC1,ExpN1)							   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros?ExpC1: Alias da tabela da solicitacao de compra             ³±?
±±?         ?ExpL2: Indica se deve validar o cadastor de solicitantes.   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ?ExpL1: .T. - Se a solicitacao pode ser centralizada         ³±?
±±?         ?       .F. - Se a solicitacao NAO pode ser centralizada     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?Materiais                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function MaCanCenSC(cAliasSC1,lVerPerm)
Local lRetorno := .T.

If (SubStr((cAliasSC1)->C1_TX,1,1) == "R" .And. SubStr((cAliasSC1)->C1_TX,2,1) <> " ") .Or.; //-- Transmitida
	(cAliasSC1)->C1_QUJE >= (cAliasSC1)->C1_QUANT .Or.;									//-- Encerrada (recebida ou residuo)
	!Empty((cAliasSC1)->C1_COTACAO) .Or.;													//-- Em cotacao
	(cAliasSC1)->C1_TPOP == "P" .Or.;														//-- Prevista
	(cAliasSC1)->C1_IMPORT == "S" .Or.;													//-- Item importado (SI)
	!((cAliasSC1)->C1_APROV $ " ,L") .Or.;													//-- Nao aprovada
	AllTrim((cAliasSC1)->C1_ORIGEM) == "TRM" .Or.;											//-- Originada por TRM
	!Empty((cAliasSC1)->C1_SCORI)															//-- Solicitacao gerada por centralizacao

	lRetorno := .F.
EndIf

If lRetorno .And. lVerPerm .And. SuperGetMv("MV_RESTSOL") == "S" //-- Avalia se o usuario tem permissao de solicitante
	SB1->(dbSetOrder(1))
	If SB1->(dbSeek(xFilial("SB1")+SC1->C1_PRODUTO)) .And. SB1->B1_SOLICIT =="S" .And.;
			!A110Restr((cAliasSC1)->C1_PRODUTO,UsrRetGrp(),RetCodUsr(),lHelp)
		lRetorno := .F.
	EndIf
EndIf

Return(lRetorno)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³ComCentMarºAutor  ?Andre Anjos        ?Data ? 15/01/13   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Funcao de marcacao de registros da tela de compra centrali º±?
±±?         ?zada (para validar quando produto nao existente na empresa º±?
±±?         ?centralizadora).											  º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?MAComCent                                                  º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Static Function ComCentMar(oBrowse,cCombo,lVldProd,lTodos)
Local nX       := 0
Local nPRODUTO := aScan(oBrowse:aHeaders,{|x| x == RetTitle("C1_PRODUTO")})
Local aAreaSB1 := SB1->(GetArea())
Local cFilSB1  := xFilial("SB1",PadR(cCombo,FWSizeFilial()))

SB1->(dbSetOrder(1))

If lTodos
	For nX := 1 To Len(oBrowse:aArray)
		If !lVldProd .Or. oBrowse:aArray[nX,1] .Or. SB1->(dbSeek(cFilSB1+oBrowse:aArray[oBrowse:nAt,nPRODUTO]))
			oBrowse:aArray[nX,1] := !oBrowse:aArray[nX,1]
		EndIf
	Next nX
Else
	If oBrowse:aArray[oBrowse:nAt,1] .Or. SB1->(dbSeek(cFilSB1+oBrowse:aArray[oBrowse:nAt,nPRODUTO]))
		oBrowse:aArray[oBrowse:nAt,1] := !oBrowse:aArray[oBrowse:nAt,1]
	Else
		Aviso(STR0014,STR0113 +AllTrim(cCombo) +STR0114,{"OK"}) //-- Este item não poder?ser comprado pela empresa ### pois não faz parte de seu cadastro de produtos.
	EndIf
EndIf

oBrowse:Refresh()

SB1->(RestArea(aAreaSB1))
Return
                  
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³CotGeraSCHºAutor  ?Cleber Maldonado	 ?Data ? 15/01/13   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Funcao de marcacao de registros da tela de compra centrali º±?
±±?         ?zada (para validar quando produto nao existente na empresa º±?
±±?         ?centralizadora).											  º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºParametros?cFilOri: codigo da filial de origem do processo de compra. º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso     	 ?MaAvalCot                                                  º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Static Function CotGeraSCH(cFilOri)
Local nX		:= 0
Local nY		:= 0
Local nTotSCH	:= 0
Local aSCs		:= {}
Local cItemCH	:= StrZero(0,TamSX3("CH_ITEM")[1])
Local cFilSC1 := ""
Local aCTBEnt	:= If(FindFunction("CTBEntArr"),CTBEntArr(),{})
Local lCotRatP  := SuperGetMv("MV_COTRATP",.F.,.F.)
Local lHasSCX	:= .F.

If AliasInDic("SCH")    
	SC1->(dbSetOrder(5))
	SC1->(dbSeek(xFilial("SC1",cFilOri)+SC8->(C8_NUM+C8_PRODUTO+C8_ITEM)))
	cFilSC1 := IIF(Empty(SC1->C1_FILIAL),SC1->C1_FILENT,SC1->C1_FILIAL)
	While !SC1->(EOF()) .And. cFilSC1 == xFilial("SC8",cFilOri) .And. SC1->(C1_COTACAO+C1_PRODUTO+C1_IDENT) == SC8->(C8_NUM+C8_PRODUTO+C8_ITEM)
		If AliasInDic("SCX")
			SCX->(dbSetOrder(1))
			lHasSCX := SCX->(dbSeek(xFilial("SCX",cFilOri)+SC1->(C1_NUM+C1_ITEM)))
			While SCX->(!EOF()) .And. SCX->(CX_FILIAL+CX_SOLICIT+CX_ITEMSOL) == xFilial("SCX",cFilOri)+SC1->(C1_NUM+C1_ITEM)			
				If (nX := aScan(aSCs,{|x| ChaveSCH(1,aCTBEnt,x,"SCX")})) == 0
					ChaveSCH(2,aCTBEnt,aSCs,"SCX")
					nX := Len(aSCs)
				Else
					aTail(aSCs[nX]) += Round((((SC1->C1_QUANT*100)/SC7->C7_QUANT)*SCX->CX_PERC)/100,2)
				Endif
				
				//-- Totaliza rateio da SCH
				nTotSCH += aTail(aSCs[nX])
				
				SCX->(dbSkip())
			End
		EndIf
		
		//-- Caso nao tenha SCX, gera rateio com os dados da SC1
		If !lHasSCX .And. lCotRatP
			If (nX := aScan(aSCs,{|x| ChaveSCH(1,aCTBEnt,x,"SC1")})) == 0
				ChaveSCH(2,aCTBEnt,aSCs,"SC1")
				nX := Len(aSCs)
			Else
				aTail(aSCs[nX]) += Round((SC1->C1_QUANT / SC8->C8_QUANT) * 100,TamSX3("CH_PERC")[1])
			Endif
			
			//-- Totaliza rateio da SCH
			nTotSCH += aTail(aSCs[nX])
		EndIf
		
		SC1->(dbSkip())
	End
	  
  	//-- So gera rateio quando ha mais de uma quebra contabil
  	If Len(aSCs) >= 1
  		//-- Caso o arredondamento tenha dado diferenca (ate 0,05), ajusta no ultimo item
		If (Abs(nTotSCH - 100) > 0 .And. (nTotSCH - 100) < 0.05) .Or.;
							(Abs(nTotSCH - 100) < 0 .And. (nTotSCH - 100) > 0.05)
			aTail(aTail(aSCs)) -= nTotSCH - 100
			nTotSCH -= nTotSCH - 100
		EndIf
		
		//-- Grava dados dos rateios
		For nX := 1 To Len(aSCs)     
			cItemCH := Soma1(cItemCH)	
			RecLock("SCH",.T.)
			SCH->CH_FILIAL	:= xFilial("SCH")
			SCH->CH_PEDIDO  := SC7->C7_NUM
			SCH->CH_FORNECE := SC7->C7_FORNECE
			SCH->CH_LOJA 	:= SC7->C7_LOJA
			SCH->CH_ITEMPD 	:= SC7->C7_ITEM
			SCH->CH_ITEM 	:= cItemCH
			SCH->CH_CC 		:= aSCs[nX,1]
			SCH->CH_CONTA 	:= aSCs[nX,2]
			SCH->CH_ITEMCTA	:= aSCs[nX,3]
			SCH->CH_CLVL	:= aSCs[nX,4]
			SCH->CH_PERC 	:= aTail(aSCs[nX])
			//-- Grava entidades contabeis
			For nY := 1 To Len(aCTBEnt)
				If SCH->(FieldPos("CH_EC"+aCTBEnt[nY]+"CR")) > 0 .And. SC1->(FieldPos("C1_EC"+aCTBEnt[nY]+"CR")) > 0
					SCH->&("CH_EC"+aCTBEnt[nY]+"CR") := aSCs[nX,nY+4]
					SCH->&("CH_EC"+aCTBEnt[nY]+"DB") := aSCs[nX,nY+5]
				EndIf
			Next nY
			SCH->(MsUnlock())
		Next nX
		
		//-- Gera linha de rateio em branco para a sobra
		If nTotSCH <> 100
			cItemCH := Soma1(cItemCH)
			RecLock("SCH",.T.)
			SCH->CH_FILIAL	:= xFilial("SCH")
			SCH->CH_PEDIDO  := SC7->C7_NUM
			SCH->CH_FORNECE := SC7->C7_FORNECE
			SCH->CH_LOJA 	:= SC7->C7_LOJA
			SCH->CH_ITEMPD 	:= SC7->C7_ITEM
			SCH->CH_ITEM 	:= cItemCH
			SCH->CH_PERC 	:= 100 - nTotSCH
			SCH->(MsUnlock())
		EndIf
		
		//-- Limpa campos da SC7, ja que ha rateio
		SC7->C7_RATEIO 	:= '1'
		SC7->C7_CC		:= CriaVar("C7_CC",.F.)
		SC7->C7_CONTA	:= CriaVar("C7_CONTA",.F.)
		SC7->C7_ITEMCTA	:= CriaVar("C7_ITEMCTA",.F.)
		SC7->C7_CLVL	:= CriaVar("C7_CLVL",.F.)
		For nX := 1 To Len(aCTBEnt)
			If SC7->(FieldPos("C7_EC"+aCTBEnt[nX]+"CR")) > 0
				SC7->&("C7_EC"+aCTBEnt[nX]+"CR") := CriaVar("C7_EC"+aCTBEnt[nX]+"CR",.F.)
				SC7->&("C7_EC"+aCTBEnt[nX]+"DB") := CriaVar("C7_EC"+aCTBEnt[nX]+"DB",.F.)
			EndIf
		Next nX
	EndIf
EndIf

Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºPrograma  ³ChaveSCH  ºAutor  ?Andre Anjos		 ?Data ? 15/03/13   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescricao ?Faz busca ou inclui item no array de SCs.                  º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?CotGeraSCH                                                 º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
*/
Static Function ChaveSCH(nEvento,aCTBEnt,aSC,cAlias)
Local lRet 	  := .F.
Local nX   	  := 0
Local cPrefix := Substr(cAlias,2,2)+"_"

//-- Buscao no array aSCs (aScan)
If nEvento == 1
	If (lRet := aSC[1]+aSC[2]+aSC[3]+aSC[4] == (cAlias)->&(cPrefix+"CC+"+cPrefix+"CONTA+"+cPrefix+"ITEMCTA+"+cPrefix+"CLVL"))
		For nX := 1 To Len(aCTBEnt)
			If !(lRet := aSC[nX+4]+aSC[nX+5] == (cAlias)->&(cPrefix+"EC"+aCTBEnt[nX]+"CR")+(cAlias)->&(cPrefix+"EC"+aCTBEnt[nX]+"DB"))
				Exit
			EndIf
		Next nX
	EndIf
//-- Inclui no array aSCs (aAdd)
ElseIf nEvento == 2
	aAdd(aSC,Array(4 + (Len(aCTBEnt) * 2) + 1))
	aTail(aSC)[1] := (cAlias)->&(cPrefix+"CC")
	aTail(aSC)[2] := (cAlias)->&(cPrefix+"CONTA")
	aTail(aSC)[3] := (cAlias)->&(cPrefix+"ITEMCTA")
	aTail(aSC)[4] := (cAlias)->&(cPrefix+"CLVL")
	For nX := 1 To Len(aCTBEnt)
		If (cAlias)->(FieldPos(cPrefix+"EC"+aCTBEnt[nX]+"CR")) > 0
			aTail(aSC)[nX+4] := (cAlias)->&(cPrefix+"EC"+aCTBEnt[nX]+"CR")
			aTail(aSC)[nX+5] := (cAlias)->&(cPrefix+"EC"+aCTBEnt[nX]+"DB")
		EndIf
	Next nX
	If cAlias == "SC1"
		aTail(aTail(aSC)) := Round((SC1->C1_QUANT / SC8->C8_QUANT) * 100,TamSX3("CH_PERC")[1])
	ElseIf cAlias == "SCX"
		aTail(aTail(aSC)) := Round((((SC1->C1_QUANT*100)/SC7->C7_QUANT)*SCX->CX_PERC)/100,2)
	EndIf
EndIf

Return lRet

/*±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡ao    ³SAGeraSGX   | Autor ³Carlos Capeli			   ?Data ?14/06/13 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡ao ?Funcao utilizada para buscar os rateios da solicitacao ao armazem ³±?
±±?         ?e passar na rotina automatica de solicitacao de compra.			 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros?cChaveRat = Chave da tabela SCX									 ³±?
±±?		 ?aHeadSCX  = aHeader da tabela SCX								 ³±?
±±?		 ?aColsSCX  = aCols da tabela SCX									 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?MATA110                                                           ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
Static Function SAGeraSGX(cChaveRat,aColsSCX)
Local aAreaSGS	:= SGS->(GetArea())
Local cItemSCX	:= ""
Local cItemSA	:= ""
Local nItemSCX	:= 1
Local aItemRat	:= {}
DEFAULT aColsSCX := {}

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Montagem do aCols SCX  ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
aColsSCX := {}
SGS->(dbSetOrder(1))
SGS->(dbSeek(xFilial("SGS")+cChaveRat))
While SGS->(!Eof()) .And. SGS->(GS_FILIAL+GS_SOLICIT+GS_ITEMSOL) == xFilial("SGS")+cChaveRat
	aAdd(aItemRat,{"CX_ITEM",StrZero(Val(SGS->GS_ITEM),Len(SCX->CX_ITEM)),NIL})
	aAdd(aItemRat,{"CX_PERC",SGS->GS_PERC,NIL})
	aAdd(aItemRat,{"CX_CC",SGS->GS_CC,NIL})
	aAdd(aItemRat,{"CX_CONTA",SGS->GS_CONTA,NIL})
	aAdd(aItemRat,{"CX_ITEMCTA",SGS->GS_ITEMCTA,NIL})
	aAdd(aItemRat,{"CX_CLVL",SGS->GS_CLVL,NIL})
	If cItemSA <> StrZero(Val(SGS->GS_ITEMSOL),Len(SC1->C1_ITEM))
		cItemSA  := StrZero(Val(SGS->GS_ITEMSOL),Len(SC1->C1_ITEM))
		cItemSCX := StrZero(nItemSCX,Len(SC1->C1_ITEM))
		aAdd(aColsSCX,{cItemSCX,{}})
		nItemSCX++
	EndIf
	aAdd(aColsSCX[Val(cItemSCX)][2],aItemRat)
	aItemRat := {}

	SGS->(dbSkip())
EndDo

RestArea(aAreaSGS)
Return()

/*±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡ao    ³AtuSC5   | Autor ³Marcia A. R. Torres			   ?Data ?04/11/13 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡ao ?Funcao utilizada para liberar os pedidos de venda 					³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros?nNumPed = Numero do Pedido de Venda									³±?
±±?																						³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ?COMXFUN                                                           ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/

Static Function AtuSC5(nNumPed)

Local lLiberOk := .F.
local aArea    := {}
Local aAreaSC5 := {}
Local aAreaSC6 := {}

Default nNumPed := 0

aArea   :=  getarea()
aAreaSC5:=  SC5->(getarea())
aAreaSC6:=  SC6->(getarea())

dbSelectArea("SC6")
dbSetOrder(1)  //Filial + Ped. Venda

If dbSeek(xFilial("SC6")+nNumPed)

	While !( SC6->(Eof()) ) .And. (SC6->C6_FILIAL+SC6->C6_NUM == xFilial("SC6")+nNumPed)
		If  (SC6->C6_QTDLIB + SC6->C6_QTDEMP) == SC6->C6_QTDVEN
			lLiberOk := .T.
		Else
			lLiberOk := .F.
			Exit
		EndIf
		SC6->( dbSkip() )
	EndDo
		
	If lLiberOk
		dbSelectArea("SC5")
		dbSetOrder(1)   //Filial + Ped. Venda
		If DbSeek(xFilial("SC5")+nNumPed)	
			RecLock("SC5",.F.)
			REPLACE C5_LIBEROK WITH "S"
			MsUnlock()
		EndIf
	EndIf
	
Endif

restarea(aAreaSC6)
restarea(aAreaSC5)
restarea(aArea)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MTGetVProd ?Autor ?Cleber Maldonado      ?Data ?7.08.2013³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Retorna o valor do produto respeitando a seguinte ordem:   ³±?
±±?         ?1- Ultimo Preço de Compra 2- Custo Standard 3- Custo Médio ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe e ?MTGetVProd(cProd)   					                      ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?ExpC1 = Código do Produto                                  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?Generico                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Function MTGetVProd(cProd)
Local nRet := 0

dbSelectArea("SB1")
dbSetOrder(1)

If MsSeek(xFilial("SB1")+cProd)
	If !Empty(SB1->B1_UPRC)
		nRet := SB1->B1_UPRC
	ElseIf !Empty(SB1->B1_CUSTD)
		nRet := SB1->B1_CUSTD
	Endif
	If nRet == 0
		dbSelectArea("SB2")
		dbSetOrder(1)
		If MsSeek(xFilial("SB2")+cProd+SB1->B1_LOCPAD)
			nRet := SB2->B2_CM1
		Endif
	Endif
Endif
Return nRet

//-------------------------------------------------------------------
/*/{Protheus.doc} MTGETFEC()
Função para criar array dos campos das entidades contabeis criadas adicionamelnte as padroes. 

@author alexandre.gimenez
@since 26/08/2013
@version 1.0
@param cTab Alias da tabela.
@param cPrefix Prefixo da tabela.
@param aCampos campos ja existentes no array.
@return aCampos 
/*/
//-------------------------------------------------------------------
Function MTGETFEC(cTab,cPrefix,aCampos)
Local aEntidades 	:= CtbEntArr()
Local aArea		:= GetArea()
local cCpo		 	:= ""
local nEnt 		:= 0
local nDeb		 	:= 0

Default cPrefix	:= "  "
Default cTab 	 	:= "   "

If Empty(aCampos)
	aCampos	:= {cPrefix+"_CC",cPrefix+"_CONTA", IIF(cPrefix == "B1",substr(cPrefix+"_ITEMCC",1,10),substr(cPrefix+"_ITEMCTA",1,10)), cPrefix+"_CLVL"}
EndIf

If AliasIndic(cTab)
	dbSelectArea(cTab) // Sim ou não eis a questao;.
	For nEnt := 1 to Len(aEntidades)
		For nDeb := 1 to 2
			cCpo := cPrefix + "_EC"+aEntidades[nEnt]
			
			If nDeb == 1
				cCpo += "DB"
			Else
				cCpo += "CR"
			EndIf
	
			If (cTab)->(FieldPos(cCpo)) > 0
				aadd(aCampos,cCpo)
			Endif
			cCpo := ""
						
		Next nDeb
	Next nEnt	
EndIf

RestArea(aArea)
Return aCampos

//-------------------------------------------------------------------
/*/{Protheus.doc} MTFindMVC(oModel,aCampo)
Função para verificar se existe um valor no modelo mvc

@author alexandre.gimenez
@return lRet
@since 23/10/2013
@version 1.0
/*/
//------------------------------------------------------------------
Function MTFindMVC(oModel,aCampos)
Local aSaveLines 	:= FWSaveRows()
Local nX			:= 0
Local nA			:= 0
Local nRet			:= 0
Local lAchou		:= .F.

For nX := 1 to oModel:Length()
	oModel:GoLine(nX)
	If !oModel:IsDeleted()
		For nA := 1 to len(aCampos)
			If oModel:GetValue(aCampos[nA,1]) == aCampos[nA,2]
				lAchou := .T.
			Else
				lAchou := .F.
				Exit
			EndIf	
		Next nA
		If lAchou
			nRet := nX
			Exit
		EndIf
	EndIf
Next nX

FWRestRows(aSaveLines)
Return nRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡…o    ?MaGeraGCT     ?Autor ?Cleber Maldonado   	?Data ?20/11/13 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡…o ?Gera as medição e efetua o encerramento da mesma 			  ³±?
±±?		 ?                  											  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Parametros?cProduto:codigo do produto									  ³±?
±±?         ?nNecess: necessidade de compra   							  ³±?
±±?         ?aCampos: campos especificos a serem gravados por rotinas.	  ³±?
±±?         ?cRotina: identifica a rotina chamadora da funcao.			  ³±?
±±?         ?                                                               ³±?
±±?         ?                                                               ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?Generico                                                  	  ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Function MatGeraGCT(cProduto,nNecess,aMedicoes,nDiasCob,cRotina)
Local aCabCN120	:= {}
Local aItCN120 	:= {}
Local aRetorno	:= {}
Local aArea 	 	:= GetArea()
Local cAliasTOP 	:= GetNextAlias()
Local dDataQry	:= If(!Empty(nDiasCob),(ddatabase + nDiasCob),DBJ->DBJ_DTATE)
Local cFilCompNa	:= cFilAnt
Local cNumMed		:= ""


BeginSql Alias cAliasTOP

	SELECT CN9.CN9_NUMERO,CN9.CN9_REVISA,CNF.CNF_COMPET,CNA.CNA_NUMERO,CNF.CNF_PARCEL,CNF.CNF_PRUMED,
	      CASE  WHEN CNF.CNF_SALDO IS NULL THEN CNB.CNB_SLDMED
    	              WHEN CNS.CNS_SLDQTD IS NULL THEN ( CASE  WHEN CNA.CNA_SALDO > 0 THEN (CNF.CNF_SALDO/CNA.CNA_SALDO) * CNB.CNB_SLDMED
    	              										ELSE 0 END )
        	          ELSE CNS_SLDQTD END QTDMED 
	FROM %table:CNB% CNB 
	JOIN %table:CN9% CN9 ON
	      CN9.%NotDel% AND
	      CN9.CN9_FILIAL = %Exp:xFilial("CN9",cFilCompNa)% AND
	      CN9.CN9_NUMERO = CNB.CNB_CONTRA AND
	      CN9.CN9_REVISA = CNB.CNB_REVISA AND
	      CN9.CN9_REVISA = CN9.CN9_REVATU AND
	      CN9.CN9_SITUAC = '05' 
	JOIN %table:CN1% CN1 ON
	      CN1.%NotDel% AND
	      CN1.CN1_FILIAL = %Exp:xFilial("CN1",cFilCompNa)% AND
	      CN1.CN1_CODIGO = CN9.CN9_TPCTO AND
	      CN1.CN1_ESPCTR = '1' AND
	      CN1.CN1_MEDAUT = '1'
	JOIN %table:CNA% CNA ON
	      CNA.%NotDel% AND
	      CNA.CNA_FILIAL = %Exp:xFilial("CNA",cFilCompNa)% AND
	      CNA.CNA_CONTRA = CNB.CNB_CONTRA AND
	      CNA.CNA_REVISA = CNB.CNB_REVISA AND
	      CNA.CNA_NUMERO = CNB.CNB_NUMERO
	LEFT JOIN %table:CNF% CNF ON
	      CNF.%NotDel% AND
	      CNF.CNF_FILIAL = %Exp:xFilial("CNF",cFilCompNa)% AND
	      CNF.CNF_CONTRA = CNB.CNB_CONTRA AND
	      CNF.CNF_REVISA = CNB.CNB_REVISA AND
	      CNF.CNF_NUMERO = CNA.CNA_CRONOG
	LEFT JOIN %table:CNS% CNS ON
	      CNS.%NotDel% AND
	      CNS.CNS_FILIAL = %Exp:xFilial("CNS",cFilCompNa)% AND
	      CNS.CNS_CONTRA = CNB.CNB_CONTA AND
	      CNS.CNS_REVISA = CNB.CNB_REVISA AND
	      CNS.CNS_PLANI  = CNB.CNB_NUMERO AND
	      CNS.CNS_ITEM   = CNB.CNB_ITEM AND
	      CNS.CNS_CRONOG = CNF.CNF_NUMERO AND
	      CNS.CNS_PARCEL = CNF.CNF_PARCEL 
	WHERE CNB.%NotDel% AND
	      CNB.CNB_FILIAL = %Exp:xFilial("CNB",cFilCompNa)% AND
	      CNB.CNB_PRODUT = %Exp:cProduto% AND
	      CNB.CNB_SLDMED > 0 AND
	      CNB.CNB_PEDTIT <> '2' AND
	      CNF.CNF_PRUMED BETWEEN %Exp:ddatabase% AND %Exp:dDataQry% 
EndSQL

If Type("lMsErroAuto") # "L"
	PRIVATE lMsErroAuto := .F.
Else
	lMsErroAuto := .F.
EndIf

dbSelectArea(cAliasTop)
(cAliasTOP)->(dbGoTop())
While (cAliasTop)->(!Eof()) .And. nNecess > 0
	If (cAliasTop)->QTDMED > 0 
		cNumMed := CriaVar("CND_NUMMED")
		aAdd(aCabCN120,{"CND_CONTRA",(cAliasTOP)->CN9_NUMERO,NIL})
		aAdd(aCabCN120,{"CND_REVISA",(cAliasTOP)->CN9_REVISA,NIL})
		aAdd(aCabCN120,{"CND_COMPET",(cAliasTOP)->CNF_COMPET,NIL})
		aAdd(aCabCN120,{"CND_NUMERO",(cAliasTOP)->CNA_NUMERO,NIL})
		aAdd(aCabCN120,{"CND_NUMMED",cNumMed,NIL})
		aAdd(aCabCN120,{"CND_PARCEL",(cAliasTOP)->CNF_PARCEL,NIL})
	
		//-- Gera a medicao
		MsExecAuto({|a,b,c|,CNTA120(a,b,c)},aCabCN120,aItCN120,3)		
	
		//-- Encerra a medicao
		If !lMsErroAuto
			MsExecAuto({|a,b,c|,CNTA120(a,b,c)},aCabCN120,aItCN120,6)
		EndIf
	
		If lMsErroAuto
			MostraErro()
			Aviso("SIGAGCT","A medição automática de contrato não foi realizada.",{"Ok"}) //SIGAGCT - A medição automática de contrato não foi realizada.
			Exit
		Else
		    nNecess -= (cAliasTop)->QTDMED
		    aAdd(aRetorno,{(cAliasTop)->QTDMED,cNumMed})
		EndIf
		
		cNumMed := CND->CND_NUMMED
		dbSelectArea("CNE")
		dbSetOrder(4)
		CNE->(dbSeek(xFilial("CNE")+cNumMed))
		While CNE->(!EOF()) .And. cNumMed == CNE->CNE_NUMMED
			If CNE->CNE_PRODUT <> cProduto
				aAdd(aMedicoes,{CNE->CNE_PRODUT,cFilCompNa,CNE->CNE_QUANT,cNumMed})
			EndIf
			CNE->(dbSkip())
		End
	EndIf

	(cAliasTop)->(dbSkip())
	aCabCN120 := {}
End

RestArea(aArea)

Return aRetorno

//-------------------------------------------------------------------
/*/{Protheus.doc} COMGetFor
Função para gatilhar o nome e a loja do fornecedor 

@author taniel.silva
@param cCodFor = Código do Fornecedor
@param cLoja = Loja
@param cTipo = Loja ou Nome
@since 28/08/2014
@version P11.80
@return cRet
/*/
//-------------------------------------------------------------------
Function COMGetFor(cCodFor, cLoja, cTipo)
Local cRet := ""
Default cLoja := ""

SA2->(dbSetOrder(1))
If cTipo == 1
	If SA2->(dbSeek(xFilial("SA2")+cCodFor)) 
		cRet := SA2->A2_LOJA
	EndIf
Else
	If SA2->(dbSeek(xFilial("SA2")+cCodFor+AllTrim(cLoja)))
		cRet := SA2->A2_NOME
	EndIf	
EndIf

Return cRet

//-------------------------------------------------------------------
/*/{Protheus.doc} MTGetForRl
Busca de fornecedores relacionados

@author guilherme.pimentel

@param cFor Codigo do Fornecedor
@param cLoja Loja do Fornecedor
@return aRet
@since 29/08/2014
@version 1.0
/*/
//------------------------------------------------------------------
Function MTGetForRl(cFor,cLoja)
Local aRet := {}

SA2->(DbSetOrder(1))

CPX->(DbSetOrder(2))
CPX->(DbSeek(xFilial('CPX')+cFor+cLoja))

SA2->(DbSeek(xFilial('SA2')+cFor+cLoja))
aAdd(aRet,AllTrim(cFor)+'/'+AllTrim(cLoja)+' - '+AllTrim(SA2->A2_NOME))

While cFor == CPX->CPX_CODFOR .And. cLoja == CPX->CPX_LOJFOR
	If SA2->(DbSeek(xFilial('SA2')+CPX->CPX_CODIGO+CPX->CPX_LOJA))
		aAdd(aRet,AllTrim(CPX->CPX_CODIGO)+'/'+AllTrim(CPX->CPX_LOJA)+' - '+AllTrim(SA2->A2_NOME))
	EndIf
	CPX->(DbSkip())
EndDo

Return aRet

/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Fun‡„o    ³RetDataPD3?Autor ?Isaias Florencio      ?Data ?20/03/15 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descri‡„o ?Abre interface para digitacao do range de datas para       ³±?
±±?         ?pesquisa na funcao F4PODER3. Depende da ativacao do        ³±?
±±?         ?MV_DATAPD3                                                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?RetDataPD3()                                               ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Uso       ?F4PODER3 - COMXFUN                                         ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?/
Static Function RetDataPD3(dPrimData,dSegData,lDataRetr)

Local oDlgEsp  := Nil
Local nOpcao   := 0
Local aSize    := MsAdvSize(.F.)
Local lOk      := .F.

While !lOk
	DEFINE MSDIALOG oDlgEsp From aSize[7],0 To 120,400 OF oMainWnd PIXEL TITLE STR0128 // "F4PODER3"
	
	@ 06,005 SAY STR0129 PIXEL // "Informe as datas para pesquisa das notas com controle de poder de terceiros:"
	
	@ 19,005 SAY STR0130 PIXEL  // "Data de: "
	@ 18,040 MSGET dPrimData PICTURE "@D" SIZE 60, 10 OF oDlgEsp PIXEL
	
	@ 38,005 SAY STR0131 PIXEL // "Data ate: "
	@ 37,040 MSGET dSegData PICTURE "@D" SIZE 60, 10 OF oDlgEsp PIXEL
	
	DEFINE SBUTTON FROM 18,160 TYPE 1 OF oDlgEsp ENABLE PIXEL ACTION ;
	{|| If(dPrimData <= dSegData,nOpcao := 1,nOpcao := 2),oDlgEsp:End() }
	
	DEFINE SBUTTON FROM 37,160 TYPE 2 OF oDlgEsp ENABLE PIXEL ACTION (nOpcao := 0,oDlgEsp:End())
		
	ACTIVATE MSDIALOG oDlgEsp CENTERED
	
	If nOpcao == 1
		lOk := .T.
	ElseIf nOpcao == 2
		Aviso(STR0132,STR0133,{STR0118}) // "AVISO"## "Inconsistencia na ordem das datas" ## "Ok"
	ElseIf nOpcao == 0
		// "AVISO" ## "Ser?ignorada a pesquisa das notas no intervalo das datas. Serao exibidas todas as notas em aberto ate a data atual do sistema." # Confirma # "Retorna"
		If Aviso(STR0132,STR0135,{STR0087,STR0134}) == 1
	       dSegData    := dDataBase
	       lDataRetr   := .F.
		   lOk         := .T.
		EndIf
	EndIf
End

Return Nil
