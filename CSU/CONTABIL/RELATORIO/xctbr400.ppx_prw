#line 1 "C:\INCLUDE\CTBR400.Ch"
















































































































		Static  STR0013 :=  "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "










		Static  STR0024 :=  "DATA                                                                             DEBITO               CREDITO            SALDO ATUAL"




		Static  STR0029 :=  "DEBITO               CREDITO           SALDO ATUAL        "

		Static  STR0031 :=  "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
		Static  STR0032 :=  "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"

		Static  STR0034 :=  "LOTE/SUB/DOC/LINHA"
		Static  STR0035 :=  "HISTORICO"

		Static  STR0037 :=  "DEBITO"
		Static  STR0038 :=  "CREDITO"





































































































































































































	STATIC uInit := __InitFun()

	Static Function __InitFun()
	uInit := Nil

		If cPaisLoc == "ALL"
			STR0024 := "DATA                                                                             DEBITO               CREDITO            SALDO ATUAL"
			STR0029 := "DEBITO               CREDITO           SALDO ATUAL        "
			STR0034 := "LOTE/SUB/DOC/LINHA"
			STR0035 := "HISTORICO"
			STR0037 := "DEBITO"
			STR0038 := "CREDITO"
		ElseIf cPaisLoc == "ARG"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "BOL"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "BRA"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "CHI"
			STR0013 := "LOTE/SUB/DOC/LINEA CORRELAT. H I S T O R I A L              C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINEA CORRELAT. H I S T O R I A L              C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINEA CORRELAT. H I S T O R I A L              C/PARTIDA                                                                                                                DEBITO               CREDITO         SALDO ACTUAL"
			STR0034 := "LOTE/SUB/DOC/LINHA"
			STR0035 := "HISTORICO"
		ElseIf cPaisLoc == "COL"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "COS"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "DOM"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "EQU"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "EUA"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "MEX"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0024 := "DATA                                                                             DEBITO               CREDITO            SALDO ATUAL"
			STR0029 := "DEBITO               CREDITO           SALDO ATUAL        "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
			STR0037 := "DEBITO"
			STR0038 := "CREDITO"
		ElseIf cPaisLoc == "PAN"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "PAR"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "PER"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "POR"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "SAL"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "URU"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		ElseIf cPaisLoc == "VEN"
			STR0013 := "LOTE/SUB/DOC/LINHA  H I S T O R I C O                        C/PARTIDA                      "
			STR0031 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                       DEBITO         CREDITO       SALDO ATUAL"
			STR0032 := "LOTE/SUB/DOC/LINHA H I S T O R I C O                        C/PARTIDA                                                                                       DEBITO               CREDITO                SALDO ATUAL"
		EndIf
	Return Nil
#line 2 "c:\users\cst1350.br\desktop\PROJET~1\contabil\RELATO~1\xctbr400.prw"
#line 1 "C:\INCLUDE\PROTHEUS.Ch"
#line 1 "C:\INCLUDE\Dialog.ch"
#line 27 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\Font.ch"
#line 28 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\PTMenu.ch"
#line 30 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\Print.ch"
#line 32 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\Colors.ch"
#line 34 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\Folder.ch"
#line 36 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\msobject.ch"
#line 37 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\VKey.ch"
#line 41 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\WinApi.ch"
#line 43 "PROTHEUS.Ch"
#line 1 "C:\INCLUDE\FWCommand.ch"
#line 47 "PROTHEUS.Ch"
#line 23 "c:\users\cst1350.br\desktop\PROJET~1\contabil\RELATO~1\xctbr400.prw"


Function U_xCTBR400(cContaIni,cContaFim,dDataIni,dDataFim,cMoeda,cSaldos,cBook,lCusto,cCustoIni,cCustoFim,lItem,cItemIni,cItemFim,lClVl,cClvlIni,cClvlFim,lSaltLin)

Local oReport

Local aArea := GetArea()
Local aCtbMoeda		:= {}

Local cArqTmp		:= ""

Local lOk := .T. 
Local lExterno		:= cContaIni <> Nil

lCusto := If( lCusto == nil, .F. , lCusto ) ;
lItem := If( lItem == nil, .F. , lItem ) ;
lCLVL := If( lCLVL == nil, .F. , lCLVL ) ;
lSaltLin := If( lSaltLin == nil, .T. , lSaltLin ) ;

PRIVATE cTipoAnt	:= ""
PRIVATE cPerg	 	:= PADR("CTR400",LEN(SX1->X1_GRUPO))
PRIVATE nomeProg  	:= "CTBR400"
PRIVATE nSldATransp	:= 0
PRIVATE nSldDTransp	:= 0












































































		CTBR400R3()


RestArea(aArea)

Return
















Static Function ReportDef(aCtbMoeda,lCusto,lItem,lCLVL,cArqTmp)

Local oReport
Local oSection1
Local oSection2
Local oSection3

Local cDesc1		:= "Este programa irá imprimir o Razäo Contabil,"
Local cDesc2		:= "de acordo com os parametros solicitados pelo"
Local cDesc3		:= "usuário."
Local titulo		:= "Emissao do Razao Contabil"
Local cNormal		:= ""

Local aTamConta	:= TAMSX3("CT1_CONTA")
Local aTamCusto	:= TAMSX3("CT3_CUSTO")
Local nTamConta	:= Len(CriaVar("CT1_CONTA"))
Local nTamHist	:= Len(CriaVar("CT2_HIST"))
Local nTamItem	:= Len(CriaVar("CTD_ITEM"))
Local nTamCLVL	:= Len(CriaVar("CTH_CLVL"))

Local lAnalitico	:= Iif(mv_par08==1, .T. , .F. )
Local lSalLin		:= IIf(mv_par31==1, .T. , .F. )
Local lPrintZero	:= IIf(mv_par30==1, .T. , .F. )
Local lSalto		:= Iif(mv_par21==1, .T. , .F. )

Local cSayCusto		:= CtbSayApro("CTT")
Local cSayItem		:= CtbSayApro("CTD")
Local cSayClVl		:= CtbSayApro("CTH")

Local nDigitAte		:= 0
Local aSetOfBook := CTBSetOf(mv_par07)
Local cPicture 		:= aSetOfBook[4]
Local cDescMoeda 	:= aCtbMoeda[2]
Local nDecimais 	:= DecimalCTB(aSetOfBook,mv_par05)

If mv_par11 == 3
	nTamConta := Len(CT1->CT1_CODIMP)
Endif

If lAnalitico .And.  (lCusto .Or.  lItem .Or.  lCLVL)
	nTamConta := 30
EndIf


oReport := TReport():New(nomeProg,titulo,cPerg, {|oReport| ReportPrint(oReport,aCtbMoeda,aSetOfBook,cPicture,cDescMoeda,nDecimais,nTamConta,lAnalitico,lCusto,lItem,lCLVL,cArqTmp)},cDesc1+cDesc2+cDesc3)
oReport:SetTotalInLine( .F. )
oReport:EndPage( .T. )

If lAnalitico
	oReport:SetLandScape( .T. )
Else
	oReport:SetPortrait( .T. )
EndIf


oSection1 := TRSection():New(oReport,"Conta",{"cArqTmp"},,,)

	If lSalto
		oSection1:SetPageBreak( .T. )
	EndIf

	TRCell():New(oSection1,"CONTA"	,"cArqTmp","CONTA",,aTamConta[1],,)
	TRCell():New(oSection1,"DESCCC"	,"cArqTmp","DESCRICAO",,nTamConta,,)

	oSection1:OnPrintLine( {|| IIf(lSalLin,oReport:SkipLine(),NIL) } )


oSection2 := TRSection():New(oReport,"Lançamentos Contábeis",{"cArqTmp","CT2"},,,)
oSection2:SetTotalInLine( .F. )
oSection2:SetHeaderPage( .T. )

	TRCell():New(oSection2,"DATAL"		,"cArqTmp","DATA",,10,,)
	TRCell():New(oSection2,"DOCUMENTO"	,""       ,STR0034,,18,,{|| cArqTmp->LOTE+cArqTmp->SUBLOTE+cArqTmp->DOC+cArqTmp->LINHA })
	TRCell():New(oSection2,"HISTORICO"	,"cArqTmp",STR0035,,nTamHist	,,{|| Subs(cArqTmp->HISTORICO,1,30) })
	TRCell():New(oSection2,"XPARTIDA"	,"cArqTmp","XPARTIDA",,aTamConta[1]	,,)
	TRCell():New(oSection2,"CCUSTO"		,"cArqTmp",Upper(cSayCusto),,aTamCusto[1],,)
	TRCell():New(oSection2,"ITEM"		,"cArqTmp",Upper(cSayItem) ,,nTamItem,,)
	TRCell():New(oSection2,"CLVL"		,"cArqTmp",Upper(cSayClVl) ,,nTamCLVL,,)
	TRCell():New(oSection2,"LANCDEB"	,"cArqTmp",STR0037,,TAM_VALOR,,{|| ValorCTB(cArqTmp->LANCDEB,,,TAM_VALOR,nDecimais, .F. ,cPicture,"1",,,,,,lPrintZero, .F. ) },"RIGHT",,"RIGHT")
	TRCell():New(oSection2,"LANCCRD"	,"cArqTmp",STR0038,,TAM_VALOR,,{|| ValorCTB(cArqTmp->LANCCRD,,,TAM_VALOR,nDecimais, .F. ,cPicture,"2",,,,,,lPrintZero, .F. ) },"RIGHT",,"RIGHT")
	TRCell():New(oSection2,"TPSLDATU"	,"cArqTmp","SALDO ATUAL",,TAM_VALOR+2,,,"RIGHT",,"RIGHT")
	If cPaisLoc = "CHI"
		TRCell():New(oSection2,"SEGOFI"	,"cArqTmp","SEGOFI",,TamSx3("CT2_SEGOFI")[1],,)
	EndIf

	If lAnalitico
		If !lCusto
			oSection2:Cell("CCUSTO"):Hide()
			oSection2:Cell("CCUSTO"):HideHeader()
		EndIf
		If !lItem
			oSection2:Cell("ITEM"):Hide()
			oSection2:Cell("ITEM"	):HideHeader()
		EndIf
		If !lCLVL
			oSection2:Cell("CLVL"):Hide()
			oSection2:Cell("CLVL"	):HideHeader()
		EndIf
	Else
		oSection2:Cell("CCUSTO"):Hide()
		oSection2:Cell("CCUSTO"):HideHeader()
		oSection2:Cell("ITEM"):Hide()
		oSection2:Cell("ITEM"):HideHeader()
		oSection2:Cell("CLVL"):Hide()
		oSection2:Cell("CLVL"):HideHeader()

		oSection2:Cell("HISTORICO"):Disable()
		oSection2:Cell("DOCUMENTO"):Hide()
		oSection2:Cell("DOCUMENTO"):HideHeader()
		oSection2:Cell("XPARTIDA"):Hide()
		oSection2:Cell("XPARTIDA"):HideHeader()
	EndIf


oSection3 := TRSection():New( oReport,"Totais",,, .F. , .F.  )
	TRCell():New(oSection3,"TOT"			,"","DESCRICAO",,17+IIF(lAnalitico,nTamHist,0)+aTamConta[1]+aTamCusto[1]+nTamItem+nTamCLVL,,)
	TRCell():New(oSection3,"TOT_ANT"		,"","SALDO ANTERIOR:",,TAM_VALOR+2,,)
	TRCell():New(oSection3,"TOT_DEBITO"		,"",STR0037,,TAM_VALOR,,,"RIGHT",,"RIGHT")
	TRCell():New(oSection3,"TOT_CREDITO"	,"",STR0038,,TAM_VALOR,,,"RIGHT",,"RIGHT")
	TRCell():New(oSection3,"TOT_ATU"		,"","SALDO ATUAL",,TAM_VALOR+2,,,"RIGHT",,"RIGHT")
	oSection3:Cell("TOT_ANT"):HideHeader()
	oSection3:Cell("TOT_DEBITO"):HideHeader()
	oSection3:Cell("TOT_CREDITO"):HideHeader()
	oSection3:Cell("TOT_ATU"):HideHeader()


oSection4 := TRSection():New( oReport,"Complemento",,, .F. , .F.  )
	TRCell():New(oSection4,"COMP","","Complemento",,17+IIF(lAnalitico,nTamHist,0)+aTamConta[1]+aTamCusto[1]+nTamItem+nTamCLVL,,)
	oSection4:Cell("COMP"):HideHeader()

oReport:ParamReadOnly()


TRPosition():New( oSection2, "CT2", 1, {|| xFilial("CT2")+cArqTmp->(DtoS(DATAL)+LOTE+SUBLOTE+DOC+LINHA+mv_par06+EMPORI+FILORI+mv_par05) } )

Return oReport















Static Function ReportPrint(oReport,aCtbMoeda,aSetOfBook,cPicture,cDescMoeda,nDecimais,nTamConta,lAnalitico,lCusto,lItem,lCLVL,cArqTmp)

Local oSection1 	:= oReport:Section(1)
Local oSection2		:= oReport:Section(2)
Local oSection3		:= oReport:Section(3)

Local cFiltro	:= oSection2:GetAdvplExp()

Local cSayCusto		:= CtbSayApro("CTT")
Local cSayItem		:= CtbSayApro("CTD")
Local cSayClVl		:= CtbSayApro("CTH")

Local aSaldo		:= {}
Local aSaldoAnt		:= {}

Local cContaIni		:= mv_par01
Local cContaFIm		:= mv_par02
Local cMoeda		:= mv_par05
Local cSaldo		:= mv_par06
Local cCustoIni		:= mv_par13
Local cCustoFim		:= mv_par14
Local cItemIni		:= mv_par16
Local cItemFim		:= mv_par17
Local cCLVLIni		:= mv_par19
Local cCLVLFim		:= mv_par20
Local cContaAnt		:= ""
Local cDescConta	:= ""
Local cCodRes		:= ""
Local cResCC		:= ""
Local cResItem		:= ""
Local cResCLVL		:= ""
Local cDescSint		:= ""
Local cContaSint	:= ""
Local cNormal 		:= ""
Local xConta		:= ""
Local cSepara1		:= ""
Local cSepara2		:= ""
Local cSepara3		:= ""
Local cSepara4		:= ""
Local cMascara1		:= ""
Local cMascara2		:= ""
Local cMascara3		:= ""
Local cMascara4		:= ""
Local dDataAnt		:= CTOD("  /  /  ")
Local dDataIni		:= mv_par03
Local dDataFim		:= mv_par04
Local nPagIni		:= mv_par22
Local nReinicia 	:= mv_par24
Local nPagFim		:= mv_par23
Local nMaxLin   	:= mv_par32
Local nTotDeb		:= 0
Local nTotCrd		:= 0
Local nTotGerDeb	:= 0
Local nTotGerCrd	:= 0
Local nVlrDeb		:= 0
Local nVlrCrd		:= 0
Local nCont			:= 0
Local lNoMov		:= Iif(mv_par09==1, .T. , .F. )
Local lSldAnt		:= Iif(mv_par09==3, .T. , .F. )
Local lJunta		:= Iif(mv_par10==1, .T. , .F. )
Local lPrintZero	:= Iif(mv_par30==1, .T. , .F. )
Local lImpLivro		:= .t. 
Local lImpTermos	:= .f. 
Local lEmissUnica	:= If(GetNewPar("MV_CTBQBPG","M") == "M", .T. , .F. )
Local lSldAntCta	:= Iif(mv_par33 == 1, .T. , .F. )
Local lSldAntCC		:= Iif(mv_par33 == 2, .T. , .F. )
Local lSldAntIt  	:= Iif(mv_par33 == 3, .T. , .F. )
Local lSldAntCv  	:= Iif(mv_par33 == 4, .T. , .F. )


	cMascara1 := IIf (Empty(aSetOfBook[2]),GetMv("MV_MASCARA"),RetMasCtb(aSetOfBook[2],@cSepara1) )

	If lCusto .Or.  lItem .Or.  lCLVL

		cMascara2 := IIf ( Empty(aSetOfBook[6]),GetMv("MV_MASCCUS"),RetMasCtb(aSetOfBook[6],@cSepara2) )

		dbSelectArea("CTD")
		cMascara3 := IIf ( Empty(aSetOfBook[7]),ALLTRIM(STR(Len(CTD->CTD_ITEM))) , RetMasCtb(aSetOfBook[7],@cSepara3) )

		dbSelectArea("CTH")
		cMascara4 := IIf ( Empty(aSetOfBook[8]) , ALLTRIM(STR(Len(CTH->CTH_CLVL))) , RetMasCtb(aSetOfBook[8],@cSepara4) )
	EndIf




	Do Case
		Case mv_par29==1 ; lImpLivro:= .t.  ; lImpTermos:= .f. 
		Case mv_par29==2 ; lImpLivro:= .t.  ; lImpTermos:= .t. 
		Case mv_par29==3 ; lImpLivro:= .f.  ; lImpTermos:= .t. 
	EndCase




	If Type("NewHead")== "U"
		IF lAnalitico
			Titulo	:=	"RAZAO ANALITICO EM "
		Else
			Titulo	:=	"RAZAO SINTETICO EM "
		EndIf

		Titulo += 	cDescMoeda + " DE " + DTOC(dDataIni) +					" ATE " + DTOC(dDataFim) + CtbTitSaldo(mv_par06)
	Else
		Titulo := NewHead
	EndIf

	oReport:SetTitle(Titulo)
	oReport:SetPageNumber(mv_par22)
	oReport:SetCustomText( {|| CtCGCCabTR(,,,,,dDataFim,oReport:Title(),,,,,oReport) } )

	If lImpLivro








		MsgMeter({|	oMeter, oText, oDlg, lEnd | CTBGerRaz(oMeter,oText,oDlg,lEnd,@cArqTmp,cContaIni,cContaFim,cCustoIni,cCustoFim, cItemIni,cItemFim,cCLVLIni,cCLVLFim,cMoeda,dDataIni,dDataFim, aSetOfBook,lNoMov,cSaldo,lJunta,"1",lAnalitico,,,cFiltro,lSldAnt)}, "Criando Arquivo Temporário...",						"Emissao do Razao Contabil")
		dbSelectArea("cArqTmp")
		dbGoTop()
		oReport:SetMeter( RecCount() )
		oReport:NoUserFilter()
	Endif



	If lImpLivro
		If cArqTmp->(EoF())

			Aviso("Atenção","Nao existem dados para os parâmetros especificados.",{"Ok"})
			oReport:CancelPrint()
			Return
		Else
			While lImpLivro .And.  cArqTmp->(!Eof()) .And.  !oReport:Cancel()




			    If oReport:Cancel()
			    	Exit
			    EndIf

				If lSldAntCC
					aSaldo    := SaldTotCT3(cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,cArqTmp->DATAL,cMoeda,cSaldo)
					aSaldoAnt := SaldTotCT3(cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,dDataIni,cMoeda,cSaldo)
				ElseIf lSldAntIt
					aSaldo    := SaldTotCT4(cItemIni,cItemFim,cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,cArqTmp->DATAL,cMoeda,cSaldo)
					aSaldoAnt := SaldTotCT4(cItemIni,cItemFim,cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,dDataIni,cMoeda,cSaldo)
				ElseIf lSldAntCv
					aSaldo    := SaldTotCTI(cClVlIni,cClVlFim,cItemIni,cItemFim,cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,cArqTmp->DATAL,cMoeda,cSaldo)
					aSaldoAnt := SaldTotCTI(cClVlIni,cClVlFim,cItemIni,cItemFim,cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,dDataIni,cMoeda,cSaldo)
				Else
					aSaldo 		:= SaldoCT7(cArqTmp->CONTA,cArqTmp->DATAL,cMoeda,cSaldo)
					aSaldoAnt	:= SaldoCT7(cArqTmp->CONTA,dDataIni,cMoeda,cSaldo,"CTBR400")
				EndIf

				If f180Fil(lNoMov,aSaldo,dDataIni,dDataFim)
					dbSkip()
					Loop
				EndIf

				nSaldoAtu:= 0
				nTotDeb	:= 0
				nTotCrd	:= 0


				cContaSint := Ctr400Sint(cArqTmp->CONTA,@cDescSint,cMoeda,@cDescConta,@cCodRes)
				cNormal := CT1->CT1_NORMAL

				If mv_par11 == 3
					oSection1:Cell("CONTA" ):SetBlock( { || EntidadeCTB(CT1->CT1_CODIMP,0,0,nTamConta, .F. ,cMascara1,cSepara1,,,,, .F. ) } )
					oSection1:Cell("DESCCC"):SetBlock( { || " - " + cDescSint } )
				Else
					oSection1:Cell("CONTA" ):SetBlock( { || EntidadeCTB(cContaSint,0,0,Len(cContaSint), .F. ,cMascara1,cSepara1,,,,, .F. ) } )
					oSection1:Cell("DESCCC"):SetBlock( { || " - " + cDescSint } )
				Endif




	    	 	oSection1:Init()
			     	oSection1:PrintLine()
			    oSection1:Finish()

				xConta := "CONTA - "

				If mv_par11 == 1
					xConta += EntidadeCTB(cArqTmp->CONTA,0,0,nTamConta, .F. ,cMascara1,cSepara1,,,,, .F. )
				Else
					dbSelectArea("CT1")
					dbSetOrder(1)
					MsSeek(xFilial("CT1")+cArqTMP->CONTA, .F. )
					If mv_par11 == 3
						xConta += EntidadeCTB(CT1->CT1_CODIMP,0,0,nTamConta, .F. ,cMascara1,cSepara1,,,,, .F. )
					Else
						xConta += EntidadeCTB(CT1->CT1_RES,0,0,nTamConta, .F. ,cMascara1,cSepara1,,,,, .F. )
					EndIf
					cDescConta := &("CT1->CT1_DESC"+cMoeda)
				Endif
				If !lAnalitico
					xConta +=  " - " + Left(cDescConta,30)
				Else
					xConta +=  " - " + Left(cDescConta,38)
				Endif


				oReport:SetPageFooter( 5 , {|| IIF(oSection2:Printing() .Or.  oSection3:Printing() ,oReport:PrintText("A TRANSPORTAR :" + ValorCTB(nSldATransp,,,TAM_VALOR,nDecimais, .T. ,cPicture,,,,,,,lPrintZero, .F. ) ),nil) } )


				oReport:OnPageBreak( {|| IIF(oSection2:Printing() .Or.  oSection3:Printing() , (oReport:PrintText(xConta + "DE TRANSPORTE :" + ValorCTB(nSldDTransp,,,TAM_VALOR,nDecimais, .T. ,cPicture,,,,,,,lPrintZero, .F. ),oReport:Row(),10),oReport:Skipline()),nil) } )





				oReport:PrintText(xConta + "SALDO ANTERIOR:" + ValorCTB(aSaldoAnt[6],,,TAM_VALOR,nDecimais, .T. ,cPicture,,,,,,,lPrintZero, .F. ) )

				nSaldoAtu := aSaldoAnt[6]








				dbSelectArea("cArqTmp")
				cContaAnt:= cArqTmp->CONTA
				dDataAnt	:= CTOD("  /  /  ")

	   			oSection3:Init()
				oSection2:Init()

				while cArqTmp->(!Eof() .And. CONTA==cContaAnt) .And. !oReport:Cancel()

				    If oReport:Cancel()
				    	Exit
				    EndIf

					If dDataAnt <> cArqTmp->DATAL
						If (cArqTmp->LANCDEB <> 0 .Or.  cArqTmp->LANCCRD <> 0)
							oSection2:Cell("DATAL"):SetBlock( { || dDataAnt } )
						Endif
						dDataAnt := cArqTmp->DATAL
					EndIf

   					If lAnalitico

   						nSaldoAtu 	:= nSaldoAtu - cArqTmp->LANCDEB + cArqTmp->LANCCRD
						nTotDeb		+= cArqTmp->LANCDEB
						nTotCrd		+= cArqTmp->LANCCRD
						nTotGerDeb	+= cArqTmp->LANCDEB
						nTotGerCrd	+= cArqTmp->LANCCRD

						dbSelectArea("cArqTmp")
						If cPaisLoc == "CHI"
							oSection2:Cell("DOCUMENTO"):SetBlock( { || cArqTmp->LOTE+cArqTmp->SUBLOTE+cArqTmp->DOC+cArqTmp->LINHA+" "+cArqTmp->SEGOFI } )
							oSection2:Cell("HISTORICO"):SetBlock( { || Subs(cArqTmp->HISTORICO,1,30) } )
						EndIf

						If mv_par11 == 1
							oSection2:Cell("XPARTIDA"):SetBlock( { || EntidadeCTB(cArqTmp->XPARTIDA,0,0,nTamConta, .F. ,cMascara1,cSepara1,,,,, .F. ) } )
						ElseIf mv_par11 == 3
							oSection2:Cell("XPARTIDA"):SetBlock( { || EntidadeCTB(CT1->CT1_CODIMP,0,0,nTamConta, .F. ,cMascara1,cSepara1,,,,, .F. ) } )
						Else
							oSection2:Cell("XPARTIDA"):SetBlock( { || EntidadeCTB(CT1->CT1_RES,0,0,TAM_CONTA, .F. ,cMascara1,cSepara1,,,,, .F. ) } )
						Endif

						If lCusto
							If mv_par25 == 1
								oSection2:Cell("CCUSTO"):SetBlock( { || EntidadeCTB(cArqTmp->CCUSTO,0,0,TAM_CONTA, .F. ,cMascara2,cSepara2,,,,, .F. ) } )
							Else
								dbSelectArea("CTT")
								dbSetOrder(1)
								dbSeek(xFilial("CTT")+cArqTmp->CCUSTO)
								cResCC := CTT->CTT_RES
								oSection2:Cell("CCUSTO"):SetBlock( { || EntidadeCTB(cResCC,0,0,TAM_CONTA, .F. ,cMascara2,cSepara2,,,,, .F. ) } )
								dbSelectArea("cArqTmp")
							Endif
						Endif
						If lItem
							If mv_par26 == 1
								oSection2:Cell("ITEM"):SetBlock( { || EntidadeCTB(cArqTmp->ITEM,0,0,TAM_CONTA, .F. ,cMascara3,cSepara3,,,,, .F. ) } )
							Else
								dbSelectArea("CTD")
								dbSetOrder(1)
								dbSeek(xFilial("CTD")+cArqTmp->ITEM)
								cResItem := CTD->CTD_RES
								oSection2:Cell("ITEM"):SetBlock( { || EntidadeCTB(cResItem,0,0,TAM_CONTA, .F. ,cMascara3,cSepara3,,,,, .F. ) } )
								dbSelectArea("cArqTmp")
							Endif
						Endif
						If lCLVL
							If mv_par27 == 1
								oSection2:Cell("CLVL"):SetBlock( { || EntidadeCTB(cArqTmp->CLVL,0,0,TAM_CONTA, .F. ,cMascara4,cSepara4,,,,, .F. ) } )
							Else
								dbSelectArea("CTH")
								dbSetOrder(1)
								dbSeek(xFilial("CTH")+cArqTmp->CLVL)
								cResClVl := CTH->CTH_RES
								oSection2:Cell("CLVL"):SetBlock( { || EntidadeCTB(cResClVl,0,0,TAM_CONTA, .F. ,cMascara4,cSepara4,,,,, .F. ) } )
								dbSelectArea("cArqTmp")
							Endif
						Endif

						oSection2:Cell("TPSLDATU"):SetBlock( { || ValorCTB(nSaldoAtu,,,TAM_VALOR,nDecimais, .T. ,cPicture,cNormal,,,,,,lPrintZero, .F. ) } )

						nSldATransp := nSaldoAtu

				     	oSection2:PrintLine()
					    oReport:IncMeter()

						nSldDTransp := nSaldoAtu


						ImpCompl(oReport)

						dbSkip()

					Else

						dbSelectArea("cArqTmp")

						While dDataAnt == cArqTmp->DATAL .And.  cContaAnt == cArqTmp->CONTA
							nVlrDeb	+= cArqTmp->LANCDEB
							nVlrCrd	+= cArqTmp->LANCCRD
							nTotGerDeb	+= cArqTmp->LANCDEB
							nTotGerCrd	+= cArqTmp->LANCCRD
							dbSkip()
						EndDo

						nSaldoAtu	:= nSaldoAtu - nVlrDeb + nVlrCrd
						oSection2:Cell("LANCDEB"):SetBlock( { || ValorCTB(nVlrDeb,,,TAM_VALOR,nDecimais, .F. ,cPicture,"1",,,,,,lPrintZero, .F. ) })
						oSection2:Cell("LANCCRD"):SetBlock( { || ValorCTB(nVlrCrd,,,TAM_VALOR,nDecimais, .F. ,cPicture,"2",,,,,,lPrintZero, .F. ) })
						oSection2:Cell("TPSLDATU"):SetBlock( { || ValorCTB(nSaldoAtu,,,TAM_VALOR,nDecimais, .T. ,cPicture,cNormal,,,,,,lPrintZero, .F. ) })



						nSldATransp := nSaldoAtu

				     	oSection2:PrintLine()
					    oReport:IncMeter()

						nSldDTransp := nSaldoAtu

						nTotDeb		+= nVlrDeb
						nTotCrd		+= nVlrCrd
						nVlrDeb	:= 0
						nVlrCrd	:= 0
					Endif
				EndDo
   				oSection2:Finish()







				oSection3:Cell("TOT"):SetTitle(OemToAnsi("T o t a i s  d a  C o n t a  ==> "))
				oSection3:Cell("TOT_DEBITO"	):SetBlock(	{ || ValorCTB(nTotDeb  ,,,TAM_VALOR,nDecimais, .F. ,cPicture,"1",,,,,,lPrintZero, .F. ) } )
				oSection3:Cell("TOT_CREDITO" ):SetBlock(	{ || ValorCTB(nTotCrd  ,,,TAM_VALOR,nDecimais, .F. ,cPicture,"2",,,,,,lPrintZero, .F. ) } )
				oSection3:Cell("TOT_ATU"	):SetBlock(		{ || ValorCTB(nSaldoAtu,,,TAM_VALOR,nDecimais, .T. ,cPicture,cNormal,,,,,,lPrintZero, .F. ) } )



				oSection3:PrintLine()

				oSection3:Finish()




			EndDo

			If lImpLivro .And.  mv_par28 == 1




				oSection3:Cell("TOT"):SetTitle(OemToAnsi("T O T A L  G E R A L ==> "))
				oSection3:Cell("TOT_ATU"):Disable()
				If lAnalitico .And.  (lCusto .Or.  lItem .Or.  lClVl)
					oSection3:Cell("TOT_DEBITO"	):SetBlock(		{ || ValorCTB(nTotGerDeb  ,,,TAM_VALOR,nDecimais, .F. ,cPicture,"1",,,,,,lPrintZero, .F. ) } )
					oSection3:Cell("TOT_CREDITO" ):SetBlock(	{ || ValorCTB(nTotGerCrd  ,,,TAM_VALOR,nDecimais, .F. ,cPicture,"2",,,,,,lPrintZero, .F. ) } )
				Else
					oSection3:Cell("TOT_DEBITO"	):SetBlock(		{ || ValorCTB(nTotGerDeb  ,,,TAM_VALOR,nDecimais, .F. ,cPicture,"1",,,,,,lPrintZero, .F. ) } )
					oSection3:Cell("TOT_CREDITO" ):SetBlock(	{ || ValorCTB(nTotGerCrd  ,,,TAM_VALOR,nDecimais, .F. ,cPicture,"2",,,,,,lPrintZero, .F. ) } )
				Endif


				oSection3:Init()
				oSection3:PrintLine()
				oSection3:Finish()





			Endif

		EndIf
    EndIf




	If lImpTermos

		oSection2:SetHeaderPage( .F. )

		cArqAbert:=GetNewPar("MV_LRAZABE","")
		cArqEncer:=GetNewPar("MV_LRAZENC","")

	    If Empty(cArqAbert)

			ApMsgAlert(	"Devem ser criados os parametros MV_LRAZABE e MV_LRAZENC. " +						"Utilize como base o parametro MV_LDIARAB.")
		Endif
	Endif

	If lImpTermos .And.  ! Empty(cArqAbert)
		dbSelectArea("SM0")
		aVariaveis:={}

		For nCont:=1 to FCount()
			If FieldName(nCont)=="M0_CGC"
				AADD(aVariaveis,{FieldName(nCont),Transform(FieldGet(nCont),"@R 99.999.999/9999-99")})
			Else
	            If FieldName(nCont)=="M0_NOME"
	                Loop
	            EndIf
				AADD(aVariaveis,{FieldName(nCont),FieldGet(nCont)})
			Endif
		Next

		dbSelectArea("SX1")
		dbSeek("CTR400"+"01")

		While SX1->X1_GRUPO=="CTR400"
			AADD(aVariaveis,{Rtrim(Upper(X1_VAR01)),&(X1_VAR01)})
			dbSkip()
		End

		If !File(cArqAbert)
			aSavSet:=__SetSets()
			cArqAbert:=CFGX024(,"Razão")
			__SetSets(aSavSet)
			Set(24,Set(24), .t. )
		Endif

		If !File(cArqEncer)
			aSavSet:=__SetSets()
			cArqEncer:=CFGX024(,"Razão")
			__SetSets(aSavSet)
			Set(24,Set(24), .t. )
		Endif

		If cArqAbert#NIL
			oReport:EndPage()
			ImpTerm2(cArqAbert,aVariaveis,,,,oReport)
		Endif
		If cArqEncer#NIL
			oReport:EndPage()
			ImpTerm2(cArqEncer,aVariaveis,,,,oReport)
		Endif
	Endif

	dbselectArea("CT2")
	If !Empty(dbFilter())
		dbClearFilter()
	Endif

Return














Static Function ImpCompl(oReport)

	Local oSection4 := oReport:Section(4)

	oSection4:Cell("COMP"):SetBlock({|| Space(15)+CT2->CT2_LINHA,Subs(CT2->CT2_HIST,1,40) } )


	dbSelectArea("CT2")
	dbSetOrder(10)
	If MsSeek(xFilial("CT2")+cArqTMP->(DTOS(DATAL)+LOTE+SUBLOTE+DOC+SEQLAN+EMPORI+FILORI), .F. )
		dbSkip()
		If CT2->CT2_DC == "4"
			oSection4:Init()









			While !CT2->(Eof()) .And.  CT2->CT2_FILIAL == xFilial("CT2") .And.  CT2->CT2_LOTE == cArqTMP->LOTE .And.  CT2->CT2_SBLOTE == cArqTMP->SUBLOTE .And.  CT2->CT2_DOC == cArqTmp->DOC .And.  CT2->CT2_SEQLAN == cArqTmp->SEQLAN .And.  CT2->CT2_EMPORI == cArqTmp->EMPORI .And.  CT2->CT2_FILORI == cArqTmp->FILORI .And.  CT2->CT2_DC == "4" .And.  DTOS(CT2->CT2_DATA) == DTOS(cArqTmp->DATAL)
				oSection4:Printline()
				CT2->(dbSkip())
			EndDo
			oSection4:Finish()
		EndIf
	EndIf

	dbSelectArea("cArqTmp")

Return


















Static Function f180Fil(lNoMov,aSaldo,dDataIni,dDataFim)

Local lDeixa	:= .F. 

	If !lNoMov
		If aSaldo[6] == 0 .And.  cArqTmp->LANCDEB ==0 .And.  cArqTmp->LANCCRD == 0
			lDeixa	:= .T. 
		Endif
	Endif

	If lNoMov .And.  aSaldo[6] == 0 .And.  cArqTmp->LANCDEB ==0 .And.  cArqTmp->LANCCRD == 0
		If CtbExDtFim("CT1")
			dbSelectArea("CT1")
			dbSetOrder(1)
			If MsSeek(xFilial()+cArqTmp->CONTA)
				If !CtbVlDtFim("CT1",dDataIni)
					lDeixa	:= .T. 
	            EndIf

	            If !CtbVlDtIni("CT1",dDataFim)
					lDeixa	:= .T. 
	            EndIf

		    EndIf
		EndIf
	EndIf

	dbSelectArea("cArqTmp")

Return (lDeixa)




























STATIC Function CTBR400R3(	cContaIni, cContaFim, dDataIni, dDataFim, cMoeda, cSaldos, cBook, lCusto, cCustoIni, cCustoFim, lItem, cItemIni, cItemFim, lClVl, cClvlIni, cClvlFim,lSaltLin)

Local aCtbMoeda	:= {}
Local WnRel			:= "CTBR400"
Local cDesc1		:= "Este programa irá imprimir o Razäo Contabil,"
Local cDesc2		:= "de acordo com os parametros solicitados pelo"
Local cDesc3		:= "usuário."
Local cString		:= "CT2"
Local titulo		:= "Emissao do Razao Contabil"
Local lAnalitico 	:= .T. 
Local lRet			:= .T. 
Local lExterno		:= cContaIni <> Nil
Local nTamLinha	:= 220
Local nTamConta		:= Len(CriaVar ("CT1_CONTA"))
Local cSepara1		:= ""
lCusto := If( lCusto == nil, .F. , lCusto ) ;
lItem := If( lItem == nil, .F. , lItem ) ;
lCLVL := If( lCLVL == nil, .F. , lCLVL ) ;
lSaltLin := If( lSaltLin == nil, .T. , lSaltLin ) ;
Private aStrZC      := {}
Private aReturn	:= { "Zebrado", 1,"Administracao", 2, 2, 1, "", 1 }
Private nomeprog	:= "CTBR400"
Private aLinha		:= {}
Private nLastKey	:= 0
Private cPerg		:= PADR("CTR400",LEN(SX1->X1_GRUPO))
Private Tamanho 	:= "G"
Private lSalLin		:= .T. 
MontaZC()
If ( !AMIIn(34) )
	Return
EndIf

AjusteSX1()
Pergunte("CTR400", .F. )
AjCTR400MV9()
If ! lExterno
	If ! Pergunte("CTR400", .T. )
		Return
	Endif
Endif




































lAnalitico	:= Iif(mv_par08 == 1, .T. , .F. )
nTamLinha	:= If( lAnalitico, 220, 132)

If !lExterno
	lCusto 		:= Iif(mv_par12 == 1, .T. , .F. )
	lItem		:= Iif(mv_par15 == 1, .T. , .F. )
	lCLVL		:= Iif(mv_par18 == 1, .T. , .F. )
EndIf

aSetOfBook	:= {}




If !Ct040Valid(mv_par07)
	lRet := .F. 
Else
	aSetOfBook := CTBSetOf(mv_par07)
EndIf

If !lRet
	dbClearFilter()
	Return
Endif


If Empty(aSetOfBook[2])
	cMascara1 := GetMv("MV_MASCARA")
Else
	cMascara1	:= RetMasCtb(aSetOfBook[2],@cSepara1)



	nTamConta	:= nTamConta+Len(ALLTRIM(cSepara1))
EndIf

If (lAnalitico .And.  (!lCusto .And.  !lItem .And.  !lCLVL) .And.  nTamConta <= 22) .Or.  ! lAnalitico
	Tamanho := "M"
	nTamLinha := 132
EndIf

wnrel := SetPrint(cString,wnrel,If(! lExterno, cPerg,),@titulo,cDesc1,cDesc2,cDesc3, .F. ,"",,Tamanho)

If !lExterno
	lCusto 	:= Iif(mv_par12 == 1, .T. , .F. )
	lItem		:= Iif(mv_par15 == 1, .T. , .F. )
	lCLVL		:= Iif(mv_par18 == 1, .T. , .F. )
Else
	mv_par01 := cContaIni
	mv_par02 := cContaFim
	mv_par03 := dDataIni
	mv_par04 := dDataFim
	mv_par05 := cMoeda
	mv_par06 := cSaldos
	mv_par07 := cBook
	mv_par12 := If(lCusto = .T. ,1,2)
	mv_par13 := cCustoIni
	mv_par14 := cCustoFim
	mv_par15 := If(lItem = .T. ,1,2)
	mv_par16 := cItemIni
	mv_par17 := cItemFim
	mv_par18 := If(lClVl = .T. ,1,2)
	mv_par19 := cClVlIni
	mv_par20 := cClVlFim
	mv_par31 := If(lSaltLin== .T. ,1,2)
Endif
lAnalitico	:= Iif(mv_par08 == 1, .T. , .F. )
nTamLinha	:= If( lAnalitico, 220, 132)

If (lAnalitico .And.  (!lCusto .And.  !lItem .And.  !lCLVL) .And.  nTamConta<= 22) .Or.  ! lAnalitico
	Tamanho := "M"
	nTamLinha := 132
EndIf

If nLastKey = 27
	dbClearFilter()
	Return
Endif




If !Ct040Valid(mv_par07)
	lRet := .F. 
Else
	aSetOfBook := CTBSetOf(mv_par07)
EndIf

If lRet
	aCtbMoeda  	:= CtbMoeda(mv_par05)
   If Empty(aCtbMoeda[1])
      Help(" ",1,"NOMOEDA")
      lRet := .F. 
   Endif
Endif

If !lRet
	dbClearFilter()
	Return
EndIf

SetDefault(aReturn,cString)

If nLastKey = 27
	dbClearFilter()
	Return
Endif

cArquivo := cGetFile("", "Informe o Diretorio e o nome do Arquivo para Exportação ",,,,16+8+32)
cPeti    := GetSrvProfString("StartPath","")



MemoWrite(cPeti+"teste.txt","teste")

While .t. 
	lSucesso := __CopyFile(cPeti+"teste.txt", cArquivo)

	If !lSucesso
	    Alert("O caminho selecionado é invalido => "+cArquivo)
		cArquivo := cGetFile("", "Informe o Diretorio e o nome do Arquivo para Exportação ",,,,16+8+32)
	Else
	    Exit
	EndIf
EndDo


RptStatus({|lEnd| CTR400Imp(@lEnd,wnRel,cString,aSetOfBook,lCusto,lItem,lCLVL, lAnalitico,Titulo,nTamlinha,aCtbMoeda, nTamConta)})
Return































STATIC Function CTR400Imp(lEnd,WnRel,cString,aSetOfBook,lCusto,lItem,lCLVL,lAnalitico,Titulo,nTamlinha, aCtbMoeda,nTamConta)




Local aSaldo		:= {}
Local aSaldoAnt		:= {}
Local aColunas

Local cArqTmp
Local cSayCusto	:= CtbSayApro("CTT")
Local cSayItem		:= CtbSayApro("CTD")
Local cSayClVl		:= CtbSayApro("CTH")

Local cDescMoeda
Local cMascara1
Local cMascara2
Local cMascara3
Local cMascara4
Local cPicture
Local cSepara1		:= ""
Local cSepara2		:= ""
Local cSepara3		:= ""
Local cSepara4		:= ""
Local cSaldo		:= mv_par06
Local cContaIni	:= mv_par01
Local cContaFIm	:= mv_par02
Local cCustoIni	:= mv_par13
Local cCustoFim	:= mv_par14
Local cItemIni		:= mv_par16
Local cItemFim		:= mv_par17
Local cCLVLIni		:= mv_par19
Local cCLVLFim		:= mv_par20
Local cContaAnt	:= ""
Local cDescConta	:= ""
Local cCodRes		:= ""
Local cResCC		:= ""
Local cResItem		:= ""
Local cResCLVL		:= ""
Local cDescSint	:= ""
Local cMoeda		:= mv_par05
Local cContaSint	:= ""
Local cNormal 		:= ""

Local dDataAnt		:= CTOD("  /  /  ")
Local dDataIni		:= mv_par03
Local dDataFim		:= mv_par04

Local lNoMov		:= Iif(mv_par09==1, .T. , .F. )
Local lSldAnt		:= Iif(mv_par09==3, .T. , .F. )
Local lJunta		:= Iif(mv_par10==1, .T. , .F. )
Local lSalto		:= Iif(mv_par21==1, .T. , .F. )
Local lFirst		:= .T. 
Local lImpLivro		:= .t. 
Local lImpTermos	:= .f. 
Local lPrintZero	:= Iif(mv_par30==1, .T. , .F. )

Local nDecimais
Local nTotDeb		:= 0
Local nTotCrd		:= 0
Local nTotGerDeb	:= 0
Local nTotGerCrd	:= 0
Local nPagIni		:= mv_par22
Local nReinicia 	:= mv_par24
Local nPagFim		:= mv_par23
Local nVlrDeb		:= 0
Local nVlrCrd		:= 0
Local nCont			:= 0
Local l1StQb 		:= .T. 
Local lQbPg			:= .F. 
Local lEmissUnica	:= If(GetNewPar("MV_CTBQBPG","M") == "M", .T. , .F. )
Local lNewPAGFIM	:= If(nReinicia > nPagFim, .T. , .F. )
Local LIMITE		:= If(TAMANHO=="G",220,If(TAMANHO=="M",132,80))
Local nInutLin		:= 1
Local nMaxLin   	:= mv_par32

Local nBloco		:= 0
Local nBlCount		:= 0

Local lSldAntCta	:= Iif(mv_par33 == 1, .T. , .F. )
Local lSldAntCC		:= Iif(mv_par33 == 2, .T. , .F. )
Local lSldAntIt  	:= Iif(mv_par33 == 3, .T. , .F. )
Local lSldAntCv  	:= Iif(mv_par33 == 4, .T. , .F. )

lSalLin		:= If(mv_par31 ==1 , .T. , .F. )
m_pag    := 1

If lEmissUnica
	CtbQbPg( .T. ,@nPagIni,@nPagFim,@nReinicia,@m_pag,@nBloco,@nBlCount)
Endif




Do Case
	Case mv_par29==1 ; lImpLivro:= .t.  ; lImpTermos:= .f. 
	Case mv_par29==2 ; lImpLivro:= .t.  ; lImpTermos:= .t. 
	Case mv_par29==3 ; lImpLivro:= .f.  ; lImpTermos:= .t. 
EndCase




cbtxt    := SPACE(10)
cbcont   := 0
li       := 80

cDescMoeda 	:= Alltrim(aCtbMoeda[2])
nDecimais 	:= DecimalCTB(aSetOfBook,cMoeda)


If Empty(aSetOfBook[2])
	cMascara1 := GetMv("MV_MASCARA")
Else
	cMascara1	:= RetMasCtb(aSetOfBook[2],@cSepara1)
EndIf

If lCusto .Or.  lItem .Or.  lCLVL

	If Empty(aSetOfBook[6])
		cMascara2 := GetMv("MV_MASCCUS")
	Else
		cMascara2	:= RetMasCtb(aSetOfBook[6],@cSepara2)
	EndIf

	If Empty(aSetOfBook[7])
		dbSelectArea("CTD")
		cMascara3 := ALLTRIM(STR(Len(CTD->CTD_ITEM)))
	Else
		cMascara3 := RetMasCtb(aSetOfBook[7],@cSepara3)
	EndIf

	If Empty(aSetOfBook[8])
		dbSelectArea("CTH")
		cMascara4 := ALLTRIM(STR(Len(CTH->CTH_CLVL)))
	Else
		cMascara4 := RetMasCtb(aSetOfBook[8],@cSepara4)
	EndIf
EndIf

cPicture 	:= aSetOfBook[4]




If Type("NewHead")== "U"
	IF lAnalitico
		Titulo	:=	"RAZAO ANALITICO EM "
	Else
		Titulo	:=	"RAZAO SINTETICO EM "
	EndIf

	Titulo += 	cDescMoeda + " DE " + DTOC(dDataIni) +				" ATE " + DTOC(dDataFim) + CtbTitSaldo(mv_par06)
Else
	Titulo := NewHead
EndIf







































If mv_par11 == 3
	nTamConta := Len(CT1->CT1_CODIMP)
Endif
If lAnalitico .And.  (lCusto .Or.  lItem .Or.  lCLVL)
	nTamConta := 30
EndIf
If ! lAnalitico
	aColunas := { 000, 019,    ,    ,    ,    , 068, 090, 111, 19, 091 }
Else
	If cPaisLoc == "CHI"
		If ((!lCusto .And.  !lItem .And.  !lCLVL) .And.  nTamConta<= 22)
  			aColunas := { 000, 030, 060,    ,    ,    , 84, 100, 115, 15, 097}
		Else
			aColunas := { 000, 030, 060, 092, 113, 134, 156, 178, 198, 20 ,178 }
		Endif
	Else
	   If ((!lCusto .And.  !lItem .And.  !lCLVL) .And.  nTamConta<=22)
	  		aColunas := { 000, 019, 060,    ,    ,    , 84, 100, 115, 15, 097}
	   Else
			aColunas := { 000, 019, 060, 092, 113, 134, 156, 178, 198, 20 ,178 }
	   Endif
	EndIf
Endif
If lAnalitico
	Cabec1 := "DATA"
	Cabec2 := ""
	If (!lCusto .And.  !lItem .And.  !lCLVL)
		If nTamConta <= 22
			Cabec2:= STR0031
		Else
		   Cabec2 := STR0032
	    EndIf
	Else
	 	Cabec2 := STR0013
		Cabec2 += Upper(cSayCusto) +Space(11)+Upper(cSayItem)+Space(11)+Upper(cSayClVl)+Space(26)
		Cabec2 += STR0029
   EndIf
Else
	lCusto := .F. 
	lItem  := .F. 
	lCLVL  := .F. 
	Cabec1 := STR0024
	Cabec2 := ""
EndIf

m_pag := mv_par22

If lImpLivro








	MsgMeter({|	oMeter, oText, oDlg, lEnd | CTBGerRaz(oMeter,oText,oDlg,lEnd,@cArqTmp,cContaIni,cContaFim,cCustoIni,cCustoFim, cItemIni,cItemFim,cCLVLIni,cCLVLFim,cMoeda,dDataIni,dDataFim, aSetOfBook,lNoMov,cSaldo,lJunta,"1",lAnalitico,,,aReturn[7],lSldAnt)}, "Criando Arquivo Temporário...",				"Emissao do Razao Contabil")

	dbSelectArea("CT2")
	If !Empty(dbFilter())
		dbClearFilter()
	Endif
	dbSelectArea("cArqTmp")
	SetRegua(RecCount())
	dbGoTop()
Endif



If lImpLivro
	If cArqTmp->(RecCount()) == 0 .And.  !Empty(aSetOfBook[5])
		dbCloseArea()
		FErase(cArqTmp+GetDBExtension())
		FErase(cArqTmp+OrdBagExt())
		Return
	EndIf
Endif

While lImpLivro .And.  !cArqTmp->(Eof())

	IF lEnd
		PrintOut(_PROW()+1,0,"***** CANCELADO PELO OPERADOR *****",,)
		Exit
	EndIF

	IncRegua()

	If lSldAntCC
		aSaldo    := SaldTotCT3(cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,cArqTmp->DATAL,cMoeda,cSaldo)
		aSaldoAnt := SaldTotCT3(cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,dDataIni,cMoeda,cSaldo)
	ElseIf lSldAntIt
		aSaldo    := SaldTotCT4(cItemIni,cItemFim,cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,cArqTmp->DATAL,cMoeda,cSaldo)
		aSaldoAnt := SaldTotCT4(cItemIni,cItemFim,cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,dDataIni,cMoeda,cSaldo)
	ElseIf lSldAntCv
		aSaldo    := SaldTotCTI(cClVlIni,cClVlFim,cItemIni,cItemFim,cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,cArqTmp->DATAL,cMoeda,cSaldo)
		aSaldoAnt := SaldTotCTI(cClVlIni,cClVlFim,cItemIni,cItemFim,cCustoIni,cCustoFim,cArqTmp->CONTA,cArqTmp->CONTA,dDataIni,cMoeda,cSaldo)
	Else
		aSaldo 		:= SaldoCT7(cArqTmp->CONTA,cArqTmp->DATAL,cMoeda,cSaldo)
		aSaldoAnt	:= SaldoCT7(cArqTmp->CONTA,dDataIni,cMoeda,cSaldo,"CTBR400")
	EndIf

	If !lNoMov
		If aSaldo[6] == 0 .And.  cArqTmp->LANCDEB ==0 .And.  cArqTmp->LANCCRD == 0
			dbSelectArea("cArqTmp")
			dbSkip()
			Loop
		Endif
	Endif

	If lNomov .And.  aSaldo[6] == 0 .And.  cArqTmp->LANCDEB ==0 .And.  cArqTmp->LANCCRD == 0
		If CtbExDtFim("CT1")
			dbSelectArea("CT1")
			dbSetOrder(1)
			If MsSeek(xFilial()+cArqTmp->CONTA)
				If !CtbVlDtFim("CT1",dDataIni)
					dbSelectArea("cArqTmp")
					dbSkip()
					Loop
	            EndIf

	            If !CtbVlDtIni("CT1",dDataFim)
					dbSelectArea("cArqTmp")
					dbSkip()
					Loop
	            EndIf

		    EndIf
		    dbSelectArea("cArqTmp")
		EndIf
	EndIf

	If li > nMaxLin .Or.  lSalto
		If lEmissUnica
			CtbQbPg( .F. ,@nPagIni,@nPagFim,@nReinicia,@m_pag,@nBloco,@nBlCount)
		Else
			If m_pag > nPagFim
				If lNewPAGFIM
					nPagFim := m_pag+nPagFim
					If l1StQb
						m_pag := nReinicia
						l1StQb := .F. 
					Endif
				Else
					m_pag := nReinicia
				Endif
			EndIf
		Endif
		CtCGCCabec(lItem,lCusto,lCLVL,Cabec1,Cabec2,dDataFim,Titulo,lAnalitico,"1",Tamanho)
		If !lFirst
			lQbPg	:= .T. 
		Else
			lFirst := .F. 
		Endif
	EndIf

	nSaldoAtu:= 0
	nTotDeb	:= 0
	nTotCrd	:= 0


	cContaSint := Ctr400Sint(cArqTmp->CONTA,@cDescSint,cMoeda,@cDescConta,@cCodRes)
	cNormal := CT1->CT1_NORMAL
	If mv_par11 == 3
		EntidadeCTB(CT1->CT1_CODIMP,li,000,nTamConta, .F. ,cMascara1,cSepara1)
		PrintOut(li,Len(CT1->CT1_CODIMP)," - "+cDescSint,,)
	Else
		EntidadeCTB(cContaSint,li,000,Len(cContaSint), .F. ,cMascara1,cSepara1)
		PrintOut(li,Len(cContaSint)," - "+cDescSint,,)
	Endif
	If lSalLin
		li+=2
	Else
		li+=1
	EndIf


	PrintOut(li,001,"CONTA - ",,)

	If mv_par11 == 1
		EntidadeCTB(cArqTmp->CONTA,li,9,nTamConta, .F. ,cMascara1,cSepara1)
	Else
		dbSelectArea("CT1")
		dbSetOrder(1)
		MsSeek(xFilial("CT1")+cArqTMP->CONTA, .F. )
		If mv_par11 == 3
			EntidadeCTB(CT1->CT1_CODIMP,li,9,nTamConta, .F. ,cMascara1,cSepara1)
		Else
			EntidadeCTB(CT1->CT1_RES,li,9,nTamConta, .F. ,cMascara1,cSepara1)
		EndIf
		cDescConta := &("CT1->CT1_DESC"+cMoeda)
	Endif
	If !lAnalitico
		PrintOut(li,9+nTamConta,"- "+Left(cDescConta,30),,)
	Else
		PrintOut(li,9+nTamConta,"- "+Left(cDescConta,38),,)
	Endif


	PrintOut(li,aColunas[11]-Len("SALDO ANTERIOR:")-1,"SALDO ANTERIOR:",,)



	ValorCTB(aSaldoAnt[6],li,aColunas[9],aColunas[10],nDecimais, .T. ,cPicture, , , , , , ,lPrintZero)

	nSaldoAtu := aSaldoAnt[6]
	If lSalLin
		li+=2
	Else
		li += 1
	EndIf
	dbSelectArea("cArqTmp")
	cContaAnt:= cArqTmp->CONTA
	dDataAnt	:= CTOD("  /  /  ")
	While cArqTmp->(!Eof()) .And.  cArqTmp->CONTA == cContaAnt

		If li > nMaxLin
			If lSalLin
				li++
			EndIf


			PrintOut(li,aColunas[11]-Len("A TRANSPORTAR :")-1,"A TRANSPORTAR :",,)

			ValorCTB(nSaldoAtu,li,aColunas[9], aColunas[10],nDecimais, .T. ,cPicture,cNormal , , , , , ,lPrintZero)

			If lEmissUnica
				CtbQbPg( .F. ,@nPagIni,@nPagFim,@nReinicia,@m_pag,@nBloco,@nBlCount)
			Else
				If m_pag > nPagFim
					If lNewPAGFIM
						nPagFim := m_pag+nPagFim
						If l1StQb
							m_pag := nReinicia
							l1StQb := .F. 
						Endif
					Else
						m_pag := nReinicia
					Endif
				EndIf
			Endif
			CtCGCCabec(lItem,lCusto,lCLVL,Cabec1,Cabec2,dDataFim,Titulo,lAnalitico,"1",Tamanho)
			lQbPg := .T. 

			PrintOut(li,001,"CONTA - ",,)

			If mv_par11 == 1
				EntidadeCTB(cArqTmp->CONTA,li,9,nTamConta, .F. ,cMascara1,cSepara1)
			Else
				dbSelectArea("CT1")
				dbSetOrder(1)
				MsSeek(xFilial("CT1")+cArqTMP->CONTA, .F. )
				If mv_par11 == 3
					EntidadeCTB(CT1->CT1_CODIMP,li,9,nTamConta, .F. ,cMascara1,cSepara1)
				Else
					EntidadeCTB(CT1->CT1_RES,li,9,nTamConta, .F. ,cMascara1,cSepara1)
				EndIf
				cDescConta := &("CT1->CT1_DESC"+cMoeda)
			Endif
			PrintOut(li,9+nTamConta,"- "+Left(cDescConta,38),,)

			PrintOut(li,aColunas[11]-Len("DE TRANSPORTE :")-1,"DE TRANSPORTE :",,)
			ValorCTB(nSaldoAtu,li,aColunas[9],aColunas[10],nDecimais, .T. ,cPicture,cNormal , , , , , ,lPrintZero)
			li+= 2
		EndIf



		If dDataAnt <> cArqTmp->DATAL
			If (cArqTmp->LANCDEB <> 0 .Or.  cArqTmp->LANCCRD <> 0)
				If lAnalitico
					PrintOut(li,000,cArqTmp->DATAL,,)
					li++
				Else
					PrintOut(li,000,cArqTmp->DATAL,,)
				Endif
			Endif
			dDataAnt := cArqTmp->DATAL
			lQbPg := .F. 
		ElseIf lQbPg
			PrintOut(li,000,dDataAnt,,)
			li++
			lQbPg := .F. 
		EndIf

		If lAnalitico
			nSaldoAtu 	:= nSaldoAtu - cArqTmp->LANCDEB + cArqTmp->LANCCRD
			nTotDeb		+= cArqTmp->LANCDEB
			nTotCrd		+= cArqTmp->LANCCRD
			nTotGerDeb	+= cArqTmp->LANCDEB
			nTotGerCrd	+= cArqTmp->LANCCRD

			dbSelectArea("CT1")
			dbSetOrder(1)
			MsSeek(xFilial("CT1")+cArqTmp->XPARTIDA)
			cCodRes := CT1->CT1_RES
			dbSelectArea("cArqTmp")

			If cPaisLoc == "CHI"
				PrintOut(li,aColunas[1],cArqTmp->LOTE+cArqTmp->SUBLOTE+cArqTmp->DOC+cArqTmp->LINHA+" "+cArqTmp->SEGOFI,,)
				PrintOut(li,aColunas[2],Subs(cArqTmp->HISTORICO,1,30),,)
			Else
				PrintOut(li,aColunas[1],cArqTmp->LOTE+cArqTmp->SUBLOTE+cArqTmp->DOC+cArqTmp->LINHA,,)
				PrintOut(li,aColunas[2],Subs(cArqTmp->HISTORICO,1,40),,)
			EndIf

			If mv_par11 == 1
				EntidadeCTB(cArqTmp->XPARTIDA,li,aColunas[3], nTamConta , .F. ,cMascara1 ,cSepara1)
			ElseIf mv_par11 == 3
				EntidadeCTB(CT1->CT1_CODIMP,li,aColunas[3],nTamConta, .F. , cMascara1 ,cSepara1)
			Else
				EntidadeCTB(CT1->CT1_RES,li,aColunas[3],17, .F. , cMascara1 ,cSepara1)
			Endif

			If lCusto
				If mv_par25 == 1
					EntidadeCTB(cArqTmp->CCUSTO,li,aColunas[4],17, .F. ,cMascara2,cSepara2)
				Else
					dbSelectArea("CTT")
					dbSetOrder(1)
					dbSeek(xFilial("CTT")+cArqTmp->CCUSTO)
					cResCC := CTT->CTT_RES
					EntidadeCTB(cResCC,li,aColunas[4],17, .F. ,cMascara2,cSepara2)
					dbSelectArea("cArqTmp")
				Endif
			Endif

			If lItem
				If mv_par26 == 1
					EntidadeCTB(cArqTmp->ITEM,li,aColunas[5],17, .F. ,cMascara3,cSepara3)
				Else
					dbSelectArea("CTD")
					dbSetOrder(1)
					dbSeek(xFilial("CTD")+cArqTmp->ITEM)
					cResItem := CTD->CTD_RES
					EntidadeCTB(cResItem,li,aColunas[5],17, .F. ,cMascara3,cSepara3)
					dbSelectArea("cArqTmp")
				Endif
			Endif

			If lCLVL
				If mv_par27 == 1
					EntidadeCTB(cArqTmp->CLVL,li,aColunas[6],17, .F. ,cMascara4,cSepara4)
				Else
					dbSelectArea("CTH")
					dbSetOrder(1)
					dbSeek(xFilial("CTH")+cArqTmp->CLVL)
					cResClVl := CTH->CTH_RES
					EntidadeCTB(cResClVl,li,aColunas[6],17, .F. ,cMascara4,cSepara4)
					dbSelectArea("cArqTmp")
				Endif
			Endif


			ValorCTB(cArqTmp->LANCDEB,li,aColunas[7], aColunas[10],nDecimais, .F. ,cPicture,"1", , , , , ,lPrintZero)

			ValorCTB(cArqTmp->LANCCRD,li,aColunas[8], aColunas[10],nDecimais, .F. ,cPicture,"2", , , , , ,lPrintZero)

			ValorCTB(nSaldoAtu,li,aColunas[9], aColunas[10],nDecimais, .T. ,cPicture,cNormal, , , , , ,lPrintZero)


			dbSelectArea("CT2")
			dbSetOrder(10)
			If MsSeek(xFilial("CT2")+cArqTMP->(DTOS(DATAL)+LOTE+SUBLOTE+DOC+SEQLAN+EMPORI+FILORI), .F. )

				dbSkip()
				If CT2->CT2_DC == "4"








					While !CT2->(Eof()) .And.  CT2->CT2_FILIAL == xFilial("CT2") .And.  CT2->CT2_LOTE == cArqTMP->LOTE .And.  CT2->CT2_SBLOTE == cArqTMP->SUBLOTE .And.  CT2->CT2_DOC == cArqTmp->DOC .And.  CT2->CT2_SEQLAN == cArqTmp->SEQLAN .And.  CT2->CT2_EMPORI == cArqTmp->EMPORI .And.  CT2->CT2_FILORI == cArqTmp->FILORI .And.  CT2->CT2_DC == "4" .And.  DTOS(CT2->CT2_DATA) == DTOS(cArqTmp->DATAL)
						li++
						If li > nMaxLin


							If lSalLin
								li++
							EndIf

							PrintOut(li,aColunas[11]-Len("A TRANSPORTAR :")-1,"A TRANSPORTAR :",,)
							ValorCTB(nSaldoAtu,li,aColunas[9],aColunas[10],nDecimais, .T. ,cPicture,cNormal, , , , , ,lPrintZero)


							If lEmissUnica
								CtbQbPg( .F. ,@nPagIni,@nPagFim,@nReinicia,@m_pag,@nBloco,@nBlCount)
							Else
								If m_pag > nPagFim
									If lNewPAGFIM
										nPagFim := m_pag+nPagFim
										If l1StQb
											m_pag := nReinicia
											l1StQb := .F. 
										Endif
									Else
										m_pag := nReinicia
									Endif
								EndIf
							Endif
							CtCGCCabec(lItem,lCusto,lCLVL,Cabec1,Cabec2,dDataFim,Titulo,lAnalitico,"1",Tamanho)


							PrintOut(li,001,"CONTA - ",,)

							If mv_par11 == 1
								EntidadeCTB(cArqTmp->CONTA,li,9,nTamConta, .F. ,cMascara1,cSepara1)
							Else
								dbSelectArea("CT1")
								dbSetOrder(1)
								MsSeek(xFilial("CT1")+cArqTMP->CONTA, .F. )
								If mv_par11 == 3
									EntidadeCTB(CT1->CT1_CODIMP,li,9,nTamConta, .F. ,cMascara1,cSepara1)
								Else
									EntidadeCTB(CT1->CT1_RES,li,9,nTamConta, .F. ,cMascara1,cSepara1)
								Endif
								cDescConta := &("CT1->CT1_DESC"+cMoeda)
								dbSelectArea("CT2")
							EndIf
							PrintOut(li,9+nTamConta,"- "+Left(cDescConta,38),,)

							PrintOut(li,aColunas[11]-Len("DE TRANSPORTE :")-1,"DE TRANSPORTE :",,)
							ValorCTB(nSaldoAtu,li,aColunas[9],aColunas[10],nDecimais, .T. ,cPicture,cNormal , , , , , ,lPrintZero)
							li+= 2


							If !lFirst
								PrintOut(li,000,dDataAnt,,)
								li++
							Else
								lFirst := .F. 
							Endif

						EndIf
						PrintOut(li,aColunas[1],Space(15)+CT2->CT2_LINHA,,)
						PrintOut(li,aColunas[2],Subs(CT2->CT2_HIST,1,40),,)




						cArqTmp->( RecLock("cArqTmp", .f. ) )
						cArqTmp->HISTORICO := AllTrim(cArqTmp->HISTORICO)+" "+AllTrim( Subs(CT2->CT2_HIST,1,40) )

						nAxoZC := Ascan( aStrZC, { |y| Trim(y[1]) == Trim( CT2->ct2_LOTE )  } )
						If nAxoZC > 0
						   _FIELD->ID_PROVIS := aStrZC[nAxoZC][2]
						EndIf
						cArqTmp->( MsUnLock("cArqTmp") )

						CT2->(dbSkip())
					EndDo
				EndIf
			EndIf
			dbSelectArea("cArqTmp")
			dbSkip()
		Else
			dbSelectArea("cArqTmp")
			While dDataAnt == cArqTmp->DATAL .And.  cContaAnt == cArqTmp->CONTA
				nVlrDeb	+= cArqTmp->LANCDEB
				nVlrCrd	+= cArqTmp->LANCCRD
				nTotGerDeb	+= cArqTmp->LANCDEB
				nTotGerCrd	+= cArqTmp->LANCCRD
				dbSkip()
			End
			nSaldoAtu	:= nSaldoAtu - nVlrDeb + nVlrCrd

			ValorCTB(nVlrDeb,li,aColunas[7],aColunas[10], nDecimais, .F. ,cPicture,"1", , , , , ,lPrintZero)

			ValorCTB(nVlrCrd,li,aColunas[8],aColunas[10], nDecimais, .F. ,cPicture,"2", , , , , ,lPrintZero)

			ValorCTB(nSaldoAtu,li,aColunas[9],aColunas[10], nDecimais, .T. ,cPicture,cNormal, , , , , ,lPrintZero)
			nTotDeb		+= nVlrDeb
			nTotCrd		+= nVlrCrd
			nVlrDeb	:= 0
			nVlrCrd	:= 0
		Endif
		dbSelectArea("cArqTmp")

		li++
	EndDo

   	If lSalLin
		li+=2
	EndIf
	If li > nMaxLin
		If lSalLin
			li++
		EndIf


		PrintOut(li,aColunas[11]-Len("A TRANSPORTAR :")-1,"A TRANSPORTAR :",,)

		ValorCTB(nSaldoAtu,li,aColunas[9], aColunas[10],nDecimais, .T. ,cPicture,cNormal, , , , , ,lPrintZero)

		If lEmissUnica
			CtbQbPg( .F. ,@nPagIni,@nPagFim,@nReinicia,@m_pag,@nBloco,@nBlCount)
		Else
			If m_pag > nPagFim
				If lNewPAGFIM
					nPagFim := m_pag+nPagFim
					If l1StQb
						m_pag := nReinicia
						l1StQb := .F. 
					Endif
				Else
					m_pag := nReinicia
				Endif
			EndIf
		Endif
		CtCGCCabec(lItem,lCusto,lCLVL,Cabec1,Cabec2,dDataFim,Titulo,lAnalitico,"1",Tamanho)
		If !lFirst
			lQbPg := .T. 
		Else
			lFirst := .F. 
		Endif

		PrintOut(li,001,"CONTA - ",,)

		If Empty(cContaAnt) .or.  cArqTMP->CONTA == cContaAnt
			If mv_par11 == 1
				EntidadeCTB(cArqTmp->CONTA,li,9,nTamConta, .F. ,cMascara1,cSepara1)
			Else
				dbSelectArea("CT1")
				dbSetOrder(1)
				MsSeek(xFilial("CT1")+cArqTMP->CONTA, .F. )
				If mv_par11 == 3
					EntidadeCTB(CT1->CT1_CODIMP,li,9,nTamConta, .F. ,cMascara1,cSepara1)
				Else
					EntidadeCTB(CT1->CT1_RES,li,9,nTamConta, .F. ,cMascara1,cSepara1)
				EndIf
			Endif
		Else
			dbSelectArea("CT1")
			dbSetOrder(1)
			If MsSeek(xFilial("CT1")+cContaAnt, .F. )
				If mv_par11 == 1
					EntidadeCTB(cContaAnt,li,9,nTamConta, .F. ,cMascara1,cSepara1)
				ElseIf mv_par11 == 3
					EntidadeCTB(CT1->CT1_CODIMP,li,9,nTamConta, .F. ,cMascara1,cSepara1)
				Else
					EntidadeCTB(CT1->CT1_RES,li,9,nTamConta, .F. ,cMascara1,cSepara1)
				EndIf
			Endif
		Endif
		cDescConta := &("CT1->CT1_DESC"+cMoeda)
		PrintOut(li,9+nTamConta,"- "+Left(cDescConta,38),,)

		PrintOut(li,aColunas[11]-Len("DE TRANSPORTE :")-1,"DE TRANSPORTE :",,)
		ValorCTB(nSaldoAtu,li,aColunas[9],aColunas[10],nDecimais, .T. ,cPicture,cNormal, , , , , ,lPrintZero)

		If lSalLin
			li+=2
		Else
			li+= 1
		EndIf

		If lQbPg
			If cArqtmp->(!Eof()) .And.  cArqTmp->CONTA == cContaAnt
				PrintOut(li,000,dDataAnt,,)
			EndIf
			li++
			lQbPg := .F. 
		Endif
   EndIf

	PrintOut(li,aColunas[If(lAnalitico,2,1)],"T o t a i s  d a  C o n t a  ==> ",,)


	ValorCTB(nTotDeb,li,aColunas[7],aColunas[10],nDecimais, .F. ,cPicture,"1", , , , , ,lPrintZero)

	ValorCTB(nTotCrd,li,aColunas[8],aColunas[10],nDecimais, .F. ,cPicture,"2", , , , , ,lPrintZero)

	ValorCTB(nSaldoAtu,li,aColunas[9],aColunas[10],nDecimais, .T. ,cPicture,cNormal, , , , , ,lPrintZero)

	li++
	PrintOut(li,00,Replicate("-",nTamLinha),,)
	li++
	dbSelectArea("cArqTMP")
EndDo

If li <> 80 .And.  lImpLivro .And.  mv_par28 == 1
    PrintOut(li,30,"T O T A L  G E R A L ==> ",,)
	If lAnalitico .And.  (lCusto .Or.  lItem .Or.  lClVl)
		ValorCTB(nTotGerDeb,li,aColunas[7],aColunas[10],nDecimais, .F. ,cPicture,"1", , , , , ,lPrintZero)
		ValorCTB(nTotGerCrd,li,aColunas[8],aColunas[10],nDecimais, .F. ,cPicture,"2", , , , , ,lPrintZero)
		li++
		PrintOut(li,00,Replicate("-",nTamLinha),,)
	Else
		ValorCTB(nTotGerDeb,li,aColunas[7],aColunas[10],nDecimais, .F. ,cPicture,"1", , , , , ,lPrintZero)
		ValorCTB(nTotGerCrd,li,aColunas[8],aColunas[10],nDecimais, .F. ,cPicture,"2", , , , , ,lPrintZero)
		li++
		PrintOut(li,00,Replicate("-",nTamLinha),,)
	Endif
Endif

nLinAst := GetNewPar("MV_INUTLIN",0)
If li < nMaxLin .and.  nLinAst <> 0 .and.  !lEnd
	For nInutLin := 1 to nLinAst
		li++
		PrintOut(li,00,REPLICATE("*",LIMITE),,)
		If li == nMaxLin
			Exit
		EndIf
	Next
EndIf

If li <= nMaxLin .and.  !lEnd .and.  !lImpTermos
	Roda(cbCont,cbTxt,Tamanho)
EndIf

If lImpTermos

	cArqAbert:=GetNewPar("MV_LRAZABE","")
	cArqEncer:=GetNewPar("MV_LRAZENC","")

    If Empty(cArqAbert)

		ApMsgAlert(	"Devem ser criados os parametros MV_LRAZABE e MV_LRAZENC. " +						"Utilize como base o parametro MV_LDIARAB.")
	Endif
Endif

If lImpTermos .And.  ! Empty(cArqAbert)
	li+=2
	dbSelectArea("SM0")
	aVariaveis:={}

	For nCont:=1 to FCount()
		If FieldName(nCont)=="M0_CGC"
			AADD(aVariaveis,{FieldName(nCont),Transform(FieldGet(nCont),"@R 99.999.999/9999-99")})
		Else
            If FieldName(nCont)=="M0_NOME"
                Loop
            EndIf
			AADD(aVariaveis,{FieldName(nCont),FieldGet(nCont)})
		Endif
	Next

	dbSelectArea("SX1")
	dbSeek("CTR400"+"01")

	While SX1->X1_GRUPO=="CTR400"
		AADD(aVariaveis,{Rtrim(Upper(X1_VAR01)),&(X1_VAR01)})
		dbSkip()
	End

	If !File(cArqAbert)
		aSavSet:=__SetSets()
		cArqAbert:=CFGX024(,"Razão")
		__SetSets(aSavSet)
		Set(24,Set(24), .t. )
	Endif

	If !File(cArqEncer)
		aSavSet:=__SetSets()
		cArqEncer:=CFGX024(,"Razão")
		__SetSets(aSavSet)
		Set(24,Set(24), .t. )
	Endif

	If cArqAbert#NIL
		ImpTerm(cArqAbert,aVariaveis,AvalImp(132))
	Endif

	If cArqEncer#NIL
		ImpTerm(cArqEncer,aVariaveis,AvalImp(132))
	Endif
Endif









Private cDirDocs := MsDocPath()
Private cTmpTxt  := CriaTrab(Nil, .f. )
Private cCmd     := cDirDocs+"\"+cTmpTxt+".txt"
Private cPosic   := ""

	IncRegua()

	cArqTmp->( DbGoTop() )

	While !cArqTmp->( Eof() )

	    cArqTmp->( RecLock("cArqTmp", .f. ) )

	    cArqTmp->DESCCON    := Posicione( "CT1", 1,xFilial("CT1")+cArqTmp->CONTA, "CT1_DESC01" )
	    cArqTmp->XPARTIDADS := Posicione( "CT1", 1,xFilial("CT1")+cArqTmp->XPARTIDA, "CT1_DESC01" )




		If CT2->( FieldPos("CT2_X_USRI") ) > 0
			cPosic := " SELECT CT2_USERGA, CT2_X_USRI, CT2_X_DTIN, CT2_X_HRIN, CT2_X_HRUP, CT2_X_USRA, CT2_X_DTAL "
			cPosic += " FROM "+RetSqlName("CT2")
			cPosic += " WHERE CT2_FILIAL = '"+xFilial("CT2")  +"' "
			cPosic += " AND   CT2_DATA   = '"+Dtos(cArqTmp->DATAL)+"' "
			cPosic += " AND   CT2_LOTE   = '"+cArqTmp->LOTE   +"' "
			cPosic += " AND   CT2_SBLOTE = '"+cArqTmp->SUBLOTE+"' "
			cPosic += " AND   CT2_DOC    = '"+cArqTmp->DOC    +"' "
			cPosic += " AND   CT2_LINHA  = '"+cArqTmp->LINHA  +"' "
			cPosic += " AND   CT2_EMPORI = '"+cArqTmp->EMPORI +"' "
			cPosic += " AND   CT2_FILORI = '"+cArqTmp->FILORI +"' "
			cPosic += " AND   CT2_SEQHIS = '"+cArqTmp->SEQHIST+"' "
			cPosic += " AND   CT2_SEQLAN = '"+cArqTmp->SEQLAN +"' "
			cPosic += " AND   D_E_L_E_T_ = ' ' "

			U_MontaView( cPosic, cTmpTxt )

			(cTmpTxt)->( DbGoTop() )








			cArqTmp->USERINC := (cTmpTxt)->CT2_X_USRI
			cArqTmp->DTINC   := Stod((cTmpTxt)->CT2_X_DTIN)
			cArqTmp->HRINC   := (cTmpTxt)->CT2_X_HRIN
			cArqTmp->USERUPD := (cTmpTxt)->CT2_X_USRA
			cArqTmp->DTUPD   := Stod((cTmpTxt)->CT2_X_DTAL)
			cArqTmp->HRUPD   := (cTmpTxt)->CT2_X_HRUP
		EndIf

	    cArqTmp->( MsUnLock() )

		cArqTmp->( DbSkip() )

	EndDo



	cArqTmp->( DbGoTop() )
	DbSelectArea("cArqTmp")

	__dbDelim( .T. ,(cCmd) , , { },,,,,.F. )

	lSucesso := __CopyFile(cCmd, cArquivo)

	If !lSucesso
	    Alert("Nao foi possivel copiar o arquivo "+cArquivo)
	Else
	    Alert("Verificar o arquivo "+cArquivo)
	EndIf

	Ferase( cCmd )

If Select("cAliasCT2") > 0
	cAliasCT2->( DbCloseArea() )
EndIf

If lImpLivro
	dbSelectArea("cArqTmp")
	dbClearFilter()
	dbCloseArea()
	If Select("cArqTmp") == 0
		FErase(cArqTmp+GetDBExtension())
		FErase(cArqTmp+OrdBagExt())
	EndIf
Endif

dbselectArea("CT2")

MS_FLUSH()

Return
















































STATIC Function CtbGerRaz(oMeter,oText,oDlg,lEnd,cArqTmp,cContaIni,cContaFim,cCustoIni,cCustoFim, cItemIni,cItemFim,cCLVLIni,cCLVLFim,cMoeda,dDataIni,dDataFim, aSetOfBook,lNoMov,cSaldo,lJunta,cTipo,lAnalit,c2Moeda, nTipo,cUFilter,lSldAnt)

Local aTamConta	:= TAMSX3("CT1_CONTA")
Local aTamCusto	:= TAMSX3("CT3_CUSTO")
Local aTamVal	:= TAMSX3("CT2_VALOR")
Local aCtbMoeda	:= {}
Local aSaveArea := GetArea()
Local aCampos

Local cChave

Local nTamHist	:= Len(CriaVar("CT2_HIST"))
Local nTamItem	:= Len(CriaVar("CTD_ITEM"))
Local nTamCLVL	:= Len(CriaVar("CTH_CLVL"))
Local nDecimais	:= 0
Local cMensagem		:= "O plano gerencial nao esta disponivel nesse relatorio."

c2Moeda := If( c2Moeda == nil, "", c2Moeda ) ;
nTipo := If( nTipo == nil, 1, nTipo ) ;
cUFilter := If( cUFilter == nil, "", cUFilter ) ;
lSldAnt := If( lSldAnt == nil, .F. , lSldAnt ) ;

	If TcSrvType() <> "AS/400" .And.  cTipo == "1" .And.  FunName() == "CTBR400" .And.  TCGetDb() $ "MSSQL7/MSSQL"
		cUFilter := If( cUFilter == nil, ".T.", cUFilter ) ;
    Else

	cUFilter := If( cUFilter == nil, "", cUFilter ) ;

	Endif


aCtbMoeda := CTbMoeda(cMoeda)
nDecimais := aCtbMoeda[5]































aCampos :={	{ "CONTA"		, "C", aTamConta[1], 0 },			{ "DESCCON"    	, "C", TamSX3("CT1_DESC01")[1] , 0 },			{ "XPARTIDA"   	, "C", aTamConta[1] , 0 },			{ "XPARTIDADS" 	, "C", TamSX3("CT1_DESC01")[1] , 0 },			{ "TIPO"       	, "C", 01			, 0 },			{ "LANCDEB"		, "N", aTamVal[1]+2, nDecimais },			{ "LANCCRD"		, "N", aTamVal[1]+2	, nDecimais },			{ "SALDOSCR"	, "N", aTamVal[1]+2, nDecimais },			{ "TPSLDANT"	, "C", 01, 0 },			{ "TPSLDATU"	, "C", 01, 0 },			{ "HISTORICO"	, "C", 160      	, 0 },			{ "CCUSTO"		, "C", aTamCusto[1], 0 },			{ "ITEM"		, "C", nTamItem		, 0 },			{ "CLVL"		, "C", nTamCLVL		, 0 },			{ "DATAL"		, "D", 10			, 0 },			{ "LOTE" 		, "C", 06			, 0 },			{ "SUBLOTE" 	, "C", 03			, 0 },			{ "DOC" 		, "C", 06			, 0 },			{ "LINHA"		, "C", 03			, 0 },			{ "SEQLAN"		, "C", 03			, 0 },			{ "SEQHIST"		, "C", 03			, 0 },			{ "EMPORI"		, "C", 02			, 0 },			{ "FILORI"		, "C", 02			, 0 },			{ "ID_PROVIS"	, "C", 04      	    , 0 },			{ "USERINC"     , "C", 30      	    , 0 },			{ "DTINC"       , "D", 08      	    , 0 },			{ "HRINC"       , "C", 08      	    , 0 },			{ "USERUPD"     , "C", 30      	    , 0 },			{ "DTUPD"       , "D", 08      	    , 0 },			{ "HRUPD"       , "C", 08      	    , 0 },			{ "NOMOV"		, "L", 01			, 0 }}

If cPaisLoc = "CHI"
	Aadd(aCampos,{"SEGOFI","C",TamSx3("CT2_SEGOFI")[1],0})
EndIf
If ! Empty(c2Moeda)
	Aadd(aCampos, { "LANCDEB_1"	, "N", aTamVal[1]+2, nDecimais })
	Aadd(aCampos, { "LANCCRD_1"	, "N", aTamVal[1]+2, nDecimais })
	Aadd(aCampos, { "TXDEBITO"	, "N", aTamVal[1]+2, 6 })
	Aadd(aCampos, { "TXCREDITO"	, "N", aTamVal[1]+2, 6 })
Endif

cArqTmp := CriaTrab(aCampos, .T. )
If ( Select ( "cArqTmp" ) <> 0 )
	dbSelectArea ( "cArqTmp" )
	dbCloseArea ()
Endif

dbUseArea( .T. ,, cArqTmp, "cArqTmp", .F. , .F.  )




If cTipo == "1"
    If FunName() <> "CTBC400"
		cChave   := "CONTA+DTOS(DATAL)+LOTE+SUBLOTE+DOC+LINHA+EMPORI+FILORI"
	Else
		cChave   := "CONTA+DTOS(DATAL)+LOTE+SUBLOTE+DOC+EMPORI+FILORI+LINHA"
	EndIf
ElseIf cTipo == "2"
	If lAnalit
		If FunName() <> "CTBC440"
			cChave 	:= "CCUSTO+CONTA+DTOS(DATAL)+LOTE+SUBLOTE+DOC+LINHA+EMPORI+FILORI"
		Else
			cChave 	:= "CCUSTO+CONTA+DTOS(DATAL)+LOTE+SUBLOTE+DOC+EMPORI+FILORI+LINHA"
		EndIf
	Else
		cChave 	:= "CCUSTO+DTOS(DATAL)+LOTE+SUBLOTE+DOC+LINHA+EMPORI+FILORI"
	Endif
ElseIf cTipo == "3"
	If lAnalit
		If FunName() <> "CTBC480"
			cChave 	:= "ITEM+CONTA+DTOS(DATAL)+LOTE+SUBLOTE+DOC+LINHA+EMPORI+FILORI"
		Else
			cChave 	:= "ITEM+CONTA+DTOS(DATAL)+LOTE+SUBLOTE+DOC+EMPORI+FILORI+LINHA"
		Endif
	Else
		cChave 	:= "ITEM+DTOS(DATAL)+LOTE+SUBLOTE+DOC+LINHA+EMPORI+FILORI"
	Endif
ElseIf cTipo == "4"
	If lAnalit
		If FunName() <> "CTBC490"
			cChave 	:= "CLVL+CONTA+DTOS(DATAL)+LOTE+SUBLOTE+DOC+LINHA+EMPORI+FILORI"
		Else
			cChave 	:= "CLVL+CONTA+DTOS(DATAL)+LOTE+SUBLOTE+DOC+EMPORI+FILORI+LINHA"
		EndIf
	Else
		cChave 	:= "CLVL+DTOS(DATAL)+LOTE+SUBLOTE+DOC+LINHA+EMPORI+FILORI"
	Endif
EndIf

IndRegua("cArqTmp",cArqTmp,cChave,,,"Selecionando Registros...")
dbSelectArea("cArqTmp")
dbSetIndex(cArqTmp+OrdBagExt())
dbSetOrder(1)

If !Empty(aSetOfBook[5])
	MsgAlert(cMensagem)
	Return
EndIf



	If TcSrvType() <> "AS/400" .And.  cTipo == "1" .And.  FunName() == "CTBR400" .And.  TCGetDb() $ "MSSQL7/MSSQL"


		CtbQryRaz(oMeter,oText,oDlg,lEnd,cContaIni,cContaFim,cCustoIni,cCustoFim, cItemIni,cItemFim,cCLVLIni,cCLVLFim,cMoeda,dDataIni,dDataFim, aSetOfBook,lNoMov,cSaldo,lJunta,cTipo,c2Moeda,cUFilter,lSldAnt)
	Else




	CtbRazao(oMeter,oText,oDlg,lEnd,cContaIni,cContaFim,cCustoIni,cCustoFim, cItemIni,cItemFim,cCLVLIni,cCLVLFim,cMoeda,dDataIni,dDataFim, aSetOfBook,lNoMov,cSaldo,lJunta,cTipo,c2Moeda,nTipo,cUFilter,lSldAnt)

	EndIf


RestArea(aSaveArea)

Return cArqTmp













































STATIC Function CtbRazao(oMeter,oText,oDlg,lEnd,cContaIni,cContaFim,cCustoIni,cCustoFim, cItemIni,cItemFim,cCLVLIni,cCLVLFim,cMoeda,dDataIni,dDataFim, aSetOfBook,lNoMov,cSaldo,lJunta,cTipo,c2Moeda,nTipo,cUFilter,lSldAnt)

Local cCpoChave	:= ""
Local cTmpChave	:= ""
Local cContaI	:= ""
Local cContaF	:= ""
Local cCustoI	:= ""
Local cCustoF	:= ""
Local cItemI	:= ""
Local cItemF	:= ""
Local cClVlI	:= ""
Local cClVlF	:= ""
Local cVldEnt	:= ""
Local cAlias	:= ""
Local lUFilter	:= !Empty(cUFilter)
Local cFilMoeda	:= ""
Local cAliasCT2	:= "CT2"
Local bCond		:= {|| .T. }


	Local cQuery	:= ""
	Local cOrderBy	:= ""
	Local nI	:= 0
	Local aStru	:= {}


cUFilter := If( cUFilter == nil, ".T.", cUFilter ) ;
lSldAnt := If( lSldAnt == nil, .F. , lSldAnt ) ;

cCustoI	:= CCUSTOINI
cCustoF := CCUSTOFIM
cContaI	:= CCONTAINI
cContaF := CCONTAFIM
cItemI	:= CITEMINI
cItemF 	:= CITEMFIM
cClvlI	:= CCLVLINI
cClVlF 	:= CCLVLFIM


	If TcSrvType() <> "AS/400"
		If !Empty(c2Moeda)
			cFilMoeda	:= " (CT2_MOEDLC = '" + cMoeda + "' OR "
			cFilMoeda	+= " CT2_MOEDLC = '" + c2Moeda + "') "
		Else
			cFilMoeda	:= " CT2_MOEDLC = '" + cMoeda + "' "
		EndIf
	Else

	If !Empty(c2Moeda)
		cFilMoeda	:= " (CT2_MOEDLC = '" + cMoeda + "' .Or. "
		cFilMoeda	+= " CT2_MOEDLC = '" + c2Moeda + "') "
	Else
		cFilMoeda	:= " CT2_MOEDLC = '" + cMoeda + "' "
	EndIf

	EndIf


oMeter:nTotal := CT1->(RecCount())





If cTipo <> "1"
	If cTipo = "2" .And.  Empty(cCustoIni)
		CTT->(DbSeek(xFilial("CTT")))
		cCustoIni := CTT->CTT_CUSTO
	Endif
	If cTipo = "3" .And.  Empty(cItemIni)
		CTD->(DbSeek(xFilial("CTD")))
		cItemIni := CTD->CTD_ITEM
	Endif
	If cTipo = "4" .And.  Empty(cClVlIni)
		CTH->(DbSeek(xFilial("CTH")))
		cClVlIni := CTH->CTH_CLVL
	Endif
Endif


	If TcSrvType() <> "AS/400"

		If cTipo == "1"
			dbSelectArea("CT2")
			dbSetOrder(2)

			cValid	:= 	"CT2_DEBITO>='" + cContaIni + "' AND " + "CT2_DEBITO<='" + cContaFim + "'"





			cVldEnt := 	"CT2_CCD>='" + cCustoIni + "' AND " + "CT2_CCD<='" + cCustoFim + "' AND " + "CT2_ITEMD>='" + cItemIni + "' AND " + "CT2_ITEMD<='" + cItemFim + "' AND " + "CT2_CLVLDB>='" + cClVlIni + "' AND " + "CT2_CLVLDB<='" + cClVlFim + "'"
			cOrderBy:= " CT2_FILIAL, CT2_DEBITO, CT2_DATA "
		ElseIf cTipo == "2"
			dbSelectArea("CT2")
			dbSetOrder(4)

			cValid	:= 	"CT2_CCD >= '" + cCustoIni + "'  AND  " + "CT2_CCD <= '" + cCustoFim + "'"





			cVldEnt := 	"CT2_DEBITO >= '" + cContaIni + "'  AND  " + "CT2_DEBITO <= '" + cContaFim + "'  AND  " + "CT2_ITEMD >= '" + cItemIni + "'  AND  " + "CT2_ITEMD <= '" + cItemFim + "'  AND  " + "CT2_CLVLDB >= '" + cClVlIni + "'  AND  " + "CT2_CLVLDB <= '" + cClVlFim + "'"
			cOrderBy:= " CT2_FILIAL, CT2_CCD, CT2_DATA "
		ElseIf cTipo == "3"
			dbSelectArea("CT2")
			dbSetOrder(6)

			cValid 	:= 	"CT2_ITEMD >= '" + cItemIni + "'  AND  " + "CT2_ITEMD <= '" + cItemFim + "'"





			cVldEnt	:= 	"CT2_DEBITO >= '" + cContaIni + "'  AND  " + "CT2_DEBITO <= '" + cContaFim + "'  AND  " + "CT2_CCD >= '" + cCustoIni + "'  AND  " + "CT2_CCD <= '" + cCustoFim + "'  AND  " + "CT2_CLVLDB >= '" + cClVlIni + "'  AND  " + "CT2_CLVLDB <= '" + cClVlFim + "'"
			cOrderBy:= " CT2_FILIAL, CT2_ITEMD, CT2_DATA "
		ElseIf cTipo == "4"
			dbSelectArea("CT2")
			dbSetOrder(8)

			cValid 	:= 	"CT2_CLVLDB >= '" + cClVlIni + "'  AND  " + "CT2_CLVLDB <= '" + cClVlFim + "'"





			cVldEnt	:= 	"CT2_DEBITO >= '" + cContaIni + "'  AND  " + "CT2_DEBITO <= '" + cContaFim + "'  AND  " + "CT2_CCD >= '" + cCustoIni + "'  AND  " + "CT2_CCD <= '" + cCustoFim + "'  AND  " + "CT2_ITEMD >= '" + cItemIni + "'  AND  " + "CT2_ITEMD <= '" + cItemFim + "'"
			cOrderBy:= " CT2_FILIAL, CT2_CLVLDB, CT2_DATA "
		EndIf

		cAliasCT2	:= "cAliasCT2"

		cQuery	:= " SELECT * "
		cQuery	+= " FROM " + RetSqlName("CT2")
		cQuery	+= " WHERE CT2_FILIAL = '"+ xFilial("CT2") + "' AND "
		cQuery	+= cValid + " AND "
		cQuery	+= " CT2_DATA >= '" + DTOS(dDataIni) + "' AND "
		cQuery	+= " CT2_DATA <= '" + DTOS(dDataFim) + "' AND "
		cQuery	+= cVldEnt+ " AND "
		cQuery	+= cFilMoeda + " AND "
		cQuery	+= " CT2_TPSALD = '"+ cSaldo + "'"
		cQuery	+= " AND (CT2_DC = '1' OR CT2_DC = '3')"
		cQuery   += " AND CT2_VALOR <> 0 "
		cQuery	+= " AND D_E_L_E_T_ = ' ' "
		cQuery	+= " ORDER BY "+ cOrderBy
		cQuery := ChangeQuery(cQuery)

		If ( Select ( "cAliasCT2" ) <> 0 )
			dbSelectArea ( "cAliasCT2" )
			dbCloseArea ()
		Endif

		dbUseArea( .T. ,"TOPCONN",TcGenQry(,,cQuery),cAliasCT2, .T. , .F. )
		aStru := CT2->(dbStruct())

		For ni := 1 to Len(aStru)
			If aStru[ni,2] <> "C"
				TCSetField(cAliasCT2, aStru[ni,1], aStru[ni,2],aStru[ni,3],aStru[ni,4])
			Endif
		next

		If lUFilter
			If !Empty(cVldEnt)
				cVldEnt  += " AND "
				cVldEnt  += cUFilter
			EndIf
		EndIf

		If (!lUFilter) .or.  Empty(cUFilter)
			cUFilter := ".T."
		EndIf

		dbSelectArea(cAliasCT2)
		While !Eof()
			If &cUFilter
				CtbGrvRAZ(lJunta,cMoeda,cSaldo,"1",c2Moeda,cAliasCT2,nTipo)
				dbSelectArea(cAliasCT2)
			EndIf
			dbSkip()
		EndDo

    Else

	If cTipo == "1"
		dbSelectArea("CT2")
		dbSetOrder(2)

		cValid	:= 	"CT2_DEBITO>='" + cContaIni + "' .And. " + "CT2_DEBITO<='" + cContaFim + "'"





		cVldEnt := 	"CT2_CCD>='" + cCustoIni + "' .And. " + "CT2_CCD<='" + cCustoFim + "' .And. " + "CT2_ITEMD>='" + cItemIni + "' .And. " + "CT2_ITEMD<='" + cItemFim + "' .And. " + "CT2_CLVLDB>='" + cClVlIni + "' .And. " + "CT2_CLVLDB<='" + cClVlFim + "'"
		bCond 	:= { ||CT2->CT2_DEBITO >= cContaIni .And.  CT2->CT2_DEBITO <= cContaFim}
	ElseIf cTipo == "2"
		dbSelectArea("CT2")
		dbSetOrder(4)

		cValid	:= 	"CT2_CCD >= '" + cCustoIni + "'  .And.  " + "CT2_CCD <= '" + cCustoFim + "'"





		cVldEnt := 	"CT2_DEBITO >= '" + cContaIni + "'  .And.  " + "CT2_DEBITO <= '" + cContaFim + "'  .And.  " + "CT2_ITEMD >= '" + cItemIni + "'  .And.  " + "CT2_ITEMD <= '" + cItemFim + "'  .And.  " + "CT2_CLVLDB >= '" + cClVlIni + "'  .And.  " + "CT2_CLVLDB <= '" + cClVlFim + "'"
	ElseIf cTipo == "3"
		dbSelectArea("CT2")
		dbSetOrder(6)

		cValid 	:= 	"CT2_ITEMD >= '" + cItemIni + "'  .And.  " + "CT2_ITEMD <= '" + cItemFim + "'"





		cVldEnt	:= 	"CT2_DEBITO >= '" + cContaIni + "'  .And.  " + "CT2_DEBITO <= '" + cContaFim + "'  .And.  " + "CT2_CCD >= '" + cCustoIni + "'  .And.  " + "CT2_CCD <= '" + cCustoFim + "'  .And.  " + "CT2_CLVLDB >= '" + cClVlIni + "'  .And.  " + "CT2_CLVLDB <= '" + cClVlFim + "'"
	ElseIf cTipo == "4"
		dbSelectArea("CT2")
		dbSetOrder(8)

		cValid 	:= 	"CT2_CLVLDB >= '" + cClVlIni + "'  .And.  " + "CT2_CLVLDB <= '" + cClVlFim + "'"





		cVldEnt	:= 	"CT2_DEBITO >= '" + cContaIni + "'  .And.  " + "CT2_DEBITO <= '" + cContaFim + "'  .And.  " + "CT2_CCD >= '" + cCustoIni + "'  .And.  " + "CT2_CCD <= '" + cCustoFim + "'  .And.  " + "CT2_ITEMD >= '" + cItemIni + "'  .And.  " + "CT2_ITEMD <= '" + cItemFim + "'"
	EndIf

	If lUFilter
		If !Empty(cVldEnt)
			cVldEnt  += " .and. "
		EndIf
	Endif

	cVldEnt  += cUFilter

	If cTipo == "1"

		dbSelectArea("CT2")
		dbSetOrder(2)

		dbSelectArea("CT1")
		dbSetOrder(3)
		cFilCT1 := xFilial("CT1")
		cFilCT2	:= xFilial("CT2")
		cContaIni := If(Empty(cContaIni),"",cContaIni)
		dbSeek(cFilCT1+"2"+cContaIni, .T. )

		While CT1->(!Eof()) .and.  CT1->CT1_FILIAL == cFilCT1 .And.  CT1->CT1_CONTA <= cContaFim
			dbSelectArea("CT2")
			MsSeek(cFilCT2+CT1->CT1_CONTA+DTOS(dDataIni), .T. )
			While !Eof() .And.  CT2->CT2_FILIAL == cFilCT2 .And.  CT2->CT2_DEBITO == CT1->CT1_CONTA .and.  CT2->CT2_DATA <= dDataFim

				If CT2->CT2_VALOR = 0
					dbSkip()
					Loop
				EndIf

				If Empty(c2Moeda)
					If CT2->CT2_MOEDLC <> cMoeda
						dbSkip()
						Loop
					EndIF
				Else
					If !(&(cFilMoeda))
						dbSkip()
						Loop
					EndIf
				EndIf

				If (CT2->CT2_DC == "1" .Or.  CT2->CT2_DC == "3") .And.  &(cValid) .And.  &(cVldEnt) .And.  CT2->CT2_TPSALD == cSaldo
					CT2->(CtbGrvRAZ(lJunta,cMoeda,cSaldo,"1",c2Moeda,cAliasCT2,nTipo))
				Endif
				dbSelectArea("CT2")
				dbSkip()
			EndDo
			CT1->(dbSkip())
		EndDo
	Else
		dbSelectArea("CT2")

		cTabCad := "CTT"
		cEntIni	:= cCustoIni
		bCond 	:= { || CT2->CT2_CCD == CTT->CTT_CUSTO}
		bCondCad:= { || .T. }
		dbSetOrder(4)

		If cTipo == "3"
			cTabCad := "CTD"
			cEntIni := cItemIni
			bCond 	:= { || CT2->CT2_ITEMD == CTD->CTD_ITEM}
			dbSetOrder(6)
		ElseIf cTipo == "4"
			cTabCad := "CTH"
			cEntIni := cCLVLIni
			bCond 	:= { || CT2->CT2_CLVLDB == CTH->CTH_CLVL}
			dbSetOrder(8)
		EndIf

		dbSelectArea(cTabCad)
		dbSetOrder(2)
		cFilEnt := xFilial(cTabCad)
		cFilCT2	:= xFilial("CT2")
		cEntIni := If(Empty(cEntIni),"",cEntIni)
		dbSeek(cFilEnt+"2"+cEntIni, .T. )

		If cTipo == "2"
			bCondCad := {|| CTT->CTT_FILIAL == cFilEnt .and.  CTT->CTT_CUSTO <= cCustoFim }
		ElseIf cTipo == "3"
   			bCondCad := {|| CTD->CTD_FILIAL == cFilEnt .and.  CTD->CTD_ITEM <= cItemFim }
  		ElseIf cTipo == "4"
			bCondCad := {|| CTH->CTH_FILIAL == cFilEnt .and.  CTH->CTH_CLVL <= cCLVLFim }
  		EndIf

		While (cTabCad)->(!Eof()) .and.  Eval(bCondCad)

			dbSelectArea("CT2")
			If cTipo == "2"
				MsSeek(cFilCT2+CTT->CTT_CUSTO+DTOS(dDataIni), .T. )
			ElseIf cTipo == "3"
				MsSeek(cFilCT2+CTD->CTD_ITEM+DTOS(dDataIni), .T. )
			Else
				MsSeek(cFilCT2+CTH->CTH_CLVL+DTOS(dDataIni), .T. )
			EndIf

			dbSelectArea("CT2")
			While CT2->(!Eof()) .And.  CT2->CT2_FILIAL == cFilCT2 .and.  Eval(bCond) .and.  CT2->CT2_DATA <= dDataFim

				If CT2->CT2_VALOR = 0
					dbSkip()
					Loop
				EndIf

				If Empty(c2Moeda)
					If CT2->CT2_MOEDLC <> cMoeda
						dbSkip()
						Loop
					EndIF
				Else
					If !(&(cFilMoeda))
						dbSkip()
						Loop
					EndIf
				EndIf

				If (CT2->CT2_DC == "1" .Or.  CT2->CT2_DC == "3") .And.  &(cVldEnt) .And.  CT2->CT2_TPSALD == cSaldo
					CT2->(CtbGrvRAZ(lJunta,cMoeda,cSaldo,"1",c2Moeda,cAliasCT2,nTipo))
				Endif
				dbSelectArea("CT2")
				dbSkip()
			EndDo
			(cTabCad)->(dbSkip())
		EndDo
	Endif


	EndIf






If cTipo == "1"
	dbSelectArea("CT2")
	dbSetOrder(3)
ElseIf cTipo == "2"
	dbSelectArea("CT2")
	dbSetOrder(5)
ElseIf cTipo == "3"
	dbSelectArea("CT2")
	dbSetOrder(7)
ElseIf cTipo == "4"
	dbSelectArea("CT2")
	dbSetOrder(9)
EndIf


	If TcSrvType() <> "AS/400"
		If cTipo == "1"

			cValid	:= 	"CT2_CREDIT>='" + cContaIni + "' AND " + "CT2_CREDIT<='" + cContaFim + "'"





			cVldEnt :=	"CT2_CCC>='" + cCustoIni + "' AND " + "CT2_CCC<='" + cCustoFim + "' AND " + "CT2_ITEMC>='" + cItemIni + "' AND " + "CT2_ITEMC<='" + cItemFim + "' AND " + "CT2_CLVLCR>='" + cClVlIni + "' AND " + "CT2_CLVLCR<='" + cClVlFim + "'"
			cOrderBy:= " CT2_FILIAL, CT2_CREDIT, CT2_DATA "
		ElseIf cTipo == "2"

			cValid 	:= 	"CT2_CCC >= '" + cCustoIni + "'  AND  " + "CT2_CCC <= '" + cCustoFim + "'"





			cVldEnt	:= 	"CT2_CREDIT >= '" + cContaIni + "'  AND  " + "CT2_CREDIT <= '" + cContaFim + "'  AND  " + "CT2_ITEMC >= '" + cItemIni + "'  AND  " + "CT2_ITEMC <= '" + cItemFim + "'  AND  " + "CT2_CLVLCR >= '" + cClVlIni + "'  AND  " + "CT2_CLVLCR <= '" + cClVlFim + "'"
			cOrderBy:= " CT2_FILIAL, CT2_CCC, CT2_DATA "
		ElseIf cTipo == "3"

			cValid 	:= 	"CT2_ITEMC >= '" + cItemIni + "'  AND  " + "CT2_ITEMC <= '" + cItemFim + "'"





			cVldEnt := 	"CT2_CREDIT >= '" + cContaIni + "'  AND  " + "CT2_CREDIT <= '" + cContaFim + "'  AND  " + "CT2_CCC >= '" + cCustoIni + "'  AND  " + "CT2_CCC <= '" + cCustoFim + "'  AND  " + "CT2_CLVLCR >= '" + cClVlIni + "'  AND  " + "CT2_CLVLCR <= '" + cClVlFim + "'"
			cOrderBy:= " CT2_FILIAL, CT2_ITEMC, CT2_DATA "
		ElseIf cTipo == "4"

			cValid 	:= 	"CT2_CLVLCR >= '" + cClVlIni + "'  AND  " + "CT2_CLVLCR <= '" + cClVlFim + "'"





			cVldEnt := 	"CT2_CREDIT >= '" + cContaIni + "'  AND  " + "CT2_CREDIT <= '" + cContaFim + "'  AND  " + "CT2_CCC >= '" + cCustoIni + "'  AND  " + "CT2_CCC <= '" + cCustoFim + "'  AND  " + "CT2_ITEMC >= '" + cItemIni + "'  AND  " + "CT2_ITEMC <= '" + cItemFim + "'"
			cOrderBy:= " CT2_FILIAL, CT2_CLVLCR, CT2_DATA "
		EndIf

		cAliasCT2	:= "cAliasCT2"

		cQuery	:= " SELECT * "
		cQuery	+= " FROM " + RetSqlName("CT2")
		cQuery	+= " WHERE CT2_FILIAL = '"+ xFilial("CT2") + "' AND "
		cQuery	+= cValid + " AND "
		cQuery	+= " CT2_DATA >= '" + DTOS(dDataIni) + "' AND "
		cQuery	+= " CT2_DATA <= '" + DTOS(dDataFim) + "' AND "
		cQuery	+= cVldEnt+ " AND "
		cQuery	+= cFilMoeda + " AND "
		cQuery	+= " CT2_TPSALD = '"+ cSaldo + "' AND "
		cQuery	+= " (CT2_DC = '2' OR CT2_DC = '3') AND "
		cQuery	+= " CT2_VALOR <> 0 AND "
		cQuery	+= " D_E_L_E_T_ = ' ' "
		cQuery	+= " ORDER BY "+ cOrderBy
		cQuery := ChangeQuery(cQuery)

		If ( Select ( "cAliasCT2" ) <> 0 )
			dbSelectArea ( "cAliasCT2" )
			dbCloseArea ()
		Endif

		dbUseArea( .T. ,"TOPCONN",TcGenQry(,,cQuery),cAliasCT2, .T. , .F. )

		aStru := CT2->(dbStruct())

		For ni := 1 to Len(aStru)
			If aStru[ni,2] <> "C"
				TCSetField(cAliasCT2, aStru[ni,1], aStru[ni,2],aStru[ni,3],aStru[ni,4])
			Endif
		next


		If lUFilter
			If !Empty(cVldEnt)
				cVldEnt  += " AND "
				cVldEnt  += cUFilter
			EndIf
		EndIf

		If (!lUFilter) .or.  Empty(cUFilter)
			cUFilter := ".T."
		EndIf

		dbSelectArea(cAliasCT2)
		While !Eof()
			If &cUFilter
				CtbGrvRAZ(lJunta,cMoeda,cSaldo,"2",c2Moeda,cAliasCT2,nTipo)
				dbSelectArea(cAliasCT2)
		    EndIf
			dbSkip()
		EndDo

	Else

	bCond	:= {|| .T. }

	If cTipo == "1"

		cValid	:= 	"CT2_CREDIT>='" + cContaIni + "'.And." + "CT2_CREDIT<='" + cContaFim + "'"





		cVldEnt :=	"CT2_CCC>='" + cCustoIni + "'.And." + "CT2_CCC<='" + cCustoFim + "'.And." + "CT2_ITEMC>='" + cItemIni + "'.And." + "CT2_ITEMC<='" + cItemFim + "'.And." + "CT2_CLVLCR>='" + cClVlIni + "'.And." + "CT2_CLVLCR<='" + cClVlFim + "'"
		bCond 	:= { ||CT2->CT2_CREDIT >= cContaIni .And.  CT2->CT2_CREDIT <= cContaFim}
	ElseIf cTipo == "2"

		cValid 	:= 	"CT2_CCC >= '" + cCustoIni + "' .And. " + "CT2_CCC <= '" + cCustoFim + "'"





		cVldEnt	:= 	"CT2_CREDIT >= '" + cContaIni + "' .And. " + "CT2_CREDIT <= '" + cContaFim + "' .And. " + "CT2_ITEMC >= '" + cItemIni + "' .And. " + "CT2_ITEMC <= '" + cItemFim + "' .And. " + "CT2_CLVLCR >= '" + cClVlIni + "' .And. " + "CT2_CLVLCR <= '" + cClVlFim + "'"
	ElseIf cTipo == "3"

		cValid 	:= 	"CT2_ITEMC >= '" + cItemIni + "' .And. " + "CT2_ITEMC <= '" + cItemFim + "'"





		cVldEnt := 	"CT2_CREDIT >= '" + cContaIni + "' .And. " + "CT2_CREDIT <= '" + cContaFim + "' .And. " + "CT2_CCC >= '" + cCustoIni + "' .And. " + "CT2_CCC <= '" + cCustoFim + "' .And. " + "CT2_CLVLCR >= '" + cClVlIni + "' .And. " + "CT2_CLVLCR <= '" + cClVlFim + "'"
	ElseIf cTipo == "4"

		cValid 	:= 	"CT2_CLVLCR >= '" + cClVlIni + "' .And. " + "CT2_CLVLCR <= '" + cClVlFim + "'"





		cVldEnt := 	"CT2_CREDIT >= '" + cContaIni + "' .And. " + "CT2_CREDIT <= '" + cContaFim + "' .And. " + "CT2_CCC >= '" + cCustoIni + "' .And. " + "CT2_CCC <= '" + cCustoFim + "' .And. " + "CT2_ITEMC >= '" + cItemIni + "' .And. " + "CT2_ITEMC <= '" + cItemFim + "'"
	EndIf

	If lUFilter
		If !Empty(cVldEnt)
			cVldEnt  += " .and. "
		EndIf
	Endif

	cVldEnt  += cUFilter

	If cTipo == "1"
		dbSelectArea("CT2")
		dbSetOrder(3)

		dbSelectArea("CT1")
		dbSetOrder(3)
		cFilCT1 := xFilial("CT1")
		cFilCT2	:= xFilial("CT2")
		cContaIni := If(Empty(cContaIni),"",cContaIni)
		dbSeek(cFilCT1+"2"+cContaIni, .T. )

		While CT1->(!Eof()) .and.  CT1->CT1_FILIAL == cFilCT1 .And.  CT1->CT1_CONTA <= cContaFim
			dbSelectArea("CT2")
			MsSeek(cFilCT2+CT1->CT1_CONTA+DTOS(dDataIni), .T. )
			While !Eof() .And.  CT2->CT2_FILIAL == cFilCT2 .And.  CT2->CT2_CREDIT == CT1->CT1_CONTA .and.  CT2->CT2_DATA <= dDataFim

				If CT2->CT2_VALOR = 0
					dbSkip()
					Loop
				EndIf

				If (CT2->CT2_DC == "2" .Or.  CT2->CT2_DC == "3") .And.  &(cValid) .And.  &(cVldEnt) .And.  CT2->CT2_TPSALD == cSaldo
					If Empty(c2Moeda)
						If CT2->CT2_MOEDLC <> cMoeda
							dbSkip()
							Loop
						EndIF
					Else
						If !(&(cFilMoeda))
							dbSkip()
							Loop
						EndIf
					EndIf
					CT2->(CtbGrvRAZ(lJunta,cMoeda,cSaldo,"2",c2Moeda,cAliasCT2,nTipo))
				Endif
				dbSelectArea("CT2")
				dbSkip()
			EndDo
			CT1->(dbSkip())
		EndDo
	Else
		dbSelectArea("CT2")

		cTabCad := "CTT"
		cEntIni	:= cCustoIni
		bCond 	:= { || CT2->CT2_CCC == CTT->CTT_CUSTO}
		bCondCad:= { || .T. }
		dbSetOrder(5)

		If cTipo == "3"
			cTabCad := "CTD"
			cEntIni := cItemIni
			bCond 	:= { || CT2->CT2_ITEMC == CTD->CTD_ITEM}
			dbSetOrder(7)
		ElseIf cTipo == "4"
			cTabCad := "CTH"
			cEntIni := cCLVLIni
			bCond 	:= { || CT2->CT2_CLVLCR == CTH->CTH_CLVL}
			dbSetOrder(9)
		EndIf

		dbSelectArea(cTabCad)
		dbSetOrder(2)
		cFilEnt := xFilial(cTabCad)
		cFilCT2	:= xFilial("CT2")
		cEntIni := If(Empty(cEntIni),"",cEntIni)
		dbSeek(cFilEnt+"2"+cEntIni, .T. )

		If cTipo == "2"
			bCondCad := {|| CTT->CTT_FILIAL == cFilEnt .and.  CTT->CTT_CUSTO <= cCustoFim }
		ElseIf cTipo == "3"
   			bCondCad := {|| CTD->CTD_FILIAL == cFilEnt .and.  CTD->CTD_ITEM <= cItemFim }
  		ElseIf cTipo == "4"
			bCondCad := {|| CTH->CTH_FILIAL == cFilEnt .and.  CTH->CTH_CLVL <= cCLVLFim }
  		EndIf

		While (cTabCad)->(!Eof()) .and.  Eval(bCondCad)

			dbSelectArea("CT2")
			If cTipo == "2"
				MsSeek(cFilCT2+CTT->CTT_CUSTO+DTOS(dDataIni), .T. )
			ElseIf cTipo == "3"
				MsSeek(cFilCT2+CTD->CTD_ITEM+DTOS(dDataIni), .T. )
			Else
				MsSeek(cFilCT2+CTH->CTH_CLVL+DTOS(dDataIni), .T. )
			EndIf

			dbSelectArea("CT2")
			While CT2->(!Eof()) .And.  CT2->CT2_FILIAL == cFilCT2 .and.  Eval(bCond) .and.  CT2->CT2_DATA <= dDataFim

				If CT2->CT2_VALOR = 0
					dbSkip()
					Loop
				EndIf

				If Empty(c2Moeda)
					If CT2->CT2_MOEDLC <> cMoeda
						dbSkip()
						Loop
					EndIF
				Else
					If !(&(cFilMoeda))
						dbSkip()
						Loop
					EndIf
				EndIf

				If (CT2->CT2_DC == "2" .Or.  CT2->CT2_DC == "3") .And.  &(cVldEnt) .And.  CT2->CT2_TPSALD == cSaldo
					CT2->(CtbGrvRAZ(lJunta,cMoeda,cSaldo,"2",c2Moeda,cAliasCT2,nTipo))
				Endif
				dbSelectArea("CT2")
				dbSkip()
			EndDo
			(cTabCad)->(dbSkip())
		EndDo
	EndIf


	EndIf


If lNoMov .or.  lSldAnt
	If cTipo == "1"
		dbSelectArea("CT1")
		dbSetOrder(3)


		IndRegua(	Alias(),CriaTrab(nil, .f. ),IndexKey(),, "CT1_FILIAL == '" + xFilial("CT1") + "' .And. CT1_CONTA >= '"+cContaI+ "' .And. CT1_CONTA <= '" + cContaF + "' .And. CT1_CLASSE = '2'","Selecionando Registros...")
		cCpoChave := "CT1_CONTA"
		cTmpChave := "CONTA"
	ElseIf cTipo == "2"
		dbSelectArea("CTT")
		dbSetOrder(2)


		IndRegua(	Alias(),CriaTrab(nil, .f. ),IndexKey(),, "CTT_FILIAL == '" + xFilial("CTT") + "' .And. CTT_CUSTO >= '"+cCustoI+"' .And. CTT_CUSTO <= '" + cCUSTOF + "' .And. CTT_CLASSE == '2'","Selecionando Registros...")
		cCpoChave := "CTT_CUSTO"
		cTmpChave := "CCUSTO"
	ElseIf ctipo == "3"
		dbSelectArea("CTD")
		dbSetOrder(2)


		IndRegua(	Alias(),CriaTrab(nil, .f. ),IndexKey(),, "CTD_FILIAL == '" + xFilial("CTD") + "' .And. CTD_ITEM >= '"+cItemI+"' .And. CTD_ITEM <= '" + cITEMF + "' .And. CTD_CLASSE == '2'","Selecionando Registros...")
		cCpoChave := "CTD_ITEM"
		cTmpChave := "ITEM"
	ElseIf ctipo == "4"
		dbSelectArea("CTH")
		dbSetOrder(2)


		IndRegua(	Alias(),CriaTrab(nil, .f. ),IndexKey(),, "CTH_FILIAL == '" + xFilial("CTH") + "' .And. CTH_CLVL >= '"+cClVlI+"' .And. CTH_CLVL <= '" + cCLVLF + "' .And. CTH_CLASSE == '2'","Selecionando Registros...")
		cCpoChave := "CTH_CLVL"
		cTmpChave := "CLVL"
	EndIf

	cAlias := Alias()

	While ! Eof()
		dbSelectArea("cArqTmp")
		cKey2Seek	:= &(cAlias + "->" + cCpoChave)
		If !DbSeek(cKey2Seek)
			If lNoMov
				CtbGrvNoMov(cKey2Seek,dDataIni,cTmpChave)
			ElseIf cTipo == "1"

				If SaldoCT7(cKey2Seek,dDataIni,cMoeda,cSaldo,"CTBR400")[6] <> 0 .and.  cArqTMP->CONTA <> cKey2Seek

					CtbGrvNoMov(cKey2Seek,dDataIni,cTmpChave)
				Endif
			EndIf
		Endif
		DbSelectArea(cAlias)
		DbSkip()
	EndDo

	DbSelectArea(cAlias)
	DbClearFil()
	RetIndex(cAlias)
Endif

Return

























STATIC Function CtbGrvRAZ(lJunta,cMoeda,cSaldo,cTipo,c2Moeda,cAliasCT2,nTipo)

Local cConta
Local cContra
Local cCusto
Local cItem
Local cCLVL
Local cChave   	:= ""
Local lImpCPartida := GetNewPar("MV_IMPCPAR", .T. )


cAliasCT2 := If( cAliasCT2 == nil, "CT2", cAliasCT2 ) ;

If !Empty(c2Moeda)
	If cTipo == "1"
		cChave	:=	(cAliasCT2)->(CT2_DEBITO+DTOS(CT2_DATA)+CT2_LOTE+CT2_SBLOTE+CT2_DOC+CT2_LINHA+CT2_EMPORI+CT2_FILORI)
	Else
    	cChave	:=	(cAliasCT2)->(CT2_CREDIT+DTOS(CT2_DATA)+CT2_LOTE+CT2_SBLOTE+CT2_DOC+CT2_LINHA+CT2_EMPORI+CT2_FILORI)
 	EndIf
EndIf


If cTipo == "1"
	cConta 	:= (cAliasCT2)->CT2_DEBITO
	cContra	:= (cAliasCT2)->CT2_CREDIT
	cCusto	:= (cAliasCT2)->CT2_CCD
	cItem	:= (cAliasCT2)->CT2_ITEMD
	cCLVL	:= (cAliasCT2)->CT2_CLVLDB
EndIf
If cTipo == "2"
	cConta 	:= (cAliasCT2)->CT2_CREDIT
	cContra := (cAliasCT2)->CT2_DEBITO
	cCusto	:= (cAliasCT2)->CT2_CCC
	cItem	:= (cAliasCT2)->CT2_ITEMC
	cCLVL	:= (cAliasCT2)->CT2_CLVLCR
EndIf

dbSelectArea("cArqTmp")
dbSetOrder(1)
If !Empty(c2Moeda)
	If MsSeek(cChave, .F. )
		Reclock("cArqTmp", .F. )
	Else
		RecLock("cArqTmp", .T. )
	EndIf
Else
	RecLock("cArqTmp", .T. )
EndIf
nAxoZC := Ascan( aStrZC, { |y| Trim(y[1]) == Trim( (cAliasCT2)->CT2_LOTE )  } )
If nAxoZC > 0
   _FIELD->ID_PROVIS := aStrZC[nAxoZC][2]
EndIf
_FIELD->DATAL := (cAliasCT2)->CT2_DATA
_FIELD->TIPO := cTipo
_FIELD->LOTE := (cAliasCT2)->CT2_LOTE
_FIELD->SUBLOTE := (cAliasCT2)->CT2_SBLOTE
_FIELD->DOC := (cAliasCT2)->CT2_DOC
_FIELD->LINHA := (cAliasCT2)->CT2_LINHA
_FIELD->CONTA := cConta
If lImpCPartida
	_FIELD->XPARTIDA := cContra
EndIf
_FIELD->CCUSTO := cCusto
_FIELD->ITEM := cItem
_FIELD->CLVL := cCLVL
_FIELD->HISTORICO := (cAliasCT2)->CT2_HIST
_FIELD->EMPORI := (cAliasCT2)->CT2_EMPORI
_FIELD->FILORI := (cAliasCT2)->CT2_FILORI
_FIELD->SEQHIST := (cAliasCT2)->CT2_SEQHIST
_FIELD->SEQLAN := (cAliasCT2)->CT2_SEQLAN
_FIELD->NOMOV := .F. 

If cPaisLoc == "CHI"
	_FIELD->SEGOFI := (cAliasCT2)->CT2_SEGOFI
EndIf

If Empty(c2Moeda)
	If cTipo == "1"
		_FIELD->LANCDEB := LANCDEB+(cAliasCT2)->CT2_VALOR
	EndIf
	If cTipo == "2"
		_FIELD->LANCCRD := LANCCRD+(cAliasCT2)->CT2_VALOR
	EndIf
	If (cAliasCT2)->CT2_DC == "3"
		_FIELD->TIPO := cTipo
	Else
		_FIELD->TIPO := (cAliasCT2)->CT2_DC
	EndIf
Else
	If (nTipo = 1 .Or.  nTipo = 3) .And.  (cAliasCT2)->CT2_MOEDLC = cMoeda
		If cTipo == "1"
			_FIELD->LANCDEB := (cAliasCT2)->CT2_VALOR
		Else
			_FIELD->LANCCRD := (cAliasCT2)->CT2_VALOR
		EndIf
	EndIf
    If (nTipo = 2 .Or.  nTipo = 3) .And.  (cAliasCT2)->CT2_MOEDLC = c2Moeda
		If cTipo == "1"
			_FIELD->LANCDEB_1 := (cAliasCT2)->CT2_VALOR
		Else
			_FIELD->LANCCRD_1 := (cAliasCT2)->CT2_VALOR
		Endif
	EndIf
	If LANCDEB_1 <> 0 .And.  LANCDEB <> 0
		_FIELD->TXDEBITO := LANCDEB_1/LANCDEB
	Endif
	If LANCCRD_1 <> 0 .And.  LANCCRD <> 0
		_FIELD->TXCREDITO := LANCCRD_1/LANCCRD
	EndIf
	If (cAliasCT2)->CT2_DC == "3"
		_FIELD->TIPO := cTipo
	Else
		_FIELD->TIPO := (cAliasCT2)->CT2_DC
	EndIf
EndIf

If nTipo = 1 .And.  (LANCDEB + LANCCRD) = 0
	DbDelete()
ElseIf nTipo = 2 .And.  (LANCDEB_1 + LANCCRD_1) = 0
	DbDelete()
Endif
If ! Empty(c2Moeda) .And.  LANCDEB + LANCDEB_1 + LANCCRD + LANCCRD_1 = 0
	DbDelete()
Endif
MsUnlock()

Return























STATIC Function CtbGrvNoMov(cConteudo,dDataL,cCpoTmp)

dbSelectArea("cArqTmp")
dbSetOrder(1)

RecLock("cArqTmp", .T. )
_FIELD->&(cCpoTmp) := cConteudo
If cCpoTmp = "CONTA"
	_FIELD->HISTORICO := "CONTA SEM MOVIMENTO NO PERIODO"
ElseIf cCpoTmp = "CCUSTO"
	_FIELD->HISTORICO := Upper(AllTrim(CtbSayApro("CTT")))+" "+"SEM MOVIMENTO NO PERIODO"
ElseIf cCpoTmp = "ITEM"
	_FIELD->HISTORICO := Upper(AllTrim(CtbSayApro("CTD")))+" "+"SEM MOVIMENTO NO PERIODO"
ElseIf cCpoTmp = "CLVL"
	_FIELD->HISTORICO := Upper(AllTrim(CtbSayApro("CTH")))+" "+"SEM MOVIMENTO NO PERIODO"
Endif
_FIELD->DATAL := dDataL
MsUnlock()

Return
























STATIC Function Ctr400Sint(cConta,cDescSint,cMoeda,cDescConta,cCodRes)

Local aSaveArea := GetArea()

Local nPosCT1
Local cContaPai	:= ""
Local cContaSint	:= ""

dbSelectArea("CT1")
dbSetOrder(1)
If dbSeek(xFilial("CT1")+cConta)
	nPosCT1 	:= Recno()
	cDescConta  := &("CT1->CT1_DESC"+cMoeda)
	If Empty(cDescConta)
		cDescConta  := CT1->CT1_DESC01
	Endif
	cCodRes		:= CT1->CT1_RES
	cContaPai	:= CT1->CT1_CTASUP
	If dbSeek(xFilial("CT1")+cContaPai)
		cContaSint 	:= CT1->CT1_CONTA
		cDescSint	:= &("CT1->CT1_DESC"+cMoeda)
		If Empty(cDescSint)
			cDescSint := CT1->CT1_DESC01
		Endif
	EndIf
	dbGoto(nPosCT1)
EndIf

RestArea(aSaveArea)

Return cContaSint












































STATIC Function CtbQryRaz(oMeter,oText,oDlg,lEnd,cContaIni,cContaFim,cCustoIni,cCustoFim, cItemIni,cItemFim,cCLVLIni,cCLVLFim,cMoeda,dDataIni,dDataFim, aSetOfBook,lNoMov,cSaldo,lJunta,cTipo,c2Moeda,cUFilter,lSldAnt)

Local aSaveArea := GetArea()
Local nMeter	:= 0
Local cQuery	:= ""
Local aTamVlr	:= TAMSX3("CT2_VALOR")
Local lNoMovim	:= .F. 
Local cContaAnt	:= ""
Local cCampUSU	:= ""
local aStrSTRU	:= {}
Local nStr		:= 0

Local lImpCPartida := GetNewPar("MV_IMPCPAR", .T. )


lSldAnt := If( lSldAnt == nil, .F. , lSldAnt ) ;

oMeter:SetTotal(CT2->(RecCount()))
oMeter:Set(0)

cQuery	:= " SELECT ISNULL(CT2_LP,'') ORIGEM, CT1_CONTA CONTA, ISNULL(CT2_CCD,'') CUSTO,ISNULL(CT2_ITEMD,'') ITEM, ISNULL(CT2_CLVLDB,'') CLVL, ISNULL(CT2_DATA,'') DDATA, ISNULL(CT2_TPSALD,'') TPSALD, "
cQuery	+= " ISNULL(CT2_DC,'') DC, ISNULL(CT2_LOTE,'') LOTE, ISNULL(CT2_SBLOTE,'') SUBLOTE, ISNULL(CT2_DOC,'') DOC, ISNULL(CT2_LINHA,'') LINHA, ISNULL(CT2_CREDIT,'') XPARTIDA, ISNULL(CT2_HIST,'') HIST, ISNULL(CT2_SEQHIS,'') SEQHIS, ISNULL(CT2_SEQLAN,'') SEQLAN, '1' TIPOLAN, "



cCampUSU  := ""
If !Empty(cUFilter)
	aStrSTRU := CT2->(dbStruct())
	nStruLen := Len(aStrSTRU)
	For nStr := 1 to nStruLen
		cCampUSU += aStrSTRU[nStr][1]+","
	Next
Endif
cQuery += cCampUSU

cQuery  += " ISNULL(CT2_VALOR,0) VALOR, ISNULL(CT2_EMPORI,'') EMPORI, ISNULL(CT2_FILORI,'') FILORI"
If cPaisLoc == "CHI"
	cQuery	+= ", ISNULL(CT2_SEGOFI,'') SEGOFI"
EndIf
cQuery	+= " FROM "+ RetSqlName("CT1") + " CT1 LEFT JOIN " + RetSqlName("CT2") + " CT2 "
cQuery	+= " ON CT2.CT2_FILIAL = '"+xFilial("CT2")+"' "
cQuery	+= " AND CT2.CT2_DEBITO = CT1.CT1_CONTA"
cQuery  += " AND CT2.CT2_DATA >= '"+DTOS(dDataIni)+ "' AND CT2.CT2_DATA <= '"+DTOS(dDataFim)+"'"
cQuery	+= " AND CT2.CT2_CCD >= '" + cCustoIni + "' AND CT2.CT2_CCD <= '" + cCustoFim +"'"
cQuery  += " AND CT2.CT2_ITEMD >= '" + cItemIni + "' AND CT2.CT2_ITEMD <= '"+ cItemFim +"'"
cQuery  += " AND CT2.CT2_CLVLDB >= '" + cClvlIni + "' AND CT2.CT2_CLVLDB <= '" + cClVlFim +"'"
cQuery  += " AND CT2.CT2_TPSALD = '"+ cSaldo + "'"
cQuery	+= " AND CT2.CT2_MOEDLC = '" + cMoeda +"'"
cQuery  += " AND (CT2.CT2_DC = '1' OR CT2.CT2_DC = '3' OR OR CT2.CT2_DC = '4') "

cQuery	+= " AND CT2.D_E_L_E_T_ = ' ' "
cQuery	+= " WHERE CT1.CT1_FILIAL = '"+xFilial("CT1")+"' "
cQuery	+= " AND CT1.CT1_CLASSE = '2' "
cQuery	+= " AND CT1.CT1_CONTA >= '"+ cContaIni+"' AND CT1.CT1_CONTA <= '"+cContaFim+"'"
cQuery	+= " AND CT1.D_E_L_E_T_ = '' "
cQuery	+= " UNION "
cQuery	+= " SELECT ISNULL(CT2_LP,'') ORIGEM, CT1_CONTA CONTA, ISNULL(CT2_CCC,'') CUSTO, ISNULL(CT2_ITEMC,'') ITEM, ISNULL(CT2_CLVLCR,'') CLVL, ISNULL(CT2_DATA,'') DDATA, ISNULL(CT2_TPSALD,'') TPSALD, "
cQuery	+= " ISNULL(CT2_DC,'') DC, ISNULL(CT2_LOTE,'') LOTE, ISNULL(CT2_SBLOTE,'')SUBLOTE, ISNULL(CT2_DOC,'') DOC, ISNULL(CT2_LINHA,'') LINHA, ISNULL(CT2_DEBITO,'') XPARTIDA, ISNULL(CT2_HIST,'') HIST, ISNULL(CT2_SEQHIS,'') SEQHIS, ISNULL(CT2_SEQLAN,'') SEQLAN, '2' TIPOLAN, "



cCampUSU  := ""
If !Empty(cUFilter)
	aStrSTRU := CT2->(dbStruct())
	nStruLen := Len(aStrSTRU)
	For nStr := 1 to nStruLen
		cCampUSU += aStrSTRU[nStr][1]+","
	Next
Endif
cQuery += cCampUSU


cQuery  += " ISNULL(CT2_VALOR,0) VALOR, ISNULL(CT2_EMPORI,'') EMPORI, ISNULL(CT2_FILORI,'') FILORI"
If cPaisLoc == "CHI"
	cQuery	+= ", ISNULL(CT2_SEGOFI,'') SEGOFI"
EndIf
cQuery	+= " FROM "+RetSqlName("CT1")+ " CT1 LEFT JOIN "+ RetSqlName("CT2") + " CT2 "
cQuery	+= " ON CT2.CT2_FILIAL = '"+xFilial("CT2")+"' "
cQuery	+= " AND CT2.CT2_CREDIT =  CT1.CT1_CONTA "
cQuery  += " AND CT2.CT2_DATA >= '"+DTOS(dDataIni)+ "' AND CT2.CT2_DATA <= '"+DTOS(dDataFim)+"'"
cQuery	+= " AND CT2.CT2_CCC >= '" + cCustoIni + "' AND CT2.CT2_CCC <= '" + cCustoFim +"'"
cQuery  += " AND CT2.CT2_ITEMC >= '" + cItemIni + "' AND CT2.CT2_ITEMC <= '"+ cItemFim +"'"
cQuery  += " AND CT2.CT2_CLVLCR >= '" + cClvlIni + "' AND CT2.CT2_CLVLCR <= '" + cClVlFim +"'"
cQuery  += " AND CT2.CT2_TPSALD = '"+ cSaldo + "'"
cQuery	+= " AND CT2.CT2_MOEDLC = '" + cMoeda +"'"
cQuery  += " AND (CT2.CT2_DC = '2' OR CT2.CT2_DC = '3' OR CT2.CT2_DC = '4' ) "

cQuery	+= " AND CT2.D_E_L_E_T_ = ' ' "
cQuery	+= " WHERE CT1.CT1_FILIAL = '"+xFilial("CT1")+"' "
cQuery	+= " AND CT1.CT1_CLASSE = '2' "
cQuery	+= " AND CT1.CT1_CONTA >= '"+ cContaIni+"' AND CT1.CT1_CONTA <= '"+cContaFim+"'"
cQuery	+= " AND CT1.D_E_L_E_T_ = ''"
cQuery := ChangeQuery(cQuery)



If Select("cArqCT2") > 0
	dbSelectArea("cArqCT2")
	dbCloseArea()
Endif

dbUseArea( .T. ,"TOPCONN",TcGenQry(,,cQuery),"cArqCT2", .T. , .F. )
TcSetField("cArqCT2","CT2_VLR"+cMoeda,"N",aTamVlr[1],aTamVlr[2])
TcSetField("cArqCT2","DDATA","D",8,0)

If !Empty(cUFilter)
	For nStr := 1 to nStruLen
		If aStrSTRU[nStr][2] <> "C" .and.  cArqCT2->(FieldPos(aStrSTRU[nStr][1])) > 0
			TcSetField("cArqCT2",aStrSTRU[nStr][1],aStrSTRU[nStr][2],aStrSTRU[nStr][3],aStrSTRU[nStr][4])
		EndIf
	Next
Endif

dbSelectarea("cArqCT2")

dbSelectarea("cArqCT2")
If Empty(cUFilter)
	cUFilter := ".T."
Endif

While !Eof()
	If Empty(cArqCT2->DDATA)
		cContaAnt	:= cArqCT2->CONTA
		dbSkip()
		If Empty(cArqCT2->DDATA) .And.  cContaAnt == cArqCT2->CONTA
			lNoMovim	:= .T. 
		EndIf
	Endif

	If &("cArqCT2->("+cUFilter+")")
		If lNoMovim
			If lNoMov
				If CtbExDtFim("CT1")
					dbSelectArea("CT1")
					dbSetOrder(1)
					If MsSeek(xFilial()+cArqCT2->CONTA)
						If CtbVlDtFim("CT1",dDataIni)
							CtbGrvNoMov(cArqCT2->CONTA,dDataIni,"CONTA")
						EndIf
					EndIf
				Else
					CtbGrvNoMov(cArqCT2->CONTA,dDataIni,"CONTA")
				EndIf
			ElseIf lSldAnt
				If SaldoCT7(cArqCT2->CONTA,dDataIni,cMoeda,cSaldo,"CTBR400")[6] <> 0 .and.  cArqTMP->CONTA <> cArqCT2->CONTA
					CtbGrvNoMov(cArqCT2->CONTA,dDataIni,"CONTA")
				Endif
			EndIf
		Else
			RecLock("cArqTmp", .T. )
		    _FIELD->DATAL := cArqCT2->DDATA
			_FIELD->TIPO := cArqCT2->DC
			_FIELD->LOTE := cArqCT2->LOTE
			_FIELD->SUBLOTE := cArqCT2->SUBLOTE
			_FIELD->DOC := cArqCT2->DOC
			_FIELD->LINHA := cArqCT2->LINHA
			_FIELD->CONTA := cArqCT2->CONTA
			_FIELD->CCUSTO := cArqCT2->CUSTO
			_FIELD->ITEM := cArqCT2->ITEM
			_FIELD->CLVL := cArqCT2->CLVL
			If lImpCPartida
				_FIELD->XPARTIDA := cArqCT2->XPARTIDA
			EndIf
			_FIELD->HISTORICO := cArqCT2->HIST
			_FIELD->EMPORI := cArqCT2->EMPORI
			_FIELD->FILORI := cArqCT2->FILORI
			_FIELD->SEQHIST := cArqCT2->SEQHIS
			_FIELD->SEQLAN := cArqCT2->SEQLAN

			If cPaisLoc == "CHI"
				_FIELD->SEGOFI := cArqCT2->SEGOFI
			EndIf

			If cArqCT2->TIPOLAN = "1"
				_FIELD->LANCDEB := LANCDEB+cArqCT2->VALOR
			EndIf
			If cArqCT2->TIPOLAN = "2"
				_FIELD->LANCCRD := LANCCRD+cArqCT2->VALOR
			EndIf




			nAxoZC := Ascan( aStrZC, { |y| Trim(y[1]) == Trim( cArqCT2->LOTE )  } )
			If nAxoZC > 0
			   _FIELD->ID_PROVIS := aStrZC[nAxoZC][2]
			EndIf
			MsUnlock()
		Endif
	EndIf
	lNoMovim	:= .F. 
	dbSelectArea("cArqCT2")
	dbSkip()
	nMeter++
	oMeter:Set(nMeter)
Enddo

RestArea(aSaveArea)

Return




















Static Function CtbQbPg(lNewVars,nPagIni,nPagFim,nReinicia,m_pag,nBloco,nBlCount)

lNewVars := If( lNewVars == nil, .F. , lNewVars ) ;

If lNewVars
	nBloco		:= (nPagFim+1) - nPagIni
	nBlCount	:= 0
	m_pag		:= nPagIni
Else
	nBlCount++
	If nBlCount > nBloco
		If nReinicia > nPagFim
			nUltPg	  := m_pag
			m_pag 	  := nReinicia
			nPagFim   := nReinicia+nBloco
			nReinicia := nPagFim+(nReinicia-nUltPg)
		Else
			m_pag := nReinicia
		Endif
		nBlCount := 1
	EndIf
Endif

Return














Static Function AjCTR400MV9()

dbSelectArea("SX1")
dbSetOrder(1)
If !MsSeek("CTR40009", .F. )
	Return
EndIf

If Empty(SX1->X1_DEF03)
	RecLock("SX1", .F. )
	Field->X1_DEF03 	:= "Nao c/ Sld.Ant."
	Field->X1_DEFSPA3	:= "No c/ Sld.Ant."
	Field->X1_DEFENG3	:= "No wh Prev.Bal."
	SX1->(MsUnlock())
EndIf

Return












Static Function AjusteSX1()

Local aSaveArea 	:= GetArea()
Local aPergs		:= {}
Local aHelpPor		:= {}
Local aHelpEng		:= {}
Local aHelpSpa		:= {}

aHelpPor	:= {}
aHelpEng	:= {}
aHelpSpa	:= {}




Aadd(aHelpPor,"Informe se imprime linhas entre")
Aadd(aHelpPor,"as contas.")

Aadd(aHelpEng,"Enter whether to print blank ")
Aadd(aHelpEng,"lines between accounts.")

Aadd(aHelpSpa,"Informe si imprime lineas en")
Aadd(aHelpSpa,"blanco entre las cuentas.")

Aadd(aPergs,{"Salta linha entre contas?","¨Salta linea entre cuentas?","Skip line between accounts?","mv_chx","N",1,0,1,"C",,"mv_par31","Sim","Si","Yes","","","Nao","No","No","","","","","","","","","","","","","","","","","","","S","",aHelpPor,aHelpEng,aHelpSpa})

AjustaSx1("CTR400",aPergs)




aHelpPor	:= {}
aHelpEng	:= {}
aHelpSpa	:= {}

Aadd(aHelpPor,"Informe a quantidade de linhas ")
Aadd(aHelpPor,"que serao impressas em cada pag.")
Aadd(aHelpPor,"do Razao.")

Aadd(aHelpEng,"Enter the number of rows to ")
Aadd(aHelpEng,"be printed in each Ledger ")
Aadd(aHelpEng,"page.")

Aadd(aHelpSpa,"Indique la cantidad de lineas ")
Aadd(aHelpSpa,"que imprimiran en cada pag. ")
Aadd(aHelpspa,"del Mayor.")

Aadd(aPergs,{"Num.linhas p/ o Razao?","¨Num.lineas p/ Mayor?","No.of rows for the Ledger?","mv_chy","N",2,0,0,"G",,"mv_par32","56","","","56","","","","","","","","","","","","","","","","","","","","","","","S","",aHelpPor,aHelpEng,aHelpSpa})


aHelpPor	:= {}
aHelpEng	:= {}
aHelpSpa	:= {}

Aadd(aHelpPor,"Informe se deseja considerar o ")
Aadd(aHelpPor,"saldo anterior no nivel de conta,")
Aadd(aHelpPor,"centro de custo, item ou cl.valor.")

Aadd(aHelpEng,"Enter if you wish to consider ")
Aadd(aHelpEng,"the previous balance in the ")
Aadd(aHelpEng,"account, cost center, item ")
Aadd(aHelpEng,"or value classa levels.")

Aadd(aHelpSpa,"Informe si desea considerar el")
Aadd(aHelpSpa,"saldo anterior a nivel de cuenta,")
Aadd(aHelpspa,"centro de costo, item o clase de ")
Aadd(aHelpspa,"valor.")

Aadd(aPergs,{"Sld.Ant.Nivel?","¨Salta linea entre cuentas?","Skip line between accounts?","mv_chz","N",1,0,1,"C",,"mv_par33","Conta","Cuenta","Account","","","C.Custo","C,Costo","Cost Center","","","Item","Item","Item","","","Cl.Valor","Cl.Valor","Value Class","","","","","","","","","S","",aHelpPor,aHelpEng,aHelpSpa})

AjustaSx1("CTR400",aPergs)


RestArea(aSaveArea)

Return
















Static Function MontaZC()

Local nConta := 1
Local cTxt

SX5->( DbSetOrder(1), DbSeek( xFilial("SX5")+"ZC", .t.  ) )

While !SX5->( Eof() ) .And.  SX5->(X5_FILIAL+X5_TABELA) == xFilial("SX5")+"ZC"

    If nConta == 2
       nConta := 1
       cTxt   := "EST"
    Else
       cTxt   := "PROV"
    EndIf

    Aadd( aStrZC, { SX5->X5_CHAVE, cTxt } )

    nConta ++

	SX5->( DbSkip() )

EndDo

Return